#!/bin/bash
set -euxo pipefail
PRIVATE_KEY_PATH=~/.func_tests/private_key
DIRTY='ubuntu-14.04-dirty'  # "Dirty" VM can be deleted in this script, completed cannot.
COMPLETE='ubuntu-14.04-template'
VBoxManage controlvm "${DIRTY}" poweroff || :
sleep 1s
VBoxManage unregistervm "${DIRTY}" --delete || :
sleep 1s
rm -rf .temp_vagrant || :
mkdir .temp_vagrant
cd .temp_vagrant
cat >> Vagrantfile <<VAGRANTFILE
Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/trusty64"
  config.vm.provider "virtualbox" do |v|
    v.name = "${DIRTY}"
  end
end
VAGRANTFILE
vagrant up
ssh-keygen -y -f "${PRIVATE_KEY_PATH}" > "${PRIVATE_KEY_PATH}.pub"
vagrant ssh -c 'cat - >> /home/vagrant/.ssh/authorized_keys' < "${PRIVATE_KEY_PATH}.pub"
vagrant ssh -c 'sudo cp /home/vagrant/.ssh/authorized_keys /root/.ssh/authorized_keys'
vagrant ssh -c 'sudo chown root:root /root/.ssh/authorized_keys'
cd -
find .temp_vagrant -name private_key | xargs cp -t .
rm -rf .temp_vagrant
VBoxManage controlvm "${DIRTY}" acpipowerbutton
sleep 10s
VBoxManage modifyvm "${DIRTY}" --natpf1 delete "ssh"  # Left by Vagrant.
VBoxManage modifyvm "${DIRTY}" --ioapic 'on' # See: https://www.virtualbox.org/manual/ch03.html#settings-motherboard.
VBoxManage modifyvm "${DIRTY}" --cpus 1 --cpuexecutioncap 75 --memory 512 --vram 32 --audio none
VBoxManage modifyvm "${DIRTY}" --nic1 nat --natnet1 '10.10.0.0/24' --nic2 null --nic3 null --nic4 null --nic5 null --nic6 null --nic7 null --nic8 null
VBoxManage setextradata "${DIRTY}" 'VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled' 1  # Don't spoil tests with time synchronzation.
VBoxManage modifyvm "${DIRTY}" --name "${COMPLETE}"  # Rename if everythin is correct.
VBoxManage snapshot "${COMPLETE}" take "template"
