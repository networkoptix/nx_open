# -*- mode: ruby -*-
# vi: set ft=ruby :

# This file is generated from {{ template_file_path }}. Don't edit manually, your changes may be lost!


Vagrant.configure("2") do |config|

  config.vm.box = "ubuntu/trusty64"
  config.ssh.forward_agent = true
  config.ssh.insert_key = false

  config.vm.provider :virtualbox do |vb|
    vb.memory = 512
    vb.cpus = 1
    vb.customize [:modifyvm, :id, "--cpuexecutioncap", "75"]
    vb.customize [:modifyvm, :id, "--ioapic", "on"]
    vb.customize [:modifyvm, :id, "--vram", "32"]

    # First adapter is of NAT type. That is required for Vagrant and port forwarding.
    # Default network created by VirtualBox is overridden to avoid IP addresses collision.
    vb.customize [:modifyvm, :id, "--natnet1", "10.10.0.0/24"]

    # All other slots are unconnected adapters (not empty!) to connect them when networks when VM is running.
    vb.customize [:modifyvm, :id, "--nic2", "null"]
    vb.customize [:modifyvm, :id, "--nic3", "null"]
    vb.customize [:modifyvm, :id, "--nic4", "null"]
    vb.customize [:modifyvm, :id, "--nic5", "null"]
    vb.customize [:modifyvm, :id, "--nic6", "null"]
    vb.customize [:modifyvm, :id, "--nic7", "null"]
    vb.customize [:modifyvm, :id, "--nic8", "null"]

    # Time synchronization is disabled to test time synchronization in mediaservers.
    vb.customize [:setextradata, :id, "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled", 1]
  end


  {% for vm in vms -%}

  config.vm.define "{{ vm.vagrant_name }}" do |node|

    node.vm.provider :virtualbox do |vb|
      vb.name = "{{ vm.virtualbox_name }}"

      {%- for command in vm.virtualbox_conf %}

      vb.{{ command }}

      {%- endfor %}
    end

    node.vm.hostname = "{{ vm.vagrant_name }}"
    node.vm.network :forwarded_port, guest: 22, host: {{ vm.ssh_forwarded_port }},  host_ip: "0.0.0.0", id: "ssh"
    node.vm.network :forwarded_port, guest: {{ vm.rest_api_internal_port }}, host: {{ vm.rest_api_forwarded_port }}

    {% for command in vm.vagrant_conf -%}

    node.{{ command }}

    {% endfor %}
  
  end

  {% endfor %}

end
