## Copyright 2018-present Network Optix, Inc. Licensed under MPL 2.0: www.mozilla.org/MPL/2.0/

# ==============================================================================
# FIX START: Aggressive Removal of Legacy 'AGL' Framework
# ==============================================================================

if(APPLE)
    function(force_clean_agl target_name)
        if(TARGET ${target_name})
            # 1. Clean INTERFACE_LINK_LIBRARIES
            get_target_property(_libs ${target_name} INTERFACE_LINK_LIBRARIES)
            if(_libs)
                # Remove string variant "-framework AGL"
                string(REPLACE "-framework AGL" "" _libs "${_libs}")
                # Remove list variant "-framework;AGL"
                string(REPLACE "-framework;AGL" "" _libs "${_libs}")
                # Remove bare "AGL" just in case
                list(REMOVE_ITEM _libs "AGL")

                set_target_properties(${target_name} PROPERTIES INTERFACE_LINK_LIBRARIES "${_libs}")
            endif()

            # 2. Clean INTERFACE_LINK_OPTIONS (sometimes flags hide here)
            get_target_property(_opts ${target_name} INTERFACE_LINK_OPTIONS)
            if(_opts)
                string(REPLACE "-framework AGL" "" _opts "${_opts}")
                string(REPLACE "-framework;AGL" "" _opts "${_opts}")
                set_target_properties(${target_name} PROPERTIES INTERFACE_LINK_OPTIONS "${_opts}")
            endif()

            message(STATUS "AGL CLEANUP: Scanned ${target_name}")
        endif()
    endfunction()

    # Apply cleanup to known suspects
    force_clean_agl(WrapOpenGL::WrapOpenGL)
    force_clean_agl(ffmpeg::avdevice)
    force_clean_agl(Qt6::Gui)
    force_clean_agl(ffmpeg::ffmpeg)

    # NUCLEAR OVERRIDE:
    # WrapOpenGL is the most likely offender generated by CMake/Conan.
    # We overwrite its properties to strictly use modern frameworks (OpenGL + AppKit).
    if(TARGET WrapOpenGL::WrapOpenGL)
        message(STATUS "AGL CLEANUP: Force-overwriting WrapOpenGL properties.")
        set_target_properties(WrapOpenGL::WrapOpenGL PROPERTIES
            INTERFACE_LINK_LIBRARIES "-framework OpenGL;-framework AppKit"
            IMPORTED_LINK_INTERFACE_LIBRARIES "-framework OpenGL;-framework AppKit"
            IMPORTED_LINK_INTERFACE_LIBRARIES_RELEASE "-framework OpenGL;-framework AppKit"
            IMPORTED_LINK_INTERFACE_LIBRARIES_DEBUG "-framework OpenGL;-framework AppKit"
        )
    endif()
endif()

# ==============================================================================
# FIX END
# ==============================================================================

nx_add_target(nx_media_core LIBRARY
    PUBLIC_LIBS
        Qt6::Core
        nx_utils
        nx_codec
        nx_metric
        nx_reflect
        nx_fusion
        ffmpeg::ffmpeg
    PRIVATE_LIBS
        Qt6::Gui
    FOLDER common/libs
)

target_compile_definitions(nx_media_core
    PRIVATE NX_MEDIA_CORE_API=${API_EXPORT_MACRO}
    INTERFACE NX_MEDIA_CORE_API=${API_IMPORT_MACRO}
)

if("${arch}" STREQUAL "arm" OR "${arch}" STREQUAL "arm64")
    find_package(sse2neon)
    target_link_libraries(nx_media_core PUBLIC sse2neon::sse2neon)
endif()

target_include_directories(nx_media_core
    PRIVATE
        ${Qt6Core_PRIVATE_INCLUDE_DIRS}
)

if(withTests)
    add_subdirectory(unit_tests)
endif()
