<div class="modal-header">
    <h1 class="modal-title" translate>Merge Systems</h1>
    <button type="button" class="close"
            data-dismiss="modal" aria-label="Close"
            (click)="activeModal.close()" *ngIf="closable">
        <div class="close-content"><span class="close-icon"></span></div>
    </button>
</div>

<div *ngIf="!multipleSystems || outOfDate">
    <div class="modal-body">
        <div *ngIf="!multipleSystems">
            <p class="help-block-no-height" translate>
                You can merge only those cloud Systems, where you have the "Owner" permissions.
            </p>
            <p class="help-block-no-height" translate>
                Connect System you want to merge with this one to %PRODUCT_NAME% or merge locally using %VMS_NAME% Client.
            </p>
        </div>
        <div *ngIf="outOfDate">
            <p class="help-block-no-height" translate>
                Some of your servers don't support cloud System merge because of outdated software version.
            </p>
            <p class="help-block-no-height" translate>
                Update them to the <a [href]="latestBuildUrl" target="_blank" translate>latest build</a>
            </p>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button"
                class="btn btn-primary wide-button" (click)="activeModal.close()">
            {{ 'Ok' | translate}}
        </button>
    </div>
</div>

<form *ngIf="showMergeForm" #mergeForm="ngForm" name="mergeForm" novalidate>
    <div *ngIf="state == 'select'">
        <div class="modal-body">
            <div class="form-group">
                <label for="system" translate>Merge current System with</label>
                <nx-select [items]="systemsSelect" [selected]="targetSystem" (onSelected)="setTargetSystem($event)"></nx-select>
            </div>
            <p *ngIf="systemMergeable =='offline'"
               class="help-block-no-height warning-label" translate>
                <span translate>System</span><span>&nbsp;"{{targetSystem.info.name}}"&nbsp;</span>
                <span translate>is offline and cannot be merged with the current one.</span>
            </p>
            <p *ngIf="systemMergeable =='cannotMerge'"
               class="help-block-no-height warning-label" translate>
                <span translate>System</span><span>&nbsp;"{{targetSystem.info.name}}"&nbsp;</span>
                <span translate>is incompatible and cannot be merged with the current one.</span>
            </p>
            <p *ngIf="systemMergeable == undefined || systemMergeable == ''"
               class="help-block-no-height" translate>You can only merge Systems in which you have owner permissions.</p>
            <div *ngIf="targetSystem.id">
                <div [ngClass]="{'text-muted': systemMergeable != ''}" translate>Took System name and settings from</div>
                <div>
                    <div class="radio-group">
                        <label class="option">
                            <input type="radio"
                                   name="firstSystem" id="firstSystem"
                                   [(ngModel)]="masterId"
                                   [value]="system.id"
                                   [checked]="system.id == masterId"
                                   [disabled]="systemMergeable != ''">
                            <span class="optionmark">
                                <svg viewBox="0 0 20 16">
                                    <path class="circle" d="M8,2c3.3,0,6,2.7,6,6s-2.7,6-6,6s-6-2.7-6-6S4.7,2,8,2 M8,1C4.1,1,1,4.1,1,8s3.1,7,7,7s7-3.1,7-7S11.9,1,8,1L8,1z"></path>
                                    <circle cx="8" cy="8" r="4"></circle>
                                </svg>
                            </span>
                            <span [innerHtml]="system.info.name"></span>
                        </label>
                    </div>
                    <div class="radio-group">
                        <label class="option">
                            <input type="radio"
                                   name="secondSystem" id="secondSystem"
                                   [(ngModel)]="masterId"
                                   [value]="targetSystem.id"
                                   [checked]="targetSystem.id == masterId"
                                   [disabled]="systemMergeable != ''">
                            <span class="optionmark">
                                <svg viewBox="0 0 20 16">
                                    <path class="circle" d="M8,2c3.3,0,6,2.7,6,6s-2.7,6-6,6s-6-2.7-6-6S4.7,2,8,2 M8,1C4.1,1,1,4.1,1,8s3.1,7,7,7s7-3.1,7-7S11.9,1,8,1L8,1z"></path>
                                    <circle cx="8" cy="8" r="4"></circle>
                                </svg>
                            </span>
                            <span *ngIf="targetSystem.info" [innerHtml]="targetSystem.info.name"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default"
                    [disabled]="systemMergeable != '' || !targetSystem.id"
                    (click)="updateState()" translate>Ok</button>
            <button class="btn btn-default" (click)="activeModal.close()" translate>Cancel</button>
        </div>
    </div>
    <div *ngIf="state == 'warning'">
        <div class="modal-body">
            <p>
                <span translate>There will be more than</span>
                &nbsp;{{ config.maxServers }}&nbsp;
                <span translate>servers in the merged System.</span>
            </p>
            <p translate>Systems of such size may work but will be unstable and have troubles with updates and synchronisation.</p>
            <p translate>We'd recommend consulting with <a [href]="config.supportLink" target="_blank">support</a> before proceeding.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" (click)="updateState()" translate>Merge Anyway</button>
            <button class="btn btn-default" (click)="activeModal.close()" translate>Cancel</button>
        </div>
    </div>
    <div *ngIf="state == 'confirm'">
        <div class="modal-body">
            <p translate class="mb-3">Enter password to your account.</p>

            <div class="form-group">
                <label for="password" translate>Password</label>
                <input class="form-control"
                       [(ngModel)]="password" #mergePassword="ngModel"
                       id="password" autocomplete="new-password"
                       name="password" type="password"
                       required nxFocusMe>
                <div *ngIf="mergePassword.invalid && mergePassword.touched && !wrongPassword">
                    <label class="input-error" translate>Password is required</label>
                </div>
                <div *ngIf="mergePassword.invalid && wrongPassword">
                    <label class="input-error" translate>Wrong password</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <nx-process-button [buttonDisabled]="mergePassword.invalid"
                               [process]="merging"
                               [form]="mergeForm"
                               actionType="primary"
                               buttonText="{{ 'Merge' | translate}}"></nx-process-button>
            <button class="btn btn-default" (click)="activeModal.close()" translate>Cancel</button>
        </div>
    </div>
</form>
