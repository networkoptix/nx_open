{% extends "admin/base_site.html" %}
{% load i18n admin_urls admin_static %}
{% load static %}

{% block extrahead %}
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}"/>
    {{ block.super }}
{% endblock %}

{% block content%}
<div>
    <p><a href="{% url 'download_package' product.id %}" download>Download package (zip)</a></p>
    <p><a href="{% url 'download_package' product.id %}?draft" download>Download package draft (zip)</a></p>
</div>
<form id="productForm" action="{% url 'product_settings' product.id %}"
      method="post" class="aligned" enctype="multipart/form-data">
    {% csrf_token %}
    {% for field in form %}
        <div class="form-row">
            {{ field.label_tag }}
            <div id="{{field.label}}" style="display:inline-block;">
                {{ field }}
                
                {% if field.help_text %}
                <p class="help">{{ field.help_text|safe }}</p>
                {% endif %}
            </div>
        </div>
    {% endfor %}

    <div class="submit-row">
        <button class="btn btn-sm btn-primary" type="submit" name="Upload" onclick="cookieInterval()">Upload</button>
    </div>
    <script>
        /*
            The checkCookie function starts on a 100ms interval once the user uploads a file.
            Once the user submits the file we wait for the structure.json file to be returned.
            When the file is sent to the user it also sets a cookie.
            The check cookie function keeps checking the cookies until it a changed.
            Afterwards it reloads the page so that the user can see any error messages with the file upload
         */
        var checkCookie = function () {
            var lastCookie = document.cookie;
            return function () {
                var currentCookie = document.cookie;
                if (currentCookie != lastCookie) {
                    window.location.reload()
                }
            };
        }();
        function cookieInterval() {
            window.setInterval(checkCookie, 100);
        }
    </script>

</form>
{% endblock%}
