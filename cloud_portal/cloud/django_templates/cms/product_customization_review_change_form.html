{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}
{% load cms_filters %}
{% block content %}
    {% get_product_type original.version.product as product_type %}
    {% with can_preview=original.version.product.product_type.can_preview version=original.version product=original.version.product %}
    <div id="alert" style="display:none" class="alert alert-warning"
         title="Preview being generated">Currently making the preview for you. A new tab
        will open shortly.
    </div>
    <div id="alert-error" style="display:none" class="alert alert-error"
         title="Error generating preview">There was an error making the preview
    </div>
    <div class="module custom-block">
        {% if customization_reviews %}
        <div style="margin-bottom: 20px;">
            <h2>Review Status {% if product_type != 'Cloud Portal' %}for each customization{% endif %}</h2>
            <div class="table-responsive">
                <table class="table table-condensed">
                    <thead>
                        <tr>
                            {% if product_type != 'Cloud Portal' %}<td><strong>Customization</strong></td>{% endif %}
                            <td><strong>Status</strong></td>
                            <td><strong>Last reviewed by</strong></td>
                            <td><strong>Last checked on</strong></td>
                            <td><strong>Review Notes</strong></td>
                        </tr>
                    </thead>
                    <tbody>
                    {% for review in customization_reviews %}
                        {% get_review_state review.state as state %}
                        <tr>
                            {% if product_type != 'Cloud Portal' %}<td> {{ review.customization }} </td>{% endif %}
                            <td> {{ state }} </td>
                            <td> {{ review.reviewed_by }}</td>
                            <td> {{ review.reviewed_date }}</td>
                            <td> {{ review.notes }} </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% if contexts %}
        <div>
            <h2>Change list</h2>
            <ul>
            {% for context_name, records in contexts.items %}
                <li>
                    <div>
                        {% with context_url=records.0.data_structure.context.url %}
                            {{ context_name }}
                            {% if context_url and can_preview and version.state == 'in review'%}
                                <a class="float-right preview" href="{% url 'preview' %}"
                                   value="{{records.0.data_structure.context.id}}"
                                   target="_blank">Preview</a>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <ul>
                    {% for record in records %}
                        {% with data_structure=record.data_structure language=record.language %}
                        <li>
                            {% get_datastructure_type data_structure as data_structure_type %}
                            {% if data_structure.label %}
                                {{ data_structure.label }}:
                            {% else %}
                                {{ data_structure.name }}
                            {% endif %}

                            {% if language %}
                                ({{ language.code }})
                            {% endif %}

                            {% if data_structure_type == "Image" %}
                                <div><img class="preview-image review-preview" src="data:image/png;base64,{{ record }}"></div>
                            {% elif data_structure_type == "File" %}
                                <a href="{% url 'download_file' data_structure.name %}?version_id={{ version.id }}&lang={{ language.code }}&draft"
                                   download>Download</a>
                            {% else %}
                                <div class="show-html">{{ record|safe }}</div>
                            {% endif %}
                            {% if product_type == "Cloud Portal" %}
                                <a
                                {% if language %}
                                    href="{% url 'page_editor' data_structure.context.id language.code %}"
                                {% else %}
                                    href="{% url 'page_editor' data_structure.context.id %}"
                                {% endif %}
                                    target="_blank">(edit)</a>
                            {% endif %}
                        </li>
                        {% endwith %}
                    {% endfor %}
                    </ul>
                </li>
            {% endfor %}
            </ul>
        </div>
        {% else %}
        <div>There are no changes to review</div>
        {% endif %}
        <h2>Review</h2>
    </div>
    <form target="" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <input name="version_id" value="{{ version.id }}" hidden/>
        <input name="review_id" value="{{ original.id }}" hidden/>
        {% block field_sets %}
            {% for fieldset in adminform %}
                {% include "admin/includes/fieldset.html" %}
            {% endfor %}
        {% endblock %}

        {% get_review_state original.state as state %}
        {% if state == 'Pending' or state != 'Rejected' and can_preview and perms.cms.force_update %}
            <div class="submit-row">
                {% if state == 'Accepted' %}
                <button class="btn btn-sm btn-danger" type="submit" name="force_update">Force Update</button>
                {% endif %}
                {% if state == 'Pending' %}
                    {% if product and False %}
                    <button class="btn btn-sm btn-default">
                        <a href="{% url 'download_package' product.id %}?version_id={{ version.id }}"
                           download>Download</a>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-danger" type="submit" name="reject">Reject</button>
                    <button class="btn btn-sm btn-default" type="submit" name="ask_question">Ask a question</button>
                    {% if perms.cms.publish_version %}
                    <button class="btn btn-sm btn-success" type="submit" name="publish">
                            {% if can_preview %}Publish{% else %} Accept {% endif %}
                    </button>
                {% endif %}
            {% endif %}
            </div>
        {% endif %}
    </form>
    <script>
        $(function() {
            var previews = $('.preview');
            var csrf = $('input[name=csrfmiddlewaretoken]')[0];
            for ( var i = 0; i < previews.length; ++i){
                $(previews[i]).click(function(event){
                    event.preventDefault();
                    var posting = $.post(this.href, {
                        'version_id': {{version.id}},
                        'csrfmiddlewaretoken': csrf.value,
                        'context_id': $(this).attr('value')
                    });

                    $("#alert-error").css({display: 'none'});
                    $("#alert").css({display: 'block'});
                    posting.done(function(data){
                        $("#alert").css({display: 'none'});
                        window.open(data, '_blank');
                    });
                    posting.fail(function(){
                        $("#alert-error").css({display: 'block'});
                        alert("Error creating the preview");
                    })
                })
            }
        });
    </script>
    {% endwith %}
{% endblock %}
