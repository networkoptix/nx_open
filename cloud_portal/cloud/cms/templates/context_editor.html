{% extends "admin/base_site.html" %}
{% load i18n admin_urls admin_static %}
{% load static %}
{% load cms_filters %}

{% block extrahead %}
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <script src="{% static 'tiny_mce/tiny_mce.js' %}"></script>
{% endblock %}

{% block extrastyle %}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}"/>
    {{ block.super }}
{% endblock %}

{% block content%}
<fieldset>
    <div>{{ context.description }}</div>
    {% if context.url %}
    <div> Link to Page: <a href="{{context.url}}">{{ context.url }}</a></div>
    {% endif %}
</fieldset>

<form id="contextForm" action="{% url 'page_editor' context.id %}" method="post" class="aligned" enctype="multipart/form-data">
    <input type="hidden" name="currentLanguage" value="{{ language.code }}">
    <input type="hidden" id="languageChanged">
    {% csrf_token %}
    {% for field in form %}
        <div class="form-row">
            {% is_optional field.name context as optional %}
            {% has_value field.name context customization language as record_exists %}
            {% if not optional and not record_exists %}
            <label class="text-danger" for="id_{{ field.name }}">{{ field.label }}</label>
            {% else %}
            <label for="id_{{ field.name }}">{{ field.label }}</label>
            {% endif %}
            <div id="{{field.name}}" style="display:inline-block;">
                {% if field|is_ImageField and field.value %}
                    <div>
                        {% if optional and record_exists %}
                        <label><input id="delete_{{field.name}}" type="checkbox"
                                      name="delete_{{field.name}}" value="false"/>&nbsp;Clear Value</label>
                        <br><br>
                        {% endif %}

                        {%if optional and not record_exists %}
                        <img class="preview-image context-preview optional-image"
                             src="data:image/png;base64,{{field.value}}">
                        {% else %}
                        <img class="preview-image context-preview"
                             src="data:image/png;base64,{{field.value}}">
                        {% endif %}
                    </div>

                {% elif field|is_FileField and field.value %}
                    <div>
                        {% if optional and record_exists %}
                        <label><input id="delete_{{field.name}}" type="checkbox" name="delete_{{field.name}}" value="false"/>&nbsp;Clear Value</label>
                        {% endif %}

                        <a href="{% url 'download_file' field.name %}?lang={{language.code}}&draft" download>
                        {% if optional and not record_exists %}
                        Download Example
                        {% else %}
                        Download
                        {% endif %}
                        </a>
                    </div>
                {% endif %}
                {{ field }}
                
                {% if field.help_text %}
                <p class="help">{{ field.help_text|safe }}</p>
                {% endif %}
            </div>
        </div>
    {% endfor %}

    {% if perms.cms.edit_content %}
    <div class="submit-row">
        {% if preview_link %}
        <button class='btn btn-sm btn-default pull-left' onClick="openPreview()">Open Preview</button>
        {% endif %}
        {% if user.is_superuser and context.file_path%}
        <button class="btn btn-sm btn-default">
            <a href="{% url 'download_file' context.file_path %}?lang={{language.code}}&draft"
               download>Download Draft</a>
        </button>
        {% endif %}
        <button class="btn btn-sm btn-default" type="submit" name="Preview">Save and Preview</button>
        <button class="btn btn-sm btn-info" type="submit" name="SaveDraft">Save Draft</button>
        <button class="btn btn-sm btn-success" type="submit" name="SendReview">Send for Review</button>
        <button class="btn btn-sm btn-danger" type="reset"  name="Reset">Reset</button>
    </div>
    {% endif %}

</form>

<!--{% if image %}
<div> <img src="data:image/png;base64,{{image}}"> </div>
{% endif %}-->
<script>
    function openPreview(){
        window.open("{{ preview_link }}");
    }

    function wasTouched(){
        var inputs = document.getElementsByTagName('input');
        var textareas = document.getElementsByTagName('textarea');
        var htmlEditors = tinymce.editors;

        for(i=0;i<inputs.length;++i){
            if(inputs[i].defaultValue != inputs[i].value){
                return true;
            }
        }

        for (i=0;i<textareas.length;++i){
            if(textareas[i].defaultValue != textareas[i].value){
                return true;
            }
        }

        for (i=0;i<htmlEditors.length;++i){
            if(htmlEditors[i].startContent != htmlEditors[i].getContent()){
                return true;
            }
        }
        return false;
    }
    function languageChanged(){
        if(wasTouched() && confirm('Do you want to save changes?')){
            document.getElementById('languageChanged').name = "languageChanged";
        }
        document.getElementById('contextForm').submit();
    }


    var langSelector = document.getElementById('id_language');
    if(langSelector){
        langSelector.addEventListener('change', languageChanged, false);
    }

    tinymce.init({
        selector: '.tinymce',
        menubar: false,
        resize: 'both',
        theme:'advanced',
        plugins: 'preview,-visualblocks,-advcode,paste',
        theme_advanced_buttons1: 'undo,redo,separator,formatselect,insert,bold,italic,underline,separator,bullist,numlist,separator,outdent,indent,separator,code,removeformat,pasteword',
        theme_advanced_toolbar_location: 'top',
        theme_advanced_toolbar_align: 'left',
        theme_advanced_resizing: true
    });
</script>
{% endblock%}
