{% extends "admin/base_site.html" %}
{% load i18n admin_urls admin_static %}
{% load static %}

{% block extrahead %}
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}"/>
{% endblock %}

{% block content %}
<h1>Changes in Version {{ version.id }}</h1>
<div class="module">
	<div class="results">
	{% for context_name, records in contexts.items %}
		<h2>{{ context_name }} for {{ records.0.data_structure.context.product.name }}</h2>
		<fieldset>
		    <p>{{ records.0.data_structure.context.description }}</p>
		    {% if records.0.data_structure.context.translatable %}
		    <p>Page can be translated</p>
		    {% endif %}
		    {% if records.0.data_structure.context.url %}
		    <p> Link to Page: <a href="{{ records.0.data_structure.context.url }}">{{ records.0.data_structure.context.url }}</a></p>
		    {% endif %}
		</fieldset>
		<table style="width: 100%">
			<thead>
				<th style="width: 70px;"></th>
				<th>Language</th>
				<th>Field</th>
				<th>Value</th>
			</thead>
			<tbody>
				{% for record in records%}
				<tr>
					<td>
						{% if record.language %}
						<button class="btn btn-sm btn-info"><a
						   href="{% url 'page_editor' record.data_structure.context.id record.language.code %}">
						   Edit Record
						</a></button>
						{% else %}
						<button class="btn btn-sm btn-info"><a href="{% url 'page_editor' record.data_structure.context.id %}">
						   Edit Record
						</a></button>
						{% endif %}
					</td>
					<td>{{ record.language.code }}</td>
					<td>{{ record.data_structure.name }}</td>
					<td>
					{% if record.data_structure.type == 1 %}
						<img class="preview-image review-preview" src="data:image/png;base64,{{record}}">
					{% elif record.data_structure.type == 0 %}
						{{record}}
					{% elif record.data_structure.type == 4 %}
						<a href="{% url 'download_file' record.data_structure.name %}?version_id={{version.id}}&lang={{record.language.code}}&draft" download>Download</a>
					{% else %}
						<div style="overflow-y: scroll; max-height: 350px; padding: 5px; border: 1px solid silver">{{record|safe}}</div>
					{% endif %}
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
		<br>
		<br>
	{% endfor %}
	</div>
</div>
<form action="{% url 'version_action' version.id %}" method="post">
	{% csrf_token %}
	{% if not version.accepted_date or product.can_preview %}
	<div class="submit-row">
		{% if perms.cms.force_update and version.state == 'current' %}
			<button class="btn btn-sm btn-danger pull-left" type="submit" name="Force Update">Force Update</button>
		{% endif %}
		{% if preview_link and product.can_preview %}
			<button class='btn btn-sm btn-info' onClick="openPreview(event)">Open Preview</button>
		{% endif %}
		{% if not version.accepted_date %}
			{% if product.can_preview %}
        	<button class="btn btn-sm btn-primary" type="submit" name="Preview">Generate Preview</button>
			{% else %}
			<button class="btn btn-sm btn-default">
				<a href="{% url 'download_package' product.name %}"download>Download</a>
			</button>
			{% endif %}
			{% if perms.cms.publish_version %}
        	<button class="btn btn-sm btn-danger" type="submit" name="Publish">Publish</button>
			{% endif %}
		{% endif %}
	</div>
	{% endif %}
</form>
{% if preview_link and product.can_preview %}
<script>
    function openPreview(event){
    	event.preventDefault();
        window.open("{{ preview_link }}");
    }
</script>
{% endif %}
{% endblock %}