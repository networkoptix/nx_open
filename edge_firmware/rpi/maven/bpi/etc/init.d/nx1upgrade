#!/bin/bash

# VERSION: ${release.version}.${buildNumber}

## This command will run each time after networkoptix-embedded-tools is installed

export CUSTOMIZATION=${deb.customization.company.name}
export DATAPART=/dev/mmcblk0p2
export MNTDATAPART=/mnt/data
export BOOTPART=/dev/mmcblk0p1
export MNTBOOTPART=/mnt/boot

mkdir -p $MNTDATAPART
mount -t ext4 $DATAPART $MNTDATAPART
cp -f /opt/$CUSTOMIZATION/mediaserver/var/ecs_static.sqlite /root/tools/nx/ecs_static.sqlite
rm -Rf $MNTDATAPART/opt/$CUSTOMIZATION
tar xfv /tmp/$DISTRIB.tar.gz -C $MNTDATAPART
mkdir -p $MNTDATAPART/opt/$CUSTOMIZATION/mediaserver/var
cp -f /root/tools/nx/ecs_static.sqlite $MNTDATAPART/opt/$CUSTOMIZATION/mediaserver/var
echo "statisticsReportAllowed=true" >> $MNTDATAPART/opt/$CUSTOMIZATION/mediaserver/etc/mediaserver.conf
umount $DATAPART

mkdir -p $MNTBOOTPART
mount -t vfat $BOOTPART $MNTBOOTPART
cp -f /root/tools/uboot/*.txt $MNTBOOTPART
umount $BOOTPART
rm -Rf $MNTBOOTPART

apt-get update
apt-get install sudo nginx nginx-common nginx-full unzip --fix-missing -y

exit 0