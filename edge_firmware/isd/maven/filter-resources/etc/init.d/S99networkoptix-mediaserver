#!/bin/sh

CUSTOMIZATION=${deb.customization.company.name}

SECONDS_TO_WAIT_BEFORE_KILL_9=120
KILL_IF_HIGH_MEM_USAGE=1

SERVICE_NAME="mediaserver"
MEDIASERVER_DIR="/opt/$CUSTOMIZATION/mediaserver"
BIN_NAME="mediaserver"
BIN_PATH="$MEDIASERVER_DIR/bin/$BIN_NAME"
STORAGE_PATH="/sdcard"
HTTP_LOG_LEVEL="none"
LOGS_PATH="$MEDIASERVER_DIR/var/log"
LOG_OUTPUT_FLAG="$LOGS_PATH/log_output.flag"

export VMS_PLUGIN_DIR="$MEDIASERVER_DIR/plugins"
export SASL_PATH="$MEDIASERVER_DIR/lib/sasl2"

start()
{
    SERVICE_PID=$(pidof "$BIN_NAME")
    if [ ! -z "$SERVICE_PID" ]; then
       echo "$SERVICE_NAME is already running with pid $SERVICE_PID"
       return 0
    fi

    # Make sure that STORAGE_PATH dir exists and is in /proc/mounts.
    if ! grep "$STORAGE_PATH" /proc/mounts >/dev/null 2>&1 || [ ! -d "$STORAGE_PATH" ]; then
        echo "SD card not inserted"
        return 1
    fi

    if ! touch "$STORAGE_PATH" >/dev/null 2>&1; then
        #echo "RO"
        mount -o rw,remount "$STORAGE_PATH"
    fi

    # ATTENTION: The args should not contain spaces.
    local RUN_ARGS="-e --conf-file=$MEDIASERVER_DIR/etc/mediaserver.conf \
        --runtime-conf-file=$MEDIASERVER_DIR/etc/running_time.conf \
        --msg-log-level=$HTTP_LOG_LEVEL"

    if [ -f "$LOG_OUTPUT_FLAG" ]; then
        mkdir -p "$LOGS_PATH"
        REDIRECT_OUTPUT="$LOGS_PATH/mediaserver-out.log"
    else
        REDIRECT_OUTPUT="/dev/null"
    fi

    echo "Starting Media Server, outputting to $REDIRECT_OUTPUT, with command:"
    echo "    $BIN_PATH $RUN_ARGS"
    "$BIN_PATH" $RUN_ARGS >>"$REDIRECT_OUTPUT" 2>&1 &

    sleep 1
    # See if server instantly crashes.
    if [ $(pidof "$BIN_NAME") ]; then
        echo "OK"
    else
        echo "FAILED"
        return 1
    fi
}

startquiet()
{
    start
}

stop()
{
    echo "Stopping $BIN_NAME..."
    /usr/bin/killall "$1" "$BIN_NAME" >/dev/null
    local i=0
    while [ $(pidof "$BIN_NAME") ]
    do
        /bin/sleep 1
        let i++
        if [ $i -gt $SECONDS_TO_WAIT_BEFORE_KILL_9 ]; then
            echo -n "sending 9 signal...    "
            /usr/bin/killall -9 "$BIN_NAME" >/dev/null 2>&1
        fi
    done
    echo "DONE"
}

start_watchdog()
{
    WATCHDOG_PID=$(pgrep -f -- "-c $0")
    if [ ! -z "$WATCHDOG_PID" ]; then
        echo "$CUSTOMIZATION-mediaserver watchdog is already running with pid $WATCHDOG_PID"
        return 0
    fi

    /bin/sh -c "$0 run_watchdog" >/dev/null 2>&1 &
    echo "$SERVICE_NAME watchdog has been started"
}

stop_watchdog()
{
    WATCHDOG_PID=$(pgrep -f -- "-c $0")
    if [ -z "$WATCHDOG_PID" ]; then
        echo "$CUSTOMIZATION-mediaserver watchdog is not running"
        return 0
    fi

    echo "Stopping $CUSTOMIZATION-mediaserver watchdog..."
    kill "$WATCHDOG_PID"
    sleep 1
    echo "OK"
}

kill_ms_if_high_mem_usage()
{
    MSERVER_PID=$(pidof "$BIN_NAME")
    if [ -z "$MSERVER_PID" ]; then
        exit 0
    fi

    MEM_USAGE=$(cat /proc/$MSERVER_PID/status \
        |grep VmRSS |cut -d ":" -f2 |tr -d "\t " |cut -d "k" -f 1)

    if [ "$MEM_USAGE" -gt 89000 ]; then
        kill -FPE "$MSERVER_PID"
    fi
}

run_watchdog()
{
    while true; do
        start
        if [ ! -z "$KILL_IF_HIGH_MEM_USAGE" ]; then
            kill_ms_if_high_mem_usage
        fi
        sleep 20
    done
}

#--------------------------------------------------------------------------------------------------
# main

echo "$STORAGE_PATH/cores/core.%p" >/proc/sys/kernel/core_pattern
if [ ! -e "$STORAGE_PATH/cores" ]; then
    mkdir "$STORAGE_PATH/cores"
fi
ulimit -c unlimited

case "$1" in
    start)
        start && start_watchdog
        ;;
    startquiet)
        start
        ;;
    start_console)
        grep "$STORAGE_PATH" /proc/mounts >/dev/null 2>&1
        if [ $? -ne 0 ] || [ ! -d "$STORAGE_PATH" ]; then
            echo "SD card not inserted"
            return 1
        fi

        "$BIN_PATH" -e \
            "--conf-file=$MEDIASERVER_DIR/etc/mediaserver.conf" "--msg-log-level=$HTTP_LOG_LEVEL"
        ;;
    start_gdb)
        gdbserver 0.0.0.0:12345 "$BIN_PATH" -e \
            "--conf-file=$MEDIASERVER_DIR/etc/mediaserver.conf" "--msg-log-level=$HTTP_LOG_LEVEL"
        ;;
    stop)
        stop_watchdog
        stop
        ;;
    kill)
        stop_watchdog
        stop -9
        ;;
    status)
        SERVICE_PID=$(pidof "$BIN_NAME")
        if [ ! -z "$SERVICE_PID" ]; then
            echo "$SERVICE_NAME is running with pid $SERVICE_PID"
            exit 0
        else
            echo "$SERVICE_NAME is stopped"
            exit 1
        fi
        ;;
    server_status)
        if [ $(pidof "$BIN_NAME") ]; then
            echo "1"
        fi
        ;;
    restart|reload|force-reload)
        stop_watchdog
        stop
        while [ $(pidof "$BIN_NAME") ]; do
            /bin/sleep 1
        done
        start && start_watchdog
        ;;
    start_watchdog)
        start_watchdog
        ;;
    run_watchdog)
        run_watchdog
        ;;
    stop_watchdog)
        stop_watchdog
        ;;
    *)
        echo "Usage: $0 {start|startquiet|stop|restart|status}"
        exit 1
esac
