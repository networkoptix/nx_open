"use strict";function Chunk(a,b,c,d,e,f){this.start=b,this.end=c,this.level=d||0,this.expand=!0;var g="dd.mm.yyyy HH:MM";this.title="undefined"==typeof e||null===e?dateFormat(b,g)+" - "+dateFormat(c,g):e,this.children=[],_.extend(this,f)}function Interval(a,b,c,d,e,f,g){this.seconds=b,this.minutes=c,this.hours=d,this.days=e,this.months=f,this.years=g,this.milliseconds=a}function isDate(a){return a instanceof Date}function CameraRecordsProvider(a,b,c,d,e){this.cameras=a,this.mediaserver=b,this.$q=c,this.chunksTree=null,this.requestedCache=[],this.timeCorrection=e||0;var f=this,g=c.defer();this.archiveReadyPromise=g.promise,this.requestInterval(0,f.now()+1e4,0).then(function(){if(g.resolve(!!f.chunksTree),f.chunksTree){var a=RulerModel.getLevelIndex(f.now()-f.chunksTree.start,d);a<RulerModel.levels.length-1&&f.requestInterval(f.chunksTree.start,f.now(),a+1)}})}function ShortCache(a,b,c,d){this.$q=c,this.mediaserver=b,this.cameras=a,this.start=0,this.played=0,this.playedPosition=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.requestInterval=9e4,this.updateInterval=6e4,this.requestDetailization=1,this.limitChunks=100,this.checkpointsFrequency=6e4,this.timeCorrection=d||0}function ScaleManager(a,b,c,d,e,f){this.absMaxMsPerPixel=b,this.minMsPerPixel=a,this.stickToLiveMs=e,this.zoomAccuracy=f,this.levels={top:{index:0,level:RulerModel.levels[0]},labels:{index:0,level:RulerModel.levels[0]},middle:{index:0,level:RulerModel.levels[0]},small:{index:0,level:RulerModel.levels[0]},marks:{index:0,level:RulerModel.levels[0]},events:{index:0,level:RulerModel.levels[0]}},this.viewportWidth=d,this.end=(new Date).getTime(),this.start=this.end-c,this.updateTotalInterval(),this.msPerPixel=this.maxMsPerPixel,this.anchorPoint=1,this.anchorDate=this.end,this.updateCurrentInterval()}var Config={globalEditServersPermissions:32,globalViewArchivePermission:256,globalViewLivePermission:128,demo:"/~ebalashov/webclient/api",demoMedia:"//10.0.2.186:7001",webclientEnabled:!0,allowDebugMode:!1,debug:{video:!1,videoFormat:"flashls",chunksOnTimeline:!1},helpLinks:[]};angular.module("webadminApp",["ipCookie","ngResource","ngSanitize","ngRoute","ui.bootstrap","tc.chartjs","ngStorage"]).config(["$routeProvider",function(a){a.when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/join",{templateUrl:"views/join.html",controller:"SettingsCtrl"}).when("/info",{templateUrl:"views/info.html",controller:"InfoCtrl"}).when("/developers",{templateUrl:"views/developers.html",controller:"MainCtrl"}).when("/support",{templateUrl:"views/support.html",controller:"MainCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html"}).when("/advanced",{templateUrl:"views/advanced.html",controller:"AdvancedCtrl"}).when("/webclient",{templateUrl:"views/webclient.html",controller:"WebclientCtrl",reloadOnSearch:!1}).when("/view/",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/view/:cameraId",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/sdkeula",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).when("/sdkeula/:sdkFile",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).otherwise({redirectTo:"/settings"})}]),angular.module("webadminApp").run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("webadminApp").factory("mediaserver",["$http","$modal","$q","ipCookie","$log",function(a,b,c,d,e){function f(){return a.get(k+"/api/moduleInformation?showAddresses=true")}function g(a){if(401===a.status){var c=window.self!==window.top;return void(c||null!==p||(p=b.open({templateUrl:"views/login.html",keyboard:!1,backdrop:"static"}),p.result.then(function(){p=null})))}i=null,null===o&&f(!0)["catch"](function(a){o=b.open({templateUrl:"offline_modal",controller:"OfflineCtrl",keyboard:!1,backdrop:"static"}),o.result.then(function(a){o=null})})}function h(a){return a["catch"](g),a}var i=null,j=null,k="";if(location.search.indexOf("proxy=")>0)for(var l=location.search.replace("?","").split("&"),m=0;m<l.length;m++){var n=l[m].split("=");if("proxy"===n[0]){k="/proxy/"+n[1],"demo"==n[1]&&(k=Config.demo);break}}d("Authorization","Digest",{path:"/"});var o=null,p=null;return{url:function(){return k},mediaDemo:function(){return k==Config.demo?Config.demoMedia:!1},logUrl:function(a){return k+"/api/showLog"+(a||"")},authForMedia:function(){return d("auth")},authForRtsp:function(){return d("auth_rtsp")},previewUrl:function(a,b,c,d){return k+"/api/image?physicalId="+a+(c?"&width="+c:"")+(d?"&height="+d:"")+("&time="+(b||"LATEST"))},hasProxy:function(){return""!==k},checkAdmin:function(){var a=c.defer();return this.hasProxy()&&a.resolve(!1),this.getCurrentUser().then(function(b){var c=b.data.reply.isAdmin||b.data.reply.permissions&Config.globalEditServersPermissions;a.resolve(c)}),a.promise},getSettings:function(b){return b=b||k,b===!0?(i=null,f()):""===b?(null===i&&(i=h(f())),i):a.get(b+"/api/moduleInformation?showAddresses=true",{timeout:3e3})},saveSettings:function(b,c){return h(a.post(k+"/api/configure?systemName="+b+"&port="+c))},changePassword:function(b,c){return h(a.post(k+"/api/configure?password="+b+"&oldPassword="+c))},mergeSystems:function(b,c,d,e){return h(a.post(k+"/api/mergeSystems?password="+c+"&currentPassword="+d+"&url="+encodeURIComponent(b)+"&takeRemoteSettings="+!e))},pingSystem:function(b,c){return h(a.post(k+"/api/pingSystem?password="+c+"&url="+encodeURIComponent(b)))},restart:function(){return h(a.post(k+"/api/restart"))},getStorages:function(){return h(a.get(k+"/api/storageSpace"))},saveStorages:function(b){return h(a.post(k+"/ec2/saveStorages",b))},discoveredPeers:function(){return h(a.get(k+"/api/discoveredPeers?showAddresses=true"))},getMediaServer:function(b){return h(a.get(k+"/ec2/getMediaServersEx?id="+b.replace("{","").replace("}","")))},getMediaServers:function(){return h(a.get(k+"/ec2/getMediaServersEx"))},getResourceTypes:function(){return h(a.get(k+"/ec2/getResourceTypes"))},getLayouts:function(){return h(a.get(k+"/ec2/getLayouts"))},getCameras:function(b){return h("undefined"!=typeof b?a.get(k+"/ec2/getCamerasEx?id="+b.replace("{","").replace("}","")):a.get(k+"/ec2/getCamerasEx"))},saveMediaServer:function(b){return h(a.post(k+"/ec2/saveMediaServer",b))},statistics:function(b){return b=b||k,h(a.get(b+"/api/statistics?salt="+(new Date).getTime()))},getCurrentUser:function(b){return(null===j||b)&&(j=h(a.get(k+"/api/getCurrentUser"))),j},getTime:function(){return h(a.get(k+"/api/gettime"))},getRecords:function(b,c,d,e,f,g,i){var j=new Date;return"undefined"==typeof d&&(d=j.getTime()-2592e6),"undefined"==typeof e&&(e=j.getTime()+1e5),"undefined"==typeof f&&(f=(e-d)/1e3),"undefined"==typeof i&&(i=0),"/"!==b&&""!==b&&null!==b&&(b="/proxy/"+b+"/"),k==Config.demo&&(b=k+"/"),h(a.get(b+"ec2/recordedTimePeriods?physicalId="+c+"&startTime="+d+"&endTime="+e+"&detail="+f+"&periodsType="+i+(g?"&limit="+g:"")+"&flat"))}}}]),Chunk.prototype.debug=function(){console.log(new Array(this.level+1).join(" "),this.title,this.level,this.children.length)},Number.isInteger||(Number.isInteger=function(a){return"number"==typeof a&&Math.round(a)===a}),Interval.prototype.addToDate=function(a,b){if(Number.isInteger(a)&&(a=new Date(a)),!isDate(a))return console.error("non date "+typeof a+": "+a),a;"undefined"==typeof b&&(b=1);try{return new Date(a.getFullYear()+b*this.years,a.getMonth()+b*this.months,a.getDate()+b*this.days,a.getHours()+b*this.hours,a.getMinutes()+b*this.minutes,a.getSeconds()+b*this.seconds,a.getMilliseconds()+b*this.milliseconds)}catch(c){throw console.error("date problem",a),c}},Interval.prototype.getMilliseconds=function(){var a=new Date(1971,11,1,0,0,0,0),b=this.addToDate(a);return b.getTime()-a.getTime()},Interval.prototype.alignToPast=function(a){var b=new Date(a);return 0!==this.milliseconds?(b.setMilliseconds(Math.floor(b.getMilliseconds()/this.milliseconds)*this.milliseconds),b):(b.setMilliseconds(0),0!==this.seconds?(b.setSeconds(Math.floor(b.getSeconds()/this.seconds)*this.seconds),b):(b.setSeconds(0),0!==this.minutes?(b.setMinutes(Math.floor(b.getMinutes()/this.minutes)*this.minutes),b):(b.setMinutes(0),0!==this.hours?(b.setHours(Math.floor(b.getHours()/this.hours)*this.hours),b):(b.setHours(0),0!==this.days?(b.setDate(Math.floor(b.getDate()/this.days)*this.days),b):(b.setDate(1),0!==this.months?(b.setMonth(Math.floor(b.getMonth()/this.months)*this.months),b):(b.setMonth(0),b.setYear(Math.floor(b.getFullYear()/this.years)*this.years),b))))))},Interval.prototype.checkDate=function(a){return Number.isInteger(a)&&(a=new Date(a)),isDate(a)?this.alignToPast(a).getTime()===a.getTime():(console.error("checkDate - non date",a),!1)},Interval.prototype.alignToFuture=function(a){return this.alignToPast(this.addToDate(a))};var RulerModel={levels:[{name:"Age",interval:new Interval(0,0,0,0,0,0,100),format:"yyyy",marksW:15,smallW:40,middleW:400,width:4e3,topW:0,topFormat:"yyyy"},{name:"Decade",interval:new Interval(0,0,0,0,0,0,10),format:"yyyy",marksW:15,smallW:40,middleW:400,width:9e3},{name:"Year",format:"yyyy",interval:new Interval(0,0,0,0,0,0,1),marksW:15,smallW:40,middleW:120,width:720,topW:100,topFormat:"yyyy"},{name:"6 Months",interval:new Interval(0,0,0,0,0,6,0),format:"mmmm",marksW:15,smallW:60,middleW:360,width:3600},{name:"3 Months",interval:new Interval(0,0,0,0,0,3,0),format:"mmmm",marksW:15,smallW:60,middleW:1800,width:9e3},{name:"Month",interval:new Interval(0,0,0,0,0,1,0),format:"mmmm",marksW:15,smallW:60,middleW:1e5,width:600,topW:170,topFormat:"mmmm yyyy"},{name:"Day",interval:new Interval(0,0,0,0,1,0,0),format:"dd",marksW:5,smallW:20,middleW:100,width:200,topW:170,topFormat:"d mmmm yyyy",contained:1},{name:"12 hours",interval:new Interval(0,0,0,12,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:200,width:1200},{name:"6 hours",interval:new Interval(0,0,0,6,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:600,width:1800},{name:"3 hours",interval:new Interval(0,0,0,3,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:300,width:900},{name:"Hour",interval:new Interval(0,0,0,1,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:100,width:300},{name:"30 minutes",interval:new Interval(0,0,30,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:300,width:1500},{name:"10 minutes",interval:new Interval(0,0,10,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:500,width:1e3},{name:"5 minutes",interval:new Interval(0,0,5,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:250,width:500},{name:"1 minute",interval:new Interval(0,0,1,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:100,width:300,topW:170,topFormat:"d mmmm yyyy HH:MM"},{name:"30 seconds",interval:new Interval(0,30,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:300,width:1500},{name:"10 seconds",interval:new Interval(0,10,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:500,width:1e3},{name:"5 seconds",interval:new Interval(0,5,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:250,width:1e5},{name:"1 second",interval:new Interval(0,1,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:1e5,width:1e5,topW:200,topFormat:"d mmmm yyyy HH:MM:ss"}],getLevelIndex:function(a,b){b=b||1;var c=_.find(RulerModel.levels,function(c){return c.interval.getMilliseconds()<a/b});return"undefined"!=typeof c?this.levels.indexOf(c):this.levels.length-1},findBestLevelIndex:function(a,b){if(b){for(var c=Math.min(b-1,this.levels.length-1),d=c;d>=0;d--)if(!this.levels[d].interval.checkDate(a))return d+1;return d}for(var d=0;d<this.levels.length;d++)if(this.levels[d].interval.checkDate(a))return d;return this.levels.length-1},findBestLevel:function(a){return this.levels[this.findBestLevelIndex(a)]}};CameraRecordsProvider.prototype.now=function(){return(new Date).getTime()},CameraRecordsProvider.prototype.cacheRequestedInterval=function(a,b,c){for(var d=0;c+1>d;d++)if(d>=this.requestedCache.length)this.requestedCache.push([{start:a,end:b}]);else for(var e=0;e<this.requestedCache[d].length;e++)if(!(this.requestedCache[d][e].end<a)){if(this.requestedCache[d][e].start>b){this.requestedCache[d].splice(e,0,{start:a,end:b});break}this.requestedCache[d][e].start=Math.min(a,this.requestedCache[d][e].start),this.requestedCache[d][e].end=Math.max(b,this.requestedCache[d][e].end);break}},CameraRecordsProvider.prototype.getBlindSpotsInCache=function(a,b,c){if("undefined"==typeof this.requestedCache[c])return[{start:a,end:b}];for(var d=[],e=this.requestedCache[c],f=0;f<e.length&&(a<e[f].start&&d.push({start:a,end:e[f].start}),a=Math.max(a,e[f].end),!(b<e[f].end));f++);return d},CameraRecordsProvider.prototype.checkRequestedIntervalCache=function(a,b,c){if("undefined"==typeof this.requestedCache[c])return!1;for(var d=this.requestedCache[c],e=0;e<d.length;e++){if(a<d[e].start)return!1;if(a=Math.max(a,d[e].end),b<d[e].end)return!0}return a>=b},CameraRecordsProvider.prototype.requestInterval=function(a,b,c){var d=this.$q.defer();this.level=c;var e=RulerModel.levels[c].interval.getMilliseconds(),f=this;return f.lockRequests?d.reject("request in progress"):(f.lockRequests=!0,this.mediaserver.getRecords("/",this.cameras[0],Math.max(a-this.timeCorrection,0),b-this.timeCorrection,e).then(function(e){f.lockRequests=!1;var g=e.data.reply;_.forEach(g,function(a){a.durationMs=parseInt(a.durationMs),a.startTimeMs=parseInt(a.startTimeMs)+f.timeCorrection});var h=g.length;!c&&g.length>0&&(g[0].durationMs=-1,h=1);for(var i=0;h>i;i++){var j=g[i].startTimeMs+g[i].durationMs;g[i].durationMs<0&&(j=(new Date).getTime()+1e5);var k=new Chunk(null,g[i].startTimeMs,j,c);f.addChunk(k,null)}f.cacheRequestedInterval(a,b,c),d.resolve(f.chunksTree)},function(a){d.reject(a)})),this.ready=d.promise,this.ready},CameraRecordsProvider.prototype.getIntervalRecords=function(a,b,c,d){a instanceof Date&&(a=a.getTime()),b instanceof Date&&(b=b.getTime());var e=[];this.selectRecords(e,a,b,c,null,d);var f=!d&&!this.checkRequestedIntervalCache(a,b,c);return f&&this.requestInterval(a,b,c),e},CameraRecordsProvider.prototype.debug=function(a){if(a||console.log("Chunks tree:"+(this.chunksTree?"":"empty")),a=a||this.chunksTree){a.debug();for(var b=0;b<a.children.length;b++)this.debug(a.children[b])}},CameraRecordsProvider.prototype.addChunk=function(a,b){if(null===this.chunksTree||0===a.level)return void(this.chunksTree=a);if(b=b||this.chunksTree,0===b.children.length)return b.level===a.level-1?void b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[0]));for(var c=0;c<b.children.length;c++){var d=b.children[c];if(!(d.end<a.start))return d.end>=a.end&&d.start<=a.start?void(d.level!=a.level&&this.addChunk(a,d)):d.start<a.end?(d.end=Math.max(d.end,a.end),d.start=Math.min(d.start,a.start),void(d.level!=a.level&&this.addChunk(a,d))):void(b.level==a.level-1?b.children.splice(c,0,a):(b.children.splice(c,0,new Chunk(b,a.start,a.end,b.level+1)),this.addChunk(a,b.children[c])))}b.level==a.level-1?b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),this.addChunk(a,b.children[c]))},CameraRecordsProvider.prototype.selectRecords=function(a,b,c,d,e,f){if(e=e||this.chunksTree,e&&!(e.end<=b||e.start>=c)){if(e.level==d)return void a.push(e);if(0==e.children.length)return void a.push(e);for(var g=0;g<e.children.length;g++)this.selectRecords(a,b,c,d,e.children[g]);var h=this.getBlindSpotsInCache(e.start,e.end,e.level+1);for(g=0;g<h.length;g++){var i=h[g];(i.start>=b||i.end<=c)&&a.push(i)}}},ShortCache.prototype.init=function(a){this.liveMode=!1,a||(this.liveMode=!0,a=(new Date).getTime()),this.start=a,this.playedPosition=a,this.played=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.update()},ShortCache.prototype.update=function(a,b){if(!this.updating||a){a=Math.round(a)||Math.round(this.playedPosition),this.updating=!0;var c=this;this.lastRequestDate=a,this.lastRequestPosition=b||this.played,this.mediaserver.getRecords("/",this.cameras[0],Math.max(a-this.timeCorrection,0),(new Date).getTime()+1e5-this.timeCorrection,this.requestDetailization,this.limitChunks).then(function(b){c.updating=!1;var d=b.data.reply;_.forEach(d,function(a){a.durationMs=parseInt(a.durationMs),a.startTimeMs=parseInt(a.startTimeMs)+c.timeCorrection,-1==a.durationMs&&(a.durationMs=(new Date).getTime()-a.startTimeMs)}),d.length>0&&d[0].startTimeMs<a&&(d[0].durationMs+=d[0].startTimeMs-a,d[0].startTimeMs=a),c.currentDetailization=d;for(var e=c.lastRequestDate,f=c.lastRequestPosition,g=0,h=0;h<c.currentDetailization.length;h++)f+=c.currentDetailization[h].durationMs,e=c.currentDetailization[h].startTimeMs+c.currentDetailization[h].durationMs,e-g>c.checkpointsFrequency&&(g=e,c.checkPoints[f]=e);c.setPlayingPosition(c.played)})}},ShortCache.prototype.checkPlayingDate=function(a){if(a<this.start)return!1;if(a>this.lastPlayedDate)return!1;var b;for(var c in this.checkPoints)if(this.checkPoints.hasOwnProperty(c)){if(this.checkPoints[c]>a)break;b=c}return"undefined"==typeof b?a-this.start:b+a-this.checkPoints[c]},ShortCache.prototype.setPlayingPosition=function(a){if(this.played=a,this.playedPosition=0,a<this.lastRequestPosition){var b;for(var c in this.checkPoints){if(c>a)break;b=c}this.playedPosition=b+a-this.checkPoints[b],this.update(this.checkPoints[b],b)}var d=a-this.lastRequestPosition;this.playedPosition=this.lastRequestDate+d;for(var e=0;e<this.currentDetailization.length&&(d-=this.currentDetailization[e].durationMs,this.playedPosition=this.currentDetailization[e].startTimeMs+this.currentDetailization[e].durationMs+d,!(0>=d));e++);return e==this.currentDetailization.length&&(this.updating||(this.playedPosition=(new Date).getTime(),this.liveMode=!0)),!this.liveMode&&this.currentDetailization.length>0&&this.currentDetailization[this.currentDetailization.length-1].durationMs+this.currentDetailization[this.currentDetailization.length-1].startTimeMs<Math.round(this.playedPosition)+this.updateInterval&&this.update(),a>this.lastPlayedPosition&&(this.lastPlayedPosition=a,this.lastPlayedDate=this.playedPosition),this.playedPosition},ScaleManager.prototype.updateTotalInterval=function(){this.maxMsPerPixel=(this.end-this.start)/this.viewportWidth,this.msPerPixel=Math.min(this.msPerPixel,this.maxMsPerPixel)},ScaleManager.prototype.setViewportWidth=function(a){this.viewportWidth=a,this.updateTotalInterval(),this.updateCurrentInterval()},ScaleManager.prototype.setStart=function(a){this.start=a,this.updateTotalInterval()},ScaleManager.prototype.setEnd=function(a){this.end=a;var b=this.fullZoomOutValue()-this.zoom()<this.zoomAccuracy;this.updateTotalInterval(),b&&this.zoom(1)},ScaleManager.prototype.bound=function(a,b,c){return b=Math.max(b,a),Math.min(b,c)},ScaleManager.prototype.updateCurrentInterval=function(){this.msPerPixel=this.bound(this.minMsPerPixel,this.msPerPixel,this.maxMsPerPixel),this.anchorPoint=this.bound(0,this.anchorPoint,1),this.anchorDate=this.bound(this.start,Math.round(this.anchorDate),this.end),this.visibleStart=Math.round(this.anchorDate-this.msPerPixel*this.viewportWidth*this.anchorPoint),this.visibleEnd=Math.round(this.anchorDate+this.msPerPixel*this.viewportWidth*(1-this.anchorPoint)),this.visibleStart<this.start&&(this.visibleEnd+=this.start-this.visibleStart,this.visibleStart=this.start),this.visibleEnd>this.end&&(this.visibleStart+=this.end-this.visibleEnd,this.visibleEnd=this.end),this.visibleStart>this.visibleEnd&&console.error("wtf! visibleStart > visibleEnd ?",new Date(this.visibleStart),new Date(this.visibleEnd)),this.updateLevels()},ScaleManager.prototype.stopWatching=function(){this.watchPlayingPosition=!1,this.wasForcedToStopWatchPlaying=!0},ScaleManager.prototype.releaseWatching=function(){this.wasForcedToStopWatchPlaying=!1},ScaleManager.prototype.watchPlaying=function(a){if(this.watchPlayingPosition=!0,this.wasForcedToStopWatchPlaying=!1,a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>1&&(b=.5),this.setAnchorDateAndPoint(a,b)}},ScaleManager.prototype.checkWatchPlaying=function(a,b){var c=this.dateToScreenCoordinate(a)/this.viewportWidth;this.anchorDate==a&&this.watchPlaying(a),c>=0&&1>=c&&this.watchPlaying(a),b&&c>1&&this.end-this.visibleEnd<this.stickToLiveMs&&this.watchPlaying(a)},ScaleManager.prototype.tryToSetLiveDate=function(a,b){this.anchorDate!=a&&(a>this.end&&this.setEnd(a),this.wasForcedToStopWatchPlaying||this.watchPlayingPosition||this.checkWatchPlaying(a,b),this.watchPlayingPosition&&this.setAnchorDateAndPoint(a,b?1:this.anchorPoint))},ScaleManager.prototype.tryToRestoreAnchorDate=function(a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>=0&&1>=b&&(this.anchorDate=a,this.anchorPoint=b)},ScaleManager.prototype.setAnchorCoordinate=function(a){this.setAnchorDateAndPoint(this.screenCoordinateToDate(a),a/this.viewportWidth)},ScaleManager.prototype.setAnchorDateAndPoint=function(a,b){this.anchorDate=a,"undefined"!=typeof b&&(this.anchorPoint=b),this.updateCurrentInterval()},ScaleManager.prototype.fullZoomOutValue=function(){return this.msToZoom(this.maxMsPerPixel)},ScaleManager.prototype.fullZoomInValue=function(){return this.msToZoom(this.minMsPerPixel)},ScaleManager.prototype.boundZoom=function(a){return this.bound(this.fullZoomInValue(),a,this.fullZoomOutValue())},ScaleManager.prototype.calcLevels=function(a){for(var b=RulerModel.levels[0],c={top:{index:0,level:b},labels:{index:0,level:b},middle:{index:0,level:b},small:{index:0,level:b},marks:{index:0,level:b},events:{index:0,level:b}},d=0;d<RulerModel.levels.length;d++){var e=RulerModel.levels[d],f=e.interval.getMilliseconds()/a;if("undefined"!=typeof e.topW&&f>=e.topW&&(c.top={index:d,level:e}),f>=e.width&&(c.labels={index:d,level:e}),f>=e.middleW&&(c.middle={index:d,level:e}),f>=e.smallW&&(c.small={index:d,level:e}),f>=e.marksW&&(c.marks={index:d,level:e}),c.events={index:d,level:e},1>=f)break}return c},ScaleManager.prototype.updateLevels=function(){this.levels=this.calcLevels(this.msPerPixel)},ScaleManager.prototype.alignStart=function(a){return a.interval.alignToPast(this.visibleStart)},ScaleManager.prototype.alignEnd=function(a){return a.interval.alignToFuture(this.visibleEnd)},ScaleManager.prototype.dateToScreenCoordinate=function(a){return Math.round(this.viewportWidth*(a-this.visibleStart)/(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.screenCoordinateToDate=function(a){return Math.round(this.visibleStart+a/this.viewportWidth*(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.getRelativeCenter=function(){return((this.visibleStart+this.visibleEnd)/2-this.start)/(this.end-this.start)},ScaleManager.prototype.getRelativeWidth=function(){return(this.visibleEnd-this.visibleStart)/(this.end-this.start)},ScaleManager.prototype.scroll=function(a){if("undefined"==typeof a)return this.getRelativeCenter();a=this.bound(0,a,1);var b=this.anchorDate;this.setAnchorDateAndPoint(this.start+a*(this.end-this.start),.5),this.tryToRestoreAnchorDate(b)},ScaleManager.prototype.scrollByPixels=function(a){this.scroll(this.scroll()+a/this.viewportWidth*this.getRelativeWidth())},ScaleManager.prototype.zoomToMs=function(a){var b=this.minMsPerPixel*Math.pow(this.absMaxMsPerPixel/this.minMsPerPixel,a);return this.bound(this.minMsPerPixel,b,this.maxMsPerPixel)},ScaleManager.prototype.msToZoom=function(a){var b=Math.log(a/this.minMsPerPixel)/Math.log(this.absMaxMsPerPixel/this.minMsPerPixel);return b},ScaleManager.prototype.targetLevels=function(a){a=this.boundZoom(a);var b=this.zoomToMs(a);return this.calcLevels(b)},ScaleManager.prototype.zoom=function(a){return"undefined"==typeof a?this.msToZoom(this.msPerPixel):(this.msPerPixel=this.zoomToMs(a),a-this.fullZoomInValue()<this.zoomAccuracy&&(this.msPerPixel=this.minMsPerPixel),this.fullZoomOutValue()-a<this.zoomAccuracy&&(this.msPerPixel=this.maxMsPerPixel),void this.updateCurrentInterval())},ScaleManager.prototype.zoomAroundDate=function(a,b){var c=this.anchorDate;this.tryToRestoreAnchorDate(b),this.zoom(a),this.tryToRestoreAnchorDate(c)},angular.module("webadminApp").factory("cameraRecords",["mediaserver","$q",function(a,b){return{getRecordsProvider:function(c,d,e){return new CameraRecordsProvider(c,a,b,d,e)},getPositionProvider:function(c,d){return new ShortCache(c,a,b,d)}}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").factory("animateScope",["$q",function(a){function b(b,c,d,e,f){this.scope=b,this.value=c,this.targetValue=d,this.duration=e,this.started=(new Date).getTime(),this.initialValue=b[c],this.isFinished=!1,this.dependency=f||i,this.deferred=a.defer()}function c(){var a=[],b=[];_.forEach(e,function(c){c.update(),b.indexOf(c.scope)<0&&c.scope!==h&&b.push(c.scope),c.isFinished&&a.push(c)}),_.forEach(a,function(a){e.splice(e.indexOf(a),1)}),_.forEach(b,function(a){a.$apply()})}function d(a){j&&(c(),"undefined"!=typeof k&&null!==k&&k!==!1&&k(),0!==f&&(window.animationFrame(d),f&&f--))}var e=[],f=null,g=1e3,h=null,i="linear";b.prototype.interpolate=function(a,b,c,d,e){switch(e){case"smooth":return this.smooth(a,b,c,d);case"fading":return this.fading(a,b,c,d);case"dryResistance":return this.dryResistance(a,b,c,d);case"linear":default:return this.linear(a,b,c,d)}},b.prototype.linear=function(a,b,c,d){c>d&&(c=d);var e=a+(b-a)*c/d;return isNaN(e)&&console.error("linear-error",e,a,b,c,d),e},b.prototype.smooth=function(a,b,c,d){c>d&&(c=d);var e=(Math.sin(c/d*Math.PI-Math.PI/2)+1)/2,f=a+(b-a)*e;return Number.isNaN(f)&&console.error("animation isNaN"),f},b.prototype.dryResistance=function(a,b,c,d){c>d&&(c=d);var e=c/d,f=e*(2-e),g=a+(b-a)*f;return g},b.prototype.fading=function(a,b,c,d){c>d&&(c=d);var e=Math.sin(c/d*Math.PI/2);return a+(b-a)*e},b.prototype.breakAnimation=function(){this.isFinished=!0,this.deferred.reject(this.scope[this.value])},b.prototype.update=function(){if(!this.isFinished){var a=(new Date).getTime()-this.started;this.scope[this.value]=this.interpolate(this.initialValue,this.targetValue,a,this.duration,this.dependency),this.deferred.notify(this.scope[this.value]),this.isFinished=a>this.duration,this.isFinished&&this.deferred.resolve(this.scope[this.value])}};var j=!1;window.animationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,20)}}();var k=null;return{start:function(a){j=!0,k=a,d(!0)},stop:function(){j=!1},process:function(){c()},animating:function(a,b){var c=_.find(e,function(c){return c.scope===a&&c.value===b});return c},animate:function(a,c,d,f,h){"undefined"==typeof h&&(h=g);var i=_.find(e,function(b){return b.scope===a&&b.value===c});i&&i.breakAnimation();var j=new b(a,c,d,h,f);return e.push(j),j.deferred.promise},progress:function(a,b,c,d){return a[b]=0,this.animate(a,b,1,c,d)},setDuration:function(a){g=a},setScope:function(a){h=a}}}]),angular.module("webadminApp").directive("navbar",function(){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavigationCtrl",scope:{noPanel:"="}}}),angular.module("webadminApp").directive("nxEqualEx",["$log",function(a){return{require:"ngModel",link:function(b,c,d,e){function f(){void 0!==e.$viewValue&&""!==e.$viewValue&&e.$setValidity("nxEqualEx",b.$eval(d.nxEqualEx)===e.$viewValue)}return d.nxEqualEx?(b.$watch(d.nxEqualEx,f),b.$watch("$viewValue",f),void e.$parsers.push(function(a){if(void 0===a||""===a)return e.$setValidity("nxEqualEx",!0),a;var c=a===b.$eval(d.nxEqualEx);return e.$setValidity("nxEqualEx",c),a})):void a.error("nxEqualEx expects a model as an argument!")}}}]),angular.module("webadminApp").directive("icon",function(){return{restrict:"E",scope:{"for":"="},template:"<span ng-if='for || onFalse' class='glyphicon glyphicon-{{for?onTrue:onFalse}} {{class}}' title='{{for?titleTrue:titleFalse}}'></span>",link:function(a,b,c){a.onTrue=c.onTrue||"ok",a.onFalse=c.onFalse,a["class"]=c["class"],a.titleTrue=c.titleTrue,a.titleFalse=c.titleFalse}}}),angular.module("webadminApp").directive("fileupload",function(){return{restrict:"E",template:"<span class='btn btn-success fileinput-button' ><span>{{text}}</span><input type='file' name='installerFile1' class='fileupload' id='fileupload' ></span><div class='progress' style='display:none;'><div class='progress-bar progress-bar-success progress-bar-striped'></div></div>",link:function(a,b,c){b.find(".fileupload").fileupload({url:c.url,dataType:"json",done:function(a,c){if("0"===c.result.error)alert("Updating successfully started. It will take several minutes");else switch(c.result.errorString){case"UP_TO_DATE":alert("Updating failed. The provided version is already installed.");break;case"INVALID_FILE":alert("Updating failed. Provided file is not a valid update archive.");break;case"INCOMPATIBLE_SYSTEM":alert("Updating failed. Provided file is targeted for another system.");break;case"EXTRACTION_ERROR":alert("Updating failed. Extraction failed, check available storage.");break;case"INSTALLATION_ERROR":alert("Updating failed. Couldn't execute installation script.")}b.find(".progress").hide()},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.find(".progress").show(),b.find(".progress-bar").css("width",d+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),a.text=c.text||"Select files"}}}),angular.module("webadminApp").directive("inplaceEdit",function(){return{restrict:"E",templateUrl:"views/inplace-edit.html",scope:{model:"=ngModel"},link:function(a,b,c){var d=a.model;a.type=c.type||"text",a.placeholder=c.placeholder,a.inputId=c.inputId,a.edit=function(){d=a.model,b.find("input").val(d),b.find(".read-container").hide(),b.find(".edit-container").show(),b.find("input").focus()},a.save=function(){d!==a.model&&a.$parent.$eval(c.nxOnsave),d=a.model,b.find(".read-container").show(),b.find(".edit-container").hide()},a.cancel=function(){a.model=d,a.$apply(),b.find(".read-container").show(),b.find(".edit-container").hide()},b.find(".edit-container").hide()}}}),angular.module("webadminApp").directive("timeline",["$interval","$timeout","animateScope",function(a,b,c,d){return{restrict:"E",scope:{recordsProvider:"=",positionProvider:"=",playHandler:"=",liveOnly:"=",canPlayLive:"=",ngClick:"&",positionHandler:"="},templateUrl:"views/components/timeline.html",link:function(a,d){function e(){a.viewportHeight=d.find(".viewport").height(),J.height=a.viewportHeight}function f(){a.viewportWidth=d.find(".viewport").width(),J.width=a.viewportWidth,a.scaleManager.setViewportWidth(a.viewportWidth)}function g(){var b=(new Date).getTime();a.scaleManager.setStart(a.recordsProvider&&a.recordsProvider.chunksTree?a.recordsProvider.chunksTree.start:b-G.initialInterval),a.scaleManager.setEnd(b),a.zoomTo(1)}function h(){a.positionProvider&&a.scaleManager.tryToSetLiveDate(a.positionProvider.playedPosition,a.positionProvider.liveMode),a.scaleManager.setEnd((new Date).getTime()),C();var b=k();l(b),m(b),F?r(b):s(b),u(b),v(b),w(b)}function i(a,b){if("string"==typeof a)return a;"undefined"==typeof b&&(b=1),b>1&&console.error("bad value",b),a.length>3&&(b*=a[3]);var c="rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+b+")";return c}function j(a){return a.weight+" "+Math.round(a.size)+"px "+a.face}function k(){var b=J.getContext("2d");return b.fillStyle=i(G.timelineBgColor,1),b.clearRect(0,0,a.viewportWidth,a.viewportHeight),b.lineWidth=G.lineWidth,b}function l(b){p(b,a.scaleManager.levels.top.index,a.scaleManager.levels.top.index,1,"topFormat",G.topLabelFixed,0,G.topLabelHeight,G.topLabelFont,G.topLabelAlign,G.topLabelBgColor,G.topLabelBgOddColor,G.topLabelMarkerColor,G.topLabelPositionFix,G.topLabelMarkerAttach,G.topLabelMarkerHeight);
}function m(b){return G.oldStyle?void o(b,"format",G.labelFixed,G.topLabelHeight,G.labelHeight,G.labelFont,G.labelAlign,G.labelBgColor,G.labelBgColor,G.labelMarkerColor,G.labelMarkerAttach,G.levelsSettings):(p(b,L.labels.index,K.labels.index,a.zooming,"format",G.labelFixed,G.topLabelHeight,G.labelHeight,G.labelFont,G.labelAlign,G.labelBgColor,G.labelBgColor,G.labelMarkerColor,G.labelPositionFix,G.labelMarkerAttach,G.labelMarkerHeight),void n(b))}function n(b){p(b,L.marks.index,K.marks.index,a.zooming,!1,"none",G.topLabelHeight,G.labelHeight,null,null,null,null,G.marksColor,0,G.marksAttach,G.marksHeight)}function o(b,c,d,e,f,g,h,i,j,k,l,m){function n(b,c){var d=a.zooming,e=o(c);return e>=b?null:K[c].index==L[c].index?null:K[c].index>L[c].index?1-d:d}function o(a){return Math.min(L[a].index,K[a].index)}function p(a){return Math.max(L[a].index,K[a].index)}function r(a){return a<=p("labels")?"labels":a<=p("middle")?"middle":a<=p("small")?"small":a<=p("marks")?"marks":"events"}function s(a){return a<=o("labels")?"labels":a<=o("middle")?"middle":a<=o("small")?"small":a<=o("marks")?"marks":"events"}function t(a,b,c){return b+a*(c-b)}for(var u=Math.max(a.scaleManager.levels.marks.index,K.marks.index),v=RulerModel.levels[u],w=v.interval.getMilliseconds();w<G.minMarkWidth*a.scaleManager.msPerPixel;)u--,v=RulerModel.levels[u],w=v.interval.getMilliseconds();for(var x=a.scaleManager.alignStart(RulerModel.levels[u>0?u-1:0]),y=x,z=a.scaleManager.alignEnd(v),A=0;z>=y&&A++<3e3;){var B=i!=j||Math.round(y.getTime()/w)%2===1,C=RulerModel.findBestLevelIndex(y,u),D=r(C),E=n(C,D),F=m[D].markSize,H=m[D].transparency,I=m[D].fontSize,J=m[D].labelPositionFix;if(null!==E){var M=s(C);F=t(E,F,m[M].markSize),H=t(E,H,m[M].transparency),I=t(E,I,m[M].fontSize),J=t(E,J,m[M].labelPositionFix)}g.size=I,q(b,y,v,H,c,d,e,f,g,h,B?i:j,k,J,l,F),y=v.interval.addToDate(y)}3e3==A&&console.error("counter problem!",x,y,z,v)}function p(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,r){for(var s=Math.max(c,d),t=RulerModel.levels[s],u=a.scaleManager.alignStart(t),v=a.scaleManager.alignStart(t),w=a.scaleManager.alignEnd(t),x=t.interval.getMilliseconds(),y=1e3;w>=v&&y-->0;){var z=Math.round(v.getTime()/x)%2===1,A=RulerModel.findBestLevelIndex(v),B=1;A>d?B=1-e:A>c&&(B=e),q(b,v,t,B,f,g,h,i,j,k,z?l:m,n,o,p,r),v=t.interval.addToDate(v)}1>y&&console.error("problem!",u,v,w,t)}function q(b,c,d,e,f,g,h,k,l,m,n,o,p,q,r){var s=a.scaleManager.dateToScreenCoordinate(c);if(f){b.font=j(l);var t=d.interval.addToDate(c),u=a.scaleManager.dateToScreenCoordinate(t),v=g?d:RulerModel.findBestLevel(t),w=(dateFormat(new Date(t),v[f]),g?d:RulerModel.findBestLevel(c)),x=dateFormat(new Date(c),w[f]),y=b.measureText(x).width,z=h*a.viewportHeight+(k*a.viewportHeight-l.size)/2+l.size+p,A=0;switch(m){case"center":var B=Math.max(0,s),C=Math.min(u,a.viewportWidth),D=(B+C)/2;A=a.scaleManager.bound(s+G.labelPadding,D-y/2,u-y-G.labelPadding);break;case"left":A=a.scaleManager.bound(G.labelPadding,s+G.labelPadding,u-y-G.labelPadding);break;case"above":default:A=s-y/2}}var E="top"==q?h:h+k-r;if(n)switch(b.fillStyle=i(n,e),m){case"center":case"left":b.fillRect(s,h*a.viewportHeight,u-s,k*a.viewportHeight)}if(o&&(b.strokeStyle=i(o,e),b.beginPath(),b.moveTo(s+.5,E*a.viewportHeight),b.lineTo(s+.5,(E+r)*a.viewportHeight),b.stroke()),n)switch(b.fillStyle=i(n,e),m){case"center":case"left":break;case"above":default:b.clearRect(A,z-l.size,y,l.size)}f&&(b.fillStyle=i(l.color,e),b.fillText(x,A,z))}function r(b){if(b.fillStyle=i(G.chunksBgColor,1),b.clearRect(0,top,a.viewportWidth,G.chunkHeight*a.viewportHeight),a.recordsProvider&&a.recordsProvider.chunksTree)for(var c=a.scaleManager.levels.events.index,d=0;d<RulerModel.levels.length;d++)for(var e=RulerModel.levels[d],f=a.scaleManager.alignStart(e),g=a.scaleManager.alignEnd(e),h=a.recordsProvider.getIntervalRecords(f,g,d,!0),j=0;j<h.length;j++)t(b,h[j],d,!0,c)}function s(b){var c=(G.topLabelHeight+G.labelHeight)*a.viewportHeight;if(Q=O>c&&O<c+G.chunkHeight*a.viewportHeight,b){b.fillStyle=i(G.chunksBgColor,1),b.fillRect(0,c,a.viewportWidth,G.chunkHeight*a.viewportHeight);var d=a.scaleManager.levels.events.level,e=a.scaleManager.levels.events.index,f=a.scaleManager.alignStart(d),g=a.scaleManager.alignEnd(d);if(a.recordsProvider&&a.recordsProvider.chunksTree)for(var h=a.recordsProvider.getIntervalRecords(f,g,e),j=0;j<h.length;j++)t(b,h[j],e)}}function t(b,c,d,e,f){var g=a.scaleManager.dateToScreenCoordinate(c.start),h=a.scaleManager.dateToScreenCoordinate(c.end),j=(d==c.level,1);b.fillStyle=i(G.exactChunkColor,j);var k=(G.topLabelHeight+G.labelHeight)*a.viewportHeight,l=G.chunkHeight*a.viewportHeight;e&&(f==d&&(b.fillStyle=i(G.highlighChunkColor,1)),d==c.level&&(b.fillStyle=i(G.loadingChunkColor,j)),c.level||(b.fillStyle=i(G.blindChunkColor,1)),k+=(1+d)/RulerModel.levels.length*l,l/=RulerModel.levels.length,k=Math.floor(k),l=Math.ceil(l)),b.fillRect(g-G.minChunkWidth/2,k,h-g+G.minChunkWidth/2,l)}function u(b){var c=(G.topLabelHeight+G.labelHeight+G.chunkHeight)*a.viewportHeight,d=a.scaleManager.getRelativeCenter(),e=a.scaleManager.getRelativeWidth();M=Math.max(a.viewportWidth*e,G.minScrollBarWidth);var f=a.scaleManager.bound(0,a.viewportWidth*d-M/2,a.viewportWidth-M);return S=O>=c,P=N>=f&&f+M>=N&&O>=c,b?(b.fillStyle=i(G.scrollBarBgColor,1),b.fillRect(0,c,a.viewportWidth,G.scrollBarHeight*a.viewportHeight),b.fillStyle=P||T?i(G.scrollBarHighlightColor,1):i(G.scrollBarColor,1),b.fillRect(f,c,M,G.scrollBarHeight*a.viewportHeight),void 0):(P||T?(P=N-f,R=!1):R=N,S&&(S=N-f),P)}function v(b){a.positionProvider&&!a.positionProvider.liveMode&&x(b,a.positionProvider.playedPosition,G.timeMarkerColor,G.timeMarkerTextColor)}function w(b){N&&Q&&x(b,a.scaleManager.screenCoordinateToDate(N),G.pointerMarkerColor,G.pointerMarkerTextColor)}function x(b,c,d,e){var f=a.scaleManager.dateToScreenCoordinate(c);if(!(0>f||f>a.viewportWidth)){c=new Date(c);var g=G.markerHeight*a.viewportHeight;b.strokeStyle=i(d,1),b.fillStyle=i(d,1);var h=(G.topLabelHeight+G.labelHeight)*a.viewportHeight;b.beginPath(),b.moveTo(f+.5,h),b.lineTo(f+.5,Math.round(a.viewportHeight-G.scrollBarHeight*a.viewportHeight)),b.stroke();var k=f-G.markerWidth/2;0>k&&(k=0),k>a.viewportWidth-G.markerWidth&&(k=a.viewportWidth-G.markerWidth),b.fillRect(k,0,G.markerWidth,g),b.beginPath(),b.moveTo(f+G.markerTriangleHeight*a.viewportHeight+.5,g),b.lineTo(f+.5,g+G.markerTriangleHeight*a.viewportHeight),b.lineTo(f-G.markerTriangleHeight*a.viewportHeight+.5,g),b.closePath(),b.fill(),b.fillStyle=i(e,1),b.font=j(G.markerDateFont),f=k+G.markerWidth/2;var l=dateFormat(c,G.dateFormat),m=b.measureText(l).width,n=(g-G.markerDateFont.size)/2;b.fillText(l,f-m/2,n),b.font=j(G.markerTimeFont),l=dateFormat(c,G.timeFormat),m=b.measureText(l).width,n=g/2+n,b.fillText(l,f-m/2,n)}}function y(a){return a?(N=$(a.target).is("canvas")&&a.offsetX?a.offsetX:a.pageX-$(J).offset().left,O=a.offsetY||a.pageY-$(J).offset().top,u(),void s()):(O=0,N=null,P=!1,S=!1,Q=!1,void(R=!1))}function z(b){y(b),b.preventDefault(),Math.abs(b.deltaY)>Math.abs(b.deltaX)?(window.jscd.touch?V=a.scaleManager.zoom()-b.deltaY/G.maxVerticalScrollForZoomWithTouch:(V||(V=a.scaleManager.zoom()),V-=b.deltaY/G.maxVerticalScrollForZoom,V=a.scaleManager.boundZoom(V)),a.zoomTo(V,a.scaleManager.screenCoordinateToDate(N),window.jscd.touch)):(a.scaleManager.scrollByPixels(b.deltaX),A()),a.$apply()}function A(){W?clearTimeout(W):a.scaleManager.stopWatching(),W=setTimeout(function(){a.scaleManager.releaseWatching(),W=null},G.animationDuration)}function B(b){A(),c.animate(a,"scrollPosition",b).then(function(){},function(){},function(b){a.scaleManager.scroll(b)})}function C(){Y&&a.zoom(Z,!0,!1)}function D(a,b){return a.labels.index!=b.labels.index?!0:a.middle.index!=b.middle.index?!0:a.small.index!=b.small.index?!0:a.marks.index!=b.marks.index?!0:!1}function E(){var b=a.scaleManager.zoom();a.disableZoomOut=b>=a.scaleManager.fullZoomOutValue()-G.zoomAccuracy,a.disableZoomIn=b<=a.scaleManager.fullZoomInValue()+G.zoomAccuracy}var F=Config.debug.chunksOnTimeline&&Config.allowDebugMode,G={initialInterval:36e5,stickToLiveMs:1e3,maxMsPerPixel:31536e6,minMsPerPixel:10,minMarkWidth:1,zoomSpeed:.025,zoomAccuracy:1e-5,slowZoomSpeed:.01,maxVerticalScrollForZoom:250,maxVerticalScrollForZoomWithTouch:5e3,animationDuration:300,levelsSettings:{labels:{markSize:15/110,transparency:1,fontSize:14,labelPositionFix:5},middle:{markSize:10/110,transparency:.75,fontSize:13,labelPositionFix:0},small:{markSize:5/110,transparency:.5,fontSize:11,labelPositionFix:-5},marks:{markSize:5/110,transparency:.25,fontSize:0,labelPositionFix:-10},events:{markSize:0,transparency:0,fontSize:0,labelPositionFix:-15}},timelineBgColor:[28,35,39,.6],font:"Roboto",labelPadding:10,lineWidth:1,chunkHeight:30/110,minChunkWidth:1,chunksBgColor:[34,57,37],exactChunkColor:[58,145,30],loadingChunkColor:[0,255,255,.3],blindChunkColor:[255,0,0,.3],highlighChunkColor:[255,255,0,1],scrollBarSpeed:.1,scrollBarHeight:20/110,minScrollBarWidth:50,scrollBarBgColor:[28,35,39],scrollBarColor:[53,70,79],scrollBarHighlightColor:[53,70,79,.8],timeMarkerColor:[215,223,227],timeMarkerTextColor:[12,21,23],pointerMarkerColor:[12,21,23],pointerMarkerTextColor:[255,255,255],markerDateFont:{size:15,weight:400,face:"Roboto"},markerTimeFont:{size:17,weight:500,face:"Roboto"},markerWidth:140,markerHeight:50/110,markerTriangleHeight:6/110,dateFormat:"d mmmm yyyy",timeFormat:"HH:MM:ss",scrollBoundariesPrecision:1e-6,scrollingSpeed:.25,end:0};a.timelineConfig=G;var H={topLabelAlign:"center",topLabelHeight:30/110,topLabelFont:{size:17,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerAttach:"top",topLabelMarkerHeight:.5,topLabelBgColor:!1,topLabelBgOddColor:!1,topLabelPositionFix:0,topLabelFixed:!0,oldStyle:!1,labelAlign:"above",labelHeight:30/110,labelFont:{size:15,weight:400,face:"Roboto",color:[105,135,150]},labelMarkerAttach:"bottom",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],labelPositionFix:-5,labelMarkerHeight:.2,labelFixed:!0,marksAttach:"bottom",marksHeight:10/110,marksColor:[83,112,127,.4]};a.presets=[{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[53,70,79,0],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,0]},{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,0]},{topLabelAlign:"left",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"left",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,.4]},{topLabelAlign:"center",topLabelHeight:20/110,topLabelFont:{size:12,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerHeight:20/110,topLabelMarkerAttach:"top",topLabelBgColor:[33,42,47],topLabelBgOddColor:[43,56,63],topLabelPositionFix:-2,topLabelFixed:!0,labelAlign:"above",labelHeight:40/110,labelFont:{size:15,weight:400,face:"Roboto",color:[145,167,178]},labelMarkerAttach:"top",labelMarkerColor:[105,135,150],labelBgColor:[28,35,39],labelPositionFix:5,labelMarkerHeight:20/110,labelFixed:!1,marksAttach:"top",marksHeight:10/110,marksColor:[83,112,127,.4],oldStyle:!0}],a.selectPreset=function(b){a.activePreset=b,a.timelineConfig=$.extend(a.timelineConfig,H,b)},a.selectPreset(a.presets[3]);var I=d.find(".viewport"),J=d.find("canvas").get(0);a.scaleManager=new ScaleManager(G.minMsPerPixel,G.maxMsPerPixel,G.initialInterval,100,G.stickToLiveMs,G.zoomAccuracy),a.changingLevel=1;var K=a.scaleManager.levels,L={events:{index:0},labels:{index:0},middle:{index:0},small:{index:0},marks:{index:0}},M=0,N=null,O=0,P=!1,Q=!1,R=!1,S=!1,T=!1,U=!1,V=0,W=null,X=!1;a.dblClick=function(b){y(b),X||(S?P||B(S>0?1:0):(a.scaleManager.setAnchorCoordinate(N),a.zoom(!0)))},a.click=function(b){if(y(b),!X)if(S)P||(a.scrollPosition=a.scaleManager.scroll(),B(N/a.viewportWidth));else{a.scaleManager.setAnchorCoordinate(N);var c=a.scaleManager.screenCoordinateToDate(N);a.positionHandler(a.scaleManager.screenCoordinateToDate(N)),a.scaleManager.watchPlaying(c)}},a.mouseUp=function(a){},a.mouseLeave=function(a){},a.mouseMove=function(a){y(a)},a.mouseDown=function(a){},a.draginit=function(b){y(b),T=P,U=R,a.scaleManager.stopWatching()},a.drag=function(b){if(y(b),T){var c=P-T;a.scaleManager.scroll(a.scaleManager.scroll()+c/a.viewportWidth)}if(U){var c=U-R;U=R,a.scaleManager.scrollByPixels(c)}},a.drastart=function(a){},a.dragend=function(b){T=!1,U=!1,a.scaleManager.releaseWatching(),X=!0,setTimeout(function(){X=!1},G.animationDuration),y(null)},$(J).drag("draginit",a.draginit),$(J).drag("dragstart",a.drastart),$(J).drag("drag",a.drag),$(J).drag("dragend",a.dragend),$(J).bind("touchstart",a.draginit),$(J).bind("touchmove",a.drag),$(J).bind("touchend",a.dragend),$(J).bind("touchcancel",a.dragend),a.zoom=function(b,c,d){V=a.scaleManager.zoom()-(b?1:-1)*(c?G.slowZoomSpeed:G.zoomSpeed),a.zoomTo(V,null,!1,d)},a.zoomOut=function(){V=a.scaleManager.boundZoom(1),a.zoomTo(V)};var Y=!1,Z=!1;a.stopZoom=function(b){Y&&(Y=!1,a.zoom(Z,!0,!0))},a.startZoom=function(b){a.disableZoomOut&&!b||a.disableZoomIn&&b||(Y=!0,Z=b,C())},a.zooming=1,a.zoomTo=function(d,e,f,g){function h(c){e?a.scaleManager.zoomAroundDate(c,e):a.scaleManager.zoom(c),b(E),A()}d=a.scaleManager.boundZoom(d);var i=a.scaleManager.targetLevels(d);D(i,K)&&(K=i,1==a.zooming&&(a.zooming=0),c.animate(a,"zooming",1,"dryResistance").then(function(){L=a.scaleManager.levels},function(){})),f?(h(d),a.zoomTarget=a.scaleManager.zoom()):(a.zoomTarget||(a.zoomTarget=a.scaleManager.zoom()),A(),c.animate(a,"zoomTarget",d,g?"linear":"dryResistance").then(function(){},function(){},h))},a.goToLive=function(b){var d=a.scaleManager.screenCoordinateToDate(1);c.progress(a,"goingToLive").then(function(){var b=(new Date).getTime();a.scaleManager.setAnchorDateAndPoint(b,1),a.scaleManager.watchPlaying()},function(){},function(b){var c=d+b*((new Date).getTime()-d);a.scaleManager.setAnchorDateAndPoint(c,1)}),(!a.positionProvider.liveMode||b)&&a.positionHandler(!1)},a.playPause=function(){a.positionProvider.playing||a.scaleManager.watchPlaying(),a.playHandler(!a.positionProvider.playing)},$(window).resize(f),a.$watch("positionProvider.liveMode",function(b){a.positionProvider&&a.positionProvider.liveMode&&a.goToLive(!0)}),a.$watch("recordsProvider",function(){a.recordsProvider&&(a.recordsProvider.ready.then(g),a.recordsProvider.archiveReadyPromise.then(function(b){a.emptyArchive=!b}))}),I.mousewheel(z),e(),f(),g(),c.setDuration(G.animationDuration),c.setScope(a),c.start(h),a.$on("$destroy",function(){c.stop()})}}}]),angular.module("webadminApp").directive("objecter",function(){return{restrict:"E",scope:{ngId:"=",ngParam:"=",ngSource:"=",ngName:"="},link:function(a,b,c){var d=b;d.html("");var e="",f="";_.forEach(a.ngParam,function(a,b){e+='<param name="'+b+'" value="'+a+'">',f+=b+'="'+a+'" '}),e+='<embed  width="100%" height="100%" id="'+a.ngName+'" name="'+a.ngName+'" src="'+a.ngSource+'" '+f+"></embed>";var g='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="100%" height="100%" id="'+a.ngId+'" data="'+a.ngSource+'">'+e+"</object>";Config.allowDebugMode&&Config.debug.video&&console.log("objecter",g),d.html(g)}}}),angular.module("webadminApp").directive("videowindow",["$interval","$timeout","animateScope",function(a,b,c){return{restrict:"E",scope:{vgUpdateTime:"&",vgPlayerReady:"&",vgSrc:"="},templateUrl:"views/components/videowindow.html",link:function(a,c){function d(b){var c=_.find(a.vgSrc,function(a){return a.type==k[b]});return a.debugMode&&console.log("playing",c?c.src:null),c?c.src:null}function e(){function b(a){var b=!1,c=document.createElement("video");return c.canPlayType&&c.canPlayType(k[a]).replace(/no/,"")&&(b=!0),b}if(a.flashRequired=!1,a.flashOrWebmRequired=!1,a.noArmSupport=!1,a.noFormat=!1,a.errorLoading=!1,a.ieNoWebm=!1,a.loading=!1,a.ieWin10=!1,a.debugMode&&a.debugFormat)return a.debugFormat;var c=_.find(a.vgSrc,function(a){return a.type==k.webm}),d=_.find(a.vgSrc,function(a){return a.type==k.hls}),e=_.find(a.vgSrc,function(a){return a.type==k.rtsp});if(c&&b("webm")&&!("Microsoft Internet Explorer"==window.jscd.browser&&window.jscd.osVersion>=10))return"webm";if(d&&b("hls"))return"native-hls";if("Android"==window.jscd.os)return c?"webm":(a.noArmSupport=!0,!1);if(window.jscd.mobile&&d)return"native-hls";switch(window.jscd.browser){case"Microsoft Internet Explorer":return c&&window.jscd.osVersion<10?(a.ieNoWebm=!0,!1):c&&window.jscd.osVersion>=10?(a.ieWin10=!0,!1):(a.noFormat=!0,!1);case"Safari":if(d)return"native-hls";case"Chrome":case"Firefox":case"Opera":case"Webkit":default:return d&&window.jscd.flashVersion?"flashls":e&&window.jscd.flashVersion?"rtsp":d?(a.flashRequired=!0,!1):(a.noFormat=!0,!1)}}function f(b){l!=b&&(c.find(".videoplayer").html(""),a.vgPlayerReady({$API:null})),l=b}function g(e){a["native"]=!0,a.flashls=!1,nativePlayer.init(c.find(".videoplayer"),function(c){a.vgApi=c,a.vgSrc&&(b(function(){a.loading=!!m}),a.vgApi.load(d(e),k[e]),a.vgApi.addEventListener("timeupdate",function(c,d,e){var f=c.srcElement||c.originalTarget;a.vgUpdateTime({$currentTime:f.currentTime,$duration:f.duration}),a.loading&&b(function(){a.loading=!1})})),a.vgPlayerReady({$API:a.vgApi})},function(a){console.error("some error")})}function h(){a.flashls=!0,a["native"]=!1,a.flashSource="components/flashlsChromeless.swf",a.debugMode&&a.debugFormat&&(a.flashSource="components/flashlsChromeless_debug.swf"),a.flashParam=flashlsAPI.flashParams(),flashlsAPI.ready()?(flashlsAPI.kill(),a.flashls=!1,b(h)):b(function(){flashlsAPI.init("videowindow",function(c){a.vgApi=c,a.vgSrc&&(b(function(){a.loading=!!m}),a.vgApi.load(d("hls"))),a.vgPlayerReady({$API:c})},function(c){b(function(){a.errorLoading=!0,a.loading=!1,a.flashls=!1,a["native"]=!1}),console.error(c)},function(b,c){0!=b&&(a.loading=!1,a.vgUpdateTime({$currentTime:b/1e3,$duration:c}))})})}function i(){jshlsAPI.init(c.find(".videoplayer"),function(c){a.vgApi=c,a.vgSrc&&(b(function(){a.loading=!!m}),a.vgApi.load(d("hls"))),a.vgPlayerReady({$API:c})},function(a){console.error("some error")})}function j(){var c=new Locomote("videowindow","components/Player.swf");c.on("apiReady",function(){a.vgApi=c,a.vgApi.load||(b(function(){a.loading=!!m}),a.vgApi.load=a.vgApi.play,a.vgApi.play=function(){a.vgApi.load(d("rtsp"))}),c.on("streamStarted",function(){}),c.on("error",function(a){console.error(a)}),a.vgSrc&&a.vgApi.play(a.vgSrc[2].src),a.vgPlayerReady({$API:api})})}var k={hls:"application/x-mpegURL",webm:"video/webm",rtsp:"application/x-rtsp",flv:"video/x-flv",mp4:"video/mp4"};a.debugMode=Config.debug.video&&Config.allowDebugMode,a.debugFormat=Config.allowDebugMode&&Config.debug.videoFormat;var l=null;c.bind("contextmenu",function(){return!!a.debugMode});var m=null;a.$watch("vgSrc",function(){if(a.loading=!1,a.errorLoading=!1,a.vgSrc){if(m=e(),f(m),!m)return a["native"]=!1,void(a.flashls=!1);switch(m){case"flashls":h();break;case"jshls":i();break;case"rtsp":j();break;case"native-hls":g("hls");break;case"webm":default:g(m)}}})}}}]),angular.module("webadminApp").controller("MainCtrl",["$scope",function(a){a.config=Config}]),angular.module("webadminApp").controller("NavigationCtrl",["$scope","$location","mediaserver","ipCookie","$sessionStorage",function(a,b,c,d,e){a.user={isAdmin:!0},c.checkAdmin().then(function(b){a.user={isAdmin:b}}),c.getSettings().then(function(b){a.settings=b.data.reply,a.settings.remoteAddresses=a.settings.remoteAddresses.join("\n")}),a.isActive=function(a){var c=b.path().split("/")[1];return c.split("?")[0]===a.split("/")[1].split("?")[0]},a.logout=function(){d.remove("auth",{path:"/"}),d.remove("nonce",{path:"/"}),d.remove("realm",{path:"/"}),window.location.reload()},a.webclientEnabled=Config.webclientEnabled,a.alertVisible=!0,a.session=e,a.closeAlert=function(){a.session.serverInfoAlertHidden=!0}}]),angular.module("webadminApp").controller("SettingsCtrl",["$scope","$modal","$log","mediaserver","$location","$timeout",function(a,b,c,d,e,f){function g(c){b.open({templateUrl:"views/restart.html",controller:"RestartCtrl",resolve:{port:function(){return c?a.settings.port:null}}})}function h(){return alert("Connection error"),!1}function i(b){var c=b.data;if("0"!==c.error){var d=c.errorString;switch(d){case"UNAUTHORIZED":case"password":case"PASSWORD":d="Wrong password."}alert("Error: "+d)}else c.reply.restartNeeded?confirm("All changes saved. New settings will be applied after restart. \n Do you want to restart server now?")&&g(!0):(alert("Settings saved"),a.settings.port!==window.location.port?window.location.href=window.location.protocol+"//"+window.location.hostname+":"+a.settings.port:window.location.reload())}function j(b,c){var e=b.networkAddresses.split(";"),f=b.apiUrl.substring(b.apiUrl.lastIndexOf(":")),g=window.location.protocol+"//"+e[c]+f;d.getSettings(g).then(function(){b.apiUrl=g},function(){return c<e.length-1?j(b,c+1):(b.status="Unavailable",a.mediaServers=_.sortBy(a.mediaServers,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id})),!1})}d.checkAdmin().then(function(a){return a?void 0:void e.path("/info")}),d.getSettings().then(function(b){a.settings={systemName:b.data.reply.systemName,port:b.data.reply.port,id:b.data.reply.id},a.oldSystemName=b.data.reply.systemName,a.oldPort=b.data.reply.port}),a.password="",a.oldPassword="",a.confirmPassword="",a.openJoinDialog=function(){var e=b.open({templateUrl:"views/join.html",controller:"JoinCtrl",resolve:{items:function(){return a.settings}}});e.result.then(function(a){c.info(a),d.mergeSystems(a.url,a.password,a.currentPassword,a.keepMySystem).then(function(a){if("0"!==a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":case"PASSWORD":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version.";break;case"url":case"URL":b="Wrong url."}alert("Merge failed: "+b)}else alert("Merge succeed."),window.location.reload()})})},a.save=function(){a.settingsForm.$valid?(a.oldSystemName===a.settings.systemName||confirm('If there are others servers in local network with "'+a.settings.systemName+'" system name then it could lead to this server settings loss. Continue?')||(a.settings.systemName=a.oldSystemName),(a.oldSystemName!==a.settings.systemName||a.oldPort!==a.settings.port)&&d.saveSettings(a.settings.systemName,a.settings.port).then(i,h)):alert("form is not valid")},a.changePassword=function(){a.password===a.confirmPassword&&d.changePassword(a.password,a.oldPassword).then(i,h)},a.restart=function(){confirm("Do you want to restart server now?")&&g(!1)},d.getMediaServers().then(function(b){a.mediaServers=_.sortBy(b.data,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id}),f(function(){_.each(a.mediaServers,function(a){var b=0;j(a,b)})},1e3)})}]),angular.module("webadminApp").controller("JoinCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){a.settings={url:"",password:"",currentPassword:"",keepMySystem:!0},a.systems={joinSystemName:"NOT FOUND",systemName:"SYSTEMNAME",systemFound:!1},d.getSettings().then(function(b){a.systems.systemName=b.data.reply.systemName,d.discoveredPeers().then(function(b){var c=_.map(b.data.reply,function(a){return{url:window.location.protocol+"//"+a.remoteAddresses[0]+":"+a.port,systemName:a.systemName,ip:a.remoteAddresses[0],name:a.name}});a.systems.discoveredUrls=_.filter(c,function(b){return b.systemName!==a.systems.systemName})})}),a.test=function(){d.pingSystem(a.settings.url,a.settings.password).then(function(b){if("0"!==b.data.error){var c=b.data.errorString;switch(c){case"FAIL":c="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":c="Wrong password.";break;case"INCOMPATIBLE":c="Found system has incompatible version.";break;case"url":c="Wrong url."}alert("Connection failed: "+c)}else a.systems.systemFound=!0,a.systems.joinSystemName=b.data.reply.systemName})},a.join=function(){b.close({url:a.settings.url,password:a.settings.password,keepMySystem:a.settings.keepMySystem,currentPassword:a.settings.currentPassword})},a.selectSystem=function(b){a.settings.url=b.url},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").controller("LoginCtrl",["$scope","mediaserver","ipCookie",function(a,b,c){function d(){return a.authorized=!0,a.authorizing=!1,setTimeout(function(){window.location.reload()},20),!1}a.authorized=!1,a.authorizing=!1,a.user||(a.user={username:"",password:""}),a.login=function(){if(a.loginForm.$valid){var e=a.user.username.toLowerCase(),f=c("realm"),g=c("nonce"),h=md5(e+":"+f+":"+a.user.password),i=md5("GET:"),j=md5(h+":"+g+":"+i),k=Base64.encode(e+":"+g+":"+j);c("auth",k,{path:"/"});var l=md5("PLAY:"),m=md5(h+":"+g+":"+l),n=Base64.encode(e+":"+g+":"+m);c("auth_rtsp",n,{path:"/"}),a.authorizing=!0,b.getCurrentUser(!0).then(d)["catch"](function(b){a.authorizing=!1,alert("Login or password is incorrect")})}}}]),angular.module("webadminApp").controller("AdvancedCtrl",["$scope","$modal","$log","mediaserver","$location",function(a,b,c,d,e){function f(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}d.checkAdmin().then(function(a){a||e.path("/info")}),a.someSelected=!1,a.reduceArchiveWarning=!1,d.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return f(a.url)});for(var c=0;c<a.storages.length;c++)a.storages[c].reservedSpaceGb=Math.round(a.storages[c].reservedSpace/1073741824),a.storages[c].url=f(a.storages[c].url);a.$watch(function(){a.reduceArchiveWarning=!1,a.someSelected=!1;for(var b in a.storages){var c=a.storages[b];c.reservedSpace=1073741824*c.reservedSpaceGb,a.someSelected=a.someSelected||c.isUsedForWriting&&c.isWritable,c.reservedSpace>c.freeSpace&&(a.reduceArchiveWarning=!0)}})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]},a.toGBs=function(a){return Math.floor(a/1073741824)},a.update=function(){},a.save=function(){var b,c=!1;_.each(a.storages,function(a){b=b||a.isUsedForWriting,a.reservedSpace>a.freeSpace&&(c="Set reserved space is greater than free space left. Possible partial remove of the video footage is expected. Do you want to continue?")}),b||(c="No storages were selected for writing - video will not be recorded on this server. Do you want to continue?"),(!c||confirm(c))&&d.getSettings().then(function(b){d.getMediaServer(b.data.reply.id.replace("{","").replace("}","")).then(function(b){var c=b.data[0];_.each(a.storages,function(a){var b=_.findWhere(c.storages,{id:a.storageId});null!==b&&(b.spaceLimit=a.reservedSpace,b.usedForWriting=a.isUsedForWriting)}),d.saveStorages(c.storages).then(function(a){if("undefined"!=typeof a.error&&"0"!==a.error){var b=a.errorString;alert("Error: "+b)}else alert("Settings saved")},function(){alert("Error: Couldn't save settings")})})})},a.cancel=function(){window.location.reload()}}]),angular.module("webadminApp").controller("InfoCtrl",["$scope","mediaserver",function(a,b){function c(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}a.logUrl=b.logUrl(),b.getSettings().then(function(b){a.settings=b.data.reply}),b.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return c(a.url)}),_.each(a.storages,function(a){a.url=c(a.url)})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]}}]),angular.module("webadminApp").controller("RestartCtrl",["$scope","$modalInstance","$interval","mediaserver","port",function(a,b,c,d,e){function f(){return window.location.href=h,!1}function g(){var b=j?d.getSettings(h):d.statistics(h);b.then(function(b){return j||b.data.reply.uptimeMs<i?(a.state="server is starting",f()):(a.state="server is restarting",i=b.data.reply.uptimeMs,void setTimeout(g,1e3))},function(){return a.state="server is offline",j=!0,setTimeout(g,1e3),!1})}e=e||window.location.port,a.state="";var h=window.location.protocol+"//"+window.location.hostname+":"+e;a.url=h+window.location.pathname+window.location.search;var i=Number.MAX_VALUE,j=!1;a.refresh=f,d.statistics().then(function(a){i=a.data.reply.uptimeMs,d.restart().then(function(){g()},function(){return g(),!1})},function(){return a.state="server is offline",setTimeout(g,1e3),!1})}]),angular.module("webadminApp").controller("SdkeulaCtrl",["$scope","$routeParams",function(a,b){a.agree=!1,a.next=function(){return window.open(b.sdkFile+".zip"),!1}}]),angular.module("webadminApp").controller("OfflineCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){function e(){return window.location.reload(),!1}function f(){var a=d.getSettings(!0);a.then(function(){return e()},function(){return setTimeout(f,1e3),!1})}a.refresh=e,a.state="server is offline",setTimeout(f,1e3)}]),angular.module("webadminApp").controller("WebclientCtrl",function(){}),angular.module("webadminApp").controller("ViewCtrl",["$scope","$rootScope","$location","$routeParams","mediaserver","cameraRecords","$timeout","$q","$sessionStorage","$localStorage",function(a,b,c,d,e,f,g,h,i,j){function k(a,b){var c=document.createElement("video");if(c.canPlayType&&c.canPlayType(G[a]).replace(/no/,""))return!0;if(b){if("hls"==a&&"Android"!=window.jscd.os)return!0;if("webm"==a&&"Microsoft Internet Explorer"==window.jscd.browser)return!0}return"hls"==a?!!window.jscd.flashVersion:!1}function l(b){return a.activeCamera?_.find(a.activeCamera.mediaStreams,function(a){return a.transports.indexOf(b)>0}):null}function m(a){return l(a)&&k(a,!0)}function n(){a.activeCamera||(a.activeResolution="Auto",a.availableResolutions=["Auto"]),m("webm")?a.availableResolutions=D:a.availableResolutions=E,a.availableResolutions.indexOf(a.activeResolution)<0&&(a.activeResolution=a.availableResolutions[0])}function o(b){return a.mediaServers?_.find(a.mediaServers,function(a){return a.id===b}):null}function p(b){if(!a.cameras)return null;for(var c in a.cameras){var d=_.find(a.cameras[c],function(a){return a.id===b});if(d)return d}return null}function q(b){var c=!b;if(a.positionSelected=!!b,a.positionProvider){a.positionProvider.init(b),b=c?(new Date).getTime():Math.round(b);var d=a.activeCamera.physicalId,f="",g="rtsp://"+window.location.host,h=e.mediaDemo();h&&(f=h,g="rtsp:"+h);var i="&auth="+e.authForMedia(),j="&auth="+e.authForRtsp(),k=c?"":"&pos="+b,l=c?"":"&startTimestamp="+b;a.acitveVideoSource=_.filter([{src:f+"/hls/"+d+".m3u8?"+a.activeResolution+l+i,type:G.hls,transport:"hls"},{src:f+"/media/"+d+".webm?resolution="+a.activeResolution+k+i,type:G.webm,transport:"webm"},{src:g+"/"+d+"?"+k+j+"&stream="+("lo"==a.activeResolution?1:0),type:G.rtsp,transport:"rtsp"}],function(b){return m(b.transport)&&"Auto"==a.activeFormat||a.activeFormat==b.type})}}function r(a){return a=a.split("/")[2]||a.split("/")[0],a.split(":")[0].split("?")[0]}function s(a){var b=0;if(a.url){for(var c=a.url.split("."),d=0;d<c.length;d++){var e=3-d;b+=parseInt(c[d])%256*Math.pow(256,e)}isNaN(b)?b=a.url:(b=b.toString(16),b.length<8&&(b="0"+b))}return a.name+"__"+b}function t(){var b=h.defer();return e.getCameras().then(function(c){function d(a){return a.typeId==K?!1:x?!0:A?A.indexOf(a.id)>=0:!1}function f(a){a.url=r(a.url),a.preview=e.previewUrl(a.physicalId,!1,null,256),a.server=o(a.parentId),a.server&&"Offline"==a.server.status&&(a.status="Offline");var b=_.find(a.addParams,i);return a.mediaStreams=b?JSON.parse(b.value).streams:[],s(a)}function g(a){var b=p(a.id);return b?($.extend(b,a),!1):!0}var h=c.data,i=function(a){return"mediaStreams"==a.name};h=_.filter(h,d),h=_.sortBy(h,f);var j=_.groupBy(h,function(a){return a.parentId});if(a.cameras){for(var k in a.cameras){for(var l=a.cameras[k],m=j[k],n=0;n<l.length;n++)_.find(m,function(a){return a.id==l[n].id})||(l.splice(n,1),
n--);var m=_.filter(m,g);_.forEach(m,function(a){l.push(a)})}for(var k in j)a.cameras[k]||(a.cameras[k]=j[k])}else a.cameras=j;b.resolve(h)},function(a){b.reject(a)}),b.promise}function u(){function b(b){return b.url=r(b.url),b.collapsed=a.storage.serverStates[b.id],s(b)}function c(b){var c=o(b.id);return b.collapsed=c?c.collapsed:a.storage.serverStates[b.id]||"Online"!==b.status&&(b.allowAutoRedundancy||b.flags.indexOf("SF_Edge")<0),c&&$.extend(c,b),!c}var d=h.defer();return e.getMediaServers().then(function(e){if(a.mediaServers){for(var f=e.data,g=0;g<a.mediaServers.length;g++)_.find(f,function(b){return b.id==a.mediaServers[g].id})||(a.mediaServers.splice(g,1),g--);var h=_.filter(f,c);_.forEach(_.sortBy(h,b),function(b){a.mediaServers.push(b)})}else a.mediaServers=_.sortBy(e.data,b);t().then(function(a){d.resolve(a)},function(a){d.reject(a)})},function(a){d.reject(a)}),d.promise}function v(){u().then(function(){a.selectCameraById(a.storage.cameraId,I&&c.search().time||!1,!I),I=!1,J=g(v,F)},function(a){console.error(a)})}function w(){e.getResourceTypes().then(function(a){K=_.find(a.data,function(a){return"SERVER_DESKTOP_CAMERA"==a.name}),K=K?K.id:null,v()})}a.session=i,a.storage=j,a.storage.serverStates=a.storage.serverStates||{},a.playerApi=!1,a.cameras={},a.liveOnly=!0,a.storage.cameraId=d.cameraId||a.storage.cameraId||null,!d.cameraId&&a.storage.cameraId&&c.path("/view/"+a.storage.cameraId,!1),a.activeCamera=null;var x=!1,y=!1,z=!1,A=null,B=0,C=2e3;a.activeResolution="Auto";var D=["Auto","1080p","720p","640p","320p","240p"],E=["Auto","hi","lo"],F=5e3,G={hls:"application/x-mpegURL",webm:"video/webm",rtsp:"application/x-rtsp",flv:"video/x-flv",mp4:"video/mp4",mjpeg:"video/x-motion-jpeg"};if(a.activeFormat="Auto",a.availableFormats=["Auto","video/webm","application/x-mpegURL","application/x-rtsp"],a.settings={id:""},e.getSettings().then(function(b){a.settings={id:b.data.reply.id}}),"Microsoft Internet Explorer"!=window.jscd.browser||k("webm",!1)||window.jscd.osVersion<10&&(a.ieNoWebm=!0),window.jscd.mobile){a.mobileStore="iOS"==window.jscd.os?"appstore":"googleplay";var H=_.find(Config.helpLinks,function(b){if(!b.urls)return!1;var c=_.find(b.urls,function(b){return b["class"]==a.mobileStore});return c?(a.mobileAppLink=c.url,!0):!1});a.hasMobileApp=!!H}n(),a.playerReady=function(b){a.playerAPI=b,a.switchPlaying(!0)},a.activeVideoRecords=null,a.positionProvider=null,a.updateTime=function(b,c){b=b||0,a.positionProvider.setPlayingPosition(1e3*b)},a.selectCameraById=function(b,c,d){var e=null;a.positionProvider&&!a.positionProvider.liveMode&&(e=a.positionProvider.playedPosition),a.storage.cameraId=b||a.storage.cameraId,c=c?parseInt(c):e,a.activeCamera=p(a.storage.cameraId),!d&&a.activeCamera&&(a.positionProvider=f.getPositionProvider([a.activeCamera.physicalId],B),a.activeVideoRecords=f.getRecordsProvider([a.activeCamera.physicalId],640,B),a.liveOnly=!0,z&&a.activeVideoRecords.archiveReadyPromise.then(function(b){a.liveOnly=!b}),q(c),n(),a.switchPlaying(!0))},a.selectCamera=function(b){c.path("/view/"+b.id,!1),a.selectCameraById(b.id,!1)},a.toggleServerCollapsed=function(b){b.collapsed=!b.collapsed,a.storage.serverStates[b.id]=b.collapsed},a.switchPlaying=function(b){a.playerAPI&&(b?a.playerAPI.play():a.playerAPI.pause(),a.positionProvider&&(a.positionProvider.playing=b,b||g(function(){a.positionProvider.liveMode=!1})))},a.switchPosition=function(a){q(a)},a.selectFormat=function(b){a.activeFormat=b,q(a.positionProvider.liveMode?null:a.positionProvider.playedPosition)},a.selectResolution=function(b){a.activeResolution!=b&&(a.activeResolution=b,q(a.positionProvider.liveMode?null:a.positionProvider.playedPosition))},a.enableFullScreen=screenfull.enabled,a.fullScreen=function(){screenfull.enabled&&screenfull.request($(".videowindow").get(0))};var I=!0,J=!1,K=null;a.$watch("positionProvider.liveMode",function(b){b&&(a.positionSelected=!1)}),e.getTime().then(function(a){var b=parseInt(a.data.reply.utcTime),c=(new Date).getTime();Math.abs(c-b)>C&&(B=c-b)}),e.getCurrentUser().then(function(a){if(x=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalEditServersPermissions,y=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalViewLivePermission,z=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalViewArchivePermission,y){var b=a.data.reply.id;return x?void w():void e.getLayouts().then(function(a){A=_.chain(a.data).filter(function(a){return a.parentId==b}).map(function(a){return a.items}).flatten().map(function(a){return a.resourceId}).uniq().value(),w()})}}),a.$on("$destroy",function(){g.cancel(J)}),b.$on("$routeChangeStart",function(b,d){a.selectCameraById(d.params.cameraId,c.search().time||!1)});var L=$(window),M=$("#top"),N=$(".view-panel"),O=$(".cameras-panel"),P=function(){var a=L.height(),b=M.height(),c=0,d=$("td.alert");d.length&&(c=d.height());var e=a-b-c+"px";O.css("height",e),N.css("height",e)};P(),setTimeout(P,50),L.resize(P),a.mobileAppAlertClose=function(){a.session.mobileAppNotified=!0,setTimeout(P,50)},a.ieNoWebmAlertClose=function(){a.session.ieNoWebmNotified=!0,setTimeout(P,50)}}]),angular.module("webadminApp").controller("HealthCtrl",["$scope","$modal","$log","mediaserver","$timeout",function(a,b,c,d,e){function f(b){for(var c=[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)},{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)}],d=0;d<b.length;d++){var e=i[b[d].deviceType],f=e[d%e.length];c.push({label:b[d].description,fillColor:f,strokeColor:f,pointColor:f,pointStrokeColor:f,pointHighlightFill:f,pointHighlightStroke:f,show:!0,hideLegend:!1,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)})}a.datasets=c,a.updateVisibleDatasets()}function g(b){for(var c=a.datasets,d=function(a){return a.description===f.label},e=2;e<c.length;e++){var f=c[e],g=0,h=_.filter(b,d);h&&h.length>0&&(g=h[0].value),f.data.push(100*g),f.data.length>a.healthLength&&(f.data=f.data.slice(f.data.length-a.healthLength,f.data.length))}}function h(){d.statistics().then(function(b){return null===k&&f(b.data.reply.statistics),a.serverIsOnline=!0,g(200===b.status&&"0"===b.data.error?b.data.reply.statistics:[]),k=e(h,a.interval),!1},function(){g([]),a.serverIsOnline=!1,k=e(h,a.interval)})}a.healthLength=100,a.interval=1e3,a.serverIsOnline=!0;var i={StatisticsCPU:["#3776ca"],StatisticsRAM:["#db3ba9"],StatisticsHDD:["#438231","#484848","#aa880b","#b25e26","#9200d1","#00d5d5","#267f00","#8f5656","#c90000"],StatisticsNETWORK:["#ff3434","#b08f4c","#8484ff","#34ff84"]},j="rgba(255,255,255,0)";a.data={labels:Array.apply(null,new Array(a.healthLength)).map(String.prototype.valueOf,""),datasets:[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)}]},a.legend="",a.options={animation:!1,scaleOverride:!1,scaleSteps:10,scaleShowLabels:!1,scaleLabel:"<%=value%> %",scaleIntegersOnly:!0,responsive:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!1,pointDotRadius:0,pointDotStrokeWidth:1,pointHitDetectionRadius:0,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!1,onAnimationProgress:function(){},onAnimationComplete:function(){},legendTemplate:'<ul class="tc-chart-js-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].strokeColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'},a.updateVisibleDatasets=function(){a.data.datasets=_.filter(a.datasets,function(a){return a.show})};var k=null,l=setTimeout(h,a.interval);a.$on("$destroy",function(){e.cancel(k),clearTimeout(l)})}]),angular.module("webadminApp").controller("LogCtrl",["$scope","mediaserver",function(a,b){a.logUrl=b.logUrl()}]);