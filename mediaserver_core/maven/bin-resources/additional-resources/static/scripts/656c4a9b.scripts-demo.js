"use strict";var Config={globalEditServersPermissions:32,globalViewArchivePermission:256,globalViewLivePermission:128,cloud:{apiUrl:"http://cloud-demo.hdw.mx/api",portalWhiteList:"http://cloud-demo.hdw.mx/**",portalUrl:"http://cloud-demo.hdw.mx",portalRegisterUrl:"http://cloud-demo.hdw.mx/static/index.html#/register",portalSystemUrl:"http://cloud-demo.hdw.mx/static/index.html#/systems/{systemId}?inline",portalConnectUrl:"http://cloud-demo.hdw.mx/static/index.html#/systems/connect/{systemName}?inline",portalDisconnectUrl:"http://cloud-demo.hdw.mx/static/index.html#/systems/{systemId}/disconnect?inline"},cloudLocalhost:{portalWhiteList:"http://localhost:8000/**",portalUrl:"http://localhost:8000",portalRegisterUrl:"http://localhost:8000/static/index.html#/register",portalSystemUrl:"http://localhost:8000/static/index.html#/systems/{systemId}?inline",portalConnectUrl:"http://localhost:8000/static/index.html#/systems/connect/{systemName}?inline",portalDisconnectUrl:"http://localhost:8000/static/index.html#/systems/{systemId}/disconnect?inline"},demo:"/~ebalashov/webclient/api",demoMedia:"//10.0.2.186:7001",webclientEnabled:!0,allowDebugMode:!1,debug:{video:!0,videoFormat:!1,chunksOnTimeline:!1},helpLinks:[]};angular.module("webadminApp",["ipCookie","ngResource","ngSanitize","ngRoute","ui.bootstrap","ngStorage"]).config(["$routeProvider",function(a){a.when("/setup",{templateUrl:"views/dialogs/setup-inline.html",controller:"SetupCtrl"}).otherwise({redirectTo:"/setup"})}]),angular.module("webadminApp").factory("mediaserver",["$http","$modal","$q","ipCookie",function(a,b,c,d){function e(){return a.get(l+"/api/moduleInformation?showAddresses=true")}function f(a){if(401===a.status){var c=window.self!==window.top;return void(c||null!==q||(q=b.open({templateUrl:"views/login.html",keyboard:!1,backdrop:"static"}),q.result.then(function(){q=null})))}0!==a.status&&(console.log(a),j=null,null===p&&e(!0)["catch"](function(){p=b.open({templateUrl:"offline_modal",controller:"OfflineCtrl",keyboard:!1,backdrop:"static"}),p.result.then(function(){p=null})}))}function g(a){return a["catch"](f),a}function h(b,c){return g(a.post(b,c))}function i(b){var d=c.defer(),e=g(a.get(b,{timeout:d.promise}));return e.then(function(){d=null},function(){d=null}),e.abort=function(a){d&&d.resolve("abort request: "+a)},e}var j=null,k=null,l="";if(location.search.indexOf("proxy=")>0)for(var m=location.search.replace("?","").split("&"),n=0;n<m.length;n++){var o=m[n].split("=");if("proxy"===o[0]){l="/proxy/"+o[1],"demo"===o[1]&&(l=Config.demo);break}}d("Authorization","Digest",{path:"/"});var p=null,q=null;return{url:function(){return l},mediaDemo:function(){return l===Config.demo?Config.demoMedia:!1},logUrl:function(a){return l+"/api/showLog"+(a||"")},authForMedia:function(){return d("auth")},authForRtsp:function(){return d("auth_rtsp")},previewUrl:function(a,b,c,d){return Config.allowDebugMode?"":l+"/api/image?physicalId="+a+(c?"&width="+c:"")+(d?"&height="+d:"")+("&time="+(b||"LATEST"))},hasProxy:function(){return""!==l},getUser:function(){var a=c.defer();return this.hasProxy()&&a.resolve(!1),this.getCurrentUser().then(function(b){var c=b.data.reply.permissions&Config.globalEditServersPermissions,d=b.data.reply.isAdmin||c,e=b.data.reply.isAdmin;a.resolve({isAdmin:d,isOwner:e,name:b.data.reply.name})}),a.promise},getScripts:function(){return a.get("/api/scriptList")},execute:function(b,c){return a.post("/api/execute/"+b+"?"+(c||""))},getSettings:function(b){return b=b||l,b===!0?(j=null,e()):""===b?(null===j&&(j=g(e())),j):a.get(b+"/api/moduleInformation?showAddresses=true",{timeout:3e3})},setupCloudSystem:function(a,b,d){function e(a){f.reject(a)}var f=c.defer();return this.changeSystemName($scope.settings.systemName).then(function(){this.saveCloudSystemCredentials(message.data.systemId,message.data.authKey).then(function(a){f.resolve(a)},e)},e),f.promise},setupLocalSystem:function(a,b,c){return this.changeSystem(a,b,c)},changeSystemName:function(a){return h(l+"/api/configure?"+$.param({systemName:a}))},changeSystem:function(a,b,c){return h(l+"/api/configure?"+$.param({systemName:a,login:b,password:c}))},changePort:function(a){return h(l+"/api/configure?"+$.param({port:a}))},mergeSystems:function(a,b,c,d,e){return h(l+"/api/mergeSystems?"+$.param({login:b,password:c,currentPassword:d,url:a,takeRemoteSettings:!e}))},pingSystem:function(a,b){return h(l+"/api/pingSystem?"+$.param({password:b,url:a}))},restart:function(){return h(l+"/api/restart")},getStorages:function(){return i(l+"/api/storageSpace")},saveStorages:function(a){return h(l+"/ec2/saveStorages",a)},discoveredPeers:function(){return i(l+"/api/discoveredPeers?showAddresses=true")},getMediaServer:function(a){return i(l+"/ec2/getMediaServersEx?id="+a.replace("{","").replace("}",""))},getMediaServers:function(){return i(l+"/ec2/getMediaServersEx")},getResourceTypes:function(){return i(l+"/ec2/getResourceTypes")},getLayouts:function(){return i(l+"/ec2/getLayouts")},getCameras:function(a){return i("undefined"!=typeof a?l+"/ec2/getCamerasEx?id="+a.replace("{","").replace("}",""):l+"/ec2/getCamerasEx")},saveMediaServer:function(a){return h(l+"/ec2/saveMediaServer",a)},statistics:function(a){return a=a||l,i(a+"/api/statistics?salt="+(new Date).getTime())},getCurrentUser:function(a){return(null===k||a)&&(k=i(l+"/api/getCurrentUser")),k},getTime:function(){return i(l+"/api/gettime")},logLevel:function(a,b){return i(l+"/api/logLevel?id="+a+(b?"&value="+b:""))},systemSettings:function(a){if(a){var b=[];for(var c in a)b.push(c+"="+a[c]);return i(l+"/api/systemSettings?"+b.join("&"))}return i(l+"/api/systemSettings")},getSystemSettings:function(){return i(l+"/ec2/getSettings")},saveCloudSystemCredentials:function(a,b){return h(l+"/api/saveCloudSystemCredentials",{cloudSystemID:a,cloudAuthKey:b})},clearCloudSystemCredentials:function(){return h(l+"/api/saveCloudSystemCredentials",{reset:!0})},getRecords:function(a,b,c,d,e,f,g,h){var j=new Date;return"undefined"==typeof c&&(c=j.getTime()-2592e6),"undefined"==typeof d&&(d=j.getTime()+1e5),"undefined"==typeof e&&(e=(d-c)/1e3),"undefined"==typeof h&&(h=0),"/"!==a&&""!==a&&null!==a&&(a="/proxy/"+a+"/"),l===Config.demo&&(a=l+"/"),i(a+"ec2/recordedTimePeriods?"+(g||"")+"&physicalId="+b+"&startTime="+c+"&endTime="+d+"&detail="+e+"&periodsType="+h+(f?"&limit="+f:"")+"&flat&keepSmallChunks")},debugFunctionUrl:function(a,b){var c=a.indexOf("?")>=0?"&":"?";return l+a+c+$.param(b)},debugFunction:function(b,c,d,e){switch(b){case"GET":return a.get(this.debugFunctionUrl(c,d));case"POST":return a.post(this.debugFunctionUrl(c,d),e)}}}}]),angular.module("webadminApp").factory("cloudAPI",["$http",function(a){return{login:function(b,c){return a.post(Config.cloud.apiUrl+"/account/login",{email:b,password:c})},connect:function(b,c,d){return a.post(Config.cloud.apiUrl+"/account/connect",{name:b,email:c,password:d})}}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").controller("CloudDialogCtrl",["$scope","$modalInstance","mediaserver","connect","systemName",function(a,b,c,d,e){function f(b){a.connecting=!1,a.finished=!0,a.succeed=!0,b.data.errorString&&""!==b.data.errorString&&(a.errorMessage+=": "+b.data.errorString,a.succeed=!1)}function g(b){a.connecting=!1,a.finished=!0,a.succeed=!1,console.error(b)}function h(b){switch(b.data.message){case"connected":c.saveCloudSystemCredentials(b.data.systemId,b.data.authKey).then(f,g);break;case"disconnected":c.clearCloudSystemCredentials().then(f,g)}a.hideCloud=!0,a.connecting=!0,a.$digest()}d?(a.title="Connect system to Nx cloud",a.actionLabel="Connect",a.cloudPortalUrl=Config.cloud.portalConnectUrl.replace("{systemName}",encodeURIComponent(e)),a.successMessage="System is connected to cloud",a.errorMessage="Can't connect to cloud: some error happened"):(a.title="Disconnect system from Nx cloud",a.actionLabel="Disconnect",a.cloudPortalUrl=Config.cloud.portalDisconnectUrl.replace("{systemId}",encodeURIComponent(e)),a.successMessage="System was disconnected from cloud",a.errorMessage="Some error happened"),window.addEventListener("message",h,!1),a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").controller("SetupCtrl",["$scope","mediaserver","$sessionStorage","cloudAPI",function(a,b,c,d){function e(){b.getSettings().then(function(b){a.serverInfo=b.data.reply,a.next("start")})}function f(a){alert("error happened"),console.error(a)}function g(){b.discoveredPeers().then(function(b){var c=_.map(b.data.reply,function(a){return{url:a.remoteAddresses[0]+":"+a.port,systemName:a.systemName,ip:a.remoteAddresses[0],name:a.name}});console.log(b.data.reply,c),a.discoveredUrls=c,_.filter(c,function(b){return console.log(systemName),b.systemName!==a.serverInfo.systemName})})}function h(){return k?void a.next("mergeSuccess"):void b.mergeSystems(a.settings.selectedSystem.url,a.settings.remoteLogin,a.settings.remotePassword,"admin",!1).then(function(b){if("0"!==b.data.error){var c=f(b.data.errorString);if(c)return void alert("Merge failed: "+c)}e(),a.next("mergeSuccess")})}function i(){function c(){a.next("cloudFailure")}return k?void a.next("cloudSuccess"):void d.connect(a.settings.systemName,a.settings.cloudEmail,a.settings.cloudPassword).then(function(d){b.setupCloudSystem(a.settings.systemName,d.data.systemId,d.data.authKey).then(function(){a.next("cloudSuccess")},c)},c)}function j(){return k?void a.next("localSuccess"):void b.setupCloudSystem(a.settings.systemName,a.settings.localLogin,a.settings.localPassword).then(function(){a.next("localSuccess")},function(){a.next("cloudFailure")})}a.settings={systemName:"",cloudEmail:"",cloudPassword:"",localLogin:"admin",localPassword:"",localPasswordConfirmation:"",remoteSystem:"",remoteLogin:"",remotePassword:""},a.serverAddress=window.location.host;var k=!0;a.stepIs=function(b){return a.step==b},a.finish=function(){a.next("start"),console.log("close")},a.back=function(){a.next(a.activeStep.back)},a.next=function(b){if(!b){var c=a.activeStep||a.wizardFlow[0];b=c.next||c.finish}return $.isFunction(b)?b():(a.step=b,a.activeStep=a.wizardFlow[b],void(a.activeStep.onShow&&a.activeStep.onShow()))},a.createAccount=function(){window.open(Config.cloud.portalRegisterUrl),a.next("cloudLogin")},a.learnMore=function(){window.open(Config.cloud.portalUrl)},a.selectSystem=function(b){a.settings.remoteSystem=b.systemName,a.settings.remoteSystemHint=b.url+" ("+b.name+")",a.settings.selectedSystem=b},a.findSystem=function(){a.settings.selectedSystem=null,a.settings.remoteSystemHint=""},a.wizardFlow={0:{next:"start"},start:{next:"systemName"},systemName:{back:"start",next:"cloudIntro"},cloudIntro:{back:"systemName"},cloudLogin:{back:"cloudIntro",next:i},cloudSuccess:{finish:!0},cloudFailure:{back:"cloudLogin",next:"localLogin"},merge:{onShow:g,next:h},mergeSuccess:{finish:!0},localLogin:{next:j},localSuccess:{finish:!0}},e()}]);