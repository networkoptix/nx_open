set(dmg_file_name ${client_distribution_name}.dmg)
set(update_file_name ${client_update_distribution_name}.zip)

set(libdir ${CMAKE_BINARY_DIR})
set(build.configuration)
set(ClientHelpSourceDir ${help_directory}/bin/help)

set(filtered_files_dir ${CMAKE_CURRENT_BINARY_DIR}/filtered_files_dir)

nx_configure_directory(
    ${CMAKE_CURRENT_SOURCE_DIR}/maven/filter-resources
    ${filtered_files_dir}
    @ONLY
    OUTPUT_FILES_VARIABLE filtered1
)

nx_configure_directory(
    ${CMAKE_CURRENT_SOURCE_DIR}/maven/bin-resources
    ${filtered_files_dir}
    @ONLY COPYONLY
    OUTPUT_FILES_VARIABLE filtered2
)

nx_configure_directory(
    ${customization_dir}/client-dmg
    ${filtered_files_dir}
    @ONLY COPYONLY
    OUTPUT_FILES_VARIABLE filtered3
)

file(WRITE ${CMAKE_CURRENT_BINARY_DIR}/launcher.version "${releaseVersion.full}")

add_custom_target(desktop_client_dmg ALL
    DEPENDS desktop_client applauncher
        ${filtered1} ${filtered2} ${filtered3}
        ${customization_dir}/icons/macosx/logo.icns
    COMMENT "Creating ${distribution_output_dir}/${dmg_file_name}"
    BYPRODUCTS
        ${distribution_output_dir}/${dmg_file_name}
        ${distribution_output_dir}/${update_file_name}

    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    COMMAND ${CMAKE_COMMAND} -E copy
        ${customization_dir}/icons/macosx/logo.icns ${CMAKE_CURRENT_BINARY_DIR}
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_CURRENT_BINARY_DIR}/dmg-folder
    COMMAND ${CMAKE_COMMAND} -E copy_directory ${filtered_files_dir} ${CMAKE_CURRENT_BINARY_DIR}

    # Copying some files and directories for maven compatibility.
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/qml
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/imageformats
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/platforms
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/audio
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/mediaservice

    COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${QT_DIR}/qml ${libdir}/bin/qml
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${QT_DIR}/plugins/imageformats ${libdir}/bin/imageformats
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${QT_DIR}/plugins/platforms ${libdir}/bin/platforms
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${QT_DIR}/plugins/audio ${libdir}/bin/audio
    COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${QT_DIR}/plugins/mediaservice ${libdir}/bin/mediaservice
    COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_CURRENT_BINARY_DIR}/launcher.version ${libdir}/bin

    COMMAND ${CMAKE_CURRENT_BINARY_DIR}/build_dmg.sh

    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/qml
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/imageformats
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/platforms
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/audio
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${libdir}/plugins/mediaservice
    COMMAND ${CMAKE_COMMAND} -E remove ${libdir}/launcher.version

    COMMAND ${CMAKE_COMMAND} -E copy
        ${CMAKE_CURRENT_BINARY_DIR}/${dmg_file_name} ${distribution_output_dir}
    COMMAND ${CMAKE_COMMAND} -E copy
        ${CMAKE_CURRENT_BINARY_DIR}/${update_file_name} ${distribution_output_dir}
)
