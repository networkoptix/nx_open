"use strict";function Chunk(a,b,c,d,e,f){this.start=b,this.end=c,this.level=d||0,this.expand=!0;var g="dd.mm.yyyy HH:MM";this.title="undefined"==typeof e||null===e?dateFormat(b,g)+" - "+dateFormat(c,g):e,this.children=[],_.extend(this,f)}function Interval(a,b,c,d,e,f,g){this.seconds=b,this.minutes=c,this.hours=d,this.days=e,this.months=f,this.years=g,this.milliseconds=a}function isDate(a){return a instanceof Date}function CameraRecordsProvider(a,b,c,d){this.cameras=a,this.mediaserver=b,this.$q=c,this.chunksTree=null,this.requestedCache=[],this.width=d;var e=this,f=c.defer();this.archiveReadyPromise=f.promise,this.requestInterval(0,e.now()+1e4,0).then(function(){if(f.resolve(!!e.chunksTree),e.chunksTree){var a=RulerModel.getLevelIndex(e.now()-e.chunksTree.start,e.width);a<RulerModel.levels.length-1&&e.requestInterval(e.chunksTree.start,e.now(),a+1)}})}function ShortCache(a,b,c){this.$q=c,this.mediaserver=b,this.cameras=a,this.start=0,this.played=0,this.playedPosition=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.requestInterval=9e4,this.updateInterval=6e4,this.requestDetailization=1,this.limitChunks=100,this.checkpointsFrequency=6e4}function ScaleManager(a,b,c,d,e){this.absMaxMsPerPixel=b,this.minMsPerPixel=a,this.stickToLiveMs=e,this.levels={top:{index:0,level:RulerModel.levels[0]},labels:{index:0,level:RulerModel.levels[0]},middle:{index:0,level:RulerModel.levels[0]},small:{index:0,level:RulerModel.levels[0]},marks:{index:0,level:RulerModel.levels[0]},events:{index:0,level:RulerModel.levels[0]}},this.viewportWidth=d,this.end=(new Date).getTime(),this.start=this.end-c,this.updateTotalInterval(),this.msPerPixel=this.maxMsPerPixel,this.anchorPoint=1,this.anchorDate=this.end,this.updateCurrentInterval()}var Config={globalEditServersPermissions:32,globalViewArchivePermission:256,globalViewLivePermission:128,demo:"/~ebalashov/webclient/api",demoMedia:"//10.0.2.186:7001",webclientEnabled:!0,helpLinks:[]};angular.module("webadminApp",["ipCookie","ngResource","ngSanitize","ngRoute","ui.bootstrap","tc.chartjs"]).config(["$routeProvider",function(a){a.when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/join",{templateUrl:"views/join.html",controller:"SettingsCtrl"}).when("/info",{templateUrl:"views/info.html",controller:"InfoCtrl"}).when("/developers",{templateUrl:"views/developers.html",controller:"MainCtrl"}).when("/support",{templateUrl:"views/support.html",controller:"MainCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html"}).when("/advanced",{templateUrl:"views/advanced.html",controller:"AdvancedCtrl"}).when("/webclient",{templateUrl:"views/webclient.html",controller:"WebclientCtrl",reloadOnSearch:!1}).when("/view/",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/view/:cameraId",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/sdkeula",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).otherwise({redirectTo:"/settings"})}]),angular.module("webadminApp").run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("webadminApp").factory("mediaserver",["$http","$modal","$q","ipCookie","$log",function(a,b,c,d,e){function f(){return a.get(k+"/api/moduleInformation?showAddresses=true")}function g(a){if(401===a.status){var c=window.self!==window.top;return void(c||null!==p||(p=b.open({templateUrl:"views/login.html",keyboard:!1,backdrop:"static"}),p.result.then(function(){p=null})))}i=null,null===o&&f(!0)["catch"](function(a){o=b.open({templateUrl:"offline_modal",controller:"OfflineCtrl",keyboard:!1,backdrop:"static"}),o.result.then(function(a){o=null})})}function h(a){return a["catch"](g),a}var i=null,j=null,k="";if(location.search.indexOf("proxy=")>0)for(var l=location.search.replace("?","").split("&"),m=0;m<l.length;m++){var n=l[m].split("=");if("proxy"===n[0]){k="/proxy/"+n[1],"demo"==n[1]&&(k=Config.demo);break}}d("Authorization","Digest",{path:"/"});var o=null,p=null;return{url:function(){return k},mediaDemo:function(){return k==Config.demo?Config.demoMedia:!1},logUrl:function(a){return k+"/api/showLog"+(a||"")},authForMedia:function(){return d("auth")},authForRtsp:function(){return d("auth_rtsp")},previewUrl:function(a,b,c,d){return k+"/api/image?physicalId="+a+(c?"&width="+c:"")+(d?"&height="+d:"")+("&time="+(b||"LATEST"))},hasProxy:function(){return""!==k},checkAdmin:function(){var a=c.defer();return this.hasProxy()&&a.resolve(!1),this.getCurrentUser().then(function(b){var c=b.data.reply.isAdmin||b.data.reply.permissions&Config.globalEditServersPermissions;a.resolve(c)}),a.promise},getSettings:function(b){return b=b||k,b===!0?(i=null,f()):""===b?(null===i&&(i=h(f())),i):a.get(b+"/api/moduleInformation?showAddresses=true",{timeout:3e3})},saveSettings:function(b,c){return h(a.post(k+"/api/configure?systemName="+b+"&port="+c))},changePassword:function(b,c){return h(a.post(k+"/api/configure?password="+b+"&oldPassword="+c))},mergeSystems:function(b,c,d,e){return h(a.post(k+"/api/mergeSystems?password="+c+"&currentPassword="+d+"&url="+encodeURIComponent(b)+"&takeRemoteSettings="+!e))},pingSystem:function(b,c){return h(a.post(k+"/api/pingSystem?password="+c+"&url="+encodeURIComponent(b)))},restart:function(){return h(a.post(k+"/api/restart"))},getStorages:function(){return h(a.get(k+"/api/storageSpace"))},saveStorages:function(b){return h(a.post(k+"/ec2/saveStorages",b))},discoveredPeers:function(){return h(a.get(k+"/api/discoveredPeers?showAddresses=true"))},getMediaServer:function(b){return h(a.get(k+"/ec2/getMediaServersEx?id="+b.replace("{","").replace("}","")))},getMediaServers:function(){return h(a.get(k+"/ec2/getMediaServersEx"))},getResourceTypes:function(){return h(a.get(k+"/ec2/getResourceTypes"))},getLayouts:function(){return h(a.get(k+"/ec2/getLayouts"))},getCameras:function(b){return h("undefined"!=typeof b?a.get(k+"/ec2/getCamerasEx?id="+b.replace("{","").replace("}","")):a.get(k+"/ec2/getCamerasEx"))},saveMediaServer:function(b){return h(a.post(k+"/ec2/saveMediaServer",b))},statistics:function(b){return b=b||k,h(a.get(b+"/api/statistics?salt="+(new Date).getTime()))},getCurrentUser:function(b){return(null===j||b)&&(j=h(a.get(k+"/api/getCurrentUser"))),j},getRecords:function(b,c,d,e,f,g,i){var j=new Date;return"undefined"==typeof d&&(d=j.getTime()-2592e6),"undefined"==typeof e&&(e=j.getTime()+1e5),"undefined"==typeof f&&(f=(e-d)/1e3),"undefined"==typeof i&&(i=0),"/"!==b&&""!==b&&null!==b&&(b="/proxy/"+b+"/"),k==Config.demo&&(b=k+"/"),h(a.get(b+"ec2/recordedTimePeriods?physicalId="+c+"&startTime="+d+"&endTime="+e+"&detail="+f+"&periodsType="+i+(g?"&limit="+g:"")+"&flat"))}}}]),Chunk.prototype.debug=function(){console.log(new Array(this.level+1).join(" "),this.title,this.level,this.children.length)},Number.isInteger||(Number.isInteger=function(a){return"number"==typeof a&&Math.round(a)===a}),Interval.prototype.addToDate=function(a,b){if(Number.isInteger(a)&&(a=new Date(a)),!isDate(a))return console.error("non date "+typeof a+": "+a),a;"undefined"==typeof b&&(b=1);try{return new Date(a.getFullYear()+b*this.years,a.getMonth()+b*this.months,a.getDate()+b*this.days,a.getHours()+b*this.hours,a.getMinutes()+b*this.minutes,a.getSeconds()+b*this.seconds,a.getMilliseconds()+b*this.milliseconds)}catch(c){throw console.error("date problem",a),c}},Interval.prototype.getMilliseconds=function(){var a=new Date(1971,11,1,0,0,0,0),b=this.addToDate(a);return b.getTime()-a.getTime()},Interval.prototype.alignToPast=function(a){var b=new Date(a);return 0!==this.milliseconds?(b.setMilliseconds(Math.floor(b.getMilliseconds()/this.milliseconds)*this.milliseconds),b):(b.setMilliseconds(0),0!==this.seconds?(b.setSeconds(Math.floor(b.getSeconds()/this.seconds)*this.seconds),b):(b.setSeconds(0),0!==this.minutes?(b.setMinutes(Math.floor(b.getMinutes()/this.minutes)*this.minutes),b):(b.setMinutes(0),0!==this.hours?(b.setHours(Math.floor(b.getHours()/this.hours)*this.hours),b):(b.setHours(0),0!==this.days?(b.setDate(Math.floor(b.getDate()/this.days)*this.days),b):(b.setDate(1),0!==this.months?(b.setMonth(Math.floor(b.getMonth()/this.months)*this.months),b):(b.setMonth(0),b.setYear(Math.floor(b.getFullYear()/this.years)*this.years),b))))))},Interval.prototype.checkDate=function(a){return Number.isInteger(a)&&(a=new Date(a)),isDate(a)?this.alignToPast(a).getTime()===a.getTime():(console.error("checkDate - non date",a),!1)},Interval.prototype.alignToFuture=function(a){return this.alignToPast(this.addToDate(a))};var RulerModel={levels:[{name:"Age",interval:new Interval(0,0,0,0,0,0,100),format:"yyyy",marksW:15,smallW:20,middleW:25,width:30,topW:0,topFormat:"yyyy"},{name:"Decade",interval:new Interval(0,0,0,0,0,0,10),format:"yyyy",marksW:15,smallW:20,middleW:25,width:30},{name:"Year",format:"yyyy",interval:new Interval(0,0,0,0,0,0,1),width:30,topW:100,topFormat:"yyyy"},{name:"6 Months",interval:new Interval(0,0,0,0,0,6,0),format:"mmmm",marksW:15,smallW:30,middleW:60,width:90},{name:"3 Months",interval:new Interval(0,0,0,0,0,3,0),format:"mmmm",marksW:15,smallW:30,middleW:60,width:90},{name:"Month",interval:new Interval(0,0,0,0,0,1,0),format:"mmmm",marksW:15,smallW:30,middleW:60,width:90,topW:170,topFormat:"mmmm yyyy"},{name:"Day",interval:new Interval(0,0,0,0,1,0,0),format:"dd",marksW:5,smallW:20,middleW:40,width:60,topW:170,topFormat:"d mmmm yyyy",contained:1},{name:"12 hours",interval:new Interval(0,0,0,12,0,0,0),format:"HH:MM",marksW:15,smallW:60,middleW:80,width:100},{name:"6 hours",interval:new Interval(0,0,0,6,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"3 hours",interval:new Interval(0,0,0,3,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"Hour",interval:new Interval(0,0,0,1,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"30 minutes",interval:new Interval(0,0,30,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"10 minutes",interval:new Interval(0,0,10,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"5 minutes",interval:new Interval(0,0,5,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80},{name:"1 minute",interval:new Interval(0,0,1,0,0,0,0),format:"HH:MM",marksW:15,smallW:50,middleW:60,width:80,topW:170,topFormat:"d mmmm yyyy HH:MM"},{name:"30 seconds",interval:new Interval(0,30,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:60,middleW:80,width:100},{name:"10 seconds",interval:new Interval(0,10,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:60,width:80},{name:"5 seconds",interval:new Interval(0,5,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:50,middleW:60,width:70},{name:"1 second",interval:new Interval(0,1,0,0,0,0,0),format:'ss"s"',marksW:15,smallW:45,middleW:50,width:60,topW:200,topFormat:"d mmmm yyyy HH:MM:ss"},{name:"500 ms",interval:new Interval(500,0,0,0,0,0,0),format:'l"ms"',marksW:15,smallW:60,middleW:100,width:120},{name:"100 ms",interval:new Interval(100,0,0,0,0,0,0),format:'l"ms"',marksW:15,smallW:50,middleW:60,width:80}],getLevelIndex:function(a,b){b=b||1;var c=_.find(RulerModel.levels,function(c){return c.interval.getMilliseconds()<a/b});return"undefined"!=typeof c?this.levels.indexOf(c):this.levels.length-1},findBestLevelIndex:function(a,b){if(b){for(var c=Math.min(b-1,this.levels.length-1),d=c;d>=0;d--)if(!this.levels[d].interval.checkDate(a))return d+1;return d}for(var d=0;d<this.levels.length;d++)if(this.levels[d].interval.checkDate(a))return d;return this.levels.length-1},findBestLevel:function(a){return this.levels[this.findBestLevelIndex(a)]}};CameraRecordsProvider.prototype.now=function(){return(new Date).getTime()},CameraRecordsProvider.prototype.cacheRequestedInterval=function(a,b,c){for(var d=0;c+1>d;d++)if(d>=this.requestedCache.length)this.requestedCache.push([{start:a,end:b}]);else for(var e=0;e<this.requestedCache[d].length;e++)if(!(this.requestedCache[d][e].end<a)){if(this.requestedCache[d][e].start>b){this.requestedCache[d].splice(e,0,{start:a,end:b});break}this.requestedCache[d][e].start=Math.min(a,this.requestedCache[d][e].start),this.requestedCache[d][e].end=Math.max(b,this.requestedCache[d][e].end);break}},CameraRecordsProvider.prototype.getBlindSpotsInCache=function(a,b,c){if("undefined"==typeof this.requestedCache[c])return[{start:a,end:b}];for(var d=[],e=this.requestedCache[c],f=0;f<e.length&&(a<e[f].start&&d.push({start:a,end:e[f].start}),a=Math.max(a,e[f].end),!(b<e[f].end));f++);return d},CameraRecordsProvider.prototype.checkRequestedIntervalCache=function(a,b,c){if("undefined"==typeof this.requestedCache[c])return!1;for(var d=this.requestedCache[c],e=0;e<d.length;e++){if(a<d[e].start)return!1;if(a=Math.max(a,d[e].end),b<d[e].end)return!0}return a>=b},CameraRecordsProvider.prototype.requestInterval=function(a,b,c){var d=this.$q.defer();this.start=a,this.end=b,this.level=c;var e=RulerModel.levels[c].interval.getMilliseconds(),f=this;return f.lockRequests?d.reject("request in progress"):(f.lockRequests=!0,this.mediaserver.getRecords("/",this.cameras[0],a,b,e).then(function(e){f.lockRequests=!1;var g=e.data.reply;0==g.length,_.forEach(g,function(a){a.durationMs=parseInt(a.durationMs),a.startTimeMs=parseInt(a.startTimeMs)});for(var h=0;h<g.length;h++){var i=g[h].startTimeMs+g[h].durationMs;g[h].durationMs<0&&(i=(new Date).getTime()+1e5);var j=new Chunk(null,g[h].startTimeMs,i,c);f.addChunk(j,null)}f.cacheRequestedInterval(a,b,c),d.resolve(f.chunksTree)},function(a){d.reject(a)})),this.ready=d.promise,this.ready},CameraRecordsProvider.prototype.getIntervalRecords=function(a,b,c,d){a instanceof Date&&(a=a.getTime()),b instanceof Date&&(b=b.getTime());var e=[];this.selectRecords(e,a,b,c,null,d);var f=!d&&!this.checkRequestedIntervalCache(a,b,c);return f&&this.requestInterval(a,b,c),e},CameraRecordsProvider.prototype.debug=function(a){if(a||console.log("Chunks tree:"+(this.chunksTree?"":"empty")),a=a||this.chunksTree){a.debug();for(var b=0;b<a.children.length;b++)this.debug(a.children[b])}},CameraRecordsProvider.prototype.addChunk=function(a,b){if(null===this.chunksTree||0===a.level)return void(this.chunksTree=a);if(b=b||this.chunksTree,0===b.children.length)return b.level===a.level-1?void b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[0]));for(var c=0;c<b.children.length;c++){var d=b.children[c];if(!(d.end<a.start))return d.end>=a.end&&d.start<=a.start?void(d.level!=a.level&&this.addChunk(a,d)):d.start<a.end?(d.end=Math.max(d.end,a.end),d.start=Math.min(d.start,a.start),void(d.level!=a.level&&this.addChunk(a,d))):void(b.level==a.level-1?b.children.splice(c,0,a):(b.children.splice(c,0,new Chunk(b,a.start,a.end,b.level+1)),this.addChunk(a,b.children[c])))}b.level==a.level-1?b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),this.addChunk(a,b.children[c]))},CameraRecordsProvider.prototype.selectRecords=function(a,b,c,d,e,f){if(e=e||this.chunksTree,e&&!(e.end<=b||e.start>=c)){if(e.level==d)return void a.push(e);if(0==e.children.length&&!f)return void a.push(e);for(var g=0;g<e.children.length;g++)this.selectRecords(a,b,c,d,e.children[g]);var h=this.getBlindSpotsInCache(e.start,e.end,e.level+1);for(g=0;g<h.length;g++){var i=h[g];(i.start>=b||i.end<=c)&&a.push(i)}}},ShortCache.prototype.init=function(a){this.liveMode=!1,a||(this.liveMode=!0,a=(new Date).getTime()),this.start=a,this.playedPosition=a,this.played=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.update()},ShortCache.prototype.update=function(a,b){if(!this.updating||a){a=Math.round(a)||Math.round(this.playedPosition),this.updating=!0;var c=this;this.lastRequestDate=a,this.lastRequestPosition=b||this.played,this.mediaserver.getRecords("/",this.cameras[0],a,(new Date).getTime()+1e3,this.requestDetailization,this.limitChunks).then(function(b){c.updating=!1;var d=b.data.reply;_.forEach(d,function(a){a.durationMs=parseInt(a.durationMs),a.startTimeMs=parseInt(a.startTimeMs),-1==a.durationMs&&(a.durationMs=(new Date).getTime()-a.startTimeMs)}),0==d.length,d.length>0&&d[0].startTimeMs<a&&(d[0].durationMs+=d[0].startTimeMs-a,d[0].startTimeMs=a),c.currentDetailization=d;for(var e=c.lastRequestDate,f=c.lastRequestPosition,g=0,h=0;h<c.currentDetailization.length;h++)f+=c.currentDetailization[h].durationMs,e=c.currentDetailization[h].startTimeMs+c.currentDetailization[h].durationMs,e-g>c.checkpointsFrequency&&(g=e,c.checkPoints[f]=e)})}},ShortCache.prototype.checkPlayingDate=function(a){if(a<this.start)return!1;if(a>this.lastPlayedDate)return!1;var b;for(var c in this.checkPoints)if(this.checkPoints.hasOwnProperty(c)){if(this.checkPoints[c]>a)break;b=c}return"undefined"==typeof b?a-this.start:b+a-this.checkPoints[c]},ShortCache.prototype.setPlayingPosition=function(a){if(this.played=a,this.playedPosition=0,a<this.lastRequestPosition){var b;for(var c in this.checkPoints){if(c>a)break;b=c}this.playedPosition=b+a-this.checkPoints[b],this.update(this.checkPoints[b],b)}var d=a-this.lastRequestPosition;this.playedPosition=this.lastRequestDate+d;for(var e=0;e<this.currentDetailization.length&&(d-=this.currentDetailization[e].durationMs,this.playedPosition=this.currentDetailization[e].startTimeMs+this.currentDetailization[e].durationMs+d,!(0>=d));e++);return e==this.currentDetailization.length&&(this.playedPosition=(new Date).getTime(),this.liveMode=!0),!this.liveMode&&this.currentDetailization.length>0&&this.currentDetailization[this.currentDetailization.length-1].durationMs+this.currentDetailization[this.currentDetailization.length-1].startTimeMs<Math.round(this.playedPosition)+this.updateInterval&&(console.log("it's time to update",this.currentDetailization[this.currentDetailization.length-1].durationMs+this.currentDetailization[this.currentDetailization.length-1].startTimeMs,this.playedPosition+this.updateInterval),this.update()),a>this.lastPlayedPosition&&(this.lastPlayedPosition=a,this.lastPlayedDate=this.playedPosition),this.playedPosition},ScaleManager.prototype.updateTotalInterval=function(){this.maxMsPerPixel=(this.end-this.start)/this.viewportWidth,this.msPerPixel=Math.min(this.msPerPixel,this.maxMsPerPixel)},ScaleManager.prototype.setViewportWidth=function(a){this.viewportWidth=a,this.updateTotalInterval(),this.updateCurrentInterval()},ScaleManager.prototype.setStart=function(a){this.start=a,this.updateTotalInterval()},ScaleManager.prototype.setEnd=function(a){this.end=a,this.updateTotalInterval()},ScaleManager.prototype.bound=function(a,b,c){return b=Math.max(b,a),Math.min(b,c)},ScaleManager.prototype.updateCurrentInterval=function(){this.msPerPixel=this.bound(this.minMsPerPixel,this.msPerPixel,this.maxMsPerPixel),this.anchorPoint=this.bound(0,this.anchorPoint,1),this.anchorDate=this.bound(this.start,Math.round(this.anchorDate),this.end),this.visibleStart=Math.round(this.anchorDate-this.msPerPixel*this.viewportWidth*this.anchorPoint),this.visibleEnd=Math.round(this.anchorDate+this.msPerPixel*this.viewportWidth*(1-this.anchorPoint)),this.visibleStart<this.start&&(this.visibleEnd+=this.start-this.visibleStart,this.visibleStart=this.start),this.visibleEnd>this.end&&(this.visibleStart+=this.end-this.visibleEnd,this.visibleEnd=this.end),this.visibleStart>this.visibleEnd&&console.error("wtf! visibleStart > visibleEnd ?",new Date(this.visibleStart),new Date(this.visibleEnd)),this.updateLevels()},ScaleManager.prototype.stopWatching=function(){this.watchPlayingPosition=!1,this.wasForcedToStopWatchPlaying=!0},ScaleManager.prototype.releaseWatching=function(){this.wasForcedToStopWatchPlaying=!1},ScaleManager.prototype.watchPlaying=function(a){if(this.watchPlayingPosition=!0,this.wasForcedToStopWatchPlaying=!1,a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>1&&(b=.5),this.setAnchorDateAndPoint(a,b)}},ScaleManager.prototype.checkWatchPlaying=function(a,b){var c=this.dateToScreenCoordinate(a)/this.viewportWidth;this.anchorDate==a&&this.watchPlaying(a),c>=0&&1>=c&&this.watchPlaying(a),b&&c>1&&this.end-this.visibleEnd<this.stickToLiveMs&&this.watchPlaying(a)},ScaleManager.prototype.tryToSetLiveDate=function(a,b){this.anchorDate!=a&&(a>this.end&&this.setEnd(a),this.wasForcedToStopWatchPlaying||this.watchPlayingPosition||this.checkWatchPlaying(a,b),this.watchPlayingPosition&&this.setAnchorDateAndPoint(a,b?1:this.anchorPoint))},ScaleManager.prototype.tryToRestoreAnchorDate=function(a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>=0&&1>=b&&(this.anchorDate=a,this.anchorPoint=b)},ScaleManager.prototype.setAnchorCoordinate=function(a){this.setAnchorDateAndPoint(this.screenCoordinateToDate(a),a/this.viewportWidth)},ScaleManager.prototype.setAnchorDateAndPoint=function(a,b){this.anchorDate=a,"undefined"!=typeof b&&(this.anchorPoint=b),this.updateCurrentInterval()},ScaleManager.prototype.fullZoomOutValue=function(){return this.msToZoom(this.maxMsPerPixel)},ScaleManager.prototype.fullZoomInValue=function(){return this.msToZoom(this.minMsPerPixel)},ScaleManager.prototype.calcLevels=function(a){for(var b={},c=0;c<RulerModel.levels.length;c++){var d=RulerModel.levels[c],e=d.interval.getMilliseconds()/a;if("undefined"!=typeof d.topW&&e>=d.topW&&(b.top={index:c,level:d}),e>=d.width&&(b.labels={index:c,level:d}),e>=d.middleW&&(b.middle={index:c,level:d}),e>=d.smallW&&(b.small={index:c,level:d}),e>=d.marksW&&(b.marks={index:c,level:d}),b.events={index:c,level:d},1>=e)break}if(b.top.index==b.labels.index&&b.top.index>0)do b.top.index--,b.top.level=RulerModel.levels[b.top.index];while(!b.top.level.topW&&b.top.index);return b},ScaleManager.prototype.updateLevels=function(){this.levels=this.calcLevels(this.msPerPixel)},ScaleManager.prototype.alignStart=function(a){return a.interval.alignToPast(this.visibleStart)},ScaleManager.prototype.alignEnd=function(a){return a.interval.alignToFuture(this.visibleEnd)},ScaleManager.prototype.dateToScreenCoordinate=function(a){return Math.round(this.viewportWidth*(a-this.visibleStart)/(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.screenCoordinateToDate=function(a){return Math.round(this.visibleStart+a/this.viewportWidth*(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.getRelativeCenter=function(){return((this.visibleStart+this.visibleEnd)/2-this.start)/(this.end-this.start)},ScaleManager.prototype.getRelativeWidth=function(){return(this.visibleEnd-this.visibleStart)/(this.end-this.start)},ScaleManager.prototype.scroll=function(a){if("undefined"==typeof a)return this.getRelativeCenter();a=this.bound(0,a,1);var b=this.anchorDate;this.setAnchorDateAndPoint(this.start+a*(this.end-this.start),.5),this.tryToRestoreAnchorDate(b)},ScaleManager.prototype.scrollByPixels=function(a){this.scroll(this.scroll()+a/this.viewportWidth*this.getRelativeWidth())},ScaleManager.prototype.zoomToMs=function(a){var b=this.minMsPerPixel*Math.pow(this.absMaxMsPerPixel/this.minMsPerPixel,a);return this.bound(this.minMsPerPixel,b,this.maxMsPerPixel)},ScaleManager.prototype.msToZoom=function(a){var b=Math.log(a/this.minMsPerPixel)/Math.log(this.absMaxMsPerPixel/this.minMsPerPixel);return b},ScaleManager.prototype.targetLevels=function(a){var b=this.zoomToMs(a);return this.calcLevels(b)},ScaleManager.prototype.zoom=function(a){return"undefined"==typeof a?this.msToZoom(this.msPerPixel):(this.msPerPixel=this.zoomToMs(a),void this.updateCurrentInterval())},ScaleManager.prototype.zoomAroundDate=function(a,b){var c=this.anchorDate;this.tryToRestoreAnchorDate(b),this.zoom(a),this.tryToRestoreAnchorDate(c)},angular.module("webadminApp").factory("cameraRecords",["mediaserver","$q",function(a,b){return{getRecordsProvider:function(c,d){return new CameraRecordsProvider(c,a,b,d)},getPositionProvider:function(c){return new ShortCache(c,a,b)}}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").factory("animateScope",["$q",function(a){function b(b,c,d,e,f){this.scope=b,this.value=c,this.targetValue=d,this.duration=e,this.started=(new Date).getTime(),this.initialValue=b[c],this.isFinished=!1,this.dependency=f||i,this.deferred=a.defer()}function c(){var a=[],b=[];_.forEach(e,function(c){c.update(),b.indexOf(c.scope)<0&&c.scope!==h&&b.push(c.scope),c.isFinished&&a.push(c)}),_.forEach(a,function(a){e.splice(e.indexOf(a),1)}),_.forEach(b,function(a){a.$apply()})}function d(a){j&&(c(),"undefined"!=typeof k&&null!==k&&k!==!1&&k(),0!==f&&(window.animationFrame(d),f&&f--))}var e=[],f=null,g=1e3,h=null,i="linear";b.prototype.interpolate=function(a,b,c,d,e){switch(e){case"smooth":return this.smooth(a,b,c,d);case"fading":return this.fading(a,b,c,d);case"dryResistance":return this.dryResistance(a,b,c,d);case"linear":default:return this.linear(a,b,c,d)}},b.prototype.linear=function(a,b,c,d){c>d&&(c=d);var e=a+(b-a)*c/d;return isNaN(e)&&console.error("linear-error",e,a,b,c,d),e},b.prototype.smooth=function(a,b,c,d){c>d&&(c=d);var e=(Math.sin(c/d*Math.PI-Math.PI/2)+1)/2,f=a+(b-a)*e;return Number.isNaN(f)&&console.error("animation isNaN"),f},b.prototype.dryResistance=function(a,b,c,d){c>d&&(c=d);var e=c/d,f=e*(2-e),g=a+(b-a)*f;return g},b.prototype.fading=function(a,b,c,d){c>d&&(c=d);var e=Math.sin(c/d*Math.PI/2);return a+(b-a)*e},b.prototype.breakAnimation=function(){this.isFinished=!0,this.deferred.reject(this.scope[this.value])},b.prototype.update=function(){if(!this.isFinished){var a=(new Date).getTime()-this.started;this.scope[this.value]=this.interpolate(this.initialValue,this.targetValue,a,this.duration,this.dependency),this.deferred.notify(this.scope[this.value]),this.isFinished=a>this.duration,this.isFinished&&this.deferred.resolve(this.scope[this.value])}};var j=!1;window.animationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,20)}}();var k=null;return{start:function(a){j=!0,k=a,d(!0)},stop:function(){j=!1},process:function(){c()},animating:function(a,b){var c=_.find(e,function(c){return c.scope===a&&c.value===b});return c},animate:function(a,c,d,f,h){"undefined"==typeof h&&(h=g);var i=_.find(e,function(b){return b.scope===a&&b.value===c});i&&i.breakAnimation();var j=new b(a,c,d,h,f);return e.push(j),j.deferred.promise},progress:function(a,b,c,d){return a[b]=0,this.animate(a,b,1,c,d)},setDuration:function(a){g=a},setScope:function(a){h=a}}}]),angular.module("webadminApp").directive("navbar",function(){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavigationCtrl",scope:{noPanel:"="}}}),angular.module("webadminApp").directive("nxEqualEx",["$log",function(a){return{require:"ngModel",link:function(b,c,d,e){function f(){void 0!==e.$viewValue&&""!==e.$viewValue&&e.$setValidity("nxEqualEx",b.$eval(d.nxEqualEx)===e.$viewValue)}return d.nxEqualEx?(b.$watch(d.nxEqualEx,f),b.$watch("$viewValue",f),void e.$parsers.push(function(a){if(void 0===a||""===a)return e.$setValidity("nxEqualEx",!0),a;var c=a===b.$eval(d.nxEqualEx);return e.$setValidity("nxEqualEx",c),a})):void a.error("nxEqualEx expects a model as an argument!")}}}]),angular.module("webadminApp").directive("icon",function(){return{restrict:"E",scope:{"for":"="},template:"<span ng-if='for || onFalse' class='glyphicon glyphicon-{{for?onTrue:onFalse}} {{class}}' title='{{for?titleTrue:titleFalse}}'></span>",link:function(a,b,c){a.onTrue=c.onTrue||"ok",a.onFalse=c.onFalse,a["class"]=c["class"],a.titleTrue=c.titleTrue,a.titleFalse=c.titleFalse}}}),angular.module("webadminApp").directive("fileupload",function(){return{restrict:"E",template:"<span class='btn btn-success fileinput-button' ><span>{{text}}</span><input type='file' name='installerFile1' class='fileupload' id='fileupload' ></span><div class='progress' style='display:none;'><div class='progress-bar progress-bar-success progress-bar-striped'></div></div>",link:function(a,b,c){b.find(".fileupload").fileupload({url:c.url,dataType:"json",done:function(a,c){if("0"===c.result.error)alert("Updating successfully started. It will take several minutes");else switch(c.result.errorString){case"UP_TO_DATE":alert("Updating failed. The provided version is already installed.");break;case"INVALID_FILE":alert("Updating failed. Provided file is not a valid update archive.");break;case"INCOMPATIBLE_SYSTEM":alert("Updating failed. Provided file is targeted for another system.");break;case"EXTRACTION_ERROR":alert("Updating failed. Extraction failed, check available storage.");break;case"INSTALLATION_ERROR":alert("Updating failed. Couldn't execute installation script.")}b.find(".progress").hide()},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.find(".progress").show(),b.find(".progress-bar").css("width",d+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),a.text=c.text||"Select files"}}}),angular.module("webadminApp").directive("inplaceEdit",function(){return{restrict:"E",templateUrl:"views/inplace-edit.html",scope:{model:"=ngModel"},link:function(a,b,c){var d=a.model;a.type=c.type||"text",a.placeholder=c.placeholder,a.inputId=c.inputId,a.edit=function(){d=a.model,b.find("input").val(d),b.find(".read-container").hide(),b.find(".edit-container").show(),b.find("input").focus()},a.save=function(){d!==a.model&&a.$parent.$eval(c.nxOnsave),d=a.model,b.find(".read-container").show(),b.find(".edit-container").hide()},a.cancel=function(){a.model=d,a.$apply(),b.find(".read-container").show(),b.find(".edit-container").hide()},b.find(".edit-container").hide()}}}),angular.module("webadminApp").directive("timeline",["$interval","$timeout","animateScope",function(a,b,c){return{restrict:"E",scope:{recordsProvider:"=",positionProvider:"=",playHandler:"=",liveOnly:"=",canPlayLive:"=",ngClick:"&",positionHandler:"="},templateUrl:"views/components/timeline.html",link:function(a,b){function d(){a.viewportHeight=b.find(".viewport").height(),F.height=a.viewportHeight}function e(){a.viewportWidth=b.find(".viewport").width(),F.width=a.viewportWidth,a.scaleManager.setViewportWidth(a.viewportWidth)}function f(){var b=(new Date).getTime();a.scaleManager.setStart(a.recordsProvider&&a.recordsProvider.chunksTree?a.recordsProvider.start:b-C.initialInterval),a.scaleManager.setEnd(b),a.zoomTo(1)}function g(){a.positionProvider&&a.scaleManager.tryToSetLiveDate(a.positionProvider.playedPosition,a.positionProvider.liveMode),a.scaleManager.setEnd((new Date).getTime()),A();var b=j();k(b),l(b),q(b),s(b),t(b),u(b)}function h(a,b){if("string"==typeof a)return a;"undefined"==typeof b&&(b=1),b>1&&console.error("bad value",b),a.length>3&&(b*=a[3]);var c="rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+b+")";return c}function i(a){return a.weight+" "+Math.round(a.size)+"px "+a.face}function j(){var b=F.getContext("2d");return b.fillStyle=h(C.timelineBgColor,1),b.clearRect(0,0,a.viewportWidth,a.viewportHeight),b.lineWidth=C.lineWidth,b}function k(b){o(b,a.scaleManager.levels.top.index,a.scaleManager.levels.top.index,1,"topFormat",C.topLabelFixed,0,C.topLabelHeight,C.topLabelFont,C.topLabelAlign,C.topLabelBgColor,C.topLabelBgOddColor,C.topLabelMarkerColor,C.topLabelPositionFix,C.topLabelMarkerAttach,C.topLabelMarkerHeight)}function l(b){return C.oldStyle?void n(b,"format",C.labelFixed,C.topLabelHeight,C.labelHeight,C.labelFont,C.labelAlign,C.labelBgColor,C.labelBgColor,C.labelMarkerColor,C.labelMarkerAttach,C.levelsSettings):(o(b,H.labels.index,G.labels.index,a.zooming,"format",C.labelFixed,C.topLabelHeight,C.labelHeight,C.labelFont,C.labelAlign,C.labelBgColor,C.labelBgColor,C.labelMarkerColor,C.labelPositionFix,C.labelMarkerAttach,C.labelMarkerHeight),
void m(b))}function m(b){o(b,H.marks.index,G.marks.index,a.zooming,!1,"none",C.topLabelHeight,C.labelHeight,null,null,null,null,C.marksColor,0,C.marksAttach,C.marksHeight)}function n(b,c,d,e,f,g,h,i,j,k,l,m){function n(b,c){var d=a.zooming,e=o(c);return e>=b?null:G[c].index==H[c].index?null:G[c].index>H[c].index?1-d:d}function o(a){return Math.min(H[a].index,G[a].index)}function q(a){return Math.max(H[a].index,G[a].index)}function r(a){return a<=q("labels")?"labels":a<=q("middle")?"middle":a<=q("small")?"small":a<=q("marks")?"marks":"events"}function s(a){return a<=o("labels")?"labels":a<=o("middle")?"middle":a<=o("small")?"small":a<=o("marks")?"marks":"events"}function t(a,b,c){return b+a*(c-b)}for(var u=Math.max(a.scaleManager.levels.marks.index,G.marks.index),v=RulerModel.levels[u],w=a.scaleManager.alignStart(RulerModel.levels[u>0?u-1:0]),x=w,y=a.scaleManager.alignEnd(v),z=0;y>=x&&z++<3e3;){var A=i!=j||Math.round(x.getTime()/v.interval.getMilliseconds())%2===1,B=RulerModel.findBestLevelIndex(x,u),C=r(B),D=n(B,C),E=m[C].markSize,F=m[C].transparency,I=m[C].fontSize,J=m[C].labelPositionFix;if(null!==D){var K=s(B);E=t(D,E,m[K].markSize),F=t(D,F,m[K].transparency),I=t(D,I,m[K].fontSize),J=t(D,J,m[K].labelPositionFix)}g.size=I,p(b,x,v,F,c,d,e,f,g,h,A?i:j,k,J,l,E),x=v.interval.addToDate(x)}3e3==z&&console.error("counter problem!",w,x,y,v)}function o(b,c,d,e,f,g,h,i,j,k,l,m,n,o,q,r){for(var s=Math.max(c,d),t=RulerModel.levels[s],u=a.scaleManager.alignStart(t),v=a.scaleManager.alignStart(t),w=a.scaleManager.alignEnd(t),x=1e3;w>=v&&x-->0;){var y=Math.round(v.getTime()/t.interval.getMilliseconds())%2===1,z=RulerModel.findBestLevelIndex(v),A=1;z>d?A=1-e:z>c&&(A=e),p(b,v,t,A,f,g,h,i,j,k,y?l:m,n,o,q,r),v=t.interval.addToDate(v)}1>x&&console.error("problem!",u,v,w,t)}function p(b,c,d,e,f,g,j,k,l,m,n,o,p,q,r){var s=a.scaleManager.dateToScreenCoordinate(c);if(f){b.font=i(l);var t=d.interval.addToDate(c),u=a.scaleManager.dateToScreenCoordinate(t),v=g?d:RulerModel.findBestLevel(t),w=(dateFormat(new Date(t),v[f]),g?d:RulerModel.findBestLevel(c)),x=dateFormat(new Date(c),w[f]),y=b.measureText(x).width,z=j*a.viewportHeight+(k*a.viewportHeight-l.size)/2+l.size+p,A=0;switch(m){case"center":var B=Math.max(0,s),D=Math.min(u,a.viewportWidth),E=(B+D)/2;A=a.scaleManager.bound(s+C.labelPadding,E-y/2,u-y-C.labelPadding);break;case"left":A=a.scaleManager.bound(C.labelPadding,s+C.labelPadding,u-y-C.labelPadding);break;case"above":default:A=s-y/2}}var F="top"==q?j:j+k-r;if(n)switch(b.fillStyle=h(n,e),m){case"center":case"left":b.fillRect(s,j*a.viewportHeight,u-s,k*a.viewportHeight)}if(o&&(b.strokeStyle=h(o,e),b.beginPath(),b.moveTo(s+.5,F*a.viewportHeight),b.lineTo(s+.5,(F+r)*a.viewportHeight),b.stroke()),n)switch(b.fillStyle=h(n,e),m){case"center":case"left":break;case"above":default:b.clearRect(A,z-l.size,y,l.size)}f&&(b.fillStyle=h(l.color,e),b.fillText(x,A,z))}function q(b){var c=(C.topLabelHeight+C.labelHeight)*a.viewportHeight;if(M=K>c&&K<c+C.chunkHeight*a.viewportHeight,b){b.fillStyle=h(C.chunksBgColor,1),b.fillRect(0,c,a.viewportWidth,C.chunkHeight*a.viewportHeight);var d=a.scaleManager.levels.events.level,e=a.scaleManager.levels.events.index,f=a.scaleManager.alignStart(d),g=a.scaleManager.alignEnd(d);if(a.recordsProvider&&a.recordsProvider.chunksTree)for(var i=a.recordsProvider.getIntervalRecords(f,g,e),j=0;j<i.length;j++)r(b,i[j],e)}}function r(b,c,d,e,f){var g=a.scaleManager.dateToScreenCoordinate(c.start),i=a.scaleManager.dateToScreenCoordinate(c.end),j=d==c.level,k=1;b.fillStyle=j?h(C.exactChunkColor,k):h(C.loadingChunkColor,k),e&&f==d&&(b.fillStyle=h(C.highlighChunkColor,1)),c.level||(b.fillStyle=h(C.blindChunkColor,1));var l=(C.topLabelHeight+C.labelHeight)*a.viewportHeight,m=C.chunkHeight*a.viewportHeight;e&&(l+=(1+d)/RulerModel.levels.length*m,m/=RulerModel.levels.length,m>5&&console.log(m)),b.fillRect(g-C.minChunkWidth/2,l,i-g+C.minChunkWidth/2,m)}function s(b){var c=(C.topLabelHeight+C.labelHeight+C.chunkHeight)*a.viewportHeight,d=a.scaleManager.getRelativeCenter(),e=a.scaleManager.getRelativeWidth();I=Math.max(a.viewportWidth*e,C.minScrollBarWidth);var f=a.scaleManager.bound(0,a.viewportWidth*d-I/2,a.viewportWidth-I);return O=K>=c,L=J>=f&&f+I>=J&&K>=c,b?(b.fillStyle=h(C.scrollBarBgColor,1),b.fillRect(0,c,a.viewportWidth,C.scrollBarHeight*a.viewportHeight),b.fillStyle=L||P?h(C.scrollBarHighlightColor,1):h(C.scrollBarColor,1),b.fillRect(f,c,I,C.scrollBarHeight*a.viewportHeight),void 0):(L||P?(L=J-f,N=!1):N=J,O&&(O=J-f),L)}function t(b){a.positionProvider&&!a.positionProvider.liveMode&&v(b,a.positionProvider.playedPosition,C.timeMarkerColor,C.timeMarkerTextColor)}function u(b){J&&M&&v(b,a.scaleManager.screenCoordinateToDate(J),C.pointerMarkerColor,C.pointerMarkerTextColor)}function v(b,c,d,e){var f=a.scaleManager.dateToScreenCoordinate(c);if(!(0>f||f>a.viewportWidth)){c=new Date(c);var g=C.markerHeight*a.viewportHeight;b.strokeStyle=h(d,1),b.fillStyle=h(d,1);var j=(C.topLabelHeight+C.labelHeight)*a.viewportHeight;b.beginPath(),b.moveTo(f+.5,j),b.lineTo(f+.5,Math.round(a.viewportHeight-C.scrollBarHeight*a.viewportHeight)),b.stroke();var k=f-C.markerWidth/2;0>k&&(k=0),k>a.viewportWidth-C.markerWidth&&(k=a.viewportWidth-C.markerWidth),b.fillRect(k,0,C.markerWidth,g),b.beginPath(),b.moveTo(f+C.markerTriangleHeight*a.viewportHeight+.5,g),b.lineTo(f+.5,g+C.markerTriangleHeight*a.viewportHeight),b.lineTo(f-C.markerTriangleHeight*a.viewportHeight+.5,g),b.closePath(),b.fill(),b.fillStyle=h(e,1),b.font=i(C.markerDateFont),f=k+C.markerWidth/2;var l=dateFormat(c,C.dateFormat),m=b.measureText(l).width,n=(g-C.markerDateFont.size)/2;b.fillText(l,f-m/2,n),b.font=i(C.markerTimeFont),l=dateFormat(c,C.timeFormat),m=b.measureText(l).width,n=g/2+n,b.fillText(l,f-m/2,n)}}function w(a){return a?(J=$(a.target).is("canvas")&&a.offsetX?a.offsetX:a.pageX-$(F).offset().left,K=a.offsetY||a.pageY-$(F).offset().top,s(),void q()):(K=0,J=null,L=!1,O=!1,M=!1,void(N=!1))}function x(b){w(b),b.preventDefault(),Math.abs(b.deltaY)>Math.abs(b.deltaX)?(window.jscd.touch?R=a.scaleManager.zoom()-b.deltaY/C.maxVerticalScrollForZoomWithTouch:(R||(R=a.scaleManager.zoom()),R-=b.deltaY/C.maxVerticalScrollForZoom),a.zoomTo(R,a.scaleManager.screenCoordinateToDate(J),window.jscd.touch)):(a.scaleManager.scrollByPixels(b.deltaX),y()),a.$apply()}function y(){S?clearTimeout(S):a.scaleManager.stopWatching(),S=setTimeout(function(){a.scaleManager.releaseWatching(),S=null},C.animationDuration)}function z(b){y(),c.animate(a,"scrollPosition",b).then(function(){},function(){},function(b){a.scaleManager.scroll(b)})}function A(){U&&a.zoom(V,!0,!1)}function B(a,b){return a.labels.index!=b.labels.index?!0:a.middle.index!=b.middle.index?!0:a.small.index!=b.small.index?!0:a.marks.index!=b.marks.index?!0:!1}var C={initialInterval:36e5,stickToLiveMs:1e3,maxMsPerPixel:31536e6,minMsPerPixel:1,zoomSpeed:.025,slowZoomSpeed:.01,maxVerticalScrollForZoom:250,maxVerticalScrollForZoomWithTouch:5e3,animationDuration:300,levelsSettings:{labels:{markSize:15/110,transparency:1,fontSize:14,labelPositionFix:5},middle:{markSize:10/110,transparency:.75,fontSize:13,labelPositionFix:0},small:{markSize:5/110,transparency:.5,fontSize:11,labelPositionFix:-5},marks:{markSize:5/110,transparency:.25,fontSize:0,labelPositionFix:-10},events:{markSize:0,transparency:0,fontSize:0,labelPositionFix:-15}},timelineBgColor:[28,35,39,.6],font:"Roboto",labelPadding:10,lineWidth:1,chunkHeight:30/110,minChunkWidth:1,chunksBgColor:[34,57,37],exactChunkColor:[58,145,30],loadingChunkColor:[58,145,30,.5],blindChunkColor:[255,128,128,.5],highlighChunkColor:[255,255,0,1],scrollBarSpeed:.1,scrollBarHeight:20/110,minScrollBarWidth:50,scrollBarBgColor:[28,35,39],scrollBarColor:[53,70,79],scrollBarHighlightColor:[53,70,79,.8],timeMarkerColor:[215,223,227],timeMarkerTextColor:[12,21,23],pointerMarkerColor:[12,21,23],pointerMarkerTextColor:[255,255,255],markerDateFont:{size:15,weight:400,face:"Roboto"},markerTimeFont:{size:17,weight:500,face:"Roboto"},markerWidth:140,markerHeight:50/110,markerTriangleHeight:6/110,dateFormat:"d mmmm yyyy",timeFormat:"HH:MM:ss",scrollBoundariesPrecision:1e-6,scrollingSpeed:.25,end:0};a.timelineConfig=C;var D={topLabelAlign:"center",topLabelHeight:30/110,topLabelFont:{size:17,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerAttach:"top",topLabelMarkerHeight:.5,topLabelBgColor:!1,topLabelBgOddColor:!1,topLabelPositionFix:0,topLabelFixed:!0,oldStyle:!1,labelAlign:"above",labelHeight:30/110,labelFont:{size:15,weight:400,face:"Roboto",color:[105,135,150]},labelMarkerAttach:"bottom",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],labelPositionFix:-5,labelMarkerHeight:.2,labelFixed:!0,marksAttach:"bottom",marksHeight:10/110,marksColor:[83,112,127,.4]};a.presets=[{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[53,70,79,0],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,0]},{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,0]},{topLabelAlign:"left",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"left",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],oldStyle:!1,marksColor:[83,112,127,.4]},{topLabelAlign:"center",topLabelHeight:20/110,topLabelFont:{size:12,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerHeight:20/110,topLabelMarkerAttach:"top",topLabelBgColor:[33,42,47],topLabelBgOddColor:[43,56,63],topLabelPositionFix:0,topLabelFixed:!0,labelAlign:"above",labelHeight:40/110,labelFont:{size:15,weight:400,face:"Roboto",color:[105,135,150]},labelMarkerAttach:"top",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],labelPositionFix:5,labelMarkerHeight:20/110,labelFixed:!1,marksAttach:"top",marksHeight:10/110,marksColor:[83,112,127,.4],oldStyle:!0}],a.selectPreset=function(b){a.activePreset=b,a.timelineConfig=$.extend(a.timelineConfig,D,b)},a.selectPreset(a.presets[3]);var E=b.find(".viewport"),F=b.find("canvas").get(0);a.scaleManager=new ScaleManager(C.minMsPerPixel,C.maxMsPerPixel,C.initialInterval,100,C.stickToLiveMs),a.changingLevel=1;var G=a.scaleManager.levels,H={events:{index:0},labels:{index:0},middle:{index:0},small:{index:0},marks:{index:0}},I=0,J=null,K=0,L=!1,M=!1,N=!1,O=!1,P=!1,Q=!1,R=0,S=null,T=!1;a.dblClick=function(b){w(b),T||(O?L||z(O>0?1:0):(a.scaleManager.setAnchorCoordinate(J),a.zoom(!0)))},a.click=function(b){if(w(b),!T)if(O)L||(a.scrollPosition=a.scaleManager.scroll(),z(J/a.viewportWidth));else{a.scaleManager.setAnchorCoordinate(J);var c=a.scaleManager.screenCoordinateToDate(J);a.positionHandler(a.scaleManager.screenCoordinateToDate(J)),a.scaleManager.watchPlaying(c)}},a.mouseUp=function(a){},a.mouseLeave=function(a){},a.mouseMove=function(a){w(a)},a.mouseDown=function(a){},a.draginit=function(b){w(b),P=L,Q=N,a.scaleManager.stopWatching()},a.drag=function(b){if(w(b),P){var c=L-P;a.scaleManager.scroll(a.scaleManager.scroll()+c/a.viewportWidth)}if(Q){var c=Q-N;Q=N,a.scaleManager.scrollByPixels(c)}},a.drastart=function(a){},a.dragend=function(b){P=!1,Q=!1,a.scaleManager.releaseWatching(),T=!0,setTimeout(function(){T=!1},C.animationDuration),w(null)},$(F).drag("draginit",a.draginit),$(F).drag("dragstart",a.drastart),$(F).drag("drag",a.drag),$(F).drag("dragend",a.dragend),$(F).bind("touchstart",a.draginit),$(F).bind("touchmove",a.drag),$(F).bind("touchend",a.dragend),$(F).bind("touchcancel",a.dragend),a.zoom=function(b,c,d){var e=a.scaleManager.zoom()-(b?1:-1)*(c?C.slowZoomSpeed:C.zoomSpeed);a.zoomTo(e,null,!1,d)};var U=!1,V=!1;a.stopZoom=function(b){U&&(U=!1,a.zoom(V,!0,!0))},a.startZoom=function(b){a.disableZoomOut&&!b||a.disableZoomIn&&b||(U=!0,V=b,A())},a.zooming=1,a.zoomTo=function(b,d,e,f){function g(b){d?a.scaleManager.zoomAroundDate(b,d):a.scaleManager.zoom(b),y()}var h=a.scaleManager.fullZoomOutValue();b>=h?(b=h,a.disableZoomOut=!0):a.disableZoomOut=!1;var i=a.scaleManager.fullZoomInValue();i>=b?(b=i,a.disableZoomIn=!0):a.disableZoomIn=!1;var j=a.scaleManager.targetLevels(b);B(j,G)&&(G=j,1==a.zooming&&(a.zooming=0),c.animate(a,"zooming",1,"dryResistance").then(function(){H=a.scaleManager.levels},function(){})),e?(g(b),a.zoomTarget=a.scaleManager.zoom()):(a.zoomTarget||(a.zoomTarget=a.scaleManager.zoom()),y(),c.animate(a,"zoomTarget",b,f?"linear":"dryResistance").then(function(){},function(){},g))},a.goToLive=function(){if(a.positionProvider.liveMode)return void a.scaleManager.watchPlaying();var b=a.scaleManager.screenCoordinateToDate(1);c.progress(a,"goingToLive").then(function(){var b=(new Date).getTime();a.scaleManager.setAnchorDateAndPoint(b,1),a.scaleManager.watchPlaying()},function(){},function(c){var d=b+c*((new Date).getTime()-b);a.scaleManager.setAnchorDateAndPoint(d,1)}),a.scaleManager.liveMode||a.positionHandler(!1)},a.playPause=function(){a.positionProvider.playing||a.scaleManager.watchPlaying(),a.playHandler(!a.positionProvider.playing)},$(window).resize(e),a.$watch("recordsProvider",function(){a.recordsProvider&&(a.recordsProvider.ready.then(f),a.recordsProvider.archiveReadyPromise.then(function(b){a.emptyArchive=!b}))}),E.mousewheel(x),d(),e(),f(),c.setDuration(C.animationDuration),c.setScope(a),c.start(g),a.$on("$destroy",function(){c.stop()})}}}]),angular.module("webadminApp").directive("object",function(){return{restrict:"E",scope:{ngParam:"=",ngSource:"=",ngName:"="},link:function(a,b,c){var d=b,e=b.clone().attr("data",a.ngSource),f="",g="";_.forEach(a.ngParam,function(a,b){f+='<param name="'+b+'" value="'+a+'">',g+=b+'="'+a+'" '}),d.replaceWith(e.html(f+='<embed  width="100%" height="100%" id="'+a.ngName+'" name="'+a.ngName+'" src="'+a.ngSource+'" '+g+"></embed>"))}}}),angular.module("webadminApp").directive("videowindow",["$interval","$timeout","animateScope",function(a,b,c){return{restrict:"E",scope:{vgUpdateTime:"&",vgPlayerReady:"&",vgSrc:"="},templateUrl:"views/components/videowindow.html",link:function(a,b){function c(b){var c=_.find(a.vgSrc,function(a){return a.type==j[b]});return c?c.src:null}function d(){function b(a){var b=!1,c=document.createElement("video");return c.canPlayType&&c.canPlayType(j[a]).replace(/no/,"")&&(b=!0),b}a.flashRequired=!1,a.noArmSupport=!1,a.noFormat=!1;var c=_.find(a.vgSrc,function(a){return a.type==j.webm}),d=_.find(a.vgSrc,function(a){return a.type==j.hls}),e=_.find(a.vgSrc,function(a){return a.type==j.rtsp});if(c&&b("webm"))return"webm";if(d&&b("hls"))return"native-hls";if("Android"==window.jscd.os)return c?"webm":(a.noArmSupport=!0,!1);if(window.jscd.mobile&&d)return"native-hls";switch(window.jscd.browser){case"Microsoft Internet Explorer":return c&&(a.ieNoWebm=!0),d&&"-"!=window.jscd.flashVersion?"flashls":d?(a.flashRequired=!0,!1):c?(a.edgeNoWebm=!0,!1):(a.noFormat=!0,!1);case"Safari":if(d)return"native-hls";case"Chrome":case"Firefox":case"Opera":case"Webkit":default:return d&&"-"!=window.jscd.flashVersion?"flashls":e&&"-"!=window.jscd.flashVersion?"rtsp":d?(a.flashRequired=!0,!1):(a.noFormat=!0,!1)}}function e(c){k!=c&&(b.find(".videoplayer").html(""),a.vgPlayerReady({$API:null})),k=c}function f(d){nativePlayer.init(b.find(".videoplayer"),function(b){a.vgApi=b,a.vgSrc&&(a.vgApi.load(c(d),j[d]),a.vgApi.addEventListener("timeupdate",function(b,c,d){a.vgUpdateTime({$currentTime:b.srcElement.currentTime,$duration:b.srcElement.duration}),a.loading&&(a.loading=!1)})),a.vgPlayerReady({$API:a.vgApi})},function(a){console.error("some error")})}function g(){a.flashls=!0,a.flashSource="components/flashlsChromeless.swf",a.flashParam=flashlsAPI.flashParams(),flashlsAPI.ready()?flashlsAPI.load(c("hls")):flashlsAPI.init("videowindow",function(b){a.vgApi=b,a.vgSrc&&a.vgApi.load(c("hls")),a.vgPlayerReady({$API:b})},function(b){a.errorLoading=!0,a.loading=!1,a.flashls=!1,a.$digest(),console.error(b)},function(b,c){a.loading=!1,a.vgUpdateTime({$currentTime:b,$duration:c})})}function h(){jshlsAPI.init(b.find(".videoplayer"),function(b){a.vgApi=b,a.vgSrc&&a.vgApi.load(c("hls")),a.vgPlayerReady({$API:b})},function(a){console.error("some error")})}function i(){var b=new Locomote("videowindow","components/Player.swf");b.on("apiReady",function(){a.vgApi=b,a.vgApi.load||(a.vgApi.load=a.vgApi.play,a.vgApi.play=function(){a.vgApi.load(c("rtsp"))}),b.on("streamStarted",function(){}),b.on("error",function(a){console.error(a)}),a.vgSrc&&a.vgApi.play(a.vgSrc[2].src),a.vgPlayerReady({$API:api})})}var j={hls:"application/x-mpegURL",webm:"video/webm",rtsp:"application/x-rtsp",flv:"video/x-flv",mp4:"video/mp4"},k=null;b.bind("contextmenu",function(){return!1}),a.$watch("vgSrc",function(){if(a.errorLoading=!1,a.vgSrc){var b=d();switch(a.loading=!!b,e(b),b){case"flashls":g();break;case"jshls":h();break;case"rtsp":i();break;case"native-hls":f("hls");break;case"webm":default:f(b)}}})}}}]),angular.module("webadminApp").controller("MainCtrl",["$scope",function(a){a.config=Config}]),angular.module("webadminApp").controller("NavigationCtrl",["$scope","$location","mediaserver","ipCookie",function(a,b,c,d){a.user={isAdmin:!0},c.checkAdmin().then(function(b){a.user={isAdmin:b}}),c.getSettings().then(function(b){a.settings=b.data.reply,a.settings.remoteAddresses=a.settings.remoteAddresses.join("\n")}),a.isActive=function(a){var c=b.path().split("/")[1];return c.split("?")[0]===a.split("/")[1].split("?")[0]},a.logout=function(){d.remove("auth",{path:"/"}),d.remove("nonce",{path:"/"}),d.remove("realm",{path:"/"}),window.location.reload()},a.webclientEnabled=Config.webclientEnabled,a.alertVisible=!a.isActive("/view"),a.closeAlert=function(){a.alertVisible=!1}}]),angular.module("webadminApp").controller("SettingsCtrl",["$scope","$modal","$log","mediaserver","$location","$timeout",function(a,b,c,d,e,f){function g(c){b.open({templateUrl:"views/restart.html",controller:"RestartCtrl",resolve:{port:function(){return c?a.settings.port:null}}})}function h(){return alert("Connection error"),!1}function i(b){var c=b.data;if("0"!==c.error){var d=c.errorString;switch(d){case"UNAUTHORIZED":case"password":case"PASSWORD":d="Wrong password."}alert("Error: "+d)}else c.reply.restartNeeded?confirm("All changes saved. New settings will be applied after restart. \n Do you want to restart server now?")&&g(!0):(alert("Settings saved"),a.settings.port!==window.location.port?window.location.href=window.location.protocol+"//"+window.location.hostname+":"+a.settings.port:window.location.reload())}function j(b,c){var e=b.networkAddresses.split(";"),f=b.apiUrl.substring(b.apiUrl.lastIndexOf(":")),g=window.location.protocol+"//"+e[c]+f;d.getSettings(g).then(function(){b.apiUrl=g},function(){return c<e.length-1?j(b,c+1):(b.status="Unavailable",a.mediaServers=_.sortBy(a.mediaServers,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id})),!1})}d.checkAdmin().then(function(a){return a?void 0:void e.path("/info")}),d.getSettings().then(function(b){a.settings={systemName:b.data.reply.systemName,port:b.data.reply.port,id:b.data.reply.id},a.oldSystemName=b.data.reply.systemName,a.oldPort=b.data.reply.port}),a.password="",a.oldPassword="",a.confirmPassword="",a.openJoinDialog=function(){var e=b.open({templateUrl:"views/join.html",controller:"JoinCtrl",resolve:{items:function(){return a.settings}}});e.result.then(function(a){c.info(a),d.mergeSystems(a.url,a.password,a.currentPassword,a.keepMySystem).then(function(a){if("0"!==a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":case"PASSWORD":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version.";break;case"url":case"URL":b="Wrong url."}alert("Merge failed: "+b)}else alert("Merge succeed."),window.location.reload()})})},a.save=function(){a.settingsForm.$valid?(a.oldSystemName===a.settings.systemName||confirm('If there are others servers in local network with "'+a.settings.systemName+'" system name then it could lead to this server settings loss. Continue?')||(a.settings.systemName=a.oldSystemName),(a.oldSystemName!==a.settings.systemName||a.oldPort!==a.settings.port)&&d.saveSettings(a.settings.systemName,a.settings.port).then(i,h)):alert("form is not valid")},a.changePassword=function(){a.password===a.confirmPassword&&d.changePassword(a.password,a.oldPassword).then(i,h)},a.restart=function(){confirm("Do you want to restart server now?")&&g(!1)},d.getMediaServers().then(function(b){a.mediaServers=_.sortBy(b.data,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id}),f(function(){_.each(a.mediaServers,function(a){var b=0;j(a,b)})},1e3)})}]),angular.module("webadminApp").controller("JoinCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){a.settings={url:"",password:"",currentPassword:"",keepMySystem:!0},a.systems={joinSystemName:"NOT FOUND",systemName:"SYSTEMNAME",systemFound:!1},d.getSettings().then(function(b){a.systems.systemName=b.data.reply.systemName,d.discoveredPeers().then(function(b){var c=_.map(b.data.reply,function(a){return{url:window.location.protocol+"//"+a.remoteAddresses[0]+":"+a.port,systemName:a.systemName,ip:a.remoteAddresses[0],name:a.name}});a.systems.discoveredUrls=_.filter(c,function(b){return b.systemName!==a.systems.systemName})})}),a.test=function(){d.pingSystem(a.settings.url,a.settings.password).then(function(b){if("0"!==b.data.error){var c=b.data.errorString;switch(c){case"FAIL":c="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":c="Wrong password.";break;case"INCOMPATIBLE":c="Found system has incompatible version.";break;case"url":c="Wrong url."}alert("Connection failed: "+c)}else a.systems.systemFound=!0,a.systems.joinSystemName=b.data.reply.systemName})},a.join=function(){b.close({url:a.settings.url,password:a.settings.password,keepMySystem:a.settings.keepMySystem,currentPassword:a.settings.currentPassword})},a.selectSystem=function(b){a.settings.url=b.url},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").controller("LoginCtrl",["$scope","mediaserver","ipCookie",function(a,b,c){function d(){return a.authorized=!0,a.authorizing=!1,setTimeout(function(){window.location.reload()},20),!1}a.authorized=!1,a.authorizing=!1,a.user||(a.user={username:"",password:""}),a.login=function(){if(a.loginForm.$valid){var e=a.user.username.toLowerCase(),f=c("realm"),g=c("nonce"),h=md5(e+":"+f+":"+a.user.password),i=md5("GET:"),j=md5(h+":"+g+":"+i),k=Base64.encode(e+":"+g+":"+j);c("auth",k,{path:"/"});var l=md5("PLAY:"),m=md5(h+":"+g+":"+l),n=Base64.encode(e+":"+g+":"+m);c("auth_rtsp",n,{path:"/"}),a.authorizing=!0,b.getCurrentUser(!0).then(d)["catch"](function(b){a.authorizing=!1,alert("Login or password is incorrect")})}}}]),angular.module("webadminApp").controller("AdvancedCtrl",["$scope","$modal","$log","mediaserver","$location",function(a,b,c,d,e){function f(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}d.checkAdmin().then(function(a){a||e.path("/info")}),a.someSelected=!1,a.reduceArchiveWarning=!1,d.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return f(a.url)});for(var c=0;c<a.storages.length;c++)a.storages[c].reservedSpaceGb=Math.round(a.storages[c].reservedSpace/1073741824),a.storages[c].url=f(a.storages[c].url);a.$watch(function(){a.reduceArchiveWarning=!1,a.someSelected=!1;for(var b in a.storages){var c=a.storages[b];c.reservedSpace=1073741824*c.reservedSpaceGb,a.someSelected=a.someSelected||c.isUsedForWriting&&c.isWritable,c.reservedSpace>c.freeSpace&&(a.reduceArchiveWarning=!0)}})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]},a.toGBs=function(a){return Math.floor(a/1073741824)},a.update=function(){},a.save=function(){var b,c=!1;_.each(a.storages,function(a){b=b||a.isUsedForWriting,a.reservedSpace>a.freeSpace&&(c="Set reserved space is greater than free space left. Possible partial remove of the video footage is expected. Do you want to continue?")}),b||(c="No storages were selected for writing - video will not be recorded on this server. Do you want to continue?"),(!c||confirm(c))&&d.getSettings().then(function(b){d.getMediaServer(b.data.reply.id.replace("{","").replace("}","")).then(function(b){var c=b.data[0];_.each(a.storages,function(a){var b=_.findWhere(c.storages,{id:a.storageId});null!==b&&(b.spaceLimit=a.reservedSpace,b.usedForWriting=a.isUsedForWriting)}),d.saveStorages(c.storages).then(function(a){if("undefined"!=typeof a.error&&"0"!==a.error){var b=a.errorString;alert("Error: "+b)}else alert("Settings saved")},function(){alert("Error: Couldn't save settings")})})})},a.cancel=function(){window.location.reload()}}]),angular.module("webadminApp").controller("InfoCtrl",["$scope","mediaserver",function(a,b){function c(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}a.logUrl=b.logUrl(),b.getSettings().then(function(b){a.settings=b.data.reply}),b.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return c(a.url)}),_.each(a.storages,function(a){a.url=c(a.url)})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]}}]),angular.module("webadminApp").controller("RestartCtrl",["$scope","$modalInstance","$interval","mediaserver","port",function(a,b,c,d,e){function f(){return window.location.href=h,!1}function g(){var b=j?d.getSettings(h):d.statistics(h);b.then(function(b){return j||b.data.reply.uptimeMs<i?(a.state="server is starting",f()):(a.state="server is restarting",i=b.data.reply.uptimeMs,void setTimeout(g,1e3))},function(){return a.state="server is offline",j=!0,setTimeout(g,1e3),!1})}e=e||window.location.port,a.state="";var h=window.location.protocol+"//"+window.location.hostname+":"+e;a.url=h+window.location.pathname+window.location.search;var i=Number.MAX_VALUE,j=!1;a.refresh=f,d.statistics().then(function(a){i=a.data.reply.uptimeMs,d.restart().then(function(){g()},function(){return g(),!1})},function(){return a.state="server is offline",setTimeout(g,1e3),!1})}]),angular.module("webadminApp").controller("SdkeulaCtrl",["$scope",function(a){a.agree=!1,a.next=function(){return window.open("sdk.zip"),!1}}]),angular.module("webadminApp").controller("OfflineCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){function e(){return window.location.reload(),!1}function f(){var a=d.getSettings(!0);a.then(function(){return e()},function(){return setTimeout(f,1e3),!1})}a.refresh=e,a.state="server is offline",setTimeout(f,1e3)}]),angular.module("webadminApp").controller("WebclientCtrl",function(){}),angular.module("webadminApp").controller("ViewCtrl",["$scope","$rootScope","$location","$routeParams","mediaserver","cameraRecords","$timeout","$q",function(a,b,c,d,e,f,g,h){function i(a){var b=document.createElement("video");return b.canPlayType&&b.canPlayType(C[a]).replace(/no/,"")?!0:"hls"==a?"-"!=window.jscd.flashVersion:!1}function j(b){return a.activeCamera?_.find(a.activeCamera.mediaStreams,function(a){return a.transports.indexOf(b)>0}):null}function k(a){return j(a)&&i(a)}function l(){a.activeCamera||(a.activeResolution="Auto",a.availableResolutions=["Auto"]),k("webm")?a.availableResolutions=z:a.availableResolutions=A,a.availableResolutions.indexOf(a.activeResolution)<0&&(a.activeResolution=a.availableResolutions[0])}function m(b){return a.mediaServers?_.find(a.mediaServers,function(a){return a.id===b}):null}function n(b){if(!a.cameras)return null;for(var c in a.cameras){var d=_.find(a.cameras[c],function(a){return a.id===b});if(d)return d}return null}function o(b){var c=!b;if(a.positionProvider){a.positionProvider.init(b),c&&(b=(new Date).getTime());var d=a.activeCamera.physicalId,f="",g="rtsp://"+window.location.host,h=e.mediaDemo();h&&(f=h,g="rtsp:"+h);var i="&auth="+e.authForMedia(),j="&auth="+e.authForRtsp(),l=c?"":"&pos="+b,m=c?"":"&startTimestamp="+b;a.acitveVideoSource=_.filter([{src:f+"/hls/"+d+".m3u8?"+a.activeResolution+m+i,type:C.hls,transport:"hls"},{src:f+"/media/"+d+".webm?resolution="+a.activeResolution+l+i,type:C.webm,transport:"webm"},{src:g+"/"+d+"?"+l+j+"&stream="+("lo"==a.activeResolution?1:0),type:C.rtsp,transport:"rtsp"}],function(b){return k(b.transport)&&"Auto"==a.activeFormat||a.activeFormat==b.type})}}function p(a){return a=a.split("/")[2]||a.split("/")[0],a.split(":")[0].split("?")[0]}function q(a){var b=0;if(a.url){for(var c=a.url.split("."),d=0;d<c.length;d++){var e=3-d;b+=parseInt(c[d])%256*Math.pow(256,e)}isNaN(b)?b=a.url:(b=b.toString(16),b.length<8&&(b="0"+b))}return a.name+"__"+b}function r(){var b=h.defer();return e.getCameras().then(function(c){function d(a){return a.typeId==G?!1:v?!0:y?y.indexOf(a.id)>=0:!1}function f(a){a.url=p(a.url),a.preview=e.previewUrl(a.physicalId,!1,null,256),a.server=m(a.parentId),"Offline"==a.server.status&&(a.status="Offline");var b=_.find(a.addParams,i);return a.mediaStreams=b?JSON.parse(b.value).streams:[],q(a)}function g(a){var b=n(a.id);return b?($.extend(b,a),!1):!0}var h=c.data,i=function(a){return"mediaStreams"==a.name};h=_.filter(h,d),h=_.sortBy(h,f);var j=_.groupBy(h,function(a){return a.parentId});if(a.cameras){for(var k in a.cameras){for(var l=a.cameras[k],o=j[k],r=0;r<l.length;r++)_.find(o,function(a){return a.id==l[r].id})||(l.splice(r,1),r--);var o=_.filter(o,g);_.forEach(o,function(a){l.push(a)})}for(var k in j)a.cameras[k]||(a.cameras[k]=j[k])}else a.cameras=j;b.resolve(h)},function(a){b.reject(a)}),b.promise}function s(){function b(a){return a.url=p(a.url),q(a)}function c(a){var b=m(a.id);return a.collapsed=b?b.collapsed:"Online"!==a.status&&(a.allowAutoRedundancy||a.flags.indexOf("SF_Edge")<0),b&&$.extend(b,a),!b}var d=h.defer();return e.getMediaServers().then(function(e){if(a.mediaServers){for(var f=e.data,g=0;g<a.mediaServers.length;g++)_.find(f,function(b){return b.id==a.mediaServers[g].id})||(a.mediaServers.splice(g,1),g--);var h=_.filter(f,c);_.forEach(_.sortBy(h,b),function(b){a.mediaServers.push(b)})}else a.mediaServers=_.sortBy(e.data,b);r().then(function(a){d.resolve(a)},function(a){d.reject(a)})},function(a){d.reject(a)}),d.promise}function t(){s().then(function(){a.selectCameraById(a.cameraId,c.search().time||!1,!E),E=!1,F=g(t,B)},function(a){console.error(a)})}function u(){e.getResourceTypes().then(function(a){G=_.find(a.data,function(a){return"SERVER_DESKTOP_CAMERA"==a.name}),G=G?G.id:null,t()})}a.playerApi=!1,a.cameras={},a.liveOnly=!0,a.cameraId=a.cameraId||d.cameraId||null,a.activeCamera=null;var v=!1,w=!1,x=!1,y=null;a.activeResolution="Auto";var z=["Auto","1080p","720p","640p","320p","240p"],A=["Auto","hi","lo"],B=5e3,C={hls:"application/x-mpegURL",webm:"video/webm",rtsp:"application/x-rtsp",flv:"video/x-flv",mp4:"video/mp4",mjpeg:"video/x-motion-jpeg"};if(a.activeFormat="Auto",a.availableFormats=["Auto","video/webm","application/x-mpegURL","application/x-rtsp"],a.settings={id:""},e.getSettings().then(function(b){a.settings={id:b.data.reply.id}}),"Microsoft Internet Explorer"!=window.jscd.browser||i("webm")||(a.ieNoWebm=!0),window.jscd.mobile){a.mobileStore="iOS"==window.jscd.os?"appstore":"googleplay";var D=_.find(Config.helpLinks,function(b){if(!b.urls)return!1;var c=_.find(b.urls,function(b){return b["class"]==a.mobileStore});return c?(a.mobileAppLink=c.url,!0):!1});a.hasMobileApp=!!D}l(),a.playerReady=function(b){a.playerAPI=b,a.switchPlaying(!0)},a.activeVideoRecords=null,a.positionProvider=null,a.updateTime=function(b,c){b=b||0,a.positionProvider.setPlayingPosition(1e3*b)},a.selectCameraById=function(b,c,d){a.cameraId=b||a.cameraId,c&&(c=parseInt(c)),a.activeCamera=n(a.cameraId),!d&&a.activeCamera&&(a.positionProvider=f.getPositionProvider([a.activeCamera.physicalId]),a.activeVideoRecords=f.getRecordsProvider([a.activeCamera.physicalId],640),a.liveOnly=!0,x&&a.activeVideoRecords.archiveReadyPromise.then(function(b){
a.liveOnly=!b}),o(c),l(),a.switchPlaying(!0))},a.selectCamera=function(b){c.path("/view/"+b.id,!1),a.selectCameraById(b.id,!1)},a.switchPlaying=function(b){a.playerAPI&&(b?a.playerAPI.play():a.playerAPI.pause(),a.positionProvider&&(a.positionProvider.playing=b))},a.switchPosition=function(a){o(a)},a.selectFormat=function(b){a.activeFormat=b,o(a.positionProvider.liveMode?null:a.positionProvider.playedPosition)},a.selectResolution=function(b){a.activeResolution!=b&&(a.activeResolution=b,o(a.positionProvider.liveMode?null:a.positionProvider.playedPosition))},a.enableFullScreen=screenfull.enabled,a.fullScreen=function(){screenfull.enabled&&screenfull.request($(".videowindow").get(0))};var E=!0,F=!1,G=null;e.getCurrentUser().then(function(a){if(v=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalEditServersPermissions,w=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalViewLivePermission,x=a.data.reply.isAdmin||a.data.reply.permissions&Config.globalViewArchivePermission,w){var b=a.data.reply.id;return v?void u():void e.getLayouts().then(function(a){y=_.chain(a.data).filter(function(a){return a.parentId==b}).map(function(a){return a.items}).flatten().map(function(a){return a.resourceId}).uniq().value(),u()})}}),a.$on("$destroy",function(){g.cancel(F)}),b.$on("$routeChangeStart",function(b,d){a.selectCameraById(d.params.cameraId,c.search().time||!1)});var H=$(window),I=$("#top"),J=$(".view-panel"),K=$(".cameras-panel"),L=function(){var a=H.height(),b=I.height(),c=0,d=$("td.alert");d.length&&(c=d.height());var e=a-b-c+"px";K.css("height",e),J.css("height",e)};L(),setTimeout(L,50),H.resize(L),a.mobileAppAlertClose=function(){a.mobileAppNotified=!0,setTimeout(L,50)},a.ieNoWebmAlertClose=function(){a.ieNoWebmNotified=!0,setTimeout(L,50)}}]),angular.module("webadminApp").controller("HealthCtrl",["$scope","$modal","$log","mediaserver","$timeout",function(a,b,c,d,e){function f(b){for(var c=[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)},{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)}],d=0;d<b.length;d++){var e=i[b[d].deviceType],f=e[d%e.length];c.push({label:b[d].description,fillColor:f,strokeColor:f,pointColor:f,pointStrokeColor:f,pointHighlightFill:f,pointHighlightStroke:f,show:!0,hideLegend:!1,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)})}a.datasets=c,a.updateVisibleDatasets()}function g(b){for(var c=a.datasets,d=function(a){return a.description===f.label},e=2;e<c.length;e++){var f=c[e],g=0,h=_.filter(b,d);h&&h.length>0&&(g=h[0].value),f.data.push(100*g),f.data.length>a.healthLength&&(f.data=f.data.slice(f.data.length-a.healthLength,f.data.length))}}function h(){d.statistics().then(function(b){return null===k&&f(b.data.reply.statistics),a.serverIsOnline=!0,g(200===b.status&&"0"===b.data.error?b.data.reply.statistics:[]),k=e(h,a.interval),!1},function(){g([]),a.serverIsOnline=!1,k=e(h,a.interval)})}a.healthLength=100,a.interval=1e3,a.serverIsOnline=!0;var i={StatisticsCPU:["#3776ca"],StatisticsRAM:["#db3ba9"],StatisticsHDD:["#438231","#484848","#aa880b","#b25e26","#9200d1","#00d5d5","#267f00","#8f5656","#c90000"],StatisticsNETWORK:["#ff3434","#b08f4c","#8484ff","#34ff84"]},j="rgba(255,255,255,0)";a.data={labels:Array.apply(null,new Array(a.healthLength)).map(String.prototype.valueOf,""),datasets:[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)}]},a.legend="",a.options={animation:!1,scaleOverride:!1,scaleSteps:10,scaleShowLabels:!1,scaleLabel:"<%=value%> %",scaleIntegersOnly:!0,responsive:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!1,pointDotRadius:0,pointDotStrokeWidth:1,pointHitDetectionRadius:0,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!1,onAnimationProgress:function(){},onAnimationComplete:function(){},legendTemplate:'<ul class="tc-chart-js-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].strokeColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'},a.updateVisibleDatasets=function(){a.data.datasets=_.filter(a.datasets,function(a){return a.show})};var k=null,l=setTimeout(h,a.interval);a.$on("$destroy",function(){e.cancel(k),clearTimeout(l)})}]),angular.module("webadminApp").controller("LogCtrl",["$scope","mediaserver",function(a,b){a.logUrl=b.logUrl()}]);