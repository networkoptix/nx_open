"use strict";function Chunk(a,b,c,d,e,f){this.start=b,this.end=c,this.level=d||0,this.expand=!0;var g="dd.mm.yyyy HH:MM";this.title="undefined"==typeof e||null===e?dateFormat(b,g)+" - "+dateFormat(c,g):e,this.children=[],_.extend(this,f)}function Interval(a,b,c,d,e,f){this.seconds=a,this.minutes=b,this.hours=c,this.days=d,this.months=e,this.years=f}function CameraRecordsProvider(a,b,c,d){this.cameras=a,this.mediaserver=b,this.$q=c,this.chunksTree=null,this.requestedCache=[],this.width=d;var e=this;this.requestInterval(0,e.now()+1e4,0).then(function(){if(e.chunksTree){var a=RulerModel.getLevelIndex(e.now()-e.chunksTree.start,e.width);e.requestInterval(e.chunksTree.start,e.now(),a+1)}})}function ShortCache(a,b){this.mediaserver=b,this.cameras=a,this.start=0,this.played=0,this.playedPosition=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.requestInterval=9e4,this.updateInterval=6e4,this.requestDetailization=1,this.limitChunks=10,this.checkpointsFrequency=6e4}var Config={globalEditServersPermissions:32,helpLinks:[]};angular.module("webadminApp",["ipCookie","ngResource","ngSanitize","ngRoute","ui.bootstrap","tc.chartjs","com.2fdevs.videogular","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.buffering","com.2fdevs.videogular.plugins.dash","com.2fdevs.videogular.plugins.poster"]).config(["$routeProvider",function(a){a.when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/join",{templateUrl:"views/join.html",controller:"SettingsCtrl"}).when("/info",{templateUrl:"views/info.html",controller:"InfoCtrl"}).when("/developers",{templateUrl:"views/developers.html",controller:"MainCtrl"}).when("/support",{templateUrl:"views/support.html",controller:"MainCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html"}).when("/advanced",{templateUrl:"views/advanced.html",controller:"AdvancedCtrl"}).when("/webclient",{templateUrl:"views/webclient.html",controller:"WebclientCtrl",reloadOnSearch:!1}).when("/view/",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/view/:cameraId",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/sdkeula",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).otherwise({redirectTo:"/settings"})}]),angular.module("webadminApp").run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("webadminApp").factory("mediaserver",["$http","$modal","$q","ipCookie","$log",function(a,b,c,d,e){function f(){return a.get(k+"/api/moduleInformation?showAddresses=true")}function g(a){if(401===a.status){var c=window.self!==window.top;return void(c||null!==p||(p=b.open({templateUrl:"views/login.html",keyboard:!1,backdrop:"static"}),p.result.then(function(){p=null})))}i=null,null===o&&f(!0).catch(function(a){e.error(a),o=b.open({templateUrl:"offline_modal",controller:"OfflineCtrl",keyboard:!1,backdrop:"static"}),o.result.then(function(){o=null})})}function h(a){return a.catch(g),a}var i=null,j=null,k="";if(location.search.indexOf("proxy=")>0)for(var l=location.search.replace("?","").split("&"),m=0;m<l.length;m++){var n=l[m].split("=");if("proxy"===n[0]){k="/proxy/"+n[1];break}}d("Authorization","Digest",{path:"/"});var o=null,p=null;return{logUrl:function(a){return k+"/api/showLog"+(a||"")},hasProxy:function(){return""!==k},checkAdmin:function(){var a=c.defer();return this.hasProxy()&&a.resolve(!1),this.getCurrentUser().then(function(b){var c=b.data.reply.isAdmin||b.data.reply.permissions&Config.globalEditServersPermissions;a.resolve(c)}),a.promise},getSettings:function(b){return b=b||k,b===!0?(i=null,f()):""===b?(null===i&&(i=h(f())),i):a.get(b+"/api/moduleInformation?showAddresses=true",{timeout:3e3})},saveSettings:function(b,c){return h(a.post(k+"/api/configure?systemName="+b+"&port="+c))},changePassword:function(b,c){return h(a.post(k+"/api/configure?password="+b+"&oldPassword="+c))},mergeSystems:function(b,c,d,e){return h(a.post(k+"/api/mergeSystems?password="+c+"&currentPassword="+d+"&url="+encodeURIComponent(b)+"&takeRemoteSettings="+!e))},pingSystem:function(b,c){return h(a.post(k+"/api/pingSystem?password="+c+"&url="+encodeURIComponent(b)))},restart:function(){return h(a.post(k+"/api/restart"))},getStorages:function(){return h(a.get(k+"/api/storageSpace"))},saveStorages:function(b){return h(a.post(k+"/ec2/saveStorages",b))},discoveredPeers:function(){return h(a.get(k+"/api/discoveredPeers?showAddresses=true"))},getMediaServer:function(b){return h(a.get(k+"/ec2/getMediaServersEx?id="+b.replace("{","").replace("}","")))},getMediaServers:function(){return h(a.get(k+"/ec2/getMediaServersEx"))},getCameras:function(b){return h("undefined"!=typeof b?a.get(k+"/ec2/getCamerasEx?id="+b.replace("{","").replace("}","")):a.get(k+"/ec2/getCamerasEx"))},saveMediaServer:function(b){return h(a.post(k+"/ec2/saveMediaServer",b))},statistics:function(b){return b=b||k,h(a.get(b+"/api/statistics?salt="+(new Date).getTime()))},getCurrentUser:function(b){return(null===j||b)&&(j=h(a.get(k+"/api/getCurrentUser"))),j},getRecords:function(b,c,d,e,f,g,i){var j=new Date;return"undefined"==typeof d&&(d=j.getTime()-2592e6),"undefined"==typeof e&&(e=j.getTime()+1e5),"undefined"==typeof f&&(f=(e-d)/1e3),"undefined"==typeof i&&(i=0),"undefined"==typeof g&&(g=Number.MAX_VALUE),"/"!==b&&""!==b&&null!==b&&(b="/proxy/"+b+"/"),h(a.get(b+"api/RecordedTimePeriods?physicalId="+c+"&startTime="+d+"&endTime="+e+"&detail="+f+"&periodsType="+i+"&limit="+g))}}}]),Interval.prototype.addToDate=function(a,b){Number.isInteger(a)&&(a=new Date(a)),"undefined"==typeof b&&(b=1);try{return new Date(a.getFullYear()+b*this.years,a.getMonth()+b*this.months,a.getDate()+b*this.days,a.getHours()+b*this.hours,a.getMinutes()+b*this.minutes,a.getSeconds()+b*this.seconds)}catch(c){throw console.log(a),c}},Interval.secondsBetweenDates=function(a,b){return(b.getTime()-a.getTime())/1e3},Interval.prototype.getSeconds=function(){var a=new Date(1971,11,1,0,0,0,0),b=this.addToDate(a);return Interval.secondsBetweenDates(a,b)},Interval.prototype.alignToPast=function(a){var b=new Date(a);return b.setMilliseconds(0),0!==this.seconds?(b.setSeconds(Math.floor(b.getSeconds()/this.seconds)*this.seconds),b):(b.setSeconds(0),0!==this.minutes?(b.setMinutes(Math.floor(b.getMinutes()/this.minutes)*this.minutes),b):(b.setMinutes(0),0!==this.hours?(b.setHours(Math.floor(b.getHours()/this.hours)*this.hours),b):(b.setHours(0),0!==this.days?(b.setDate(Math.floor(b.getDate()/this.days)*this.days),b):(b.setDate(1),0!==this.months?(b.setMonth(Math.floor(b.getMonth()/this.months)*this.months),b):(b.setMonth(0),b.setYear(Math.floor(b.getFullYear()/this.years)*this.years),b)))))},Interval.prototype.checkDate=function(a){return Number.isInteger(a)&&(a=new Date(a)),this.alignToPast(a).getTime()===a.getTime()},Interval.prototype.alignToFuture=function(a){return this.alignToPast(this.addToDate(a))};var RulerModel={levels:[{name:"Age",format:"yyyy",interval:new Interval(0,0,0,0,0,100),width:25,topWidth:0,topFormat:""},{name:"Decade",format:"yyyy",interval:new Interval(0,0,0,0,0,10),width:25},{name:"Year",format:"yyyy",interval:new Interval(0,0,0,0,0,1),width:25,topWidth:100,topFormat:"yyyy"},{name:"Month",format:"mmmm",interval:new Interval(0,0,0,0,1,0),width:50,topWidth:140,topFormat:"mmmm yyyy"},{name:"Day",format:"dd mmmm",interval:new Interval(0,0,0,1,0,0),width:60,topWidth:140,topFormat:"dd mmmm yyyy"},{name:"6 hours",format:'HH"h"',interval:new Interval(0,0,6,0,0,0),width:60},{name:"Hour",format:'HH"h"',interval:new Interval(0,0,1,0,0,0),width:60,topWidth:140,topFormat:"dd mmmm yyyy HH:MM"},{name:"10 minutes",format:'MM"m"',interval:new Interval(0,10,0,0,0,0),width:60},{name:"1 minute",format:'MM"m"',interval:new Interval(0,1,0,0,0,0),width:60,topWidth:140,topFormat:"dd mmmm yyyy HH:MM"},{name:"10 seconds",format:'ss"s"',interval:new Interval(10,0,0,0,0,0),width:30},{name:"1 second",format:'ss"s"',interval:new Interval(1,0,0,0,0,0),width:30}],getLevelIndex:function(a,b){b=b||1;var c=_.find(RulerModel.levels,function(c){return 1e3*c.interval.getSeconds()<a/b});return"undefined"!=typeof c?RulerModel.levels.indexOf(c):RulerModel.levels.length-1}};CameraRecordsProvider.prototype.now=function(){return(new Date).getTime()},CameraRecordsProvider.prototype.cacheRequestedInterval=function(a,b,c){for(var d=0;c+1>d;d++)if(d>=this.requestedCache.length)this.requestedCache.push([{start:a,end:b}]);else for(var e=0;e<this.requestedCache[d].length;e++)if(!(this.requestedCache[d][e].end<a))return this.requestedCache[d][e].start>b?void this.requestedCache[d].splice(e,0,{start:a,end:b}):(this.requestedCache[d][e].start=Math.min(a,this.requestedCache[d][e].start),void(this.requestedCache[d][e].end=Math.max(b,this.requestedCache[d][e].end)))},CameraRecordsProvider.prototype.checkRequestedIntervalCache=function(a,b,c){for(var d=this.requestedCache[c],e=0;e<d.length;e++){if(a<d[e].start)return!1;if(a=Math.max(a,d[e].end),b<d[e].end)return!0}return a>=b},CameraRecordsProvider.prototype.requestInterval=function(a,b,c){var d=this.$q.defer();this.start=a,this.end=b,this.level=c;var e=1e3*RulerModel.levels[c].interval.getSeconds(),f=this;return f.lockRequests?d.reject("request in progress"):(f.lockRequests=!0,this.mediaserver.getRecords("/",this.cameras[0],a,b,e).then(function(e){f.cacheRequestedInterval(a,b,c),f.lockRequests=!1,0==e.data.length&&console.log("no chunks for this camera");for(var g=0;g<e.data.length;g++){var h=e.data[g][0]+e.data[g][1];e.data[g][1]<0&&(h=(new Date).getTime()+1e5);var i=new Chunk(null,e.data[g][0],h,c);f.addChunk(i)}d.resolve(f.chunksTree)},function(a){d.reject(a)})),this.ready=d.promise,this.ready},CameraRecordsProvider.prototype.getIntervalRecords=function(a,b,c){a instanceof Date&&(a=a.getTime()),b instanceof Date&&(b=b.getTime());var d=[];this.splice(d,a,b,c);var e=this.checkRequestedIntervalCache(a,b,c);return e||this.requestInterval(a,b,c),d},CameraRecordsProvider.prototype.debug=function(a,b){if(a||console.log("Chunks tree:"+(this.chunksTree?"":"empty")),b=b||0,a=a||this.chunksTree){console.log(Array(b+1).join(" "),a.title,a.level,a.children.length);for(var c=0;c<a.children.length;c++)this.debug(a.children[c],b+1)}},CameraRecordsProvider.prototype.addChunk=function(a,b){if(null===this.chunksTree||0===a.level)return void(this.chunksTree=a);if(b=b||this.chunksTree,0===b.children.length)return b.level===a.level-1?void b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[0]));if(b.level===a.level-1){for(var c=0;c<b.children.length;c++){if(b.children[c].start==a.start&&b.children[c].end==a.end)return;if(b.children[c].start>=a.start){b.children[c].start<a.end&&console.error("impossible situation - intersection in chunks",a,b.children[c],c,b);break}}return void b.children.splice(c,0,a)}for(var c=0;c<b.children.length;c++){var d=b.children[c];if(!(d.end<a.start))return d.start<=a.start&&d.end>=a.end?void this.addChunk(a,d):d.start-a.end<RulerModel.levels[d.level].detailization?(d.start=a.start,void this.addChunk(a,d)):c>0&&a.start-b.children[c-1].end<RulerModel.levels[a.level].detailization?(b.children[c-1].end=a.end,void this.addChunk(a,b.children[c-1])):(b.children.splice(c,0,new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[c]))}return a.start-b.children[c-1].end<RulerModel.levels[a.level].detailization?(b.children[c-1].end=a.end,void this.addChunk(a,b.children[c-1])):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[c]))},CameraRecordsProvider.prototype.splice=function(a,b,c,d,e){if(e=e||this.chunksTree,!e)return!1;if(e.children.length>0)for(var f=0;f<e.children.length;f++){var g=e.children[f];if(!(g.end<b)){if(g.start>c)break;g.level===d?a.push(g):this.splice(a,b,c,d,g)}}else a.push(e)},ShortCache.prototype.init=function(a){this.start=a,this.playedPosition=a,this.played=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.update()},ShortCache.prototype.update=function(a,b){if(!this.updating||a){console.log("update detailization",this.updating,a),a=a||this.playedPosition,this.updating=!0;var c=this;this.lastRequestDate=a,this.lastRequestPosition=b||this.played,console.log("lastRequestPosition ",b,this.played,new Date(this.lastRequestDate)),this.mediaserver.getRecords("/",this.cameras[0],a,(new Date).getTime()+1e3,this.requestDetailization,this.limitChunks).then(function(b){c.updating=!1,0==b.data.length&&console.log("no chunks for this camera and interval"),b.data.length>0&&parseInt(b.data[0][0])<a&&(b.data[0][1]-=a-parseInt(b.data[0][0]),b.data[0][0]=a),c.currentDetailization=b.data;for(var d=c.lastRequestDate,e=c.lastRequestPosition,f=0,g=0;g<c.currentDetailization.length;g++)e+=c.currentDetailization[g][1],d=c.currentDetailization[g][0]+c.currentDetailization[g][1],d-f>c.checkpointsFrequency&&(f=d,c.checkPoints[e]=d)})}},ShortCache.prototype.checkPlayingDate=function(a){if(a<this.start)return console.log("too left!",new Date(a),new Date(this.start),a-this.start),!1;if(a>this.lastPlayedDate)return console.log("too right!",new Date(a),new Date(this.lastPlayedDate),a-this.lastPlayedDate),!1;var b;for(var c in this.checkPoints){if(this.checkPoints[c]>a)break;b=c}return"undefined"==typeof b?(console.log("no checkpoints found - use the start point!"),a-this.start):b+a-this.checkPoints[c]},ShortCache.prototype.setPlayingPosition=function(a){if(this.played=a,this.playedPosition=0,a<this.lastRequestPosition){var b;for(var c in this.checkPoints){if(c>a)break;b=c}this.playedPosition=b+a-this.checkPoints[b],console.log("back on timeline"),this.update(this.checkPoints[b],b)}var d=a-this.lastRequestPosition;this.playedPosition=this.lastRequestDate+d;for(var e=0;e<this.currentDetailization.length&&(d-=this.currentDetailization[e][1],this.playedPosition=this.currentDetailization[e][0]+this.currentDetailization[e][1]+d,!(0>=d));e++);return this.liveMode=!1,e==this.currentDetailization.length&&(this.playedPosition=(new Date).getTime(),this.liveMode=!0),!this.liveMode&&this.currentDetailization.length>0&&this.currentDetailization[this.currentDetailization.length-1][1]+this.currentDetailization[this.currentDetailization.length-1][0]<this.playedPosition+this.updateInterval&&this.update(),a>this.lastPlayedPosition&&(this.lastPlayedPosition=a,this.lastPlayedDate=this.playedPosition),this.playedPosition},angular.module("webadminApp").factory("cameraRecords",["mediaserver","$q",function(a,b){return{getRecordsProvider:function(c,d){return new CameraRecordsProvider(c,a,b,d)},getPositionProvider:function(c){return new ShortCache(c,a,b)}}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").factory("animateScope",["$q",function(a){function b(b,c,d,e){this.scope=b,this.value=c,this.targetValue=d,this.duration=e,this.started=(new Date).getTime(),this.initialValue=b[c],this.isFinished=!1,this.deferred=a.defer()}function c(){var a=[],b=[];_.forEach(e,function(c){c.update(),b.indexOf(c.scope)<0&&c.scope!==h&&b.push(c.scope),c.isFinished&&a.push(c)}),_.forEach(a,function(a){e.splice(e.indexOf(a),1)}),_.forEach(b,function(a){a.$apply()})}function d(a){i&&(c(),"undefined"!=typeof j&&null!==j&&j!==!1&&j(),h.$root.$$phase&&!a&&console.error("wrong phase",h.$root.$$phase),null===h||a||h.$apply(),0!==f&&(window.animationFrame(d),f&&f--))}var e=[],f=null,g=1e3,h=null;b.prototype.linear=function(a,b,c,d){c>d&&(c=d);var e=a+(b-a)*c/d;return isNaN(e)&&console.log("linear-error",e,a,b,c,d),e},b.prototype.smooth=function(a,b,c,d){c>d&&(c=d);var e=(Math.sin(c/d*Math.PI-Math.PI/2)+1)/2,f=a+(b-a)*e;return f},b.prototype.break=function(){this.isFinished=!0,this.deferred.reject(this.scope[this.value])},b.prototype.update=function(){if(!this.isFinished){var a=(new Date).getTime()-this.started;this.scope[this.value]=this.linear(this.initialValue,this.targetValue,a,this.duration),this.deferred.notify(this.scope[this.value]),this.isFinished=a>this.duration,this.isFinished&&this.deferred.resolve(this.scope[this.value])}};var i=!1;window.animationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,20)}}();var j=null;return{start:function(a){i=!0,j=a,d(!0)},stop:function(){i=!1},animate:function(a,c,d,f){"undefined"==typeof f&&(f=g);var h=_.find(e,function(b){return b.scope===a&&b.value===c});h&&h.break();var i=new b(a,c,d,f);return e.push(i),i.deferred.promise},progress:function(a,b,c){return a[b]=0,this.animate(a,b,1,c)},setDuration:function(a){g=a},setScope:function(a){h=a}}}]),angular.module("webadminApp").directive("navbar",function(){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavigationCtrl",scope:{noPanel:"="}}}),angular.module("webadminApp").directive("nxEqualEx",["$log",function(a){return{require:"ngModel",link:function(b,c,d,e){function f(){console.log("updateValidity",e.$viewValue,b.$eval(d.nxEqualEx)),void 0!==e.$viewValue&&""!==e.$viewValue&&e.$setValidity("nxEqualEx",b.$eval(d.nxEqualEx)===e.$viewValue)}return d.nxEqualEx?(b.$watch(d.nxEqualEx,f),b.$watch("$viewValue",f),void e.$parsers.push(function(a){if(void 0===a||""===a)return e.$setValidity("nxEqualEx",!0),a;var c=a===b.$eval(d.nxEqualEx);return e.$setValidity("nxEqualEx",c),a})):void a.error("nxEqualEx expects a model as an argument!")}}}]),angular.module("webadminApp").directive("icon",function(){return{restrict:"E",scope:{"for":"="},template:"<span ng-if='for || onFalse' class='glyphicon glyphicon-{{for?onTrue:onFalse}} {{class}}' title='{{for?titleTrue:titleFalse}}'></span>",link:function(a,b,c){a.onTrue=c.onTrue||"ok",a.onFalse=c.onFalse,a["class"]=c["class"],a.titleTrue=c.titleTrue,a.titleFalse=c.titleFalse}}}),angular.module("webadminApp").directive("fileupload",function(){return{restrict:"E",template:"<span class='btn btn-success fileinput-button' ><span>{{text}}</span><input type='file' name='installerFile1' class='fileupload' id='fileupload' ></span><div class='progress' style='display:none;'><div class='progress-bar progress-bar-success progress-bar-striped'></div></div>",link:function(a,b,c){b.find(".fileupload").fileupload({url:c.url,dataType:"json",done:function(a,c){if("0"===c.result.error)alert("Updating successfully started. It will take several minutes");else switch(c.result.errorString){case"UP_TO_DATE":alert("Updating failed. The provided version is already installed.");break;case"INVALID_FILE":alert("Updating failed. Provided file is not a valid update archive.");break;case"INCOMPATIBLE_SYSTEM":alert("Updating failed. Provided file is targeted for another system.");break;case"EXTRACTION_ERROR":alert("Updating failed. Extraction failed, check available storage.");break;case"INSTALLATION_ERROR":alert("Updating failed. Couldn't execute installation script.")}b.find(".progress").hide()},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.find(".progress").show(),b.find(".progress-bar").css("width",d+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),a.text=c.text||"Select files"}}}),angular.module("com.2fdevs.videogular.plugins.controls").directive("vgQuality",function(){return{restrict:"E",require:"^videogular",transclude:!0,template:'<button class="iconButton enter" ng-click="onClickQuality()" ng-class="qualityIcon" aria-label="Chose quality"></button>',scope:{current:"=",list:"="},link:function(){}}}),angular.module("webadminApp").directive("inplaceEdit",function(){return{restrict:"E",templateUrl:"views/inplace-edit.html",scope:{model:"=ngModel"},link:function(a,b,c){var d=a.model;a.type=c.type||"text",a.placeholder=c.placeholder,a.inputId=c.inputId,a.edit=function(){d=a.model,b.find("input").val(d),b.find(".read-container").hide(),b.find(".edit-container").show(),b.find("input").focus()},a.save=function(){d!==a.model&&a.$parent.$eval(c.nxOnsave),d=a.model,b.find(".read-container").show(),b.find(".edit-container").hide()},a.cancel=function(){a.model=d,a.$apply(),b.find(".read-container").show(),b.find(".edit-container").hide()},b.find(".edit-container").hide()}}}),angular.module("webadminApp").directive("timeline",["$interval","$timeout","animateScope",function(a,b,c){return{restrict:"E",scope:{records:"=",ngClick:"&",positionProvider:"=",handler:"="},templateUrl:"views/components/timeline.html",link:function(a,b){function d(){var b=a.positionCoordinate;if(!a.positionProvider)return void G.addClass("hiddenTimemarker");var c=a.positionProvider.playedPosition;a.positionCoordinate=n(c).toFixed(1),a.positionCoordinate!=b&&(a.positionCoordinate>0&&a.positionCoordinate<C?(G.removeClass("hiddenTimemarker"),G.css("left",a.positionCoordinate+"px")):G.addClass("hiddenTimemarker"));var d=new Date(c);a.playingDate=dateFormat(d,A.dateFormat),a.playingTime=dateFormat(d,A.timeFormat)}function e(){var a=document.createElement("div");a.style.visibility="hidden",a.style.width="100px",a.style.msOverflowStyle="scrollbar",document.body.appendChild(a);var b=a.offsetWidth;a.style.overflow="scroll";var c=document.createElement("div");c.style.width="100%",a.appendChild(c);var d=c.offsetWidth;return a.parentNode.removeChild(a),b-d}function f(a,b,c){return Math.max(a,Math.min(b,c))}function g(b){var c=a.scrollWidth-C;if("undefined"==typeof b)return 1>c&&(K=.5),K;K=b;var d=Math.round(b*c);J=!1,F.scrollLeft(d),J=!0}function h(){var b=RulerModel.levels[RulerModel.levels.length-1],c=b.interval.getSeconds()/b.width,d=(a.end-a.start)/1e3,e=d/c/C,f=Math.ceil(Math.log(e)/Math.log(A.zoomStep));return f}function i(a,b){b>1&&console.error("bad value",b);var c="rgb("+Math.round(a[0]*b+255*(1-b))+","+Math.round(a[1]*b+255*(1-b))+","+Math.round(a[2]*b+255*(1-b))+")";return c}function j(){return Math.pow(A.zoomStep,a.actualZoomLevel)}function k(){return(a.end-a.start)/a.actualWidth/1e3}function l(){for(var b=a.actualLevel,d=a.visibleLabelsLevel,e=a.increasedLevel,f=k(),g=1;g<RulerModel.levels.length;g++){var h=RulerModel.levels[g],i=h.interval.getSeconds()/f;if("undefined"!=typeof h.topWidth&&i>=h.topWidth&&(a.topLabelsLevel=g),i>=h.width&&(a.visibleLabelsLevel=g),i>A.increasedMarkWidth&&(a.increasedLevel=g),i>A.minimumMarkWidth&&(a.actualLevel=g),i>=1&&(a.chunksLevel=g),1>=i)break}a.chunksLevel++,a.chunksLevel>=RulerModel.levels.length&&(a.chunksLevel=RulerModel.levels.length-1),a.disableZoomIn=Math.ceil(a.actualZoomLevel)>=a.maxZoomLevel,a.disableZoomOut=a.actualZoomLevel<=0,b<a.actualLevel?c.progress(a,"levelAppearance"):b>a.actualLevel&&c.progress(a,"levelDisappearance"),e<a.increasedLevel?c.progress(a,"levelEncreasing"):e>a.increasedLevel&&c.progress(a,"levelDecreasing"),d<a.visibleLabelsLevel?c.progress(a,"labelAppearance"):d>a.visibleLabelsLevel&&c.progress(a,"labelDisappearance")}function m(){return g()*(a.frameWidth-C)}function n(b){var c=a.frameWidth*(b-a.start)/(a.frameEnd-a.start);return c-m()}function o(b){var c=m()+b*C,d=Math.round(a.start+(a.frameEnd-a.start)*c/a.frameWidth);return d}function p(b,c){if(a.frameWidth===C)return 0;var d=(b-a.start)/(a.frameEnd-a.start),e=d*a.frameWidth,f=e-C*c,g=f/(a.frameWidth-C);return g}function q(a,b,c,d){a.fillStyle=d?A.exactChunkColor:A.loadingChunkColor,a.fillRect(b,B,Math.max(1,c-b),A.chunkHeight),a.stroke()}function r(){var b=H.getContext("2d"),c=RulerModel.levels[a.actualLevel],d=c.interval.alignToFuture(o(0)),e=c.interval.alignToFuture(o(1));if(a.records&&a.records.chunksTree)for(var f=a.records.getIntervalRecords(d,e,a.chunksLevel),g=0;g<f.length;g++){var h=f[g],i=n(h.start),j=n(h.end);q(b,i,j,h.level)}}function s(b,c,d,e,f){if(!(0>c)){var g=A.rulerBasicSize,h=0;if(0===d)g=A.rulerBasicSize*a.levelAppearance,h=a.levelAppearance/A.colorLevels;else if(0>d)g=A.rulerBasicSize*(1-a.levelDisappearance),h=(1-a.levelDisappearance)/A.colorLevels;else{var j=1;a.levelAppearance<1?j=a.levelAppearance:a.levelDisappearance<1&&(j=2-a.levelDisappearance),h=(Math.min(d,A.colorLevels-1)+j)/A.colorLevels,g=(Math.min(d,4)+j)*A.rulerStepSize+A.rulerBasicSize}if(!(0>=g)){var k=i(A.rulerColor,h);if(b.strokeStyle=k,b.beginPath(),b.moveTo(c,A.topLabelHeight),b.lineTo(c,g+A.topLabelHeight),b.stroke(),"undefined"!=typeof f){var l=A.rulerFontSize+A.rulerFontStep*Math.min(d,3);a.labelAppearance<1&&0===e?k=i(A.rulerColor,a.labelAppearance*h):a.labelDisappearance<1&&0>e&&(k=i(A.rulerColor,(1-a.labelDisappearance)*h)),b.font=l+"px "+A.font,b.fillStyle=k;var m=b.measureText(f).width;b.fillText(f,c-m/2,g+l*(1+A.labelsPadding)+A.topLabelHeight)}}}}function t(a,b,c,d,e){b=Math.max(b,0),c=Math.min(c,C),a.fillStyle=e?A.oddColor:A.evenColor,a.fillRect(b,0,c-b,A.topLabelHeight),a.stroke();var f=A.topLabelHeight-A.topLabelPadding;a.font=f+"px "+A.font,a.fillStyle=A.topLabelTextColor;var g=a.measureText(d).width,h=(b+c-g)/2;0>h&&(h=0),h+g>c-A.topLabelPadding&&C>c&&(h=c-g-A.topLabelPadding),h<b+A.topLabelPadding&&b>0&&(h=b+A.topLabelPadding),a.fillText(d,h,A.topLabelHeight-A.topLabelPadding)}function u(){d();var b=H.getContext("2d");b.strokeStyle=A.timeMarkerColor,b.fillStyle=A.timeMarkerColor,b.beginPath(),b.moveTo(a.positionCoordinate,0),b.lineTo(a.positionCoordinate,H.height),b.stroke()}function v(){var b=H.getContext("2d");b.fillStyle=i(A.rulerColor,1),b.clearRect(0,0,H.width,H.height),b.strokeStyle=A.topLabelBorderColor,b.beginPath(),b.moveTo(0,A.topLabelHeight),b.lineTo(C,A.topLabelHeight),b.stroke();for(var c=RulerModel.levels[a.topLabelsLevel],d=c.interval.alignToFuture(o(1)),e=c.interval.alignToPast(o(0));d>e;){var f=c.interval.addToDate(e),g=n(e),h=n(f),j=dateFormat(new Date(e),c.topFormat);t(b,g,h,j,Math.round(e/1e3/c.interval.getSeconds())%2===1),e=f}c=RulerModel.levels[a.actualLevel],d=c.interval.alignToFuture(o(1)),e=c.interval.alignToFuture(o(0));for(var k=function(a){return a.interval.checkDate(e)};d>e;){var l=n(e),m=_.find(RulerModel.levels,k),p=RulerModel.levels.indexOf(m),j=p>a.visibleLabelsLevel&&!(a.labelDisappearance<1&&p===a.visibleLabelsLevel+1)?"":dateFormat(new Date(e),m.format);if(s(b,l,a.actualLevel-p,a.visibleLabelsLevel-p,j),a.levelDisappearance<1)for(var q=e,r=c.interval.addToDate(e),u=RulerModel.levels[a.actualLevel+1];r>q;)q=u.interval.addToDate(q),l=n(q),s(b,l,-1);e=c.interval.addToDate(e)}}function w(){var b=o(a.positionToKeep);a.actualWidth=C*j(),a.frameEnd=(new Date).getTime(),a.frameWidth=Math.round(a.actualWidth*(a.frameEnd-a.start)/(a.end-a.start));var c=a.scrollWidth;a.scrollWidth=Math.round(Math.min(a.frameWidth,A.maximumScrollScale*C)),c!==a.scrollWidth&&E.width(a.scrollWidth);var d=0;d=a.scrolling<1?a.targetScrollPosition/(a.frameWidth-C):p(b,a.positionToKeep),d=f(0,d,1),g(d),a.checkRightLeftVisibility()}function x(){w(),l(),v(),r(),u()}function y(){var b=(new Date).getTime();a.start=a.records?a.records.start:b-A.initialInterval,a.end=b,a.maxZoomLevel=h(),x()}function z(b){a.scroll(b,A.scrollingSpeed).then(function(){P&&z(b)})}var A={initialInterval:31536e6,futureInterval:864e5,zoomStep:1.5,maxTimeLineWidth:3e7,initialZoom:0,updateInterval:20,animationDuration:300,rulerColor:[0,0,0],rulerFontSize:9,rulerFontStep:1,rulerBasicSize:6,rulerStepSize:3,labelsPadding:.3,minimumMarkWidth:5,increasedMarkWidth:10,maximumScrollScale:20,colorLevels:6,scrollingSpeed:.25,maxVerticalScrollForZoom:5e3,scrollBoundariesPrecision:1e-6,dblClckZoomSpeed:2,topLabelBorderColor:"silver",topLabelTextColor:"rgb(128,128,128)",topLabelHeight:12,topLabelPadding:2,font:"sans-serif",evenColor:"rgb(200,200,255)",oddColor:"white",chunkTopMargin:5,chunkHeight:20,exactChunkColor:"rgba(192,192,192,0.65)",hightlightChunkColor:"rgb(192,192,192)",loadingChunkColor:"rgb(00,200,00)",timeMarkerColor:"blue",dateFormat:"dd.mm.yyyy",timeFormat:"HH:MM:ss"};a.$watch("position",d);var B=A.topLabelHeight+5*A.rulerStepSize+A.rulerBasicSize+A.rulerFontSize+3*A.rulerFontStep+A.chunkTopMargin;c.setDuration(A.animationDuration),c.setScope(a);var C=b.find(".viewport").width(),D=b.find(".viewport").height(),E=b.find(".frame"),F=b.find(".scroll"),G=b.find(".timeMarker"),H=b.find("canvas").get(0);H.width=C;var I=e();H.height=D-I,b.find("canvas").height(D-I);var J=!0,K=0;F.scroll(function(){if(J){var b=F.scrollLeft(),c=a.scrollWidth-C;g(b/c)}});var L=1;F.mousewheel(function(b){if(b.preventDefault(),Math.abs(b.deltaY)>Math.abs(b.deltaX)){if(1===a.zooming){a.positionToKeep=b.offsetX/C;var d=1===a.scrollZooming?a.actualZoomLevel:L,e=d/a.maxZoomLevel;e-=b.deltaY/A.maxVerticalScrollForZoom,e=f(0,e,1),L=a.maxZoomLevel*e,c.animate(a,"actualZoomLevel",L),c.progress(a,"scrollZooming")}}else{var h=g();h+=b.deltaX/a.actualWidth,g(h)}a.$apply()});var M=null,N=null,O=!1;F.mousemove(function(a){N=a.offsetX-F.scrollLeft(),M=o(N/C),O=a.offsetY>=B&&a.offsetY<=B+A.chunkHeight}),F.mouseout(function(){M=null,N=null,O=!1}),F.click(function(b){N=b.offsetX-F.scrollLeft(),M=o(N/C),a.handler(M)}),a.positionToKeep=.5,a.levels=RulerModel.levels,a.actualZoomLevel=A.initialZoom,a.disableZoomOut=!0,a.disableZoomIn=!1,a.disableScrollRight=!0,a.disableScrollLeft=!0,a.actualWidth=C,a.scrollWidth=C,a.levelAppearance=1,a.levelDisappearance=1,a.levelEncreasing=1,a.levelDecreasing=1,a.labelAppearance=1,a.labelDisappearance=1,a.zooming=1,a.scrolling=1,a.targetScrollPosition=0,a.scrollZooming=1,a.scroll=function(b,d){a.scrolling>=1&&(a.targetScrollPosition=m());var e=a.targetScrollPosition+(b?1:-1)*d*C;e=f(0,e,a.frameWidth-C),c.animate(a,"targetScrollPosition",e);var g=c.progress(a,"scrolling");return g.then(function(){a.checkRightLeftVisibility(b)}),g},a.scrollToEnd=function(b){c.animate(a,"targetScrollPosition",b?a.frameWidth:-a.frameWidth);var d=c.progress(a,"scrolling");return d.then(function(){a.checkRightLeftVisibility(b)}),d},a.checkRightLeftVisibility=function(b){var c=g();(b||"undefined"==typeof b)&&(a.disableScrollRight=c>1-A.scrollBoundariesPrecision||a.frameWidth===C),b||(a.disableScrollLeft=c<A.scrollBoundariesPrecision||a.frameWidth===C)};var P=!1;a.scrollStart=function(a){P=!0,z(a)},a.scrollEnd=function(){P=!1},a.zoom=function(b,d,e){a.positionToKeep=e||.5,d=d||1;var g=a.actualZoomLevel;b&&!a.disableZoomIn&&(g+=d),b||a.disableZoomOut||(g-=d),g=f(0,g,a.maxZoomLevel),c.animate(a,"actualZoomLevel",g),c.progress(a,"zooming")},a.zoomToPoint=function(b){a.zoom(!0,A.dblClckZoomSpeed,(b-F.scrollLeft())/C)};var Q=null;a.dragStart=function(a){var b=(a-F.scrollLeft())/C;Q=o(b)},a.drag=function(b){if(null!==Q){var c=(b-F.scrollLeft())/C,d=p(Q,c);d=f(0,d,1),g(d),a.checkRightLeftVisibility()}},a.dragEnd=function(){Q=null},a.$watch("records",function(){a.records&&a.records.ready.then(y)}),y(),c.start(x),a.$on("$destroy",function(){c.stop()}),a.log=function(a){console.log(a)},a.goToLive=function(){console.log("gotolive"),a.liveMode=!0,a.handler(null)}}}}]),angular.module("webadminApp").controller("MainCtrl",["$scope",function(a){a.config=Config}]),angular.module("webadminApp").controller("NavigationCtrl",["$scope","$location","mediaserver","ipCookie",function(a,b,c,d){a.user={isAdmin:!0},c.checkAdmin().then(function(b){a.user={isAdmin:b}}),c.getSettings().then(function(b){a.settings=b.data.reply,a.settings.remoteAddresses=a.settings.remoteAddresses.join("\n")}),a.isActive=function(a){var c=b.path().split("/")[1];return c.split("?")[0]===a.split("/")[1].split("?")[0]},a.logout=function(){d.remove("response",{path:"/"}),d.remove("nonce",{path:"/"}),d.remove("realm",{path:"/"}),d.remove("username",{path:"/"}),window.location.reload()},a.alertVisible=!0,a.closeAlert=function(){a.alertVisible=!1
}}]),angular.module("webadminApp").controller("SettingsCtrl",["$scope","$modal","$log","mediaserver","$location","$timeout",function(a,b,c,d,e,f){function g(c){b.open({templateUrl:"views/restart.html",controller:"RestartCtrl",resolve:{port:function(){return c?a.settings.port:null}}})}function h(){return alert("Connection error"),!1}function i(b){var c=b.data;if("0"!==c.error){var d=c.errorString;switch(d){case"UNAUTHORIZED":case"password":case"PASSWORD":d="Wrong password."}alert("Error: "+d)}else c.reply.restartNeeded?confirm("All changes saved. New settings will be applied after restart. \n Do you want to restart server now?")&&g(!0):(alert("Settings saved"),a.settings.port!==window.location.port?window.location.href=window.location.protocol+"//"+window.location.hostname+":"+a.settings.port:window.location.reload())}function j(b,c){var e=b.networkAddresses.split(";"),f=b.apiUrl.substring(b.apiUrl.lastIndexOf(":")),g=window.location.protocol+"//"+e[c]+f;d.getSettings(g).then(function(){b.apiUrl=g},function(){return c<e.length-1?j(b,c+1):(b.status="Unavailable",a.mediaServers=_.sortBy(a.mediaServers,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id})),!1})}d.checkAdmin().then(function(a){return a?void 0:void e.path("/info")}),d.getSettings().then(function(b){a.settings={systemName:b.data.reply.systemName,port:b.data.reply.port,id:b.data.reply.id},a.oldSystemName=b.data.reply.systemName,a.oldPort=b.data.reply.port}),a.password="",a.oldPassword="",a.confirmPassword="",a.openJoinDialog=function(){var e=b.open({templateUrl:"views/join.html",controller:"JoinCtrl",resolve:{items:function(){return a.settings}}});e.result.then(function(a){c.info(a),d.mergeSystems(a.url,a.password,a.currentPassword,a.keepMySystem).then(function(a){if("0"!==a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":case"PASSWORD":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version.";break;case"url":case"URL":b="Wrong url."}alert("Merge failed: "+b)}else alert("Merge succeed."),window.location.reload()})})},a.save=function(){a.settingsForm.$valid?(a.oldSystemName===a.settings.systemName||confirm('If there are others servers in local network with "'+a.settings.systemName+'" system name then it could lead to this server settings loss. Continue?')||(a.settings.systemName=a.oldSystemName),(a.oldSystemName!==a.settings.systemName||a.oldPort!==a.settings.port)&&d.saveSettings(a.settings.systemName,a.settings.port).then(i,h)):alert("form is not valid")},a.changePassword=function(){a.password===a.confirmPassword&&d.changePassword(a.password,a.oldPassword).then(i,h)},a.restart=function(){confirm("Do you want to restart server now?")&&g(!1)},d.getMediaServers().then(function(b){a.mediaServers=_.sortBy(b.data,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id}),f(function(){_.each(a.mediaServers,function(a){var b=0;j(a,b)})},1e3)})}]),angular.module("webadminApp").controller("JoinCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){a.settings={url:"",password:"",currentPassword:"",keepMySystem:!0},a.systems={joinSystemName:"NOT FOUND",systemName:"SYSTEMNAME",systemFound:!1},d.getSettings().then(function(b){a.systems.systemName=b.data.reply.systemName,d.discoveredPeers().then(function(b){var c=_.map(b.data.reply,function(a){return console.log(),{url:window.location.protocol+"//"+a.remoteAddresses[0]+":"+a.port,systemName:a.systemName,ip:a.remoteAddresses[0],name:a.name}});a.systems.discoveredUrls=_.filter(c,function(b){return b.systemName!==a.systems.systemName})})}),a.test=function(){d.pingSystem(a.settings.url,a.settings.password).then(function(b){if("0"!==b.data.error){var c=b.data.errorString;switch(c){case"FAIL":c="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":c="Wrong password.";break;case"INCOMPATIBLE":c="Found system has incompatible version.";break;case"url":c="Wrong url."}alert("Connection failed: "+c)}else a.systems.systemFound=!0,a.systems.joinSystemName=b.data.reply.systemName})},a.join=function(){b.close({url:a.settings.url,password:a.settings.password,keepMySystem:a.settings.keepMySystem,currentPassword:a.settings.currentPassword})},a.selectSystem=function(b){a.settings.url=b.url},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").controller("LoginCtrl",["$scope","mediaserver","ipCookie",function(a,b,c){function d(){return window.location.reload(),!1}a.login=function(){if(a.loginForm.$valid){var e=a.user.username.toLowerCase(),f=c("realm"),g=c("nonce"),h=md5(e+":"+f+":"+a.user.password),i=md5("GET:"),j=md5(h+":"+g+":"+i);c("response",j,{path:"/"}),c("username",e,{path:"/"}),b.getCurrentUser(!0).then(d).catch(function(){alert("not authorized ")})}}}]),angular.module("webadminApp").controller("AdvancedCtrl",["$scope","$modal","$log","mediaserver","$location",function(a,b,c,d,e){function f(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}d.checkAdmin().then(function(a){a||e.path("/info")}),a.someSelected=!1,a.reduceArchiveWarning=!1,d.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return f(a.url)});for(var c=0;c<a.storages.length;c++)a.storages[c].reservedSpaceGb=Math.round(a.storages[c].reservedSpace/1073741824),a.storages[c].url=f(a.storages[c].url);a.$watch(function(){a.reduceArchiveWarning=!1,a.someSelected=!1;for(var b in a.storages){var c=a.storages[b];c.reservedSpace=1073741824*c.reservedSpaceGb,a.someSelected=a.someSelected||c.isUsedForWriting&&c.isWritable,c.reservedSpace>c.freeSpace&&(a.reduceArchiveWarning=!0)}})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]},a.toGBs=function(a){return Math.floor(a/1073741824)},a.update=function(){},a.save=function(){var b,c=!1;_.each(a.storages,function(a){b=b||a.isUsedForWriting,a.reservedSpace>a.freeSpace&&(c="Set reserved space is greater than free space left. Possible partial remove of the video footage is expected. Do you want to continue?")}),b||(c="No storages were selected for writing - video will not be recorded on this server. Do you want to continue?"),(!c||confirm(c))&&d.getSettings().then(function(b){d.getMediaServer(b.data.reply.id.replace("{","").replace("}","")).then(function(b){var c=b.data[0];_.each(a.storages,function(a){var b=_.findWhere(c.storages,{id:a.storageId});null!==b&&(b.spaceLimit=a.reservedSpace,b.usedForWriting=a.isUsedForWriting)}),d.saveStorages(c.storages).then(function(a){if("undefined"!=typeof a.error&&"0"!==a.error){var b=a.errorString;alert("Error: "+b)}else alert("Settings saved")},function(){alert("Error: Couldn't save settings")})})})},a.cancel=function(){window.location.reload()}}]),angular.module("webadminApp").controller("InfoCtrl",["$scope","mediaserver",function(a,b){function c(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}a.logUrl=b.logUrl(),b.getSettings().then(function(b){a.settings=b.data.reply}),b.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return c(a.url)}),_.each(a.storages,function(a){a.url=c(a.url)})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]}}]),angular.module("webadminApp").controller("RestartCtrl",["$scope","$modalInstance","$interval","mediaserver","port",function(a,b,c,d,e){function f(){return window.location.href=h,!1}function g(){var b=j?d.getSettings(h):d.statistics(h);b.then(function(b){return j||b.data.reply.uptimeMs<i?(a.state="server is starting",f()):(a.state="server is restarting",i=b.data.reply.uptimeMs,void setTimeout(g,1e3))},function(){return a.state="server is offline",j=!0,setTimeout(g,1e3),!1})}e=e||window.location.port,a.state="";var h=window.location.protocol+"//"+window.location.hostname+":"+e;a.url=h+window.location.pathname+window.location.search;var i=Number.MAX_VALUE,j=!1;a.refresh=f,d.statistics().then(function(a){i=a.data.reply.uptimeMs,d.restart().then(function(){g()},function(){return g(),!1})},function(){return a.state="server is offline",setTimeout(g,1e3),!1})}]),angular.module("webadminApp").controller("SdkeulaCtrl",["$scope",function(a){a.agree=!1,a.next=function(){return window.open("sdk.zip"),!1}}]),angular.module("webadminApp").controller("WebclientCtrl",function(){}),angular.module("webadminApp").controller("ViewCtrl",["$scope","$rootScope","$location","$routeParams","mediaserver","cameraRecords",function(a,b,c,d,e,f){function g(b){return _.find(a.mediaServers,function(a){return a.id===b.parentId})}function h(b){return a.settings.id===b.id.replace("{","").replace("}","")?"":b.apiUrl.replace("http://","").replace("https://","")}function i(b){console.log("init positionProvider ",b);var c=!b;c&&(b=(new Date).getTime()),a.positionProvider.init(b);var d=a.activeCamera.physicalId,e=g(a.activeCamera),f="";a.settings.id!==e.id.replace("{","").replace("}","")&&(f="/proxy/"+h(e));var i=c?"":"&pos="+b,j=c?"":"&startTimestamp="+b;a.acitveVideoSource=[{src:f+"/media/"+d+".webm?resolution="+a.activeResolution+i,type:"video/webm"},{src:f+"/media/"+d+".mp4?resolution="+a.activeResolution+i,type:"video/mp4"},{src:f+"/hls/"+d+".m3u?resolution="+a.activeResolution+j},{src:f+"/hls/"+d+".m3u8?resolution="+a.activeResolution+j},{src:f+"/media/"+d+".mpegts?resolution="+a.activeResolution+i},{src:f+"/media/"+d+".3gp?resolution="+a.activeResolution+i},{src:f+"/media/"+d+".mpjpeg?resolution="+a.activeResolution+i}]}function j(a){return a=a.split("/")[2]||a.split("/")[0],a.split(":")[0].split("?")[0]}function k(){e.getCameras().then(function(b){function c(a){a.url=j(a.url);var b=0;try{for(var c=a.url.split("."),d=0;d<c.length;d++){var e=3-d;b+=parseInt(c[d])%256*Math.pow(256,e)}if(isNaN(b))throw b;b=b.toString(16),b.length<8&&(b="0"+b)}catch(f){b=a.url}return a.name+"__"+b}var d=b.data,e=_.partition(d,function(a){return""===a.groupId});e[1]=_.sortBy(e[1],c),e[1]=_.groupBy(e[1],function(a){return a.groupId}),e[1]=_.values(e[1]),e[1]=_.map(e[1],function(a){return{isGroup:!0,collapsed:!1,parentId:a[0].parentId,name:a[0].groupName,id:a[0].groupId,url:a[0].url,status:"Online",cameras:a}}),d=_.union(e[0],e[1]),d=_.sortBy(d,c),a.cameras=_.groupBy(d,function(a){return a.parentId}),a.allcameras=d},function(){alert("network problem")})}a.cameras={},a.activeCamera=null,a.activeResolution="320p",a.availableResolutions=["1080p","720p","640p","320p","240p"],a.settings={id:null},e.getSettings().then(function(b){a.settings={id:b.data.reply.id}}),a.activeVideoRecords=null,a.positionProvider=null,a.updateTime=function(b){b=b||0,a.positionProvider.setPlayingPosition(1e3*b),a.positionProvider.liveMode||c.search("time",Math.round(a.positionProvider.playedPosition))},a.playerReady=function(b){a.playerAPI=b,b.play()},a.selectCameraById=function(b,c){a.cameraId=b||a.cameraId,c&&(c=parseInt(c)),a.activeCamera=_.find(a.allcameras,function(b){return b.id===a.cameraId}),a.activeCamera&&(a.positionProvider=f.getPositionProvider([a.activeCamera.physicalId]),a.activeVideoRecords=f.getRecordsProvider([a.activeCamera.physicalId],640),i(c))},a.selectCamera=function(b){c.path("/view/"+b.id,!1),a.selectCameraById(b.id,!1)},b.$on("$routeChangeStart",function(b,d){a.selectCameraById(d.params.cameraId,c.search().time||!1)}),a.switchPosition=function(b){a.positionProvider.checkPlayingDate(b);i(b)},a.$watch("allcameras",function(){a.selectCameraById(a.cameraId,c.search().time||!1)}),e.getMediaServers().then(function(b){_.each(b.data,function(a){a.url=j(a.url),a.collapsed="Online"!==a.status&&(a.allowAutoRedundancy||a.flags.indexOf("SF_Edge")<0)}),a.mediaServers=b.data,k(),a.selectCameraById(d.cameraId,c.search().time||!1)},function(){alert("network problem")})}]),angular.module("webadminApp").controller("HealthCtrl",["$scope","$modal","$log","mediaserver","$timeout",function(a,b,c,d,e){function f(b){for(var c=[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)},{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)}],d=0;d<b.length;d++){var e=i[b[d].deviceType],f=e[d%e.length];c.push({label:b[d].description,fillColor:f,strokeColor:f,pointColor:f,pointStrokeColor:f,pointHighlightFill:f,pointHighlightStroke:f,show:!0,hideLegend:!1,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)})}a.datasets=c,a.updateVisibleDatasets()}function g(b){for(var c=a.datasets,d=function(a){return a.description===f.label},e=2;e<c.length;e++){var f=c[e],g=0,h=_.filter(b,d);h&&h.length>0&&(g=h[0].value),f.data.push(100*g),f.data.length>a.healthLength&&(f.data=f.data.slice(f.data.length-a.healthLength,f.data.length))}}function h(){d.statistics().then(function(b){return null===k&&f(b.data.reply.statistics),a.serverIsOnline=!0,g(200===b.status&&"0"===b.data.error?b.data.reply.statistics:[]),k=e(h,a.interval),!1},function(){g([]),a.serverIsOnline=!1,k=e(h,a.interval)})}a.healthLength=100,a.interval=1e3,a.serverIsOnline=!0;var i={StatisticsCPU:["#3776ca"],StatisticsRAM:["#db3ba9"],StatisticsHDD:["#438231","#484848","#aa880b","#b25e26","#9200d1","#00d5d5","#267f00","#8f5656","#c90000"],StatisticsNETWORK:["#ff3434","#b08f4c","#8484ff","#34ff84"]},j="rgba(255,255,255,0)";a.data={labels:Array.apply(null,new Array(a.healthLength)).map(String.prototype.valueOf,""),datasets:[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)}]},a.legend="",a.options={animation:!1,scaleOverride:!1,scaleSteps:10,scaleShowLabels:!1,scaleLabel:"<%=value%> %",scaleIntegersOnly:!0,responsive:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!1,pointDotRadius:0,pointDotStrokeWidth:1,pointHitDetectionRadius:0,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!1,onAnimationProgress:function(){},onAnimationComplete:function(){},legendTemplate:'<ul class="tc-chart-js-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].strokeColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'},a.updateVisibleDatasets=function(){a.data.datasets=_.filter(a.datasets,function(a){return a.show})};var k=null,l=setTimeout(h,a.interval);a.$on("$destroy",function(){e.cancel(k),clearTimeout(l)})}]);