"use strict";angular.module("webadminApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/join",{templateUrl:"views/join.html",controller:"SettingsCtrl"}).when("/info",{templateUrl:"views/info.html",controller:"InfoCtrl"}).when("/developers",{templateUrl:"views/developers.html",controller:"MainCtrl"}).when("/support",{templateUrl:"views/support.html",controller:"MainCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/advanced",{templateUrl:"views/advanced.html",controller:"AdvancedCtrl"}).when("/webclient",{templateUrl:"views/webclient.html",controller:"WebclientCtrl"}).when("/sdkeula",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).otherwise({redirectTo:"/settings"})}]),angular.module("webadminApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("webadminApp").controller("NavigationCtrl",["$scope","$location","mediaserver",function(a,b,c){a.settings=c.getSettings(),a.settings.then(function(b){a.settings={name:b.data.reply.name,remoteAddresses:b.data.reply.remoteAddresses.join("\n")}}),a.isActive=function(a){var c=b.path().split("/")[1];return c.split("?")[0]===a.split("/")[1].split("?")[0]}}]),angular.module("webadminApp").directive("navbar",function(){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavigationCtrl"}}),angular.module("webadminApp").controller("SettingsCtrl",["$scope","$modal","$log","mediaserver","data",function(a,b,c,d,e){function f(){e.port=a.settings.port,b.open({templateUrl:"views/restart.html",controller:"RestartCtrl"})}function g(a){a.data.reply.restartNeeded?confirm("Changes will be applied after restart. Do you want to restart server now?")&&f():alert("Settings saved")}a.settings=d.getSettings(),a.settings.then(function(b){a.settings={systemName:b.data.reply.systemName,port:b.data.reply.port}}),a.password="",a.oldPassword="",a.confirmPassword="",a.openJoinDialog=function(){var e=b.open({templateUrl:"views/join.html",controller:"JoinCtrl",resolve:{items:function(){return a.settings}}});e.result.then(function(a){c.info(a),d.joinSystem(a.url,a.password).then(function(a){if(0!=a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version."}alert("Connection failed. "+b)}else alert("Connection succeed.")})})},a.save=function(){d.saveSettings(a.settings.systemName,a.settings.port).then(g)},a.changePassword=function(){a.password==a.confirmPassword&&d.changePassword(a.password,a.oldPassword).then(g)},a.restart=function(){confirm("Do you want to restart server now?")&&f()}}]),angular.module("webadminApp").controller("JoinCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){a.settings={url:"",password:""},a.test=function(){d.pingSystem(a.settings.url,a.settings.password).then(function(a){if(0!=a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version."}alert("Connection failed. "+b)}else alert("Connection succeed.")})},a.join=function(){b.close({url:a.settings.url,password:a.settings.password})},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").factory("mediaserver",["$http","$resource",function(a){return{getSettings:function(){return a.get("/api/moduleInformation")},saveSettings:function(b,c){return a.post("/api/configure?systemName="+b+"&port="+c)},changePassword:function(b,c){return a.post("/api/configure?password="+b+"&oldPassword="+c)},joinSystem:function(b,c){return a.post("/api/joinSystem?password="+c+"&url="+encodeURIComponent(b))},pingSystem:function(b,c){return a.post("/api/pingSystem?password="+c+"&url="+encodeURIComponent(b))},restart:function(){return a.post("/api/restart")},getStorages:function(){return a.get("/api/storageSpace")},getMediaServer:function(b){return a.get("/ec2/getMediaServers?id="+b)},saveMediaServer:function(b){return a.post("/ec2/saveMediaServer",b)},statistics:function(b){return b=b||"",a.get(b+"/api/statistics")}}}]),angular.module("webadminApp").directive("nxEqualEx",function(){return{require:"ngModel",link:function(a,b,c,d){return c.nxEqualEx?(a.$watch(c.nxEqualEx,function(a){void 0!==d.$viewValue&&""!==d.$viewValue&&(d.$setValidity("nxEqualEx",a===d.$viewValue),console.log("set valid to "+(a===d.$viewValue)))}),void d.$parsers.push(function(b){if(void 0===b||""===b)return d.$setValidity("nxEqualEx",!0),console.log("set valid to true"),b;var e=b===a.$eval(c.nxEqualEx);return d.$setValidity("nxEqualEx",e),console.log("set valid to "+e),e?b:void 0})):void console.error("nxEqualEx expects a model as an argument!")}}}),angular.module("webadminApp").controller("LoginCtrl",["$scope","auth",function(a,b){a.login=function(){a.loginForm.$valid?b.login(a.user):a.loginForm.submitted=!0}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").directive("icon",function(){return{restrict:"E",scope:{"for":"="},template:'<span ng-show="for || onFalse" class="glyphicon glyphicon-{{for?onTrue:onFalse}} {{class}}" title="{{for?titleTrue:titleFalse}}"></span>',link:function(a,b,c){a.onTrue=c.onTrue||"ok",a.onFalse=c.onFalse,a.class=c.class,a.titleTrue=c.titleTrue,a.titleFalse=c.titleFalse}}}),angular.module("webadminApp").directive("inplaceEdit",function(){return{restrict:"E",templateUrl:"views/inplace-edit.html",scope:{model:"=ngModel"},link:function(a,b,c){var d=a.model;a.type=c.type||"text",a.placeholder=c.placeholder,a.inputId=c.inputId,a.edit=function(){d=a.model,b.find("input").val(d),b.find(".read-container").hide(),b.find(".edit-container").show(),b.find("input").focus()},a.save=function(){d!=a.model&&(console.log("we should call save function here, val:",c.nxOnsave),a.$parent.$eval(c.nxOnsave)),d=a.model,b.find(".read-container").show(),b.find(".edit-container").hide()},a.cancel=function(){a.model=d,a.$apply(),console.log("cancel",d),b.find(".read-container").show(),b.find(".edit-container").hide()},b.find(".edit-container").hide()}}}),angular.module("webadminApp").controller("AdvancedCtrl",["$scope","$modal","$log","mediaserver",function(a,b,c,d){a.storages=d.getStorages(),a.storages.then(function(b){a.storages=b.data.reply.storages;for(var c in a.storages)a.storages[c].reservedSpaceGb=Math.round(1*a.storages[c].reservedSpace/1073741824);a.$watch(function(){for(var b in a.storages){var c=a.storages[b];c.reservedSpace=1073741824*c.reservedSpaceGb,c.warning=c.isUsedForWriting&&(c.reservedSpace<=0||c.reservedSpace>=c.totalSpace)}})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0==a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]},a.toGBs=function(a){return Math.floor(a/1073741824)},a.save=function(){var b,c=!1;_.each(a.storages,function(a){b=b||a.isUsedForWriting,a.reservedSpace>a.freeSpace&&(c="Set reserved space is greater than free space left. Possible partial remove of the video footage is expected. Do you want to continue?")}),b||(c="No storages were selected for writing - video will not be recorded on this server. Do you want to continue?"),(!c||confirm(c))&&d.getSettings().then(function(b){d.getMediaServer(b.data.reply.id.replace("{","").replace("}","")).then(function(b){var c=b.data[0];_.each(a.storages,function(a){var b=_.findWhere(c.storages,{id:a.storageId});null!=b&&(b.spaceLimit=a.reservedSpace,b.usedForWriting=a.isUsedForWriting)}),d.saveMediaServer(c).error(function(a){alert("Error: Couldn't save settings"),console.log("saveMediaServerError",a)}).then(function(a){alert("Settings saved"),console.log("saveMediaServerReply",a)})})})},a.cancel=function(){window.location.reload()}}]),angular.module("webadminApp").controller("InfoCtrl",["$scope","mediaserver",function(a,b){a.storages=b.getStorages(),a.storages.then(function(b){a.storages=b.data.reply.storages}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0==a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]}}]),angular.module("webadminApp").controller("RestartCtrl",["$scope","$modalInstance","$interval","mediaserver","data",function(a,b,c,d,e){function f(){return window.location.href=a.url,window.location.reload(a.url),!1}function g(){d.statistics(h).success(function(){var a=0;return i>a||j?f():(i=a,void setTimeout(g,1e3))}).error(function(){return j=!0,setTimeout(g,1e3),!1})}a.url=window.location.protocol+"//"+window.location.hostname+":"+e.port+window.location.pathname+window.location.search;var h=window.location.protocol+"//"+window.location.hostname+":"+e.port;console.log(a.url);var i=0,j=!1;a.refresh=f,d.statistics().then(function(){i=0,d.restart().then(function(){g()})})}]),angular.module("webadminApp").controller("SdkeulaCtrl",["$scope",function(a){a.agree=!1,a.next=function(){return window.open("sdk.zip"),!1}}]),angular.module("webadminApp").controller("WebclientCtrl",["$scope","$modalInstance","$interval","mediaserver",function(){}]),angular.module("webadminApp").factory("data",function(){return{port:0}});