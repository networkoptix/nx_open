"use strict";function Chunk(a,b,c,d,e,f){this.start=b,this.end=c,this.level=d||0,this.expand=!0;var g="dd.mm.yyyy HH:MM";this.title="undefined"==typeof e||null===e?dateFormat(b,g)+" - "+dateFormat(c,g):e,this.children=[],_.extend(this,f)}function Interval(a,b,c,d,e,f,g){this.seconds=b,this.minutes=c,this.hours=d,this.days=e,this.months=f,this.years=g,this.milliseconds=a}function isDate(a){return a instanceof Date}function CameraRecordsProvider(a,b,c,d){this.cameras=a,this.mediaserver=b,this.$q=c,this.chunksTree=null,this.requestedCache=[],this.width=d;var e=this;this.requestInterval(0,e.now()+1e4,0).then(function(){if(e.chunksTree){var a=RulerModel.getLevelIndex(e.now()-e.chunksTree.start,e.width);e.requestInterval(e.chunksTree.start,e.now(),a+1)}})}function ShortCache(a,b,c){this.$q=c,this.mediaserver=b,this.cameras=a,this.start=0,this.played=0,this.playedPosition=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.requestInterval=9e4,this.updateInterval=6e4,this.requestDetailization=1,this.limitChunks=10,this.checkpointsFrequency=6e4}function ScaleManager(a,b,c,d){this.absMaxMsPerPixel=b,this.minMsPerPixel=a,this.levels={topLabels:{index:0,level:RulerModel.levels[0]},labels:{index:0,level:RulerModel.levels[0]},lowerMarks:{index:0,level:RulerModel.levels[0]},events:{index:0,level:RulerModel.levels[0]}},this.viewportWidth=d,this.end=(new Date).getTime(),this.start=this.end-c,this.updateTotalInterval(),this.msPerPixel=this.maxMsPerPixel,this.anchorPoint=1,this.anchorDate=this.end,this.updateCurrentInterval()}var Config={globalEditServersPermissions:32,demo:"/~ebalashov/webclient/api",demoMedia:"//demo.networkoptix.com:7001",demoAuth:"&auth=d2ViY2xpZW50OjA6MWVjNmZkNjBkZWI2ZjY1OWIzOWM5NTljMjNkNDEyY2Y=",helpLinks:[]};angular.module("webadminApp",["ipCookie","ngResource","ngSanitize","ngRoute","ui.bootstrap","tc.chartjs","com.2fdevs.videogular","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.buffering","com.2fdevs.videogular.plugins.dash","com.2fdevs.videogular.plugins.poster"]).config(["$routeProvider",function(a){a.when("/settings",{templateUrl:"views/settings.html",controller:"SettingsCtrl"}).when("/join",{templateUrl:"views/join.html",controller:"SettingsCtrl"}).when("/info",{templateUrl:"views/info.html",controller:"InfoCtrl"}).when("/developers",{templateUrl:"views/developers.html",controller:"MainCtrl"}).when("/support",{templateUrl:"views/support.html",controller:"MainCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html"}).when("/advanced",{templateUrl:"views/advanced.html",controller:"AdvancedCtrl"}).when("/webclient",{templateUrl:"views/webclient.html",controller:"WebclientCtrl",reloadOnSearch:!1}).when("/view/",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/view/:cameraId",{templateUrl:"views/view.html",controller:"ViewCtrl",reloadOnSearch:!1}).when("/sdkeula",{templateUrl:"views/sdkeula.html",controller:"SdkeulaCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).when("/log",{templateUrl:"views/log.html",controller:"LogCtrl"}).otherwise({redirectTo:"/settings"})}]),angular.module("webadminApp").run(["$route","$rootScope","$location",function(a,b,c){var d=c.path;c.path=function(e,f){if(f===!1)var g=a.current,h=b.$on("$locationChangeSuccess",function(){a.current=g,h()});return d.apply(c,[e])}}]),angular.module("webadminApp").factory("mediaserver",["$http","$modal","$q","ipCookie","$log",function(a,b,c,d,e){function f(){return a.get(k+"/api/moduleInformation?showAddresses=true")}function g(a){if(401===a.status){var c=window.self!==window.top;return void(c||null!==p||(p=b.open({templateUrl:"views/login.html",keyboard:!1,backdrop:"static"}),p.result.then(function(){p=null})))}i=null,null===o&&f(!0).catch(function(a){console.warn("remove hack here!!!")})}function h(a){return a.catch(g),a}var i=null,j=null,k="";if(location.search.indexOf("proxy=")>0)for(var l=location.search.replace("?","").split("&"),m=0;m<l.length;m++){var n=l[m].split("=");if("proxy"===n[0]){k="/proxy/"+n[1],"demo"==n[1]&&(k=Config.demo);break}}d("Authorization","Digest",{path:"/"});var o=null,p=null;return{url:function(){return k},mediaDemo:function(){return k==Config.demo?Config.demoMedia:!1},logUrl:function(a){return k+"/api/showLog"+(a||"")},authForMedia:function(){return d("auth")},previewUrl:function(a,b){return k+"/api/image?physicalId="+a+("&time="+(b||"NOW"))},hasProxy:function(){return""!==k},checkAdmin:function(){var a=c.defer();return this.hasProxy()&&a.resolve(!1),this.getCurrentUser().then(function(b){var c=b.data.reply.isAdmin||b.data.reply.permissions&Config.globalEditServersPermissions;a.resolve(c)}),a.promise},getSettings:function(b){return b=b||k,b===!0?(i=null,f()):""===b?(null===i&&(i=h(f())),i):a.get(b+"/api/moduleInformation?showAddresses=true",{timeout:3e3})},saveSettings:function(b,c){return h(a.post(k+"/api/configure?systemName="+b+"&port="+c))},changePassword:function(b,c){return h(a.post(k+"/api/configure?password="+b+"&oldPassword="+c))},mergeSystems:function(b,c,d,e){return h(a.post(k+"/api/mergeSystems?password="+c+"&currentPassword="+d+"&url="+encodeURIComponent(b)+"&takeRemoteSettings="+!e))},pingSystem:function(b,c){return h(a.post(k+"/api/pingSystem?password="+c+"&url="+encodeURIComponent(b)))},restart:function(){return h(a.post(k+"/api/restart"))},getStorages:function(){return h(a.get(k+"/api/storageSpace"))},saveStorages:function(b){return h(a.post(k+"/ec2/saveStorages",b))},discoveredPeers:function(){return h(a.get(k+"/api/discoveredPeers?showAddresses=true"))},getMediaServer:function(b){return h(a.get(k+"/ec2/getMediaServersEx?id="+b.replace("{","").replace("}","")))},getMediaServers:function(){return h(a.get(k+"/ec2/getMediaServersEx"))},getCameras:function(b){return h("undefined"!=typeof b?a.get(k+"/ec2/getCamerasEx?id="+b.replace("{","").replace("}","")):a.get(k+"/ec2/getCamerasEx"))},saveMediaServer:function(b){return h(a.post(k+"/ec2/saveMediaServer",b))},statistics:function(b){return b=b||k,h(a.get(b+"/api/statistics?salt="+(new Date).getTime()))},getCurrentUser:function(b){return(null===j||b)&&(j=h(a.get(k+"/api/getCurrentUser"))),j},getRecords:function(b,c,d,e,f,g,i){var j=new Date;return"undefined"==typeof d&&(d=j.getTime()-2592e6),"undefined"==typeof e&&(e=j.getTime()+1e5),"undefined"==typeof f&&(f=(e-d)/1e3),"undefined"==typeof i&&(i=0),"undefined"==typeof g&&(g=Number.MAX_VALUE),"/"!==b&&""!==b&&null!==b&&(b="/proxy/"+b+"/"),k==Config.demo&&(b=k+"/"),h(a.get(b+"api/RecordedTimePeriods?physicalId="+c+"&startTime="+d+"&endTime="+e+"&detail="+f+"&periodsType="+i+"&limit="+g))}}}]),Chunk.prototype.debug=function(){console.log(new Array(this.level+1).join(" "),this.title,this.level,this.children.length)},Number.isInteger||(Number.isInteger=function(a){return"number"==typeof a&&Math.round(a)===a}),Interval.prototype.addToDate=function(a,b){if(Number.isInteger(a)&&(a=new Date(a)),!isDate(a))return console.error("non date "+typeof a+": "+a,Number.isInteger(a),(0^a)===a,0^a),a;"undefined"==typeof b&&(b=1);try{return new Date(a.getFullYear()+b*this.years,a.getMonth()+b*this.months,a.getDate()+b*this.days,a.getHours()+b*this.hours,a.getMinutes()+b*this.minutes,a.getSeconds()+b*this.seconds,a.getMilliseconds()+b*this.milliseconds)}catch(c){throw console.log(a),c}},Interval.prototype.getMilliseconds=function(){var a=new Date(1971,11,1,0,0,0,0),b=this.addToDate(a);return b.getTime()-a.getTime()},Interval.prototype.alignToPast=function(a){var b=new Date(a);return 0!==this.milliseconds?(b.setMilliseconds(Math.floor(b.getMilliseconds()/this.milliseconds)*this.milliseconds),b):(b.setMilliseconds(0),0!==this.seconds?(b.setSeconds(Math.floor(b.getSeconds()/this.seconds)*this.seconds),b):(b.setSeconds(0),0!==this.minutes?(b.setMinutes(Math.floor(b.getMinutes()/this.minutes)*this.minutes),b):(b.setMinutes(0),0!==this.hours?(b.setHours(Math.floor(b.getHours()/this.hours)*this.hours),b):(b.setHours(0),0!==this.days?(b.setDate(Math.floor(b.getDate()/this.days)*this.days),b):(b.setDate(1),0!==this.months?(b.setMonth(Math.floor(b.getMonth()/this.months)*this.months),b):(b.setMonth(0),b.setYear(Math.floor(b.getFullYear()/this.years)*this.years),b))))))},Interval.prototype.checkDate=function(a){return Number.isInteger(a)&&(a=new Date(a)),isDate(a)?this.alignToPast(a).getTime()===a.getTime():(console.error("checkDate - non date",a),!1)},Interval.prototype.alignToFuture=function(a){return this.alignToPast(this.addToDate(a))};var RulerModel={levels:[{name:"Age",interval:new Interval(0,0,0,0,0,0,100),format:"yyyy",width:30,lowerWidth:15,topWidth:0,topFormat:"yyyy"},{name:"Decade",interval:new Interval(0,0,0,0,0,0,10),format:"yyyy",width:30,lowerWidth:15},{name:"Year",format:"yyyy",interval:new Interval(0,0,0,0,0,0,1),width:30,topWidth:100,topFormat:"yyyy"},{name:"6 Months",interval:new Interval(0,0,0,0,0,6,0),format:"mmmm",width:90,lowerWidth:15},{name:"3 Months",interval:new Interval(0,0,0,0,0,3,0),format:"mmmm",width:90,lowerWidth:15},{name:"Month",interval:new Interval(0,0,0,0,0,1,0),format:"mmmm",width:90,lowerWidth:15,topWidth:170,topFormat:"mmmm yyyy"},{name:"Day",interval:new Interval(0,0,0,0,1,0,0),format:"dd",width:30,lowerWidth:5,topWidth:170,topFormat:"d mmmm yyyy"},{name:"12 hours",interval:new Interval(0,0,0,12,0,0,0),format:'HH"h"',width:100,lowerWidth:40},{name:"6 hours",interval:new Interval(0,0,0,6,0,0,0),format:'HH"h"',width:80,lowerWidth:40},{name:"3 hours",interval:new Interval(0,0,0,3,0,0,0),format:'HH"h"',width:80,lowerWidth:40},{name:"Hour",interval:new Interval(0,0,0,1,0,0,0),format:'HH"h"',width:80,lowerWidth:40},{name:"30 minutes",interval:new Interval(0,0,30,0,0,0,0),format:"HH:MM",width:80,lowerWidth:40},{name:"10 minutes",interval:new Interval(0,0,10,0,0,0,0),format:"HH:MM",width:80,lowerWidth:40},{name:"5 minutes",interval:new Interval(0,0,5,0,0,0,0),format:"HH:MM",width:80,lowerWidth:40},{name:"1 minute",interval:new Interval(0,0,1,0,0,0,0),format:"HH:MM",width:80,lowerWidth:40,topWidth:170,topFormat:"d mmmm yyyy HH:MM"},{name:"30 seconds",interval:new Interval(0,30,0,0,0,0,0),format:'ss"s"',width:100,lowerWidth:40},{name:"10 seconds",interval:new Interval(0,10,0,0,0,0,0),format:'ss"s"',width:80,lowerWidth:40},{name:"5 seconds",interval:new Interval(0,5,0,0,0,0,0),format:'ss"s"',width:70,lowerWidth:40},{name:"1 second",interval:new Interval(0,1,0,0,0,0,0),format:'ss"s"',width:60,lowerWidth:40,topWidth:200,topFormat:"d mmmm yyyy HH:MM:ss"},{name:"500 ms",interval:new Interval(500,0,0,0,0,0,0),format:'l"ms"',width:120,lowerWidth:40},{name:"100 ms",interval:new Interval(100,0,0,0,0,0,0),format:'l"ms"',width:80,lowerWidth:40}],getLevelIndex:function(a,b){b=b||1;var c=_.find(RulerModel.levels,function(c){return c.interval.getMilliseconds()<a/b});return"undefined"!=typeof c?RulerModel.levels.indexOf(c):RulerModel.levels.length-1},findBestLevelIndex:function(a){var b=0,c=function(c,d){return c.interval.checkDate(a)?(b=d,!0):!1};return _.find(RulerModel.levels,c),b},findBestLevel:function(a){return this.levels[this.findBestLevelIndex(a)]}};CameraRecordsProvider.prototype.now=function(){return(new Date).getTime()},CameraRecordsProvider.prototype.cacheRequestedInterval=function(a,b,c){for(var d=0;c+1>d;d++)if(d>=this.requestedCache.length)this.requestedCache.push([{start:a,end:b}]);else for(var e=0;e<this.requestedCache[d].length;e++)if(!(this.requestedCache[d][e].end<a)){if(this.requestedCache[d][e].start>b){this.requestedCache[d].splice(e,0,{start:a,end:b});break}this.requestedCache[d][e].start=Math.min(a,this.requestedCache[d][e].start),this.requestedCache[d][e].end=Math.max(b,this.requestedCache[d][e].end);break}},CameraRecordsProvider.prototype.checkRequestedIntervalCache=function(a,b,c){if("undefined"==typeof this.requestedCache[c])return!1;for(var d=this.requestedCache[c],e=0;e<d.length;e++){if(a<d[e].start)return!1;if(a=Math.max(a,d[e].end),b<d[e].end)return!0}return a>=b},CameraRecordsProvider.prototype.requestInterval=function(a,b,c){var d=this.$q.defer();this.start=a,this.end=b,this.level=c;var e=RulerModel.levels[c].interval.getMilliseconds(),f=this;return f.lockRequests?d.reject("request in progress"):(f.lockRequests=!0,this.mediaserver.getRecords("/",this.cameras[0],a,b,e).then(function(e){f.cacheRequestedInterval(a,b,c),f.lockRequests=!1,0==e.data.length&&console.log("no chunks for this camera");for(var g=0;g<e.data.length;g++){var h=e.data[g][0]+e.data[g][1];e.data[g][1]<0&&(h=(new Date).getTime()+1e5);var i=new Chunk(null,e.data[g][0],h,c);f.addChunk(i,null)}d.resolve(f.chunksTree)},function(a){d.reject(a)})),this.ready=d.promise,this.ready},CameraRecordsProvider.prototype.getIntervalRecords=function(a,b,c){a instanceof Date&&(a=a.getTime()),b instanceof Date&&(b=b.getTime());var d=[];this.selectRecords(d,a,b,c,null);var e=this.checkRequestedIntervalCache(a,b,c);return e||this.requestInterval(a,b,c),d},CameraRecordsProvider.prototype.debug=function(a){if(a||console.log("Chunks tree:"+(this.chunksTree?"":"empty")),a=a||this.chunksTree){a.debug();for(var b=0;b<a.children.length;b++)this.debug(a.children[b])}},CameraRecordsProvider.prototype.addChunk=function(a,b){if(null===this.chunksTree||0===a.level)return void(this.chunksTree=a);if(b=b||this.chunksTree,0===b.children.length)return b.level===a.level-1?void b.children.push(a):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[0]));if(b.level===a.level-1){for(d=0;d<b.children.length;d++){if(b.children[d].start==a.start&&b.children[d].end==a.end)return;if(b.children[d].end>=a.start&&b.children[d].start<=a.start){if(b.children[d].end>=a.end)return void console.warn("skipped contained chunk 1",a,b.children[d],d,b);return}if(b.children[d].start>=a.start){if(b.children[d].start<a.end){if(b.children[d].end<=a.start)return void console.warn("skipped contained chunk 2",a,b.children[d],d,b);return}break}}return void b.children.splice(d,0,a)}for(var c=b.level<RulerModel.levels.length-1?RulerModel.levels[b.level+1].interval.getMilliseconds():RulerModel.levels[RulerModel.length-1].interval.getMilliseconds(),d=0;d<b.children.length;d++){var e=b.children[d];if(!(e.end<a.start))return e.start<=a.start&&e.end>=a.end?void this.addChunk(a,e):e.start-a.end<c?(e.start=a.start,void this.addChunk(a,e)):d>0&&a.start-b.children[d-1].end<c?(b.children[d-1].end=a.end,void this.addChunk(a,b.children[d-1])):(b.children.splice(d,0,new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[d]))}return a.start-b.children[d-1].end<c?(b.children[d-1].end=a.end,void this.addChunk(a,b.children[d-1])):(b.children.push(new Chunk(b,a.start,a.end,b.level+1)),void this.addChunk(a,b.children[d]))},CameraRecordsProvider.prototype.selectRecords=function(a,b,c,d,e){e=e||this.chunksTree;var f=0;if(!e)return!1;if(e.children.length>0)for(var g=0;g<e.children.length;g++){var h=e.children[g];if(!(h.end<b)){if(h.start>c)break;h.level===d?(f++,a.push(h)):f+=this.selectRecords(a,b,c,d,h)}}return 0===f&&(f++,a.push(e)),f},ShortCache.prototype.init=function(a){this.start=a,this.playedPosition=a,this.played=0,this.lastRequestPosition=null,this.currentDetailization=[],this.checkPoints={},this.updating=!1,this.lastPlayedPosition=0,this.lastPlayedDate=0,this.update()},ShortCache.prototype.update=function(a,b){if(!this.updating||a){a=a||this.playedPosition,this.updating=!0;var c=this;this.lastRequestDate=a,this.lastRequestPosition=b||this.played,this.mediaserver.getRecords("/",this.cameras[0],a,(new Date).getTime()+1e3,this.requestDetailization,this.limitChunks).then(function(b){c.updating=!1,0==b.data.length&&console.log("no chunks for this camera and interval"),b.data.length>0&&parseInt(b.data[0][0])<a&&(b.data[0][1]-=a-parseInt(b.data[0][0]),b.data[0][0]=a),c.currentDetailization=b.data;for(var d=c.lastRequestDate,e=c.lastRequestPosition,f=0,g=0;g<c.currentDetailization.length;g++)e+=c.currentDetailization[g][1],d=c.currentDetailization[g][0]+c.currentDetailization[g][1],d-f>c.checkpointsFrequency&&(f=d,c.checkPoints[e]=d)})}},ShortCache.prototype.checkPlayingDate=function(a){if(a<this.start)return console.log("too left!",new Date(a),new Date(this.start),a-this.start),!1;if(a>this.lastPlayedDate)return console.log("too right!",new Date(a),new Date(this.lastPlayedDate),a-this.lastPlayedDate),!1;var b;for(var c in this.checkPoints)if(this.checkPoints.hasOwnProperty(c)){if(this.checkPoints[c]>a)break;b=c}return"undefined"==typeof b?(console.log("no checkpoints found - use the start point!"),a-this.start):b+a-this.checkPoints[c]},ShortCache.prototype.setPlayingPosition=function(a){if(this.played=a,this.playedPosition=0,a<this.lastRequestPosition){var b;for(var c in this.checkPoints){if(c>a)break;b=c}this.playedPosition=b+a-this.checkPoints[b],console.log("back on timeline"),this.update(this.checkPoints[b],b)}var d=a-this.lastRequestPosition;this.playedPosition=this.lastRequestDate+d;for(var e=0;e<this.currentDetailization.length&&(d-=this.currentDetailization[e][1],this.playedPosition=this.currentDetailization[e][0]+this.currentDetailization[e][1]+d,!(0>=d));e++);return this.liveMode=!1,e==this.currentDetailization.length&&(this.playedPosition=(new Date).getTime(),this.liveMode=!0),!this.liveMode&&this.currentDetailization.length>0&&this.currentDetailization[this.currentDetailization.length-1][1]+this.currentDetailization[this.currentDetailization.length-1][0]<this.playedPosition+this.updateInterval&&this.update(),a>this.lastPlayedPosition&&(this.lastPlayedPosition=a,this.lastPlayedDate=this.playedPosition),this.playedPosition},ScaleManager.prototype.updateTotalInterval=function(){this.maxMsPerPixel=(this.end-this.start)/this.viewportWidth,this.msPerPixel=Math.min(this.msPerPixel,this.maxMsPerPixel)},ScaleManager.prototype.setViewportWidth=function(a){this.viewportWidth=a,this.updateTotalInterval(),this.updateCurrentInterval()},ScaleManager.prototype.setStart=function(a){this.start=a,this.updateTotalInterval()},ScaleManager.prototype.setEnd=function(a){this.end=a,this.updateTotalInterval()},ScaleManager.prototype.bound=function(a,b,c){return b=Math.max(b,a),Math.min(b,c)},ScaleManager.prototype.updateCurrentInterval=function(){this.msPerPixel=this.bound(this.minMsPerPixel,this.msPerPixel,this.maxMsPerPixel),this.anchorPoint=this.bound(0,this.anchorPoint,1),this.anchorDate=this.bound(this.start,Math.round(this.anchorDate),this.end),this.visibleStart=Math.round(this.anchorDate-this.msPerPixel*this.viewportWidth*this.anchorPoint),this.visibleEnd=Math.round(this.anchorDate+this.msPerPixel*this.viewportWidth*(1-this.anchorPoint)),this.visibleStart<this.start&&(this.visibleEnd+=this.start-this.visibleStart,this.visibleStart=this.start),this.visibleEnd>this.end&&(this.visibleStart+=this.end-this.visibleEnd,this.visibleEnd=this.end),this.visibleStart>this.visibleEnd&&console.error("wtf! visibleStart > visibleEnd ?",new Date(this.visibleStart),new Date(this.visibleEnd)),this.updateLevels()},ScaleManager.prototype.tryToSetLiveDate=function(a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>=0&&1>=b&&this.setAnchorDateAndPoint(a,this.anchorPoint)},ScaleManager.prototype.tryToRestoreAnchorDate=function(a){var b=this.dateToScreenCoordinate(a)/this.viewportWidth;b>=0&&1>=b&&(this.anchorDate=a,this.anchorPoint=b)},ScaleManager.prototype.setAnchorCoordinate=function(a){this.setAnchorDateAndPoint(this.screenCoordinateToDate(a),a/this.viewportWidth)},ScaleManager.prototype.setAnchorDateAndPoint=function(a,b){this.anchorDate=a,"undefined"!=typeof b&&(this.anchorPoint=b),this.updateCurrentInterval()},ScaleManager.prototype.fullZoomOut=function(){this.msPerPixel=this.maxMsPerPixel,this.updateCurrentInterval()},ScaleManager.prototype.updateLevels=function(){for(var a=this.levels,b=0;b<RulerModel.levels.length;b++){var c=RulerModel.levels[b],d=c.interval.getMilliseconds()/this.msPerPixel;if("undefined"!=typeof c.topWidth&&d>=c.topWidth&&(a.topLabels={index:b,level:c}),d>=c.width&&(a.labels={index:b,level:c}),d>=c.lowerWidth&&(a.lowerMarks={index:b,level:c}),d>=1&&(a.events={index:b,level:c}),1>=d)break}if(a.topLabels.index==a.labels.index&&a.topLabels.index>0)do a.topLabels.index--,a.topLabels.level=RulerModel.levels[a.topLabels.index];while(!a.topLabels.level.topWidth&&a.topLabels.index);return a},ScaleManager.prototype.alignStart=function(a){return a.interval.alignToPast(this.visibleStart)},ScaleManager.prototype.alignEnd=function(a){return a.interval.alignToFuture(this.visibleEnd)},ScaleManager.prototype.dateToScreenCoordinate=function(a){return Math.round(this.viewportWidth*(a-this.visibleStart)/(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.screenCoordinateToDate=function(a){return Math.round(this.visibleStart+a/this.viewportWidth*(this.visibleEnd-this.visibleStart))},ScaleManager.prototype.getRelativeCenter=function(){return((this.visibleStart+this.visibleEnd)/2-this.start)/(this.end-this.start)},ScaleManager.prototype.getRelativeWidth=function(){return(this.visibleEnd-this.visibleStart)/(this.end-this.start)},ScaleManager.prototype.scroll=function(a){if("undefined"==typeof a)return this.getRelativeCenter();a=this.bound(0,a,1);var b=this.anchorDate;this.setAnchorDateAndPoint(this.start+a*(this.end-this.start),.5),this.tryToRestoreAnchorDate(b)},ScaleManager.prototype.scrollByPixels=function(a){this.scroll(this.scroll()+a/this.viewportWidth*this.getRelativeWidth())},ScaleManager.prototype.zoomToMs=function(a){var b=this.minMsPerPixel*Math.pow(this.absMaxMsPerPixel/this.minMsPerPixel,a);return this.bound(this.minMsPerPixel,b,this.maxMsPerPixel)},ScaleManager.prototype.msToZoom=function(a){var b=Math.log(a/this.minMsPerPixel)/Math.log(this.absMaxMsPerPixel/this.minMsPerPixel);return b},ScaleManager.prototype.availableZoomProportion=function(){return(this.msToZoom(this.maxMsPerPixel)-this.msToZoom(this.minMsPerPixel))/this.msToZoom(this.absMaxMsPerPixel)},ScaleManager.prototype.zoom=function(a){return"undefined"==typeof a?this.msToZoom(this.msPerPixel):(this.msPerPixel=this.zoomToMs(a),void this.updateCurrentInterval())},ScaleManager.prototype.zoomAroundDate=function(a,b){var c=this.anchorDate;this.tryToRestoreAnchorDate(b),this.zoom(a),this.tryToRestoreAnchorDate(c)},angular.module("webadminApp").factory("cameraRecords",["mediaserver","$q",function(a,b){return{getRecordsProvider:function(c,d){return new CameraRecordsProvider(c,a,b,d)},getPositionProvider:function(c){return new ShortCache(c,a,b)}}}]),angular.module("webadminApp").service("auth",["$http",function(a){this.login=function(b){return a.post("/ec2/login",{username:b.username,password:b.password})}}]),angular.module("webadminApp").factory("animateScope",["$q",function(a){function b(b,c,d,e,f){this.scope=b,this.value=c,this.targetValue=d,this.duration=e,this.started=(new Date).getTime(),this.initialValue=b[c],this.isFinished=!1,this.dependency=f,this.deferred=a.defer()}function c(){var a=[],b=[];_.forEach(e,function(c){c.update(),b.indexOf(c.scope)<0&&c.scope!==h&&b.push(c.scope),c.isFinished&&a.push(c)}),_.forEach(a,function(a){e.splice(e.indexOf(a),1)}),_.forEach(b,function(a){a.$apply()})}function d(a){i&&(c(),"undefined"!=typeof j&&null!==j&&j!==!1&&j(),h.$root.$$phase&&!a&&console.error("wrong phase",h.$root.$$phase),null===h||a||h.$apply(),0!==f&&(window.animationFrame(d),f&&f--))}var e=[],f=null,g=1e3,h=null;b.prototype.interpolate=function(a,b,c,d,e){switch(e){case"smooth":default:return this.smooth(a,b,c,d);case"fading":return this.fading(a,b,c,d);case"linear":return this.linear(a,b,c,d)}},b.prototype.linear=function(a,b,c,d){c>d&&(c=d);var e=a+(b-a)*c/d;return isNaN(e)&&console.log("linear-error",e,a,b,c,d),e},b.prototype.smooth=function(a,b,c,d){c>d&&(c=d);var e=(Math.sin(c/d*Math.PI-Math.PI/2)+1)/2,f=a+(b-a)*e;return f},b.prototype.fading=function(a,b,c,d){c>d&&(c=d);var e=1-Math.cos(c/d*Math.PI/2);return a+(b-a)*e},b.prototype.breakAnimation=function(){this.isFinished=!0,this.deferred.reject(this.scope[this.value])},b.prototype.update=function(){if(!this.isFinished){var a=(new Date).getTime()-this.started;this.scope[this.value]=this.interpolate(this.initialValue,this.targetValue,a,this.duration,this.dependency),this.deferred.notify(this.scope[this.value]),this.isFinished=a>this.duration,this.isFinished&&this.deferred.resolve(this.scope[this.value])}};var i=!1;window.animationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,20)}}();var j=null;return{start:function(a){i=!0,j=a,d(!0)},stop:function(){i=!1},animating:function(a,b){var c=_.find(e,function(c){return c.scope===a&&c.value===b});return c},animate:function(a,c,d,f,h){"undefined"==typeof f&&(f=g);var i=_.find(e,function(b){return b.scope===a&&b.value===c});i&&i.breakAnimation();var j=new b(a,c,d,f,h);return e.push(j),j.deferred.promise},progress:function(a,b,c,d){return a[b]=0,this.animate(a,b,1,c,d)},setDuration:function(a){g=a},setScope:function(a){h=a}}}]),angular.module("webadminApp").directive("navbar",function(){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavigationCtrl",scope:{noPanel:"="}}}),angular.module("webadminApp").directive("nxEqualEx",["$log",function(a){return{require:"ngModel",link:function(b,c,d,e){function f(){void 0!==e.$viewValue&&""!==e.$viewValue&&e.$setValidity("nxEqualEx",b.$eval(d.nxEqualEx)===e.$viewValue)}return d.nxEqualEx?(b.$watch(d.nxEqualEx,f),b.$watch("$viewValue",f),void e.$parsers.push(function(a){if(void 0===a||""===a)return e.$setValidity("nxEqualEx",!0),a;var c=a===b.$eval(d.nxEqualEx);return e.$setValidity("nxEqualEx",c),a})):void a.error("nxEqualEx expects a model as an argument!")}}}]),angular.module("webadminApp").directive("icon",function(){return{restrict:"E",scope:{"for":"="},template:"<span ng-if='for || onFalse' class='glyphicon glyphicon-{{for?onTrue:onFalse}} {{class}}' title='{{for?titleTrue:titleFalse}}'></span>",link:function(a,b,c){a.onTrue=c.onTrue||"ok",a.onFalse=c.onFalse,a["class"]=c["class"],a.titleTrue=c.titleTrue,a.titleFalse=c.titleFalse}}}),angular.module("webadminApp").directive("fileupload",function(){return{restrict:"E",template:"<span class='btn btn-success fileinput-button' ><span>{{text}}</span><input type='file' name='installerFile1' class='fileupload' id='fileupload' ></span><div class='progress' style='display:none;'><div class='progress-bar progress-bar-success progress-bar-striped'></div></div>",link:function(a,b,c){b.find(".fileupload").fileupload({url:c.url,dataType:"json",done:function(a,c){if("0"===c.result.error)alert("Updating successfully started. It will take several minutes");else switch(c.result.errorString){case"UP_TO_DATE":alert("Updating failed. The provided version is already installed.");break;case"INVALID_FILE":alert("Updating failed. Provided file is not a valid update archive.");break;case"INCOMPATIBLE_SYSTEM":alert("Updating failed. Provided file is targeted for another system.");break;case"EXTRACTION_ERROR":alert("Updating failed. Extraction failed, check available storage.");break;case"INSTALLATION_ERROR":alert("Updating failed. Couldn't execute installation script.")}b.find(".progress").hide()},progressall:function(a,c){var d=parseInt(c.loaded/c.total*100,10);b.find(".progress").show(),b.find(".progress-bar").css("width",d+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),a.text=c.text||"Select files"}}}),angular.module("webadminApp").directive("inplaceEdit",function(){return{restrict:"E",templateUrl:"views/inplace-edit.html",scope:{model:"=ngModel"},link:function(a,b,c){var d=a.model;a.type=c.type||"text",a.placeholder=c.placeholder,a.inputId=c.inputId,a.edit=function(){d=a.model,b.find("input").val(d),b.find(".read-container").hide(),b.find(".edit-container").show(),b.find("input").focus()},a.save=function(){d!==a.model&&a.$parent.$eval(c.nxOnsave),d=a.model,b.find(".read-container").show(),b.find(".edit-container").hide()},a.cancel=function(){a.model=d,a.$apply(),b.find(".read-container").show(),b.find(".edit-container").hide()},b.find(".edit-container").hide()}}}),angular.module("webadminApp").directive("timeline",["$interval","$timeout","animateScope",function(a,b,c){return{restrict:"E",scope:{recordsProvider:"=",positionProvider:"=",playHandler:"=",ngClick:"&",positionHandler:"="},templateUrl:"views/components/timeline.html",link:function(a,b){function d(){a.viewportHeight=b.find(".viewport").height(),A.height=a.viewportHeight}function e(){a.viewportWidth=b.find(".viewport").width(),A.width=a.viewportWidth,a.scaleManager.setViewportWidth(a.viewportWidth)}function f(){var b=(new Date).getTime();a.scaleManager.setStart(a.recordsProvider?a.recordsProvider.start:b-x.initialInterval),a.scaleManager.setEnd(b),a.scaleManager.fullZoomOut()}function g(){a.scaleManager.setEnd((new Date).getTime()),a.positionProvider&&a.scaleManager.tryToSetLiveDate(a.positionProvider.playedPosition);var b=j();k(b),l(b),m(b),p(b),r(b),s(b),t(b)}function h(a,b){if("string"==typeof a)return a;"undefined"==typeof b&&(b=1),b>1&&console.error("bad value",b),a.length>3&&(b*=a[3]);var c="rgba("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+","+b+")";return c}function i(a){return a.weight+" "+a.size+"px "+a.face}function j(){var b=A.getContext("2d");return b.fillStyle=h(x.timelineBgColor,1),b.fillRect(0,0,a.viewportWidth,a.viewportHeight),b.lineWidth=x.lineWidth,b}function k(b){var d=a.scaleManager.levels.topLabels.index;d!=C&&(C=d,c.progress(a,"changingTopLevel").then(function(){B=C})),n(b,B,C,a.changingTopLevel,"topFormat",x.topLabelFixed,0,x.topLabelHeight,x.topLabelFont,x.topLabelAlign,x.topLabelBgColor,x.topLabelBgOddColor,x.topLabelMarkerColor,x.topLabelPositionFix,x.topLabelMarkerAttach,x.topLabelMarkerHeight)}function l(b){var d=a.scaleManager.levels.labels.index;d!=E&&(E=d,c.progress(a,"changingLevel").then(function(){D=E})),n(b,D,E,a.changingLevel,"format",x.labelFixed,x.topLabelHeight,x.labelHeight,x.labelFont,x.labelAlign,x.labelBgColor,x.labelBgColor,x.labelMarkerColor,x.labelPositionFix,x.labelMarkerAttach,x.labelMarkerHeight)}function m(b){var d=a.scaleManager.levels.lowerMarks.index;d!=G&&(G=d,c.progress(a,"changingLowerMarksLevel").then(function(){F=G})),n(b,F,G,a.changingLowerMarksLevel,!1,"none",x.topLabelHeight,x.labelHeight,null,null,null,null,x.lowerMarksColor,0,x.lowerMarkerAttach,x.lowerMarksHeight)}function n(b,c,d,e,f,g,h,i,j,k,l,m,n,p,q,r){function s(a){return!isNaN(a.getTime())}var t=Math.max(c,d),u=RulerModel.levels[t],v=a.scaleManager.alignStart(u),w=a.scaleManager.alignStart(u),x=a.scaleManager.alignEnd(u);s(w)||s(x)||console.error("broken Date",s(w),s(x));for(var y=1e3;x>=w&&y-->0;){var z=Math.round(w.getTime()/u.interval.getMilliseconds())%2===1,A=RulerModel.findBestLevelIndex(w),B=1;A>d?B=1-e:A>c&&(B=e),o(b,w,u,B,f,g,h,i,j,k,z?l:m,n,p,q,r);var C=u.interval.addToDate(w);s(w)||s(C)||console.error("broken Date 2 ",s(w),s(C)),w=C}1>y&&console.error("problem!",v,w,x,u)}function o(b,c,d,e,f,g,j,k,l,m,n,o,p,q,r){var s=a.scaleManager.dateToScreenCoordinate(c);if(f){b.font=i(l);var t=d.interval.addToDate(c),u=a.scaleManager.dateToScreenCoordinate(t),v=g?d:RulerModel.findBestLevel(t),w=dateFormat(new Date(t),v[f]),y=b.measureText(w).width,z=g?d:RulerModel.findBestLevel(c),A=dateFormat(new Date(c),z[f]),B=b.measureText(A).width,C=j*a.viewportHeight+(k*a.viewportHeight-l.size)/2+l.size+p,D=0;switch(m){case"center":var E=Math.max(0,s),F=Math.min(u,a.viewportWidth),G=(E+F)/2;D=a.scaleManager.bound(s+x.labelPadding,G-B/2,u-B-x.labelPadding);break;case"left":D=a.scaleManager.bound(x.labelPadding,s+x.labelPadding,u-B-x.labelPadding);break;case"above":default:D=a.scaleManager.bound(x.labelPadding,s-B/2,u-y/2-B-x.labelPadding)}}var H="top"==q?j:j+k-r;if(n)switch(b.fillStyle=h(n,e),m){case"center":case"left":b.fillRect(s,j*a.viewportHeight,u-s,k*a.viewportHeight)
}if(o&&(b.strokeStyle=h(o,e),b.beginPath(),b.moveTo(s+.5,H*a.viewportHeight),b.lineTo(s+.5,(H+r)*a.viewportHeight),b.stroke()),n)switch(b.fillStyle=h(n,e),m){case"center":case"left":break;case"above":default:b.fillRect(D,C-l.size,B,l.size)}f&&(b.fillStyle=h(l.color,e),b.fillText(A,D,C))}function p(b){b.fillStyle=h(x.chunksBgColor,1);var c=(x.topLabelHeight+x.labelHeight)*a.viewportHeight;b.fillRect(0,c,a.viewportWidth,x.chunkHeight*a.viewportHeight);var d=a.scaleManager.levels.events.level,e=a.scaleManager.levels.events.index,f=a.scaleManager.alignStart(d),g=a.scaleManager.alignEnd(d);if(a.recordsProvider&&a.recordsProvider.chunksTree)for(var i=a.recordsProvider.getIntervalRecords(f,g,e),j=0;j<i.length;j++)q(b,i[j],e)}function q(b,c,d){var e=a.scaleManager.dateToScreenCoordinate(c.start),f=a.scaleManager.dateToScreenCoordinate(c.end),g=d==c.level;b.fillStyle=g?h(x.exactChunkColor,1):h(x.loadingChunkColor,1);var i=(x.topLabelHeight+x.labelHeight)*a.viewportHeight;b.fillRect(e,i,Math.max(x.minChunkWidth,f-e),x.chunkHeight*a.viewportHeight)}function r(b){var c=(x.topLabelHeight+x.labelHeight+x.chunkHeight)*a.viewportHeight,d=a.scaleManager.getRelativeCenter(),e=a.scaleManager.getRelativeWidth();H=Math.max(a.viewportWidth*e,x.minScrollBarWidth);var f=a.scaleManager.bound(0,a.viewportWidth*d-H/2,a.viewportWidth-H);return L=J>=c,K=I>=f&&f+H>=I&&J>=c,b?(b.fillStyle=h(x.scrollBarBgColor,1),b.fillRect(0,c,a.viewportWidth,x.scrollBarHeight*a.viewportHeight),b.fillStyle=K?h(x.scrollBarHighlightColor,1):h(x.scrollBarColor,1),b.fillRect(f,c,H,x.scrollBarHeight*a.viewportHeight),void 0):((K||M)&&(K=I-f),L&&(L=I-f),K)}function s(b){a.positionProvider&&u(b,a.positionProvider.playedPosition,x.timeMarkerColor,x.timeMarkerTextColor)}function t(b){I&&!K&&u(b,a.scaleManager.screenCoordinateToDate(I),x.pointerMarkerColor,x.pointerMarkerTextColor)}function u(b,c,d,e){var f=a.scaleManager.dateToScreenCoordinate(c);if(!(0>f||f>a.viewportWidth)){c=new Date(c);var g=x.markerHeight*a.viewportHeight;b.strokeStyle=h(d,1),b.fillStyle=h(d,1),b.beginPath(),b.moveTo(f+.5,0),b.lineTo(f+.5,Math.round(a.viewportHeight-x.scrollBarHeight*a.viewportHeight)),b.stroke();var j=null,k=f-x.markerWidth/2;0>k&&(j="left",k=0),k+x.markerWidth>a.viewportWidth&&(j="right",k=a.viewportWidth-x.markerWidth),b.fillRect(k,0,x.markerWidth,g),b.beginPath(),b.moveTo(f+x.markerTriangleHeight*a.viewportHeight,g),b.lineTo(f,g+x.markerTriangleHeight*a.viewportHeight),b.lineTo(f-x.markerTriangleHeight*a.viewportHeight,g),b.closePath(),b.fill(),b.fillStyle=h(e,1),b.font=i(x.markerFont),f=k+x.markerWidth/2;var l=dateFormat(c,x.dateFormat),m=b.measureText(l).width,n=(g-x.markerFont.size)/2;b.fillText(l,f-m/2,n),l=dateFormat(c,x.timeFormat),m=b.measureText(l).width,n=g/2+n,b.fillText(l,f-m/2,n)}}function v(a){return a?$(a.target).is("canvas")?(I=a.offsetX,J=a.offsetY,void r()):void console.warn("unexpected node"):(J=0,I=null,K=!1,L=!1,void(M=!1))}function w(b){v(b),b.preventDefault(),Math.abs(b.deltaY)>Math.abs(b.deltaX)?window.jscd.touch?(N=a.scaleManager.zoom()-b.deltaY/x.maxVerticalScrollForZoomWithTouch,a.scaleManager.zoomAroundDate(N,a.scaleManager.screenCoordinateToDate(I))):(c.animating(a,"zoomCurrent")||(a.zoomCurrent=a.scaleManager.zoom(),N=a.zoomCurrent),N-=b.deltaY/x.maxVerticalScrollForZoom,c.animate(a,"zoomCurrent",N).then(function(){},function(){},function(b){a.scaleManager.zoomAroundDate(b,a.scaleManager.screenCoordinateToDate(I))})):a.scaleManager.scrollByPixels(b.deltaX),a.$apply()}var x={initialInterval:31536e6,maxMsPerPixel:31536e6,minMsPerPixel:1,zoomSpeed:.025,maxVerticalScrollForZoom:50,maxVerticalScrollForZoomWithTouch:5e3,animationDuration:500,timelineBgColor:[28,35,39],font:"Roboto",labelPadding:10,lineWidth:1,chunkHeight:35/110,minChunkWidth:1,chunksBgColor:[34,57,37],exactChunkColor:[58,145,30],loadingChunkColor:[58,145,30],scrollBarSpeed:.1,scrollBarHeight:20/110,minScrollBarWidth:50,scrollBarBgColor:[28,35,39],scrollBarColor:[53,70,79],scrollBarHighlightColor:[53,70,79,.8],timeMarkerColor:[255,255,255],timeMarkerTextColor:[0,0,0],pointerMarkerColor:[0,0,0],pointerMarkerTextColor:[255,255,255],markerFont:{size:12,weight:400,face:"Roboto"},markerWidth:120,markerHeight:45/110,markerTriangleHeight:10/110,dateFormat:"d mmmm yyyy",timeFormat:"HH:MM:ss",scrollBoundariesPrecision:1e-6,scrollingSpeed:.25,end:0};a.timelineConfig=x;var y={topLabelAlign:"center",topLabelHeight:30/110,topLabelFont:{size:17,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerAttach:"top",topLabelMarkerHeight:.5,topLabelBgColor:!1,topLabelBgOddColor:!1,topLabelPositionFix:0,topLabelFixed:!0,labelAlign:"above",labelHeight:25/110,labelFont:{size:15,weight:400,face:"Roboto",color:[105,135,150]},labelMarkerAttach:"bottom",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],labelPositionFix:-5,labelMarkerHeight:.2,labelFixed:!0,lowerMarkerAttach:"bottom",lowerMarksHeight:10/110,lowerMarksColor:[83,112,127,.4]};a.presets=[{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[53,70,79,0],labelBgColor:[28,35,39],lowerMarksColor:[83,112,127,0]},{topLabelAlign:"center",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"above",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],lowerMarksColor:[83,112,127,0]},{topLabelAlign:"left",topLabelMarkerColor:[105,135,150],topLabelBgColor:!1,topLabelBgOddColor:!1,labelAlign:"left",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],lowerMarksColor:[83,112,127,.4]},{topLabelAlign:"center",topLabelHeight:20/110,topLabelFont:{size:12,weight:400,face:"Roboto",color:[255,255,255]},topLabelMarkerColor:[83,112,127],topLabelMarkerHeight:20/110,topLabelMarkerAttach:"top",topLabelBgColor:[33,42,47],topLabelBgOddColor:[43,56,63],topLabelPositionFix:0,topLabelFixed:!0,labelAlign:"above",labelHeight:35/110,labelFont:{size:15,weight:400,face:"Roboto",color:[105,135,150]},labelMarkerAttach:"top",labelMarkerColor:[83,112,127,.6],labelBgColor:[28,35,39],labelPositionFix:5,labelMarkerHeight:20/110,labelFixed:!1,lowerMarkerAttach:"top",lowerMarksHeight:10/110,lowerMarksColor:[83,112,127,.4]}],a.selectPreset=function(b){a.activePreset=b,a.timelineConfig=$.extend(a.timelineConfig,y,b)},a.selectPreset(a.presets[3]);var z=b.find(".viewport"),A=(b.find(".timeMarker.playing"),b.find(".timeMarker.pointer"),b.find("canvas").get(0));a.scaleManager=new ScaleManager(x.minMsPerPixel,x.maxMsPerPixel,x.initialInterval,100);var B=0,C=0;a.changingTopLevel=1;var D=0,E=0;a.changingLevel=1;var F=0,G=0;a.changingLowerMarksLevel=1;var H=0,I=null,J=0,K=!1,L=!1,M=!1,N=0;a.dblClick=function(b){v(b),L?K||c.animate(a,"scrollPosition",L>0?1:0).then(function(){},function(){},function(b){a.scaleManager.scroll(b)}):(a.scaleManager.setAnchorCoordinate(I),a.zoom(!0))},a.click=function(b){v(b),L?K||(a.scrollPosition=a.scaleManager.scroll(),c.animate(a,"scrollPosition",I/a.viewportWidth).then(function(){},function(){},function(b){a.scaleManager.scroll(b)})):(a.scaleManager.setAnchorCoordinate(I),a.positionHandler(a.scaleManager.screenCoordinateToDate(I)))},a.mouseUp=function(a){v(a),M=!1,console.log("set timer for dblclick here"),console.log("move playing position")},a.mouseLeave=function(){v(null)},a.mouseMove=function(b){if(v(b),M){var c=K-M;a.scaleManager.scroll(a.scaleManager.scroll()+c/a.viewportWidth)}},a.mouseDown=function(a){v(a),M=K},a.zoom=function(b){a.zoomTarget=a.scaleManager.zoom();var d=a.zoomTarget-(b?1:-1)*x.zoomSpeed;c.animate(a,"zoomTarget",d).then(function(){},function(){},function(b){a.scaleManager.zoom(b)})},a.goToLive=function(){a.scaleManager.setAnchorCoordinate(1),a.positionHandler(!1)},a.playPause=function(){a.playHandler(!a.positionProvider.playing)},$(window).resize(e),a.$watch("recordsProvider",function(){a.recordsProvider&&a.recordsProvider.ready.then(f)}),z.mousewheel(w),d(),e(),f(),c.setDuration(x.animationDuration),c.setScope(a),c.start(g),a.$on("$destroy",function(){c.stop()})}}}]),angular.module("webadminApp").directive("videowindow",["$interval","$timeout","animateScope",function(){return{restrict:"E",scope:{vgPlayerReady:"&",vgUpdateTime:"&",vgSrc:"="},templateUrl:"views/components/videowindow.html",link:function(a){function b(b){var c=_.find(a.vgSrc,function(a){return a.type==h[b]});return c?c.src:null}function c(){function b(a){var b=!1,c=document.createElement("video");return c.canPlayType&&c.canPlayType(h[a]).replace(/no/,"")&&(b=!0),b}var c=_.find(a.vgSrc,function(a){return a.type==h.webm}),d=_.find(a.vgSrc,function(a){return a.type==h.hls}),e=_.find(a.vgSrc,function(a){return a.type==h.rtsp});if(c&&b("webm"))return"webm";if(window.jscd.mobile&&d)return"native-hls";switch(window.jscd.browser){case"Microsoft Internet Explorer":return c&&(a.ieNoWebm=!0),window.jscd.browserMajorVersion>=10&&d?"jshls":!1;case"Chrome":case"Firefox":case"Safari":case"Opera":case"Webkit":default:return d&&"-"!=window.jscd.flashVersion?"flashls":d?"jshls":e?"rtsp":!1}return!1}function d(){a.videogular=!0}function e(){a.videogular=!1,flashlsAPI.init("videowindow",function(c){console.log("videowindow ready"),a.api=c,a.vgPlayerReady({$API:a.api}),a.vgSrc&&a.api.load(b("hls"))},function(){console.alert("some error")})}function f(){a.videogular=!1,jshlsAPI.init($("#videowindow"),function(c){console.log("videowindow ready"),a.api=c,a.vgPlayerReady({$API:a.api}),a.vgSrc&&a.api.load(b("hls"))},function(){console.alert("some error")})}function g(){a.videogular=!1;var c=new Locomote("videowindow","components/Player.swf");c.on("apiReady",function(){console.log("play rtsp"),a.api=c,console.log("API is ready. `play` can now be called"),a.vgPlayerReady({$API:a.api}),a.api.load||(a.api.load=a.api.play,a.api.play=function(){a.api.load(b("rtsp"))}),c.on("streamStarted",function(){console.log("stream has started")}),c.on("error",function(a){console.log(a)}),a.vgSrc&&(console.log("play",a.vgSrc[2].src),a.api.play(a.vgSrc[2].src))})}var h={hls:"application/x-mpegURL",webm:"video/webm",rtsp:"application/x-rtsp",flv:"video/x-flv",mp4:"video/mp4"};a.$watch("vgSrc",function(){if(console.log("change vgSrc",a.api,a.vgSrc),a.vgSrc){var b=c();switch(console.log("format",b),c()){case"flashls":e();break;case"jshls":f();break;case"rtsp":g();break;case"webm":case"nativehls":default:d()}}})}}}]),angular.module("webadminApp").controller("MainCtrl",["$scope",function(a){a.config=Config}]),angular.module("webadminApp").controller("NavigationCtrl",["$scope","$location","mediaserver","ipCookie",function(a,b,c,d){a.user={isAdmin:!0},c.checkAdmin().then(function(b){a.user={isAdmin:b}}),c.getSettings().then(function(b){a.settings=b.data.reply,a.settings.remoteAddresses=a.settings.remoteAddresses.join("\n")}),a.isActive=function(a){var c=b.path().split("/")[1];return c.split("?")[0]===a.split("/")[1].split("?")[0]},a.logout=function(){d.remove("response",{path:"/"}),d.remove("nonce",{path:"/"}),d.remove("realm",{path:"/"}),d.remove("username",{path:"/"}),window.location.reload()},a.alertVisible=!0,a.closeAlert=function(){a.alertVisible=!1}}]),angular.module("webadminApp").controller("SettingsCtrl",["$scope","$modal","$log","mediaserver","$location","$timeout",function(a,b,c,d,e,f){function g(c){b.open({templateUrl:"views/restart.html",controller:"RestartCtrl",resolve:{port:function(){return c?a.settings.port:null}}})}function h(){return alert("Connection error"),!1}function i(b){var c=b.data;if("0"!==c.error){var d=c.errorString;switch(d){case"UNAUTHORIZED":case"password":case"PASSWORD":d="Wrong password."}alert("Error: "+d)}else c.reply.restartNeeded?confirm("All changes saved. New settings will be applied after restart. \n Do you want to restart server now?")&&g(!0):(alert("Settings saved"),a.settings.port!==window.location.port?window.location.href=window.location.protocol+"//"+window.location.hostname+":"+a.settings.port:window.location.reload())}function j(b,c){var e=b.networkAddresses.split(";"),f=b.apiUrl.substring(b.apiUrl.lastIndexOf(":")),g=window.location.protocol+"//"+e[c]+f;d.getSettings(g).then(function(){b.apiUrl=g},function(){return c<e.length-1?j(b,c+1):(b.status="Unavailable",a.mediaServers=_.sortBy(a.mediaServers,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id})),!1})}d.checkAdmin().then(function(a){return a?void 0:void e.path("/info")}),d.getSettings().then(function(b){a.settings={systemName:b.data.reply.systemName,port:b.data.reply.port,id:b.data.reply.id},a.oldSystemName=b.data.reply.systemName,a.oldPort=b.data.reply.port}),a.password="",a.oldPassword="",a.confirmPassword="",a.openJoinDialog=function(){var e=b.open({templateUrl:"views/join.html",controller:"JoinCtrl",resolve:{items:function(){return a.settings}}});e.result.then(function(a){c.info(a),d.mergeSystems(a.url,a.password,a.currentPassword,a.keepMySystem).then(function(a){if("0"!==a.data.error){var b=a.data.errorString;switch(b){case"FAIL":b="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":case"PASSWORD":b="Wrong password.";break;case"INCOMPATIBLE":b="Found system has incompatible version.";break;case"url":case"URL":b="Wrong url."}alert("Merge failed: "+b)}else alert("Merge succeed."),window.location.reload()})})},a.save=function(){a.settingsForm.$valid?(a.oldSystemName===a.settings.systemName||confirm('If there are others servers in local network with "'+a.settings.systemName+'" system name then it could lead to this server settings loss. Continue?')||(a.settings.systemName=a.oldSystemName),(a.oldSystemName!==a.settings.systemName||a.oldPort!==a.settings.port)&&d.saveSettings(a.settings.systemName,a.settings.port).then(i,h)):alert("form is not valid")},a.changePassword=function(){a.password===a.confirmPassword&&d.changePassword(a.password,a.oldPassword).then(i,h)},a.restart=function(){confirm("Do you want to restart server now?")&&g(!1)},d.getMediaServers().then(function(b){a.mediaServers=_.sortBy(b.data,function(a){return("Online"===a.status?"0":"1")+a.Name+a.id}),f(function(){_.each(a.mediaServers,function(a){var b=0;j(a,b)})},1e3)})}]),angular.module("webadminApp").controller("JoinCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){a.settings={url:"",password:"",currentPassword:"",keepMySystem:!0},a.systems={joinSystemName:"NOT FOUND",systemName:"SYSTEMNAME",systemFound:!1},d.getSettings().then(function(b){a.systems.systemName=b.data.reply.systemName,d.discoveredPeers().then(function(b){var c=_.map(b.data.reply,function(a){return console.log(),{url:window.location.protocol+"//"+a.remoteAddresses[0]+":"+a.port,systemName:a.systemName,ip:a.remoteAddresses[0],name:a.name}});a.systems.discoveredUrls=_.filter(c,function(b){return b.systemName!==a.systems.systemName})})}),a.test=function(){d.pingSystem(a.settings.url,a.settings.password).then(function(b){if("0"!==b.data.error){var c=b.data.errorString;switch(c){case"FAIL":c="System is unreachable or doesn't exist.";break;case"UNAUTHORIZED":case"password":c="Wrong password.";break;case"INCOMPATIBLE":c="Found system has incompatible version.";break;case"url":c="Wrong url."}alert("Connection failed: "+c)}else a.systems.systemFound=!0,a.systems.joinSystemName=b.data.reply.systemName})},a.join=function(){b.close({url:a.settings.url,password:a.settings.password,keepMySystem:a.settings.keepMySystem,currentPassword:a.settings.currentPassword})},a.selectSystem=function(b){a.settings.url=b.url},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("webadminApp").controller("LoginCtrl",["$scope","mediaserver","ipCookie",function(a,b,c){function d(){return a.authorized=!0,a.authorizing=!1,setTimeout(function(){console.log("reload on login"),window.location.reload()},20),!1}a.authorized=!1,a.authorizing=!1,a.user||(a.user={username:"",password:""}),a.login=function(){if(a.loginForm.$valid){var e=a.user.username.toLowerCase(),f=c("realm"),g=c("nonce"),h=md5(e+":"+f+":"+a.user.password),i=md5("GET:"),j=md5(h+":"+g+":"+i),k=Base64.encode(e+":0:"+h);c("response",j,{path:"/"}),c("username",e,{path:"/"}),c("auth",k,{path:"/"}),a.authorizing=!0,b.getCurrentUser(!0).then(d).catch(function(){a.authorizing=!1,alert("not authorized ")})}}}]),angular.module("webadminApp").controller("AdvancedCtrl",["$scope","$modal","$log","mediaserver","$location",function(a,b,c,d,e){function f(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}d.checkAdmin().then(function(a){a||e.path("/info")}),a.someSelected=!1,a.reduceArchiveWarning=!1,d.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return f(a.url)});for(var c=0;c<a.storages.length;c++)a.storages[c].reservedSpaceGb=Math.round(a.storages[c].reservedSpace/1073741824),a.storages[c].url=f(a.storages[c].url);a.$watch(function(){a.reduceArchiveWarning=!1,a.someSelected=!1;for(var b in a.storages){var c=a.storages[b];c.reservedSpace=1073741824*c.reservedSpaceGb,a.someSelected=a.someSelected||c.isUsedForWriting&&c.isWritable,c.reservedSpace>c.freeSpace&&(a.reduceArchiveWarning=!0)}})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]},a.toGBs=function(a){return Math.floor(a/1073741824)},a.update=function(){},a.save=function(){var b,c=!1;_.each(a.storages,function(a){b=b||a.isUsedForWriting,a.reservedSpace>a.freeSpace&&(c="Set reserved space is greater than free space left. Possible partial remove of the video footage is expected. Do you want to continue?")}),b||(c="No storages were selected for writing - video will not be recorded on this server. Do you want to continue?"),(!c||confirm(c))&&d.getSettings().then(function(b){d.getMediaServer(b.data.reply.id.replace("{","").replace("}","")).then(function(b){var c=b.data[0];_.each(a.storages,function(a){var b=_.findWhere(c.storages,{id:a.storageId});null!==b&&(b.spaceLimit=a.reservedSpace,b.usedForWriting=a.isUsedForWriting)}),d.saveStorages(c.storages).then(function(a){if("undefined"!=typeof a.error&&"0"!==a.error){var b=a.errorString;alert("Error: "+b)}else alert("Settings saved")},function(){alert("Error: Couldn't save settings")})})})},a.cancel=function(){window.location.reload()}}]),angular.module("webadminApp").controller("InfoCtrl",["$scope","mediaserver",function(a,b){function c(a){return decodeURIComponent(a.replace(/file:\/\/.+?:.+?\//gi,""))}a.logUrl=b.logUrl(),b.getSettings().then(function(b){a.settings=b.data.reply}),b.getStorages().then(function(b){a.storages=_.sortBy(b.data.reply.storages,function(a){return c(a.url)}),_.each(a.storages,function(a){a.url=c(a.url)})}),a.formatSpace=function(a){var b=2,c=["Bytes","KB","MB","GB","TB"],d=0;if(0===a)return"n/a";for(;a>=1024;)d++,a/=1024;return Number(a).toFixed(b)+" "+c[d]}}]),angular.module("webadminApp").controller("RestartCtrl",["$scope","$modalInstance","$interval","mediaserver","port",function(a,b,c,d,e){function f(){return window.location.href=h,!1}function g(){var b=j?d.getSettings(h):d.statistics(h);b.then(function(b){return j||b.data.reply.uptimeMs<i?(a.state="server is starting",f()):(a.state="server is restarting",i=b.data.reply.uptimeMs,void setTimeout(g,1e3))},function(){return a.state="server is offline",j=!0,setTimeout(g,1e3),!1})}e=e||window.location.port,a.state="";var h=window.location.protocol+"//"+window.location.hostname+":"+e;a.url=h+window.location.pathname+window.location.search;var i=Number.MAX_VALUE,j=!1;a.refresh=f,d.statistics().then(function(a){i=a.data.reply.uptimeMs,d.restart().then(function(){g()},function(){return g(),!1})},function(){return a.state="server is offline",setTimeout(g,1e3),!1})}]),angular.module("webadminApp").controller("SdkeulaCtrl",["$scope",function(a){a.agree=!1,a.next=function(){return window.open("sdk.zip"),!1}}]),angular.module("webadminApp").controller("OfflineCtrl",["$scope","$modalInstance","$interval","mediaserver",function(a,b,c,d){function e(){return console.log("reload on offline"),window.location.reload(),!1}function f(){var a=d.getSettings(!0);a.then(function(){return e()},function(){return setTimeout(f,1e3),!1})}a.refresh=e,a.state="server is offline",setTimeout(f,1e3)}]),angular.module("webadminApp").controller("WebclientCtrl",function(){}),angular.module("webadminApp").controller("ViewCtrl",["$scope","$rootScope","$location","$routeParams","mediaserver","cameraRecords","$sce",function(a,b,c,d,e,f){function g(b){return _.find(a.mediaServers,function(a){return a.id===b.parentId})}function h(b){return a.settings.id===b.id.replace("{","").replace("}","")?"":b.apiUrl.replace("http://","").replace("https://","")}function i(b){var c=!b;if(c&&(b=(new Date).getTime()),a.positionProvider){a.positionProvider.init(b);var d=a.activeCamera.physicalId,f=g(a.activeCamera),i="",j="rtsp://"+window.location.host;a.settings.id&&a.settings.id.replace("{","").replace("}","")!==f.id.replace("{","").replace("}","")&&(i="/proxy/"+window.location.protocol.replace(":","")+"/"+h(f),j+="/proxy/rtsp/");var k=e.mediaDemo();k&&(i=k,j="rtsp:"+k);var l="&auth="+e.authForMedia(),m=c?"":"&pos="+b,n=c?"":"&startTimestamp="+b;a.acitveVideoSource=_.filter([{src:i+"/hls/"+d+".m3u8?"+n+l+"&chunked&hi",type:"application/x-mpegURL"},{src:i+"/media/"+d+".webm?resolution="+a.activeResolution+m+l,type:"video/webm"},{src:j+"/"+d+"?"+m+l,type:"application/x-rtsp"}],function(b){return"Auto"==a.activeFormat||a.activeFormat==b.type}),console.log("video source",a.activeFormat,a.acitveVideoSource[0].src,a.acitveVideoSource)}}function j(a){return a=a.split("/")[2]||a.split("/")[0],a.split(":")[0].split("?")[0]}function k(){e.getCameras().then(function(b){function c(a){a.url=j(a.url),a.preview=e.previewUrl(a.physicalId,!1,70);for(var b=0,c=a.url.split("."),d=0;d<c.length;d++){var f=3-d;b+=parseInt(c[d])%256*Math.pow(256,f)}return isNaN(b)?b=a.url:(b=b.toString(16),b.length<8&&(b="0"+b)),a.name+"__"+b}var d=b.data,f=_.partition(d,function(a){return""===a.groupId});f[1]=_.sortBy(f[1],c),f[1]=_.groupBy(f[1],function(a){return a.groupId}),f[1]=_.values(f[1]),f[1]=_.map(f[1],function(a){return{isGroup:!0,collapsed:!1,parentId:a[0].parentId,name:a[0].groupName,id:a[0].groupId,url:a[0].url,status:"Online",cameras:a}}),d=_.union(f[0],f[1]),d=_.sortBy(d,c),a.cameras=_.groupBy(d,function(a){return a.parentId}),a.allcameras=d},function(){console.error("network problem")})}a.cameras={},a.activeCamera=null,a.activeResolution="320p",a.availableResolutions=["Auto","1080p","720p","640p","320p","240p"],a.activeFormat="Auto",a.availableFormats=["Auto","video/webm","application/x-mpegURL","application/x-rtsp"],a.settings={id:null},e.getSettings().then(function(b){a.settings={id:b.data.reply.id}}),a.activeVideoRecords=null,a.positionProvider=null,a.updateTime=function(b){b=b||0,a.positionProvider.setPlayingPosition(1e3*b),a.positionProvider.liveMode||c.search("time",Math.round(a.positionProvider.playedPosition))},a.playerReady=function(b){a.playerAPI=b},a.selectCameraById=function(b,c){a.cameraId=b||a.cameraId,c&&(c=parseInt(c)),a.activeCamera=_.find(a.allcameras,function(b){return b.id===a.cameraId}),a.activeCamera&&(a.positionProvider=f.getPositionProvider([a.activeCamera.physicalId]),a.activeVideoRecords=f.getRecordsProvider([a.activeCamera.physicalId],640),i(c),a.switchPlaying(!0))},a.selectCamera=function(b){c.path("/view/"+b.id,!1),a.selectCameraById(b.id,!1)},b.$on("$routeChangeStart",function(b,d){a.selectCameraById(d.params.cameraId,c.search().time||!1)}),a.switchPlaying=function(b){a.playerAPI&&(b?a.playerAPI.play():a.playerAPI.pause(),a.positionProvider&&(a.positionProvider.playing=b))},a.switchPosition=function(a){i(a)},a.selectFormat=function(b){a.activeFormat=b,i(a.positionProvider.playedPosition)},a.selectResolution=function(b){("auto"==b||"Auto"==b||"AUTO"==b)&&(b="320p"),a.activeResolution!=b&&(a.activeResolution=b,i(a.positionProvider.playedPosition))},a.fullScreen=function(){a.playerAPI.toggleFullScreen()},a.$watch("allcameras",function(){a.selectCameraById(a.cameraId,c.search().time||!1)}),e.getMediaServers().then(function(b){_.each(b.data,function(a){a.url=j(a.url),a.collapsed="Online"!==a.status&&(a.allowAutoRedundancy||a.flags.indexOf("SF_Edge")<0)}),a.mediaServers=b.data,k(),a.selectCameraById(d.cameraId,c.search().time||!1)},function(){console.error("network problem")})}]),angular.module("webadminApp").controller("HealthCtrl",["$scope","$modal","$log","mediaserver","$timeout",function(a,b,c,d,e){function f(b){for(var c=[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)},{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)}],d=0;d<b.length;d++){var e=i[b[d].deviceType],f=e[d%e.length];c.push({label:b[d].description,fillColor:f,strokeColor:f,pointColor:f,pointStrokeColor:f,pointHighlightFill:f,pointHighlightStroke:f,show:!0,hideLegend:!1,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,0)})}a.datasets=c,a.updateVisibleDatasets()}function g(b){for(var c=a.datasets,d=function(a){return a.description===f.label},e=2;e<c.length;e++){var f=c[e],g=0,h=_.filter(b,d);h&&h.length>0&&(g=h[0].value),f.data.push(100*g),f.data.length>a.healthLength&&(f.data=f.data.slice(f.data.length-a.healthLength,f.data.length))}}function h(){d.statistics().then(function(b){return null===k&&f(b.data.reply.statistics),a.serverIsOnline=!0,g(200===b.status&&"0"===b.data.error?b.data.reply.statistics:[]),k=e(h,a.interval),!1},function(){g([]),a.serverIsOnline=!1,k=e(h,a.interval)})}a.healthLength=100,a.interval=1e3,a.serverIsOnline=!0;var i={StatisticsCPU:["#3776ca"],StatisticsRAM:["#db3ba9"],StatisticsHDD:["#438231","#484848","#aa880b","#b25e26","#9200d1","#00d5d5","#267f00","#8f5656","#c90000"],StatisticsNETWORK:["#ff3434","#b08f4c","#8484ff","#34ff84"]},j="rgba(255,255,255,0)";a.data={labels:Array.apply(null,new Array(a.healthLength)).map(String.prototype.valueOf,""),datasets:[{label:"",fillColor:j,strokeColor:j,pointColor:j,pointStrokeColor:j,pointHighlightFill:j,pointHighlightStroke:j,show:!0,hideLegend:!0,data:Array.apply(null,new Array(a.healthLength)).map(Number.prototype.valueOf,100)}]},a.legend="",a.options={animation:!1,scaleOverride:!1,scaleSteps:10,scaleShowLabels:!1,scaleLabel:"<%=value%> %",scaleIntegersOnly:!0,responsive:!0,scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!1,pointDotRadius:0,pointDotStrokeWidth:1,pointHitDetectionRadius:0,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!1,onAnimationProgress:function(){},onAnimationComplete:function(){},legendTemplate:'<ul class="tc-chart-js-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].strokeColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'},a.updateVisibleDatasets=function(){a.data.datasets=_.filter(a.datasets,function(a){return a.show})};var k=null,l=setTimeout(h,a.interval);a.$on("$destroy",function(){e.cancel(k),clearTimeout(l)})}]);