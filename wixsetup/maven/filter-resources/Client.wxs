<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">
    <Fragment Id='FragmentClient'>
        <?include BuildVars.wxi ?>

        <?define SourceDir="${libdir}/${arch}/bin/${build.configuration}"?>                
        <?define PluginsDir="${libdir}/${arch}/bin/${build.configuration}/plugins"?>                        

        <DirectoryRef Id="INSTALLDIR">
            <Directory Id="${customization}ClientDir" Name="Client">
                <Directory Id="${customization}HelpDir" Name="help"/>                         

                <Directory Id="${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir" Name="${parsedVersion.majorVersion}.${parsedVersion.minorVersion}">

                    <Component Id="AppLauncherExecutable">
                        <File Id="applauncher.exe" Name="${product.name} Launcher.exe" Source="$(var.SourceDir)/applauncher.exe" KeyPath="yes">
                            <Shortcut Id="StartmenuAppLauncher" Directory="ProgramMenuDir" Name="${product.name}"
                              WorkingDirectory='${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir' Advertise="yes" Icon="icon_menu.exe" >
                            </Shortcut>
                        </File>
                    </Component>

                    <Component Id="AppLauncherConfiguration" Permanent="yes">
                        <RegistryKey Root="HKCU"
                                 Key="Software\[Manufacturer]\${applauncher.name}">
                            <RegistryValue Type="string" Name="previousLaunchedVersion" Value="${parsedVersion.majorVersion}.${parsedVersion.minorVersion}"/>
                        </RegistryKey>
                        <RegistryKey Root="HKCU"
                                 Key="Software\[Manufacturer]\${applauncher.name}">
                            <RegistryValue Type="string" Name="mirrorListUrl" Value="${mirrorListUrl}"/>
                        </RegistryKey>                        
                    </Component>                                

                    <Component Id="DefaultLanguage" Permanent="yes">
                        <RegistryKey Root="HKCU"
                                 Key="Software\[Manufacturer]\${client.name}">
                            <RegistryValue Type="string" Name="translationPath" Value=":/translations/common_${translation1}.qm"/>
                        </RegistryKey>
                    </Component>    

                    <Component Id="clientShortcutDesktop">
                        <Condition>INSTALL_SHORTCUT_DESKTOP</Condition>

                        <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\${applauncher.name}" Name="clientShortcutDesktop" Type="integer" Value="1" KeyPath="yes"/>

                        <Shortcut Id="DesktopClient" Directory="DesktopFolder" Name="${product.name}"
                          WorkingDirectory='${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir' Target="[#applauncher.exe]" Icon="icon_desktop.exe">
                        </Shortcut>
                    </Component>                            

                    <Directory Id="styles" Name="styles">
                        <Component Id="bespin">
                            <File Id="bespin$(var.suffix).dll" Name="bespin$(var.suffix).dll" Source="$(var.SourceDir)\styles\bespin$(var.suffix).dll" />
                        </Component>
                    </Directory>

                    <Directory Id="ImageFormats" Name="imageformats">
                    </Directory>    

                    <Directory Id="Plugins" Name="plugins">
                    </Directory>                        

                    <Directory Id="Platforms" Name="platforms">
                    </Directory>                    

                    <Directory Id="${customization}VoxDir" Name="vox"/>                                

                    <Component Id="ClientExecutable">
                        <File Id="client.exe" Name="${product_name}" Source="$(var.SourceDir)/${client_name}" KeyPath="yes">
                            <fire:FirewallException Id="FirewallExceptionClient" Name="${product.name}" Scope="any" IgnoreFailure="yes"/>
                        </File>
                    </Component>                                

                    <Component Id="ClientConfiguration" Permanent="yes">
                        <Condition>
                        NOT PREVIOUSVERSIONSINSTALLED
                        </Condition>

                        <RegistryKey Root="HKCU"
                                 Key="Software\[Manufacturer]\${client.name}">
                            <RegistryValue Type="string" Name="afterFirstRun" Value="false"/>
                            <RegistryValue Type="string" Name="appserverHost" Value="[CLIENT_APPSERVER_HOST]"/>
                            <RegistryValue Type="string" Name="appserverPort" Value="[CLIENT_APPSERVER_PORT]"/>
                            <RegistryValue Type="string" Name="appserverLogin" Value="[CLIENT_APPSERVER_LOGIN]"/>
                            <RegistryValue Type="string" Name="mediaRoot" Value="[CLIENT_DIRECTORY]"/>
                        </RegistryKey>
                    </Component>

                    <Component Id="ClientSigar">
                        <File Id="ClientSigar.dll" Name="sigar.dll" Source="$(var.SourceDir)\sigar.dll"/>
                    </Component>

                    <Component Id="ClientVsRedistributable">
                        <File Id="VcRedistexe" Name="vcredist_${arch}.exe" Source="$(var.SourceDir)\vcredist_${arch}.exe"/>
                    </Component>
                </Directory>                 
            </Directory>
        </DirectoryRef>

        <ComponentGroup Id="ClientFFmpegLibraries" Directory="${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
            <Component>
                <File Id="ClientAvcodecDll" Name="avcodec-54.dll" Source="$(var.SourceDir)/avcodec-54.dll"/>
            </Component>
            <Component>
                <File Id="ClientAvdeviceDll" Name="avdevice-54.dll" Source="$(var.SourceDir)/avdevice-54.dll"/>
            </Component>
            <Component>
                <File Id="ClientAvfilterDll" Name="avfilter-2.dll" Source="$(var.SourceDir)/avfilter-2.dll"/>
            </Component>
            <Component>
                <File Id="ClientAvformatDll" Name="avformat-54.dll" Source="$(var.SourceDir)/avformat-54.dll"/>
            </Component>
            <Component>
                <File Id="ClientAvutilDll" Name="avutil-51.dll" Source="$(var.SourceDir)/avutil-51.dll"/>
            </Component>
            <Component>
                <File Id="ClientSwscaleDll" Name="swscale-2.dll" Source="$(var.SourceDir)/swscale-2.dll"/>
            </Component>
            <Component>
                <File Id="ClientOggDll" Name="libogg-0.dll" Source="$(var.SourceDir)/libogg-0.dll"/>
            </Component>
            <Component>
                <File Id="ClientVorbisDll" Name="libvorbis-0.dll" Source="$(var.SourceDir)/libvorbis-0.dll"/>
            </Component>
            <Component>
                <File Id="ClientMp3lameDll" Name="libmp3lame-0.dll" Source="$(var.SourceDir)/libmp3lame-0.dll"/>
            </Component>
            <Component>
                <File Id="ClientVorbisEncDll" Name="libvorbisenc-2.dll" Source="$(var.SourceDir)/libvorbisenc-2.dll"/>
            </Component>
        </ComponentGroup>

        <?if ${quicksync} = true ?>
        <ComponentGroup Id="ClientQuickSync" Directory="Plugins">
            <Component>
                <File Id="ClientQuickSyncDll" Name="quicksyncdecoder.dll" Source="$(var.PluginsDir)/quicksyncdecoder.dll"/>
            </Component>
            <Component>
                <File Id="ClientQuickSyncXml" Name="hw_decoding_conf.xml" Source="$(var.PluginsDir)/hw_decoding_conf.xml"/>                               
            </Component>
        </ComponentGroup>                            
        <?endif?>

        <ComponentGroup Id="ClientQTLibraries" Directory="${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
            <Component>
                <File Id="ClientQt5Core$(var.suffix).dll" Name="Qt5Core$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Core$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5Gui$(var.suffix).dll" Name="Qt5Gui$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Gui$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5Multimedia$(var.suffix).dll" Name="Qt5Multimedia$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Multimedia$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5Network$(var.suffix).dll" Name="Qt5Network$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Network$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5OpenGL$(var.suffix).dll" Name="Qt5OpenGL$(var.suffix).dll" Source="$(var.SourceDir)\Qt5OpenGL$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5Xml$(var.suffix).dll" Name="Qt5Xml$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Xml$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="ClientQt5Widgets$(var.suffix).dll" Name="Qt5Widgets$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Widgets$(var.suffix).dll"  />
            </Component>
            <Component>
                <File Id="ClientQt5Concurrent$(var.suffix).dll" Name="Qt5Concurrent$(var.suffix).dll" Source="$(var.SourceDir)\Qt5Concurrent$(var.suffix).dll"  />                
            </Component>             
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenAL" Directory="${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
            <Component>
                <File Id="OpenAL32.dll" Name="OpenAL32.dll" Source="$(var.SourceDir)\OpenAL32.dll"/>
            </Component>
            <Component>
                <File Id="wrap_oal.dll" Name="wrap_oal.dll" Source="$(var.SourceDir)\wrap_oal.dll"/>
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenSSL" Directory="${customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
            <Component>
                <File Id="Clientlibeay32.dll" Name="libeay32.dll" Source="$(var.SourceDir)\libeay32.dll"/>
            </Component>
            <Component>
                <File Id="Clientssleay32.dll" Name="ssleay32.dll" Source="$(var.SourceDir)\ssleay32.dll"/>
            </Component>
        </ComponentGroup>    

        <ComponentGroup Id="ImageFormats" Directory="ImageFormats">
            <Component>
                <File Id="qgif$(var.suffix).dll" Name="qgif.dll" Source="$(var.SourceDir)\imageformats\qgif$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="qjpeg$(var.suffix).dll" Name="qjpeg.dll" Source="$(var.SourceDir)\imageformats\qjpeg$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="qtiff$(var.suffix).dll" Name="qtiff.dll" Source="$(var.SourceDir)\imageformats\qtiff$(var.suffix).dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="Platforms" Directory="Platforms">
            <Component>
                <File Id="qminimal$(var.suffix).dll" Name="qminimal.dll" Source="$(var.SourceDir)\platforms\qminimal$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="qoffscreen$(var.suffix).dll" Name="qoffscreen.dll" Source="$(var.SourceDir)\platforms\qoffscreen$(var.suffix).dll" />
            </Component>
            <Component>
                <File Id="qwindows$(var.suffix).dll" Name="qwindows.dll" Source="$(var.SourceDir)\platforms\qwindows$(var.suffix).dll" />
            </Component>
        </ComponentGroup>            

        <Feature Id="ClientFeature" Title="${product.name} Client" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">

            <ComponentRef Id="NovFileAssociation"/>

            <ComponentRef Id="AppLauncherExecutable" />
            <ComponentRef Id="AppLauncherConfiguration" />          
            <ComponentRef Id="DefaultLanguage" />                                         
            <ComponentRef Id="ClientExecutable" />
            <ComponentRef Id="clientShortcutDesktop"/>
            <ComponentGroupRef Id="ClientHelpComponent"/>
            <ComponentGroupRef Id="ClientVoxComponent"/>
            <ComponentGroupRef Id="ClientBgComponent"/>
            <ComponentRef Id="ClientConfiguration" />
            <?if ${quicksync} = true ?>
            <ComponentGroupRef Id="ClientQuickSync"/>
            <?endif?>
            <ComponentGroupRef Id="ClientFFmpegLibraries"/>
            <ComponentGroupRef Id="ClientQTLibraries" />
            <ComponentGroupRef Id="ImageFormats" />
            <ComponentGroupRef Id="Platforms" />
            <ComponentGroupRef Id="ClientOpenAL" />
            <ComponentGroupRef Id="ClientOpenSSL" />
            <ComponentRef Id="ClientSigar"/>        
            <ComponentRef Id="ClientVsRedistributable"/>
            <ComponentRef Id="bespin" />         
        </Feature>
    </Fragment>
</Wix>