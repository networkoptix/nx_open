<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:bal="http://schemas.microsoft.com/wix/BalExtension" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    <Fragment Id='FragmentServerPackage'>
        <PackageGroup Id="ServerPackageGroup">
            <MsiPackage
                Id="ServerPackage"
                Name="$(var.ServerMsiName)"
                SourceFile="bin/strip/$(var.ServerMsiName)"
                InstallCondition="InstallServerOnly=1 OR InstallClientAndServer=1"
                Vital="yes"
                Compressed="yes">
                <MsiProperty Name="LICENSE_ALREADY_ACCEPTED" Value="1" />
            </MsiPackage>
        </PackageGroup>
    </Fragment>

    <Fragment Id='FragmentConditions'>
        <?include BuildVars.wxi ?>

        <util:RegistrySearch
          Id='SearchForIsConnectedToCloud' 
          Variable="IsConnectedToCloud" 
          Result="value"
          Root="HKLM"
          Key="$(var.ServerRegPath)" 
          Value="isConnectedToCloud"
          Format="raw"
          Win64="yes"/>

        <util:RegistrySearch
          Id='SearchForCloudHost' 
          Variable="CloudHost" 
          Result="value"
          Root="HKLM"
          Key="$(var.ServerRegPath)" 
          Value="cloudHost"
          Format="raw"
          Win64="yes"/>

        <util:ProductSearch
            Id="ServerMsiSearch"
            UpgradeCode="$(var.serverUpgradeCode)"
            Result="state"
            Variable="ServerInstalled" />

        <?define CloudHostIsDifferent="(CloudHost <> "" AND CloudHost <> "$(var.cloudHost)")" ?>

        <!-- Exit if upgrading and cloud hosts differ -->
        <bal:Condition Message="!(loc.Product_CloudHostMismatch)">
            <![CDATA[ (NOT (ServerInstalled = 5 AND IsConnectedToCloud = "yes" AND $(var.CloudHostIsDifferent))) OR WixBundleAction = 3 ]]>
        </bal:Condition>
    </Fragment>

</Wix>