<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:bal="http://schemas.microsoft.com/wix/BalExtension" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    <?define RedistPath="Redist"?>
    <?include BuildVars.wxi ?>


    <Bundle Name="$(var.productName) Client" Version="$(var.releaseVersionFull)" UpgradeCode="c9051fe2-c61e-48a4-8d5d-87cb87241729" DisableModify="yes">
        <!-- Detect existing version of VC ++ 2015 x64 libraries -->
        <util:FileSearch Id="GetVC14X64Exists" Condition="VersionNT64" Variable="vc14x64Exists" Path="[SystemFolder]vcruntime140.dll" Result="exists"/>
        <util:FileSearch Id="GetVC14X64Version" Condition="VersionNT64" Variable="vc14x64Version" Path="[SystemFolder]vcruntime140.dll" Result="version"/>

        <!-- Detect existing version of VC ++ 2015 x86 libraries -->
        <util:FileSearch Id="GetVC14X86onX64Exists" Condition="VersionNT64" Variable="vc14x86Exists" Path="[System64Folder]vcruntime140.dll" Result="exists"/>
        <util:FileSearch Id="GetVC14X86onX64Version" Condition="VersionNT64" Variable="vc14x86Version" Path="[System64Folder]vcruntime140.dll" Result="version"/>
        <util:FileSearch Id="GetVC14X86onX86Exists" Condition="NOT VersionNT64" Variable="vc14x86Exists" Path="[SystemFolder]vcruntime140.dll" Result="exists"/>
        <util:FileSearch Id="GetVC14X86onX86Version" Condition="NOT VersionNT64" Variable="vc14x86Version" Path="[SystemFolder]vcruntime140.dll" Result="version"/>

        <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.RtfLicense">
            <bal:WixStandardBootstrapperApplication
                LicenseFile="License.rtf"
                LogoFile="logo.png"
                SuppressOptionsUI="yes"
                LaunchTarget="$(var.clientInstallFullPath)\Client\$(var.releaseVersionFull)\$(var.minilauncherBinaryName)"
            />
        </BootstrapperApplicationRef>

        <Chain>
            <ExePackage
                Cache="no"
                Compressed="yes"
                PerMachine="yes"
                Permanent="yes"
                Vital="yes"
                DetectCondition="vc14$(var.arch)Exists AND vc14$(var.arch)Version &gt;= v14.0.24215"
                Name="Redist\vcredist14_$(var.arch).exe"
                SourceFile="$(var.RedistPath)\VC14\vcredist_24215_$(var.arch).exe"
                InstallCommand="/install /quiet /norestart">

                <!-- -->
                <ExitCode Value="3010" Behavior="forceReboot"/>

                <!-- Ignore "Newer version installed" error -->
                <ExitCode Value="1638" Behavior="success"/>
            </ExePackage>

            <RollbackBoundary />

            <MsiPackage
                Id="ClientPackage"
                Name="$(var.ClientMsiName)"
                SourceFile="bin/msi/$(var.ClientMsiName)"
                Vital="yes"
                Cache="no"
                Compressed="yes">
                <MsiProperty Name="LICENSE_ALREADY_ACCEPTED" Value="1" />
            </MsiPackage>
        </Chain>
    </Bundle>
</Wix>