<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:SystemTools="http://schemas.appsecinc.com/wix/SystemToolsExtension">
    <Product Id="*" Name="${product.name}" Language="1033" Version="${release.version}.${buildNumber}" Manufacturer="${company.name}" UpgradeCode="${customization.upgradeCode}">
        <Package Id="*" InstallerVersion="300" Compressed="yes" Keywords="Installer" Comments="${company.name} ${product.name} Installer" Manufacturer="${company.name}" InstallPrivileges="elevated" InstallScope="perMachine"/>

        <?define arch = "${arch}"?>
        <?define vmax = "${vmax}"?>

        <?include ControlPanel.wxi ?>
        <Property Id="ARPSYSTEMCOMPONENT" Value="1" />

        <?if $(var.arch) = x86?>
        <?define ProgramFilesFolder = "ProgramFilesFolder"?>
        <?define SystemFolderActual = "SystemFolder"?>
        <?else?>
        <?define ProgramFilesFolder = "ProgramFiles64Folder"?>
        <?define SystemFolderActual = "System64Folder"?>
        <?endif?>

        <!-- Wix Variables -->

        <?ifdef env.CommonProgramFiles(x86) ?>
        <?define commonProgramFiles = "c:\Program Files (x86)\Common Files\" ?>
        <?else?>
        <?define commonProgramFiles = "c:\Program Files\Common Files\" ?>
        <?endif?>

        <?if ${build.configuration} = debug ?>
        <?define suffix = "d" ?>
        <?else?>
        <?define suffix = "" ?>
        <?endif?>

        <?define VmsInstalling=" (NOT Installed AND NOT PREVIOUSVERSIONSINSTALLED) "?>
        <?define VmsUpgrading=" (NOT Installed AND PREVIOUSVERSIONSINSTALLED)" ?>
        <?define VmsChanging=" (Installed AND REMOVE <> "ALL") "?>
        <?define VmsRemoving=" (Installed AND REMOVE = "ALL") "?>
        <?define VmsRepairing=" (REINSTALLMODE) " ?>
        <?define VmsInstallingOrChanging="($(var.VmsInstalling) OR $(var.VmsChanging))" ?>

        <?define LaunchClientChecBoxText="Launch ${product.name} when setup exits." ?>

        <?if $(var.arch) = x86 ?>
        <Condition Message="This package is designed for 32-bit OS. Setup will now exit.">
            <![CDATA[ NOT VersionNT64 ]]>
        </Condition>
        <?endif?>

        <SetProperty Id="REBOOT" Value="reallysuppress" After="FindRelatedProducts">Installed AND REMOVE&lt;&gt;"ALL"</SetProperty>
        <SetProperty Id="PREVIOUSVERSIONSINSTALLED" Value="[MIGRATE]" After="FindRelatedProducts"/>
        <SetProperty Id="APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD_REG]" After="FindRelatedProducts">$(var.VmsRepairing)</SetProperty>

        <SetProperty Id="APPSERVER_GUID" Value="[APPSERVER_GUID32]" After="AppSearch">
            <![CDATA[ APPSERVER_GUID = "" ]]>
        </SetProperty>
        <SetProperty Id="APPSERVER_PORT" Value="[APPSERVER_PORT32]" After="AppSearch">
            <![CDATA[ APPSERVER_PORT = "" ]]>
        </SetProperty>        
        <SetProperty Id="PROXY_PORT" Value="[PROXY_PORT32]" After="AppSearch">
            <![CDATA[ PROXY_PORT = "" ]]>
        </SetProperty>
        <SetProperty Id="APPSERVER_PASSWORD_REG" Value="[APPSERVER_PASSWORD_REG32]" After="AppSearch">
            <![CDATA[ APPSERVER_PASSWORD_REG = "" ]]>
        </SetProperty>

        <Property Id="INSTALL_ECS" Secure="yes"/>
        <Property Id="INSTALL_SERVER" Secure="yes"/>
        <Property Id="INSTALL_CLIENT" Secure="yes"/>

        <SetProperty Id="INSTALL_ECS" Value="1" After="ResetPreselected" Sequence="ui">
            <![CDATA[ $(var.VmsInstalling) OR &AppServerFeature = 3 OR !AppServerFeature = 3 ]]>
        </SetProperty>
        <SetProperty Id="INSTALL_SERVER" Value="1" After="ResetPreselected" Sequence="ui">
            <![CDATA[ $(var.VmsInstalling) OR &ServerFeature = 3 OR !ServerFeature = 3 ]]>
        </SetProperty>
        <SetProperty Id="INSTALL_CLIENT" Value="1" After="ResetPreselected" Sequence="ui">
            <![CDATA[ $(var.VmsInstalling) OR &ClientFeature = 3 OR !ClientFeature = 3 ]]>
        </SetProperty>


        <SetProperty Id="SERVER_APPSERVER_HOST" Value="[SERVER_APPSERVER_HOST32]" After="AppSearch">
            <![CDATA[ SERVER_APPSERVER_HOST = "" ]]>
        </SetProperty>
        <SetProperty Id="SERVER_APPSERVER_PORT" Value="[SERVER_APPSERVER_PORT32]" After="AppSearch">
            <![CDATA[ SERVER_APPSERVER_PORT = "" ]]>
        </SetProperty>
        <SetProperty Id="SERVER_APPSERVER_LOGIN" Value="[SERVER_APPSERVER_LOGIN32]" After="AppSearch">
            <![CDATA[ SERVER_APPSERVER_LOGIN = "" ]]>
        </SetProperty>
        <SetProperty Id="SERVER_APPSERVER_PASSWORD" Value="[SERVER_APPSERVER_PASSWORD32]" After="AppSearch">
            <![CDATA[ SERVER_APPSERVER_PASSWORD = "" ]]>
        </SetProperty>

        <SetProperty Id="SERVER_PORT" Value="[SERVER_PORT32]" After="AppSearch">
            <![CDATA[ SERVER_PORT = "" ]]>
        </SetProperty>
        <SetProperty Id="SERVER_GUID" Value="[SERVER_GUID32]" After="AppSearch">
            <![CDATA[ SERVER_GUID = "" ]]>
        </SetProperty>
        <SetProperty Id="CLIENT_DIRECTORY_REG" Value="[CLIENT_DIRECTORY_REG32]" After="AppSearch">
            <![CDATA[ CLIENT_DIRECTORY_REG = "" ]]>
        </SetProperty>        

        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="Binary\eve\eve_logo-493x58.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="Binary\eve\eve_logo-493x312.bmp" />

        <!-- Logo -->
        <Icon Id="icon_menu.exe" SourceFile="Binary\eve\eve_logo.ico"/>
        <Icon Id="icon_desktop.exe" SourceFile="Binary\eve\eve_logo.ico"/>

        <!-- Add property to access from custom actions -->
        <Property Id="ARCHITECTURE" Value="$(var.arch)" />
        <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" Secure="yes"/>

        <Property Id="LAUNCHAPPONEXIT" Secure="yes" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Secure="yes" />

        <!-- Properties -->
        <Property Id="WelcomeDlg_Title" Value="${product.name} Installer Setup" />

        <Property Id="INSTALLTYPE" Secure="yes"/>

        <Property Id="BUSYPORT" Secure="yes"/>
        <Property Id="DUMMY_APPSERVER_LOGIN" Value="admin"/>

        <Property Id="MEDIASERVER_REGISTRY_PATH" Value="Software\${company.name}\${mediaserver.name}"/>

        <Property Id="REMOVE_DATABASE" Secure="yes"/>

        <Property Id="INSTALL_SHORTCUT_DESKTOP" Value="1"/>

        <!-- AppServer properties-->
        <Property Id="APPSERVER_GUID" Secure="yes">
            <RegistrySearch Id="EcsGuidReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="ecsGuid"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="APPSERVER_GUID32" Secure="yes">
            <RegistrySearch Id="EcsGuidReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="ecsGuid"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="APPSERVER_PORT" Secure="yes">
            <RegistrySearch Id="AppServerPortReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="port"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="APPSERVER_PORT32" Secure="yes">
            <RegistrySearch Id="AppServerPortReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="port"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="PROXY_PORT" Secure="yes">
            <RegistrySearch Id="ProxyPortReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="proxyPort"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="PROXY_PORT32" Secure="yes">
            <RegistrySearch Id="ProxyPortReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="proxyPort"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <!-- We use ecs password only when doing repair -->
        <Property Id="APPSERVER_PASSWORD_REG" Secure="yes">
            <RegistrySearch Id="AppServerPasswordReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="password"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="APPSERVER_PASSWORD_REG32" Secure="yes">
            <RegistrySearch Id="AppServerPasswordReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${appserver.name}"
                            Name="password"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="APPSERVER_LOGIN" Secure="yes" Value="admin"/>
        <Property Id="APPSERVER_PASSWORD" Secure="yes"/>
        <Property Id="APPSERVER_PASSWORD_CONFIRM" Secure="yes"/>

        <!-- MediaServer properties-->
        <Property Id="SERVER_APPSERVER_HOST" Secure="yes">
            <RegistrySearch Id="ServerEcsHostReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverHost"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_APPSERVER_HOST32" Secure="yes">
            <RegistrySearch Id="ServerEcsHostReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverHost"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_APPSERVER_PORT" Secure="yes">
            <RegistrySearch Id="ServerEcsPortReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverPort"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_APPSERVER_PORT32" Secure="yes">
            <RegistrySearch Id="ServerEcsPortReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverPort"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_APPSERVER_LOGIN" Secure="yes">
            <RegistrySearch Id="ServerEcsLoginReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverLogin"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_APPSERVER_LOGIN32" Secure="yes">
            <RegistrySearch Id="ServerEcsLoginReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverLogin"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_APPSERVER_PASSWORD" Secure="yes">
            <RegistrySearch Id="ServerEcsPasswordReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverPassword"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_APPSERVER_PASSWORD32" Secure="yes">
            <RegistrySearch Id="ServerEcsPasswordReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="appserverPassword"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_PORT" Secure="yes">
            <RegistrySearch Id="ServerPortReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="rtspPort"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_PORT32" Secure="yes">
            <RegistrySearch Id="ServerPortReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="rtspPort"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_GUID" Secure="yes">
            <RegistrySearch Id="ServerGuidReg"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="serverGuid"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="SERVER_GUID32" Secure="yes">
            <RegistrySearch Id="ServerGuidReg32"
                            Root="HKLM"
                            Key="Software\${company.name}\${mediaserver.name}"
                            Name="serverGuid"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <!-- Client properties-->
        <Property Id="CLIENT_APPSERVER_HOST" Secure="yes" Value="localhost"/>
        <Property Id="CLIENT_APPSERVER_PORT" Secure="yes" Value="7001"/>
        <Property Id="CLIENT_APPSERVER_LOGIN" Secure="yes" Value="admin"/>
        <Property Id="CLIENT_VMS_MODE" Value="1"/>
        <Property Id="CLIENT_DIRECTORY_REG" Secure="yes">
            <RegistrySearch Id="ClientDirectoryReg"
                            Root="HKCU"
                            Key="Software\[Manufacturer]\${product.name}"
                            Name="mediaRoot"
                            Type="raw"
                            Win64="yes"/>
        </Property>

        <Property Id="CLIENT_DIRECTORY_REG32" Secure="yes">
            <RegistrySearch Id="ClientDirectoryReg32"
                            Root="HKCU"
                            Key="Software\[Manufacturer]\${client.name}"
                            Name="mediaRoot"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Binary Id="CustomActions.dll" SourceFile="CustomActions\${build.configuration}\CustomActions.dll" />

        <!-- Custom actions -->
        <CustomAction Id="ResetPreselected" Property="Preselected" Value="" />
        <CustomAction Id="SetMoviesFolder" BinaryKey="CustomActions.dll" DllEntry="SetMoviesFolder" />
        <CustomAction Id="GenerateGuidsForServers" BinaryKey="CustomActions.dll" DllEntry="GenerateGuidsForServers"/>
        <CustomAction Id="CopyAppServerProfile" BinaryKey="CustomActions.dll" DllEntry="CopyAppServerProfile" Execute="deferred" Impersonate="no"/>
        <CustomAction Id="CopyAppServerNotificationFiles" BinaryKey="CustomActions.dll" DllEntry="CopyAppServerNotificationFiles" Execute="deferred" Impersonate="no"/>
        <CustomAction Id="CopyMediaServerProfile" BinaryKey="CustomActions.dll" DllEntry="CopyMediaServerProfile" Execute="deferred" Impersonate="no"/>
        <CustomAction Id="FindConfiguredStorages" BinaryKey="CustomActions.dll" DllEntry="FindConfiguredStorages"/>
        <CustomAction Id="DeleteDatabaseFile" BinaryKey="CustomActions.dll" DllEntry="DeleteDatabaseFile" Execute="deferred" Impersonate="no"/>

        <CustomAction Id="MissingFeature"  Error="At least one component should be selected"/>

        <CustomAction Id="IsClientFolderExists" BinaryKey="CustomActions.dll" DllEntry="IsClientFolderExists"/>

        <CustomAction Id="FindFreePorts" BinaryKey="CustomActions.dll" DllEntry="FindFreePorts" />
        <CustomAction Id="CheckPorts" BinaryKey="CustomActions.dll" DllEntry="CheckPorts"/>
        <CustomAction Id="CheckPorts2" BinaryKey="CustomActions.dll" DllEntry="CheckPorts"/>
        <CustomAction Id="FixServerFolder" BinaryKey="CustomActions.dll" DllEntry="FixServerFolder"/>
        <CustomAction Id="FixClientFolder" BinaryKey="CustomActions.dll" DllEntry="FixClientFolder"/>

        <CustomAction Id="SetNewGuidForEcs" Property="APPSERVER_GUID" Value="[APPSERVER_GUID_NEW]"/>
        <CustomAction Id="SetNewGuidForServer" Property="SERVER_GUID" Value="[SERVER_GUID_NEW]"/>

        <CustomAction Id="AssignOldAppServerPort" Property="OLD_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>
        <CustomAction Id="AssignOldServerPort" Property="OLD_SERVER_PORT" Value="[SERVER_PORT]"/>
        <CustomAction Id="AssignOldProxyPort" Property="OLD_PROXY_PORT" Value="[PROXY_PORT]"/>

        <CustomAction Id="AssignAppServerPort" Property="APPSERVER_PORT" Value="[FREEPORT1]"/>
        <CustomAction Id="AssignServerPort" Property="SERVER_PORT" Value="[FREEPORT2]"/>
        <CustomAction Id="AssignProxyPort" Property="PROXY_PORT" Value="[FREEPORT4]"/>

        <!-- Assign default values for Quick installation -->
        <CustomAction Id="AssignServerAppServerPort" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>
        <CustomAction Id="AssignClientAppServerPort" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>

        <CustomAction Id="SetClientFolderToDefault" Property="CLIENT_DIRECTORY" Value="[MOVIESFOLDER]\${product.name} Client Media" />
        <CustomAction Id="SetClientFolderToRegistry" Property="CLIENT_DIRECTORY" Value="[CLIENT_DIRECTORY_REG]" />

        <CustomAction Id="InitDatabaseAction_Cmd" Property="InitDatabaseAction"
                      Value="&quot;[#dbconfig.exe]&quot; &quot;[APPSERVER_LOGIN]&quot;  &quot;[APPSERVER_PASSWORD]&quot;" Execute="immediate" Impersonate="yes"/>
        <CustomAction Id="InitDatabaseAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="check" Impersonate="no" />

        <CustomAction Id="SyncDatabaseAction_Cmd" Property="SyncDatabaseAction"
                      Value="&quot;[#dbsync.exe]&quot;" Execute="immediate" Impersonate="yes"/>
        <CustomAction Id="SyncDatabaseAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="check" Impersonate="no" />

        <CustomAction Id="CopyAppServerProfile_Cmd" Property="CopyAppServerProfile" Execute="immediate" Impersonate="yes"
            Value="[SystemFolder]config\systemprofile\AppData\Local\${company.name}\Enterprise Controller;[System64Folder]config\systemprofile\AppData\Local\${company.name}\Enterprise Controller"/>

        <CustomAction Id="CopyAppServerNotificationFiles_Cmd" Property="CopyAppServerNotificationFiles" Execute="immediate" Impersonate="yes"
            Value="[${installer.customization}AppServerDir]hostedfiles\notifications;[System64Folder]config\systemprofile\AppData\Local\${company.name}\Enterprise Controller\hostedfiles\notifications"/>
        
        <CustomAction Id="CopyMediaServerProfile_Cmd" Property="CopyMediaServerProfile" Execute="immediate" Impersonate="yes"
            Value="[SystemFolder]config\systemprofile\AppData\Local\${company.name}\${company.name} Media Server;[System64Folder]config\systemprofile\AppData\Local\${company.name}\${company.name} Media Server"/>

        <CustomAction Id="CertGenAction_Cmd" Property="CertGenAction"
                      Value="&quot;[#certgen.exe]&quot; -i" Execute="immediate" Impersonate="yes"/>
        <CustomAction Id="CertGenAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="check" Impersonate="no" />

        <CustomAction Id="CloseTrayToolAction_Cmd" Property="CloseTrayToolAction"
                      Value="&quot;[${installer.customization}TrayToolDir]traytool.exe&quot; &quot;quit&quot;" Execute="immediate" />
        <CustomAction Id="CloseTrayToolAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="ignore" Impersonate="no" />

        <CustomAction Id="CloseAppLauncherAction_Cmd" Property="CloseAppLauncherAction"
                      Value="&quot;[${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir]${product.name} Launcher.exe&quot; &quot;quit&quot;" Execute="immediate" />
        <CustomAction Id="CloseAppLauncherAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="ignore" Impersonate="no" />

        <CustomAction Id="DeleteDatabaseFile_Cmd" Property="DeleteDatabaseFile" Execute="immediate" Impersonate="yes"
            Value="[$(var.SystemFolderActual)]config\systemprofile\AppData\Local\${company.name}\Enterprise Controller\db\ecs.db"/>

        <CustomAction Id="LaunchTrayTool" Execute="immediate" Impersonate="yes" Return="asyncNoWait" FileKey="traytool.exe" ExeCommand=""/>
        <CustomAction Id="LaunchClient" Execute="immediate" Impersonate="yes" Return="asyncNoWait" FileKey="applauncher.exe" ExeCommand=""/>

        <CustomAction Id="NoDowngrade" Error="NoDowngrade" /> 


        <!--        <util:CloseApplication Id="CloseTrayTool" ElevatedCloseMessage="yes" CloseMessage="yes" Target="traytool.exe" RebootPrompt="no"/>-->

        <MajorUpgrade AllowSameVersionUpgrades="yes"
            Schedule="afterInstallInitialize"
            DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."
            MigrateFeatures="yes" />

<!--        <Upgrade Id="${customization.clientUpgradeCode}">
            <UpgradeVersion OnlyDetect='yes' Property='NEWERCLIENTINSTALLED' Minimum='${release.version}.${buildNumber}' IncludeMinimum='no' />
        </Upgrade> -->

        <?define EcsNeedsGuid="(INSTALL_ECS AND NOT APPSERVER_GUID)"?>
        <?define ServerNeedsGuid="INSTALL_SERVER AND NOT SERVER_GUID"?>
        <InstallUISequence>
            <Custom Action="ResetPreselected" After="MigrateFeatureStates">Installed AND Preselected</Custom>
            <FindRelatedProducts Before="AppSearch" />
            <AppSearch Before="LaunchConditions" />

            <Custom Action="FindFreePorts" Before="AssignOldAppServerPort"/>
            <Custom Action="AssignOldAppServerPort" Before="AssignOldServerPort">1</Custom>
            <Custom Action="AssignOldServerPort" Before="AssignOldProxyPort">1</Custom>
            <Custom Action="AssignOldProxyPort" Before="AssignAppServerPort">1</Custom>
            <Custom Action="AssignAppServerPort" Before="AssignServerPort">NOT APPSERVER_PORT</Custom>
            <Custom Action="AssignServerPort" Before="AssignProxyPort">NOT SERVER_PORT</Custom>
            <Custom Action="AssignProxyPort" Before="AssignServerAppServerPort">NOT PROXY_PORT</Custom>
            <Custom Action="AssignServerAppServerPort" Before="AssignClientAppServerPort">NOT SERVER_APPSERVER_PORT</Custom>
            <Custom Action="AssignClientAppServerPort" Before="SetMoviesFolder">1</Custom>
            <Custom Action="SetMoviesFolder" Before="GenerateGuidsForServers">1</Custom>
            <Custom Action="GenerateGuidsForServers" Before="SetNewGuidForEcs">
                <![CDATA[ $(var.EcsNeedsGuid) OR $(var.ServerNeedsGuid) ]]>
            </Custom>
            <Custom Action="SetNewGuidForEcs" Before="SetNewGuidForServer">
                <![CDATA[ $(var.EcsNeedsGuid) ]]>
            </Custom>
            <Custom Action="SetNewGuidForServer" Before="FindConfiguredStorages">
                <![CDATA[ $(var.ServerNeedsGuid)  ]]>
            </Custom>
            <Custom Action="FindConfiguredStorages" Before="SetClientFolderToDefault"/> 

            <Custom Action="SetClientFolderToRegistry" Before="CostInitialize">1</Custom>
            <Custom Action="FixClientFolder" After="SetClientFolderToRegistry">1</Custom>
            <Custom Action="IsClientFolderExists" After="FixClientFolder">1</Custom>
            <Custom Action="SetClientFolderToDefault" After="CostInitialize">CLIENT_DIRECTORY=""</Custom>

        </InstallUISequence>

        <?define InstallECS="&AppServerFeature = 3 AND !AppServerFeature <> 3"?>

        <InstallExecuteSequence>
            <FindRelatedProducts Before="AppSearch" />
            <AppSearch Before="LaunchConditions" />

            <!--            <RemoveExistingProducts After="InstallFinalize"/>-->

            <!--            <Custom Action="CloseTrayToolAction" Before="RemoveExistingProducts" />-->
            <!--            <RemoveExistingProducts After="InstallInitialize" />-->
            <Custom Action="CloseAppLauncherAction_Cmd" Before="CloseAppLauncherAction">
                <![CDATA[ NOT $(var.VmsInstalling) ]]>
            </Custom>
            <Custom Action="CloseAppLauncherAction" Before="StopServices">
                <![CDATA[ NOT $(var.VmsInstalling) ]]>
            </Custom>

            <Custom Action="CloseTrayToolAction_Cmd" Before="CloseTrayToolAction">
                <![CDATA[ NOT $(var.VmsInstalling) ]]>
            </Custom>
            <Custom Action="CloseTrayToolAction" Before="StopServices">
                <![CDATA[ NOT $(var.VmsInstalling) ]]>
            </Custom>

            <Custom Action="CopyAppServerProfile_Cmd" After="InstallFiles">
                <![CDATA[ (INSTALL_ECS OR !AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="CopyAppServerProfile" After="CopyAppServerProfile_Cmd">
                <![CDATA[ (INSTALL_ECS OR !AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>

            <Custom Action="CopyAppServerNotificationFiles_Cmd" After="CopyAppServerProfile">
                <![CDATA[ (INSTALL_ECS OR !AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="CopyAppServerNotificationFiles" After="CopyAppServerNotificationFiles_Cmd">
                <![CDATA[ (INSTALL_ECS OR !AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            
            <Custom Action="CopyMediaServerProfile_Cmd" After="CopyAppServerNotificationFiles">
                <![CDATA[ (INSTALL_SERVER OR !ServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="CopyMediaServerProfile" After="CopyMediaServerProfile_Cmd">
                <![CDATA[ (INSTALL_SERVER OR !ServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>

            <Custom Action="CertGenAction_Cmd" After="CopyAppServerProfile">
                <![CDATA[ $(var.InstallECS) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="CertGenAction" After="CertGenAction_Cmd">
                <![CDATA[ $(var.InstallECS) AND REMOVE <> "ALL" ]]></Custom>

            <Custom Action="SyncDatabaseAction_Cmd" After="CopyAppServerProfile">
                <![CDATA[ $(var.InstallECS) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="SyncDatabaseAction" After="SyncDatabaseAction_Cmd">
                <![CDATA[ $(var.InstallECS) AND REMOVE <> "ALL" ]]></Custom>

            <Custom Action="InitDatabaseAction_Cmd" After="SyncDatabaseAction">
                <![CDATA[ $(var.VmsInstallingOrChanging) AND $(var.InstallECS) ]]>
            </Custom>
            <Custom Action="InitDatabaseAction" After="InitDatabaseAction_Cmd">
                <![CDATA[ $(var.VmsInstallingOrChanging) AND $(var.InstallECS) ]]>
            </Custom>

            <Custom Action="DeleteDatabaseFile_Cmd" After="StopServices">REMOVE_DATABASE=1</Custom>
            <Custom Action="DeleteDatabaseFile" After="DeleteDatabaseFile_Cmd">REMOVE_DATABASE=1</Custom>

            <Custom Action="LaunchTrayTool" After="InstallFinalize">
                <![CDATA[ (!AppServerFeature=3 OR INSTALL_ECS OR !ServerFeature=3 OR INSTALL_SERVER) AND REMOVE <> "ALL" ]]></Custom>
        </InstallExecuteSequence>

        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

        <Directory Id="TARGETDIR" Name="SourceDir">

            <Directory Id="$(var.SystemFolderActual)">
                <Directory Id="sysfoconfig" Name="config">
                    <Directory Id="sysfoprofile" Name="systemprofile">
                        <Directory Id="sysfoappda" Name="AppData">
                            <Directory Id="sysfolocal" Name="Local">
                                <Directory Id="sysfocona" Name="${company.name}">
                                    <Component Id="sysfomediaservercomponent">
                                        <CreateFolder Directory="sysfocona"/>
										<RegistryValue Root='HKLM' Key='Software\[Manufacturer]\version' Type='string' Value='${release.version}.${buildNumber}' KeyPath='yes' />
                                    </Component>
                                </Directory>
                            </Directory>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>

            <Directory Id="CLIENT_DIRECTORY" Name="Client Media">
                <Component Id="ClientDirectoryComponent" Permanent="yes">
                    <CreateFolder Directory="CLIENT_DIRECTORY"/>
                    <RegistryValue Root='HKCU' Key='Software\[Manufacturer]\${client.name}' Type='string' Value='' KeyPath='yes' />
                </Component>
            </Directory>

            <Directory Id="$(var.ProgramFilesFolder)">
                <Directory Id="NetworkOptix" Name="${company.name}">
                    <Directory Id="INSTALLDIR" Name="${product.name}">
                        <Directory Id="${installer.customization}AppServerDir" Name="${appserver.name}">
                            <Component Id="AppServerExecutable">
                                <File Id="ecexe" Name="ecs.exe" Source="${AppServerDir}/ecs.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionAppServer" Name="${company.name} ${appserver.name}" Scope="any" IgnoreFailure="yes" />
                                </File>

                                <ServiceInstall Id="${installer.customization}AppServerService"
                                                Name="${installer.customization}AppServer"
                                                DisplayName="${company.name} ${appserver.name}"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="${company.name} ${appserver.name}">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>

                                <ServiceControl Id="Start${installer.customization}AppServerService" Name="${installer.customization}AppServer" Start="install" Wait="no" />
                                <ServiceControl Id="Stop${installer.customization}AppServerService" Name="${installer.customization}AppServer" Stop="both" Wait="yes" Remove="uninstall" />

                            </Component>

                            <!-- Dummy file. To remove on uninstall.  -->
                            <Component>
                                <File Id="ecs.log" Name="ecs.log" Source="files/ecs.log" KeyPath="yes"/>
                            </Component>

                            <Component Id="AppServerConfigurationGuid" Permanent="yes" NeverOverwrite="yes">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\${appserver.name}">
                                    <RegistryValue Type="string" Name="ecsGuid" Value="[APPSERVER_GUID]" KeyPath="yes"/>
                                </RegistryKey>
                            </Component>

                            <Component Id="AppServerConfiguration">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\${appserver.name}">
                                    <RegistryValue Type="string" Name="port" Value="[APPSERVER_PORT]"/>
                                    <RegistryValue Type="string" Name="proxyPort" Value="[PROXY_PORT]"/>
                                    <RegistryValue Type="string" Name="login" Value="[APPSERVER_LOGIN]"/>
                                </RegistryKey>
                            </Component>

                            <Component Id="AppServerConfigurationPassword" Permanent="yes">
                                <Condition>
                                    NOT PREVIOUSVERSIONSINSTALLED
                                </Condition>

                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Enterprise Controller">
                                    <RegistryValue Type="string" Name="password" Value="[APPSERVER_PASSWORD]"/>
                                </RegistryKey>
                            </Component>
                        </Directory>

                        <Directory Id="${installer.customization}TrayToolDir" Name="TrayTool">
                            <Component Id="traytool.exe">
                                <File Id="traytool.exe" Name="traytool.exe" Source="${libdir}/bin/${build.configuration}/traytool.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallException${installer.customization}TrayTool" Name="VMS Tray Tool" Scope="any" IgnoreFailure="yes"/>

                                    <Shortcut Id="StartmenuTrayTool" Directory="ProgramMenuDir" Name="${traytool.name}"
                                              WorkingDirectory='${installer.customization}TrayToolDir' Advertise="yes" Icon="icon_menu.exe" >
                                    </Shortcut>

                                    <Shortcut Id="StartmenuStartupTrayTool" Directory="StartupFolder" Name="${traytool.name}"
                                              WorkingDirectory='${installer.customization}TrayToolDir' Advertise="yes" Icon="icon_menu.exe" >
                                    </Shortcut>
                                </File>
                            </Component>
                            <Component Id="TrayToolQjson">
                                <File Id="TrayToolQjson.dll" Name="qjson.dll" Source="${libdir}/bin/${build.configuration}\qjson.dll"/>
                            </Component>                                                    
                        </Directory>

                        <Directory Id="${installer.customization}ProxyServerDir" Name="MediaProxy">
                            <Component Id="ProxyExecutable">
                                <File Id="ProxyExe" Name="mediaproxy.exe" Source="${libdir}/bin/${build.configuration}/mediaproxy.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionProxyServer" Name="${mediaproxy.name}" Scope="any" IgnoreFailure="yes"/>
                                </File>

                                <ServiceInstall Id="${installer.customization}MediaProxyService"
                                                Name="${installer.customization}MediaProxy"
                                                DisplayName="${mediaproxy.name}"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="${mediaproxy.name}">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>

                                <ServiceControl Id="Start${installer.customization}ProxyService" Name="${installer.customization}MediaProxy" Start="install" Wait="no" />
                                <ServiceControl Id="Stop${installer.customization}ProxyService" Name="${installer.customization}MediaProxy" Stop="both" Wait="yes" Remove="uninstall" />
                            </Component>

                            <Component Id="ProxyQjson">
                                <File Id="ProxyQjson.dll" Name="qjson.dll" Source="${libdir}/bin/${build.configuration}\qjson.dll"/>
                            </Component>                        
                        </Directory>

                        <Directory Id="${installer.customization}MediaServerDir" Name="MediaServer">
                            <Component Id="ServerExecutable">
                                <File Id="ServerExe" Name="mediaserver.exe" Source="${libdir}/bin/${build.configuration}/mediaserver.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionMediaServer" Name="${mediaserver.name}" Scope="any" IgnoreFailure="yes"/>
                                </File>

                                <ServiceInstall Id="${installer.customization}MediaServerService"
                                                Name="${installer.customization}MediaServer"
                                                DisplayName="${mediaserver.name}"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="${mediaserver.name}">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>

                                <ServiceControl Id="Start${installer.customization}ServerService" Name="${installer.customization}MediaServer" Start="install" Wait="no" />
                                <ServiceControl Id="Stop${installer.customization}ServerService" Name="${installer.customization}MediaServer" Stop="both" Wait="yes" Remove="uninstall" />
                            </Component>

                            <Component Id="ServerConfigurationGuid" Permanent="yes" NeverOverwrite="yes">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\${mediaserver.name}">
                                    <RegistryValue Type="string" Name="serverGuid" Value="[SERVER_GUID]" KeyPath="yes"/>
                                </RegistryKey>
                            </Component>

                            <Component Id="ServerConfiguration" Permanent="yes">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\${mediaserver.name}">
                                    <RegistryValue Type="string" Name="appserverHost" Value="[SERVER_APPSERVER_HOST]"/>
                                    <RegistryValue Type="string" Name="appserverPort" Value="[SERVER_APPSERVER_PORT]"/>
                                    <RegistryValue Type="string" Name="appserverLogin" Value="[SERVER_APPSERVER_LOGIN]"/>
                                    <RegistryValue Type="string" Name="appserverPassword" Value="[SERVER_APPSERVER_PASSWORD]"/>
                                    <RegistryValue Type="string" Name="rtspPort" Value="[SERVER_PORT]"/>
                                </RegistryKey>
                            </Component>

                            <Directory Id="ServerSqlDrivers" Name="sqldrivers">
                                <Component Id="ServerSqlDrivers">
                                    <File Id="qsqlite$(var.suffix)4.dll" Name="qgif4.dll" Source="${libdir}/bin/${build.configuration}\sqldrivers\qsqlite$(var.suffix)4.dll" />
                                </Component>
                            </Directory>

                            <Component Id="ServerRtspPlugin">
                                <File Id="ServerRtspPluginDll" Name="genericrtspplugin1.dll" Source="${libdir}/bin/${build.configuration}\genericrtspplugin1.dll" />
                            </Component>

                            <Component Id="ServerQjson">
                                <File Id="ServerQjson.dll" Name="qjson.dll" Source="${libdir}/bin/${build.configuration}\qjson.dll"/>
                            </Component>                        

                            <Component Id="ServerSigar">
                                <File Id="ServerSigar.dll" Name="sigar.dll" Source="${libdir}/bin/${build.configuration}\sigar.dll"/>
                            </Component>

                            <Directory Id="${installer.customization}VmaxDir" Name="VmaxProxy">
                                <Component Id="vmaxproxy.exe">
                                    <File Id="vmaxproxy.exe" Name="vmaxproxy.exe" Source="${libdir}/bin/${build.configuration}/vmaxproxy/vmaxproxy.exe" KeyPath="yes">
                                        <fire:FirewallException Id="FirewallException${installer.customization}VmaxProxy" Name="VMS Vmax Proxy" Scope="any" IgnoreFailure="yes"/>
                                    </File>
                                </Component>

                                <Component Id="VmaxProxyQTLibraries">
                                    <File Id="VmaxProxyQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}/vmaxproxy/QtCore$(var.suffix)4.dll"  />
                                </Component>
                            </Directory>

                        </Directory>

                        <Directory Id="${installer.customization}ClientDir" Name="Client">
                            <Directory Id="${installer.customization}HelpDir" Name="help"/>                         

                            <Directory Id="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir" Name="${parsedVersion.majorVersion}.${parsedVersion.minorVersion}">

                                <Component Id="AppLauncherExecutable">
                                    <File Id="applauncher.exe" Name="${product.name} Launcher.exe" Source="${libdir}/bin/${build.configuration}/applauncher.exe" KeyPath="yes">
                                        <Shortcut Id="StartmenuAppLauncher" Directory="ProgramMenuDir" Name="${product.name}"
                                              WorkingDirectory='${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir' Advertise="yes" Icon="icon_menu.exe" >
                                        </Shortcut>
                                    </File>

                                    <!--<ServiceInstall Id="${installer.customization}AppLauncherService"
                                                Name="${installer.customization}AppLauncher"
                                                DisplayName="${applauncher.name}"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="${applauncher.name}">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>                               
                                
                                <ServiceControl Id="Start${installer.customization}AppLauncherService" Name="${installer.customization}AppLauncherServer" Start="install" Wait="no" />
                                <ServiceControl Id="Stop${installer.customization}AppLauncherService" Name="${installer.customization}AppLauncherServer" Stop="both" Wait="yes" Remove="uninstall" />   -->
                                </Component>

                                <Component Id="AppLauncherConfiguration" Permanent="yes">
                                    <!--<Condition>
                                        NOT PREVIOUSVERSIONSINSTALLED
                                    </Condition> -->

                                    <RegistryKey Root="HKCU"
                                                 Key="Software\[Manufacturer]\${applauncher.name}">
                                        <RegistryValue Type="string" Name="previousLaunchedVersion" Value="${parsedVersion.majorVersion}.${parsedVersion.minorVersion}"/>
                                    </RegistryKey>
                                </Component>                                

                                <Component Id="clientShortcutDesktop">
                                    <Condition>INSTALL_SHORTCUT_DESKTOP</Condition>

                                    <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\${applauncher.name}" Name="clientShortcutDesktop" Type="integer" Value="1" KeyPath="yes"/>

                                    <Shortcut Id="DesktopClient" Directory="DesktopFolder" Name="${product.name}"
                                          WorkingDirectory='${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir' Target="[#applauncher.exe]" Icon="icon_desktop.exe">
                                    </Shortcut>
                                </Component>                            

                                <Directory Id="styles" Name="styles">
                                    <Component Id="bespin">
                                        <File Id="bespin$(var.suffix).dll" Name="bespin$(var.suffix).dll" Source="${libdir}/bin/${build.configuration}\styles\bespin$(var.suffix).dll" />
                                    </Component>
                                </Directory>

                                <Directory Id="ImageFormats" Name="imageformats">
                                </Directory>    

                                <Directory Id="${installer.customization}VoxDir" Name="vox"/>                                

                                <Component Id="ClientExecutable">
                                    <File Id="client.exe" Name="${product.name}.exe" Source="${libdir}/bin/${build.configuration}/client.exe" KeyPath="yes">
                                        <fire:FirewallException Id="FirewallExceptionClient" Name="${product.name}" Scope="any" IgnoreFailure="yes"/>
                                    </File>
                                </Component>                                

                                <Component Id="ClientConfiguration" Permanent="yes">
                                    <Condition>
                                        NOT PREVIOUSVERSIONSINSTALLED
                                    </Condition>

                                    <RegistryKey Root="HKCU"
                                                 Key="Software\[Manufacturer]\${client.name}">
                                        <RegistryValue Type="string" Name="afterFirstRun" Value="false"/>
                                        <RegistryValue Type="string" Name="appserverHost" Value="[CLIENT_APPSERVER_HOST]"/>
                                        <RegistryValue Type="string" Name="appserverPort" Value="[CLIENT_APPSERVER_PORT]"/>
                                        <RegistryValue Type="string" Name="appserverLogin" Value="[CLIENT_APPSERVER_LOGIN]"/>
                                        <RegistryValue Type="string" Name="mediaRoot" Value="[CLIENT_DIRECTORY]"/>
                                    </RegistryKey>
                                </Component>

                                <Component Id="ClientQjson">
                                    <File Id="ClientQjson.dll" Name="qjson.dll" Source="${libdir}/bin/${build.configuration}\qjson.dll"/>
                                </Component>                            

                                <Component Id="ClientSigar">
                                    <File Id="ClientSigar.dll" Name="sigar.dll" Source="${libdir}/bin/${build.configuration}\sigar.dll"/>
                                </Component>

                                <Component Id="ClientQtColorPicker">
                                    <File Id="ColorPicker26$(var.suffix).dll" Name="QtSolutions_ColorPicker-2.6$(var.suffix).dll" Source="${libdir}/bin/${build.configuration}\QtSolutions_ColorPicker-2.6$(var.suffix).dll"/>
                                </Component>

                                <Component Id="ClientVsRedistributable">
                                    <File Id="VcRedistexe" Name="vcredist_${arch}.exe" Source="${libdir}/bin/${build.configuration}\vcredist_${arch}.exe"/>
                                </Component>
                            </Directory>    

                            <Directory Id="${installer.customization}_1_4_Dir" Name="1.4">

                                <Directory Id="styles_1_4" Name="styles">
                                    <Component Id="bespin_1_4">
                                        <File Id="bespin$(var.suffix).dll_1_4" Name="bespin$(var.suffix).dll" Source="${libdir}/bin/${build.configuration}\styles\bespin$(var.suffix).dll" />
                                    </Component>
                                </Directory>

                                <Directory Id="ImageFormats_1_4" Name="imageformats">
                                </Directory>                            

                                <Component Id="ClientExecutable_1_4">
                                    <File Id="client.exe_1_4" Name="${product.name}.exe" Source="${project.build.directory}/1.4/bin/client.exe" KeyPath="yes">
                                        <fire:FirewallException Id="FirewallExceptionClient_1_4" Name="${product.name} 1.4" Scope="any" IgnoreFailure="yes"/>
                                    </File>
                                </Component>

                                <Component Id="ClientSigar_1_4">
                                    <File Id="ClientSigar.dll_1_4" Name="sigar.dll" Source="${libdir}/bin/${build.configuration}\sigar.dll"/>
                                </Component>

                                <Component Id="ClientQtColorPicker_1_4">
                                    <File Id="ColorPicker26$(var.suffix).dll_1_4" Name="QtSolutions_ColorPicker-2.6$(var.suffix).dll" Source="${libdir}/bin/${build.configuration}\QtSolutions_ColorPicker-2.6$(var.suffix).dll"/>
                                </Component>
                            </Directory>                            
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>

            <Directory Id="ProgramMenuFolder" Name="Programs">
                <Directory Id="ProgramMenuDir" Name="${company.name}">
                    <Component Id="UninstallProgramMenuFolder" DiskId="1">
                    	<RegistryValue Root='HKLM' Key='Software\[Manufacturer]\ProgramMenu' Type='string' Value='' KeyPath='yes' />
                        <RemoveFolder Id='DashMenuDirRem' On='uninstall' />
                    </Component>
                </Directory>
            </Directory>

            <Directory Id="DesktopFolder" Name="Desktop"/>
            <Directory Id="StartupFolder" Name="Startup"/>            
        </Directory>

    	<!-- Component groups -->
        <ComponentGroup Id="TrayToolQTLibraries" Directory="${installer.customization}TrayToolDir">
            <Component>
                <File Id="TrayToolQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtCore$(var.suffix)4.dll"  />
            </Component>
            <Component>
                <File Id="TrayToolQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtGui$(var.suffix)4.dll"  />
            </Component>
            <Component>
                <File Id="TrayToolQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtNetwork$(var.suffix)4.dll"  />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="TrayToolOpenSSL" Directory="${installer.customization}TrayToolDir">
            <Component>
                <File Id="TrayToollibeay32.dll" Name="libeay32.dll" Source="${libdir}/bin/${build.configuration}\libeay32.dll"/>
            </Component>
            <Component>
                <File Id="TrayToolssleay32.dll" Name="ssleay32.dll" Source="${libdir}/bin/${build.configuration}\ssleay32.dll"/>
            </Component>
        </ComponentGroup>
    	
        <ComponentGroup Id="ProxyQTLibraries" Directory="${installer.customization}ProxyServerDir">
            <Component>
                <File Id="ProxyQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtCore$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ProxyQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtGui$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ProxyQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtMultimedia$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ProxyQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtNetwork$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ProxyQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtXml$(var.suffix)4.dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="ServerFFmpegLibraries" Directory="${installer.customization}MediaServerDir">
            <Component>
                <File Id="ServerAvcodecDll" Name="avcodec-54.dll" Source="${libdir}/bin/${build.configuration}/avcodec-54.dll"/>
            </Component>
            <Component>
                <File Id="ServerAvdeviceDll" Name="avdevice-53.dll" Source="${libdir}/bin/${build.configuration}/avdevice-53.dll"/>
            </Component>
            <Component>
                <File Id="ServerAvfilterDll" Name="avfilter-2.dll" Source="${libdir}/bin/${build.configuration}/avfilter-2.dll"/>
            </Component>
            <Component>
                <File Id="ServerAvformatDll" Name="avformat-54.dll" Source="${libdir}/bin/${build.configuration}/avformat-54.dll"/>
            </Component>
            <Component>
                <File Id="ServerAvutilDll" Name="avutil-51.dll" Source="${libdir}/bin/${build.configuration}/avutil-51.dll"/>
            </Component>
            <Component>
                <File Id="ServerSwscaleDll" Name="swscale-2.dll" Source="${libdir}/bin/${build.configuration}/swscale-2.dll"/>
            </Component>
            <Component>
                <File Id="ServerOggDll" Name="libogg-0.dll" Source="${libdir}/bin/${build.configuration}/libogg-0.dll"/>
            </Component>
            <Component>
                <File Id="ServerVorbisDll" Name="libvorbis-0.dll" Source="${libdir}/bin/${build.configuration}/libvorbis-0.dll"/>
            </Component>
            <Component>
                <File Id="ServerMp3lameDll" Name="libmp3lame-0.dll" Source="${libdir}/bin/${build.configuration}/libmp3lame-0.dll"/>
            </Component>
            <Component>
                <File Id="ServerVorbisEncDll" Name="libvorbisenc-2.dll" Source="${libdir}/bin/${build.configuration}/libvorbisenc-2.dll"/>
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="ServerQTLibraries" Directory="${installer.customization}MediaServerDir">
            <Component>
                <File Id="ServerQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtCore$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ServerQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtGui$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ServerQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtMultimedia$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ServerQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtNetwork$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ServerQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtXml$(var.suffix)4.dll" />
            </Component>
            <Component>
                <File Id="ServerQtSql$(var.suffix)4.dll" Name="QtSql$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtSql$(var.suffix)4.dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="ServerOpenSSL" Directory="${installer.customization}MediaServerDir">
        	<Component>
            	<File Id="Serverlibeay32.dll" Name="libeay32.dll" Source="${libdir}/bin/${build.configuration}\libeay32.dll"/>
        	</Component>
        	<Component>
            	<File Id="Serverssleay32.dll" Name="ssleay32.dll" Source="${libdir}/bin/${build.configuration}\ssleay32.dll"/>
			</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientFFmpegLibraries" Directory="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
        	<Component>
            	<File Id="ClientAvcodecDll" Name="avcodec-54.dll" Source="${libdir}/bin/${build.configuration}/avcodec-54.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvdeviceDll" Name="avdevice-53.dll" Source="${libdir}/bin/${build.configuration}/avdevice-53.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvfilterDll" Name="avfilter-2.dll" Source="${libdir}/bin/${build.configuration}/avfilter-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvformatDll" Name="avformat-54.dll" Source="${libdir}/bin/${build.configuration}/avformat-54.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvutilDll" Name="avutil-51.dll" Source="${libdir}/bin/${build.configuration}/avutil-51.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientSwscaleDll" Name="swscale-2.dll" Source="${libdir}/bin/${build.configuration}/swscale-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientOggDll" Name="libogg-0.dll" Source="${libdir}/bin/${build.configuration}/libogg-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientVorbisDll" Name="libvorbis-0.dll" Source="${libdir}/bin/${build.configuration}/libvorbis-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientMp3lameDll" Name="libmp3lame-0.dll" Source="${libdir}/bin/${build.configuration}/libmp3lame-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientVorbisEncDll" Name="libvorbisenc-2.dll" Source="${libdir}/bin/${build.configuration}/libvorbisenc-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientX264" Name="x264.exe" Source="${libdir}/bin/${build.configuration}/x264.exe"/>                                
        	</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientQuickSync" Directory="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
        	<Component>
                <File Id="ClientQuickSyncDll" Name="quicksyncdecoder1.dll" Source="${libdir}/bin/${build.configuration}/quicksyncdecoder1.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientQuickSyncXml" Name="hw_decoding_conf.xml" Source="${libdir}/bin/${build.configuration}/hw_decoding_conf.xml"/>                               
        	</Component>
        </ComponentGroup>                            

        <ComponentGroup Id="ClientQTLibraries" Directory="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
        	<Component>
                <File Id="ClientQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtCore$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtGui$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtMultimedia$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtNetwork$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtOpenGL$(var.suffix)4.dll" Name="QtOpenGL$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtOpenGL$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtXml$(var.suffix)4.dll" />
        	</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenAL" Directory="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
        	<Component>
                <File Id="OpenAL32.dll" Name="OpenAL32.dll" Source="${libdir}/bin/${build.configuration}\OpenAL32.dll"/>
        	</Component>
        	<Component>
                <File Id="wrap_oal.dll" Name="wrap_oal.dll" Source="${libdir}/bin/${build.configuration}\wrap_oal.dll"/>
        	</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenSSL" Directory="${installer.customization}_${parsedVersion.majorVersion}_${parsedVersion.minorVersion}_Dir">
        	<Component>
            	<File Id="Clientlibeay32.dll" Name="libeay32.dll" Source="${libdir}/bin/${build.configuration}\libeay32.dll"/>
        	</Component>
        	<Component>
            	<File Id="Clientssleay32.dll" Name="ssleay32.dll" Source="${libdir}/bin/${build.configuration}\ssleay32.dll"/>
			</Component>
        </ComponentGroup>

        <ComponentGroup Id="ProxyOpenSSL" Directory="${installer.customization}ProxyServerDir">
        	<Component>
            	<File Id="Proxylibeay32.dll" Name="libeay32.dll" Source="${libdir}/bin/${build.configuration}\libeay32.dll"/>
        	</Component>
        	<Component>	
            	<File Id="Proxyssleay32.dll" Name="ssleay32.dll" Source="${libdir}/bin/${build.configuration}\ssleay32.dll"/>
			</Component>
        </ComponentGroup>                            

        <ComponentGroup Id="VmaxProxySDK" Directory="${installer.customization}VmaxDir">
        	<Component>
            	<File Id="VmaxProxyacsstreamsourcemr.dll" Name="acs_stream_source_mr.dll" Source="${libdir}/bin/${build.configuration}/vmaxproxy/acs_stream_source_mr.dll"/>
        	</Component>
        	<Component>
            	<File Id="VmaxProxyPid.dat" Name="pid.dat" Source="${libdir}/bin/${build.configuration}/vmaxproxy/pid.dat"/>
			</Component>
        </ComponentGroup>                            

        <ComponentGroup Id="ClientFFmpegLibraries_1_4" Directory="${installer.customization}_1_4_Dir">
        	<Component>
                <File Id="ClientAvcodecDll_1_4" Name="avcodec-54.dll" Source="${libdir}/bin/${build.configuration}/avcodec-54.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvdeviceDll_1_4" Name="avdevice-53.dll" Source="${libdir}/bin/${build.configuration}/avdevice-53.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvfilterDll_1_4" Name="avfilter-2.dll" Source="${libdir}/bin/${build.configuration}/avfilter-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvformatDll_1_4" Name="avformat-54.dll" Source="${libdir}/bin/${build.configuration}/avformat-54.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientAvutilDll_1_4" Name="avutil-51.dll" Source="${libdir}/bin/${build.configuration}/avutil-51.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientSwscaleDll_1_4" Name="swscale-2.dll" Source="${libdir}/bin/${build.configuration}/swscale-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientOggDll_1_4" Name="libogg-0.dll" Source="${libdir}/bin/${build.configuration}/libogg-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientVorbisDll_1_4" Name="libvorbis-0.dll" Source="${libdir}/bin/${build.configuration}/libvorbis-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientMp3lameDll_1_4" Name="libmp3lame-0.dll" Source="${libdir}/bin/${build.configuration}/libmp3lame-0.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientVorbisEncDll_1_4" Name="libvorbisenc-2.dll" Source="${libdir}/bin/${build.configuration}/libvorbisenc-2.dll"/>
        	</Component>
        	<Component>
                <File Id="ClientX264_1_4" Name="x264.exe" Source="${libdir}/bin/${build.configuration}/x264.exe"/>                                
        	</Component>
        </ComponentGroup>                            

        <ComponentGroup Id="ClientQTLibraries_1_4" Directory="${installer.customization}_1_4_Dir">
        	<Component>
                <File Id="ClientQtCore$(var.suffix)4.dll_1_4" Name="QtCore$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtCore$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtGui$(var.suffix)4.dll_1_4" Name="QtGui$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtGui$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtMultimedia$(var.suffix)4.dll_1_4" Name="QtMultimedia$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtMultimedia$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtNetwork$(var.suffix)4.dll_1_4" Name="QtNetwork$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtNetwork$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtOpenGL$(var.suffix)4.dll_1_4" Name="QtOpenGL$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtOpenGL$(var.suffix)4.dll" />
        	</Component>
        	<Component>
                <File Id="ClientQtXml$(var.suffix)4.dll_1_4" Name="QtXml$(var.suffix)4.dll" Source="${libdir}/bin/${build.configuration}\QtXml$(var.suffix)4.dll" />
        	</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenAL_1_4" Directory="${installer.customization}_1_4_Dir">
        	<Component>
            	<File Id="OpenAL32.dll_1_4" Name="OpenAL32.dll" Source="${libdir}/bin/${build.configuration}\OpenAL32.dll"/>
        	</Component>
        	<Component>
            	<File Id="wrap_oal.dll_1_4" Name="wrap_oal.dll" Source="${libdir}/bin/${build.configuration}\wrap_oal.dll"/>
        	</Component>
        </ComponentGroup>

        <ComponentGroup Id="ClientOpenSSL_1_4" Directory="${installer.customization}_1_4_Dir">
        	<Component>
                <File Id="Clientlibeay32.dll_1_4" Name="libeay32.dll" Source="${libdir}/bin/${build.configuration}\libeay32.dll"/>
        	</Component>
        	<Component>
            	<File Id="Clientssleay32.dll_1_4" Name="ssleay32.dll" Source="${libdir}/bin/${build.configuration}\ssleay32.dll"/>
        	</Component>
        </ComponentGroup>                        
    	
        <ComponentGroup Id="ImageFormats" Directory="ImageFormats">
        	<Component>
            	<File Id="qgif$(var.suffix)4.dll" Name="qgif4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qgif$(var.suffix)4.dll" />
        	</Component>
        	<Component>
            	<File Id="qjpeg$(var.suffix)4.dll" Name="qjpeg4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qjpeg$(var.suffix)4.dll" />
        	</Component>
        	<Component>
            	<File Id="qtiff$(var.suffix)4.dll" Name="qtiff4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qtiff$(var.suffix)4.dll" />
			</Component>
        </ComponentGroup>
    	
        <ComponentGroup Id="ImageFormats_1_4" Directory="ImageFormats_1_4">
        	<Component>
            	<File Id="qgif4.dll_1_4" Name="qgif4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qgif$(var.suffix)4.dll" />
        	</Component>
        	<Component>
            	<File Id="qjpeg4.dll_1_4" Name="qjpeg4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qjpeg$(var.suffix)4.dll" />
        	</Component>
        	<Component>
            	<File Id="qtiff4.dll_1_4" Name="qtiff4.dll" Source="${libdir}/bin/${build.configuration}\imageformats\qtiff$(var.suffix)4.dll" />
			</Component>
        </ComponentGroup>

        <?if $(var.arch) = x86 ?>
        <?define archSuffix = "x86" ?>
        <?else?>
        <?define archSuffix = "x86_x64" ?>
        <?endif?>


        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist1" SourceFile="$(var.commonProgramFiles)Merge Modules\Microsoft_VC90_CRT_$(var.archSuffix).msm" DiskId="1" Language="0"/>
            <Merge Id="VCRedist2" SourceFile="$(var.commonProgramFiles)Merge Modules\policy_9_0_Microsoft_VC90_CRT_$(var.archSuffix).msm" DiskId="1" Language="0"/>
            <?if ${build.configuration} = Debug ?>
            <Merge Id="VCRedist3" SourceFile="$(var.commonProgramFiles)Merge Modules\Microsoft_VC90_DebugCRT_$(var.archSuffix).msm" DiskId="1" Language="0"/>
            <Merge Id="VCRedist4" SourceFile="$(var.commonProgramFiles)Merge Modules\policy_9_0_Microsoft_VC90_DebugCRT_$(var.archSuffix).msm" DiskId="1" Language="0"/>
            <?endif?>
        </DirectoryRef>

        <Feature Id="VCRedist" Title="Visual C++ 9.0 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist1"/>
            <MergeRef Id="VCRedist2"/>
            <?if ${build.configuration} = Debug ?>
            <MergeRef Id="VCRedist3"/>
            <MergeRef Id="VCRedist4"/>
            <?endif?>
        </Feature>

        <Feature Id="AppServerFeature" Title="${product.name} ${appserver.name}" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="hidden" >
            <!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !AppServerFeature <> 3 ]]> </Condition>-->

            <ComponentGroupRef Id="AppServerFilesComponent" />
            <ComponentRef Id="AppServerExecutable" />
            <ComponentRef Id="ecs.log" />           
            <ComponentRef Id="AppServerConfiguration"/>
            <ComponentRef Id="AppServerConfigurationPassword"/>
            <ComponentRef Id="AppServerConfigurationGuid"/>

            <ComponentRef Id="ProxyExecutable" />
            <ComponentGroupRef Id="ProxyQTLibraries" />
            <ComponentRef Id="ProxyQjson" />            
            <ComponentGroupRef Id="ProxyOpenSSL" />
        </Feature>

        <Feature Id="AlwaysFeature" Title="Always Tool" AllowAdvertise="no" Display="hidden" Level="1">
            <ComponentRef Id="AlwaysFiles"/>
            <ComponentRef Id="ARPAltRegistryEntries"/>            
            <ComponentRef Id="UninstallProgramMenuFolder"/>
        </Feature>

        <Feature Id="TrayToolFeature" Title="Tray Tool" AllowAdvertise="no" Display="hidden" Level="1">
            <!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !TrayToolFeature <> 3 ]]> </Condition>-->

            <ComponentRef Id="traytool.exe"/>
            <ComponentGroupRef Id="TrayToolQTLibraries"/>
            <ComponentGroupRef Id="TrayToolOpenSSL"/>
            <ComponentRef Id="TrayToolQjson"/>
        </Feature>

        <Feature Id="ServerFeature" Title="${product.name} Media Server" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
            <!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !ServerFeature <> 3 ]]> </Condition>-->

            <ComponentRef Id='ServerConfiguration'/>
            <ComponentRef Id='ServerConfigurationGuid'/>

            <ComponentRef Id="ServerExecutable" />
            <ComponentGroupRef Id="ServerFFmpegLibraries"/>
            <ComponentRef Id="ServerSqlDrivers"/>
            <ComponentRef Id="ServerRtspPlugin"/>
            <ComponentGroupRef Id="ServerQTLibraries" />
            <ComponentGroupRef Id="ServerOpenSSL"/>
            <ComponentRef Id="ServerSigar"/>
            <ComponentRef Id="ServerQjson"/>
            <ComponentRef Id="sysfomediaservercomponent"/>

            <?if $(var.vmax) = true?>   
            <ComponentRef Id="vmaxproxy.exe"/>
            <ComponentRef Id="VmaxProxyQTLibraries"/>
            <ComponentGroupRef Id="VmaxProxySDK"/>
            <?endif?>       
        </Feature>

        <Feature Id="ClientFeature" Title="${product.name} Client" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
            <!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !ClientFeature <> 3 ]]> </Condition>-->

            <ComponentRef Id="NovFileAssociation"/>

            <ComponentRef Id="AppLauncherExecutable" />
            <ComponentRef Id="AppLauncherConfiguration" />          
            <ComponentRef Id="ClientExecutable" />
            <ComponentRef Id="clientShortcutDesktop"/>
            <ComponentGroupRef Id="ClientHelpComponent"/>
            <ComponentGroupRef Id="ClientVoxComponent"/>
            <ComponentRef Id="ClientConfiguration" />
            <ComponentGroupRef Id="ClientQuickSync"/>
            <ComponentGroupRef Id="ClientFFmpegLibraries"/>
            <ComponentGroupRef Id="ClientQTLibraries" />
            <ComponentGroupRef Id="ImageFormats" />
            <ComponentGroupRef Id="ClientOpenAL" />
            <ComponentGroupRef Id="ClientOpenSSL" />
            <ComponentRef Id="ClientSigar"/>    
            <ComponentRef Id="ClientQjson"/>            
            <ComponentRef Id="ClientQtColorPicker"/>
            <ComponentRef Id="ClientVsRedistributable"/>
            <ComponentRef Id="bespin" />

            <ComponentRef Id="ClientExecutable_1_4" />          
            <ComponentGroupRef Id="ClientFFmpegLibraries_1_4"/>
            <ComponentGroupRef Id="ClientQTLibraries_1_4" />
            <ComponentGroupRef Id="ImageFormats_1_4" />
            <ComponentGroupRef Id="ClientOpenAL_1_4" />
            <ComponentGroupRef Id="ClientOpenSSL_1_4" />
            <ComponentRef Id="ClientSigar_1_4"/>            
            <ComponentRef Id="ClientQtColorPicker_1_4"/>
            <ComponentRef Id="bespin_1_4" />            

            <ComponentRef Id='ClientDirectoryComponent'/>
        </Feature>

        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <Property Id="WIXUI_CLIENT_DIRECTORY" Value="CLIENT_DIRECTORY"/>
        <Property Id="WIXUI_SERVER_ALLOWCHANGEIP" Value="SERVER_ALLOWCHANGEIP"/>


        <UIRef Id="WixUI_Common" />
        <UIRef Id="WixUI_ErrorProgressText" />

        <UI>
            <!-- These dialog references are needed for CloseApplication above to work correctly -->
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />      

            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

            <!--            <Property Id="ARPNOMODIFY" Value="1" />-->

            <DialogRef Id="MyFeaturesDlg" />
            <DialogRef Id="SelectionWarningDlg" />
            <DialogRef Id="DowngradeWarningDlg" />
            <DialogRef Id="BrowseDlg" />
            <DialogRef Id="DiskCostDlg" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />
            <!--Width="260" Height="85"-->

            <Binary Id="Warning" SourceFile="Binary\Exclam.ico" />

            <Publish Dialog="MyExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <Publish Dialog="MyExitDialog" Control="Finish" Order="1" Event="DoAction" Value="LaunchClient">WIXUI_EXITDIALOGOPTIONALCHECKBOX</Publish>

            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">NOT PREVIOUSVERSIONSINSTALLED</Publish>          
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="UpgradeDlg">PREVIOUSVERSIONSINSTALLED</Publish>

            <Publish Dialog="UpgradeDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="UpgradeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

            <Publish Dialog="DowngradeWarningDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="DowngradeWarningDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>

            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallTypeDlg">LicenseAccepted = "1"</Publish>

            <Publish Dialog="InstallTypeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_ECS" Value="{}">INSTALLTYPE=2</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_SERVER" Value="{}">INSTALLTYPE=2</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_CLIENT" Value="1">INSTALLTYPE=2</Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_ECS" Value="1">
                <![CDATA[ INSTALLTYPE <> 2 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_SERVER" Value="1">
                <![CDATA[ INSTALLTYPE <> 2 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="INSTALL_CLIENT" Value="1">
                <![CDATA[ INSTALLTYPE <> 2 ]]></Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Event="NewDialog" Value="PasswordDlg">INSTALLTYPE=0</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Event="NewDialog" Value="MyFeaturesDlg">INSTALLTYPE=1</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">INSTALLTYPE=2</Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Property="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="$(var.LaunchClientChecBoxText)">
                <![CDATA[ INSTALLTYPE=0 OR INSTALLTYPE=2 ]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4">
                <![CDATA[ INSTALLTYPE=0 ]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">
                <![CDATA[ INSTALLTYPE=0 ]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">
                <![CDATA[ INSTALLTYPE=0 ]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4" >
                <![CDATA[ INSTALLTYPE=0 ]]>
            </Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4">
                <![CDATA[ INSTALLTYPE=0 OR INSTALLTYPE=2]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">
                <![CDATA[ INSTALLTYPE=0 OR INSTALLTYPE=2]]>
            </Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">
                <![CDATA[ INSTALLTYPE=0 OR INSTALLTYPE=2]]>
            </Publish>

            <?define EcsPasswordsEqual="(APPSERVER_PASSWORD = APPSERVER_PASSWORD_CONFIRM)" ?>

            <Publish Dialog="PasswordDlg" Control="Back" Event="NewDialog" Value="InstallTypeDlg">1</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="SpawnDialog" Value="EmptyPasswordDlg">NOT APPSERVER_PASSWORD</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]">APPSERVER_PASSWORD</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="SpawnDialog" Value="PasswordShouldMatchDlg" Order="2">
                <![CDATA[ NOT $(var.EcsPasswordsEqual) ]]>
            </Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">$(var.EcsPasswordsEqual) AND APPSERVER_PASSWORD</Publish>

            <Publish Dialog="MyFeaturesDlg" Control="Back" Event="NewDialog" Value="InstallTypeDlg">
                <![CDATA[ NOT $(var.VmsChanging) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">
                <![CDATA[ $(var.VmsChanging) ]]>
            </Publish>

            <?define SomeFeaturesSelected="(INSTALL_ECS OR INSTALL_SERVER OR INSTALL_CLIENT)"?>         

            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="SpawnDialog" Value="SelectionWarningDlg">
                <![CDATA[NOT $(var.SomeFeaturesSelected)]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">
                <![CDATA[$(var.SomeFeaturesSelected) AND $(var.VmsInstalling)]]>
            </Publish>

            <?define Inst_E1="(INSTALL_ECS    AND !AppServerFeature <> 3)"?>
            <?define Inst_S1="(INSTALL_SERVER AND !ServerFeature <> 3)"?>
            <?define Inst_C1="(INSTALL_CLIENT AND !ClientFeature <> 3)"?>
            <?define Inst_E0="(NOT $(var.Inst_E1))"?>
            <?define Inst_S0="(NOT $(var.Inst_S1))"?>
            <?define Inst_C0="(NOT $(var.Inst_C1))"?>

            <?define Inst_E0S0="($(var.Inst_E0) AND $(var.Inst_S0))"?>
            <?define Inst_E0S1="($(var.Inst_E0) AND $(var.Inst_S1))"?>
            <?define Inst_E1S0="($(var.Inst_E1) AND $(var.Inst_S0))"?>

            <?define Inst_S0C0="($(var.Inst_S0) AND $(var.Inst_C0))"?>
            <?define Inst_S0C1="($(var.Inst_S0) AND $(var.Inst_C1))"?>
            <?define Inst_S1C0="($(var.Inst_S1) AND $(var.Inst_C0))"?>

            <?define Inst_E1S0C0="($(var.Inst_E1) AND $(var.Inst_S0) AND $(var.Inst_C0))"?>
            <?define Inst_E0S1C0="($(var.Inst_E0) AND $(var.Inst_S1) AND $(var.Inst_C0))"?>
            <?define Inst_E0S0C1="($(var.Inst_E0) AND $(var.Inst_S0) AND $(var.Inst_C1))"?>
            <?define Inst_E1S1C0="($(var.Inst_E1) AND $(var.Inst_S1) AND $(var.Inst_C0))"?> 
            <?define Inst_E1S0C1="($(var.Inst_E1) AND $(var.Inst_S0) AND $(var.Inst_C1))"?>
            <?define Inst_E0S1C1="($(var.Inst_E0) AND $(var.Inst_S1) AND $(var.Inst_C1))"?>
            <?define Inst_E1S1C1="($(var.Inst_E1) AND $(var.Inst_S1) AND $(var.Inst_C1))"?>
            <?define Inst_E0S0C0="($(var.Inst_E0) AND $(var.Inst_S0) AND $(var.Inst_C0))"?>                

            <?define Changing_E1="NOT $(var.VmsInstalling) AND $(var.Inst_E1)"?>
            <?define Changing_E0S1="NOT $(var.VmsInstalling) AND $(var.Inst_E0S1)"?>
            <?define Changing_E0S0C1="NOT $(var.VmsInstalling) AND $(var.Inst_E0S0C1)"?>
            <?define ChangingNothing="NOT $(var.VmsInstalling) AND $(var.Inst_E0S0C0)"?>

            <!-- Changing -->
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="AppServerDlg">
                <![CDATA[ $(var.Changing_E1) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg">
                <![CDATA[ $(var.Changing_E0S1) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="ClientDlg">
                <![CDATA[ $(var.Changing_E0S0C1) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">
                <![CDATA[ $(var.ChangingNothing) ]]>
            </Publish>

            <!-- Reset values in case when user returns to this dialog after AppServerDlg -->

            <?define AppServerInstallingMediaServer="($(var.VmsChanging) AND !AppServerFeature=3 AND $(var.Inst_S1))"?>
            <?define AppServerInstallingClient="($(var.VmsChanging) AND !AppServerFeature=3 AND $(var.Inst_C1))"?>

            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4">
                <![CDATA[ $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">
                <![CDATA[ $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">
                <![CDATA[ $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4" >
                <![CDATA[ $(var.AppServerInstallingMediaServer) ]]>
            </Publish>

            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="{}" Order="4" >
                <![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]>
            </Publish>

            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4">
                <![CDATA[ $(var.AppServerInstallingClient) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">
                <![CDATA[ $(var.AppServerInstallingClient) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">
                <![CDATA[ $(var.AppServerInstallingClient) ]]>
            </Publish>

            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingClient) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingClient) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="{}" Order="4">
                <![CDATA[ NOT $(var.AppServerInstallingClient) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="{}">
                <![CDATA[ $(var.Inst_C0) ]]>
            </Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="$(var.LaunchClientChecBoxText)">
                <![CDATA[ $(var.Inst_C1) ]]>
            </Publish>

            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg">
                <![CDATA[ INSTALLTYPE <> 2 ]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="InstallTypeDlg">
                <![CDATA[ INSTALLTYPE = 2 ]]>
            </Publish>

            <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="AppServerDlg" Order="2">INSTALL_ECS</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="3">NOT INSTALL_ECS AND INSTALL_SERVER</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="4">NOT INSTALL_ECS AND NOT INSTALL_SERVER AND INSTALL_CLIENT</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>

            <Publish Dialog="AppServerDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg">
                <![CDATA[ $(var.VmsChanging) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">
                <![CDATA[ $(var.VmsInstalling) ]]>
            </Publish>

            <?define EcsPortsDiffer="(APPSERVER_PORT <> PROXY_PORT)" ?>
            <?define EcsNeedCheckPorts="(APPSERVER_PORT <> OLD_APPSERVER_PORT OR PROXY_PORT <> OLD_PROXY_PORT)" ?>        

            <Publish Dialog="AppServerDlg" Control="Next" Property="BUSYPORT" Value="{}">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORTSTOTEST" Value="[APPSERVER_PORT] [PROXY_PORT]" Order="1">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="PortDuplicateDlg" Order="2">
                <![CDATA[ NOT $(var.EcsPortsDiffer) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="PasswordShouldMatchDlg" Order="2">
                <![CDATA[ $(var.EcsPortsDiffer) AND NOT $(var.EcsPasswordsEqual) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="DoAction" Value="CheckPorts" Order="2">
                <![CDATA[ $(var.EcsPortsDiffer) AND $(var.EcsPasswordsEqual) AND $(var.EcsNeedCheckPorts) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="PortIsBusyDlg" Order="3">
                <![CDATA[ $(var.EcsPortsDiffer) AND $(var.EcsPasswordsEqual) AND BUSYPORT ]]>
            </Publish>

            <?define IsAsSettingsFilled="(APPSERVER_PORT AND PROXY_PORT AND APPSERVER_LOGIN AND APPSERVER_PASSWORD)" ?>
            <?define EcsSettingsValid="($(var.IsAsSettingsFilled) AND NOT BUSYPORT)"?>

            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="AllFieldsAreMandatoryDlg">
                <![CDATA[ NOT $(var.IsAsSettingsFilled) ]]>
            </Publish>

            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="2">
                <![CDATA[ $(var.EcsSettingsValid) AND $(var.Inst_S1) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="4">
                <![CDATA[ ($(var.EcsSettingsValid) AND $(var.Inst_S0C1)) ]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="4">
                <![CDATA[ ($(var.EcsSettingsValid) AND $(var.Inst_S0C0)) ]]>
            </Publish>

            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4">1</Publish>

            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">1</Publish>

            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_BACK" Value="AppServerDlg">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_NEXT" Value="MediaServerDlg">
                <![CDATA[(NOT BUSYPORT AND INSTALL_SERVER)]]>
            </Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_BACK"  Value="VerifyReadyDlg">
                <![CDATA[(NOT BUSYPORT AND NOT INSTALL_SERVER)]]>
            </Publish>

            <Publish Dialog="PortIsBusyDlg" Control="Back" Event="NewDialog" Value="[PORT_DIALOG_BACK]">1</Publish>
            <Publish Dialog="PortIsBusyDlg" Control="Next" Event="NewDialog" Value="[PORT_DIALOG_NEXT]">1</Publish>

            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="AppServerDlg">
                <![CDATA[ $(var.Inst_E1) ]]>
            </Publish>
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">
                <![CDATA[ $(var.VmsInstalling) AND $(var.Inst_E0) ]]>
            </Publish>
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg">
                <![CDATA[ $(var.VmsChanging) AND $(var.Inst_E0) ]]>
            </Publish>


            <?define IsPortsValid="((INSTALL_ECS AND SERVER_PORT<>APPSERVER_PORT AND SERVER_PORT<>PROXY_PORT) OR (NOT INSTALL_ECS))" ?>
            <?define IsSettingsFilled="(SERVER_PORT AND SERVER_APPSERVER_HOST AND SERVER_APPSERVER_PORT AND SERVER_APPSERVER_LOGIN AND SERVER_APPSERVER_PASSWORD)"?>
            <?define IsSettingsValid="($(var.IsPortsValid) AND $(var.IsSettingsFilled))"?>

            <Publish Dialog="MediaServerDlg" Control="Next" Event="SpawnDialog" Value="AllFieldsAreMandatoryDlg">
                <![CDATA[ NOT $(var.IsSettingsFilled) ]]>
            </Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="SpawnDialog" Value="PortDuplicateDlg">
                <![CDATA[ NOT $(var.IsPortsValid) AND $(var.IsSettingsFilled) ]]>
            </Publish>

            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="2">
                <![CDATA[$(var.IsSettingsValid) AND $(var.IsPortsValid) AND $(var.Inst_C1) ]]>
            </Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2">
                <![CDATA[$(var.IsSettingsValid) AND $(var.IsPortsValid)  AND $(var.Inst_C0) ]]>
            </Publish>

            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="[SERVER_APPSERVER_HOST]" Order="4">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[SERVER_APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[SERVER_APPSERVER_LOGIN]" Order="4">1</Publish>

            <Publish Dialog="MediaServerDlg" Control="Next" Property="BUSYPORT" Value="{}">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORTSTOTEST" Value="[SERVER_PORT]" Order="1">
                <![CDATA[ SERVER_PORT <> OLD_SERVER_PORT]]></Publish>

            <Publish Dialog="MediaServerDlg" Control="Next" Event="DoAction" Value="CheckPorts2" Order="2">
                <![CDATA[ SERVER_PORT <> OLD_SERVER_PORT]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="PortIsBusyDlg" Order="3">BUSYPORT</Publish>

            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORT_DIALOG_BACK" Value="MediaServerDlg">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORT_DIALOG_NEXT" Value="VerifyReadyDlg">1</Publish>

            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="2">
                <![CDATA[ $(var.VmsInstalling) AND $(var.Inst_E0S0) ]]>
            </Publish>
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg" Order="2">
                <![CDATA[ $(var.VmsChanging) AND $(var.Inst_E0S0) ]]>
            </Publish>
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="AppServerDlg" Order="2">
                <![CDATA[ $(var.Inst_E1S0) ]]>
            </Publish>
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="MediaServerDlg" Order="2">
                <![CDATA[ $(var.Inst_S1) ]]>
            </Publish>
            <Publish Dialog="ClientDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2">1</Publish>

            <?define EditingSettings="(($(var.VmsInstalling) AND INSTALLTYPE=1) OR $(var.VmsChanging))"?>

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" >
                <![CDATA[ $(var.VmsInstalling) AND $(var.Inst_E0S0C0) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg" >
                <![CDATA[ $(var.VmsChanging) AND $(var.Inst_E0S0C0) ]]>
            </Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="PasswordDlg">
                <![CDATA[ $(var.VmsInstalling) AND INSTALLTYPE=0 ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="AppServerDlg" >
                <![CDATA[ $(var.EditingSettings) AND $(var.Inst_E1S0C0) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MediaServerDlg">
                <![CDATA[ $(var.EditingSettings) AND $(var.Inst_S1C0) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ClientDlg" >
                <![CDATA[ $(var.EditingSettings) AND $(var.Inst_C1) ]]>
            </Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UpgradeDlg">
                <![CDATA[$(var.VmsUpgrading)]]>
            </Publish>
            <!--            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg" Order="2"><![CDATA[ NOT $(var.VmsUpgrading) AND ((Installed AND WixUI_InstallMode <> "Repair") OR (NOT $(var.VmsInstallingOrChanging) AND NOT INSTALL_SERVER)) ]]></Publish>-->
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">
                <![CDATA[ $(var.VmsRemoving) OR WixUI_InstallMode = "Repair" ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UninstallOptionsDlg" Order="2">
                <![CDATA[ $(var.VmsRemoving) AND !AppServerFeature = 3 ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">
                <![CDATA[ $(var.VmsRemoving) AND !AppServerFeature <> 3 ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Property="REMOVE" Value="{}" Order="3">
                <![CDATA[ Installed ]]>
            </Publish>

            <?define NeedTrayTool="(INSTALL_ECS OR INSTALL_SERVER)"?>

            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="AddLocal" Value="AppServerFeature">INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="AddLocal" Value="ServerFeature">INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="AddLocal" Value="ClientFeature">INSTALL_CLIENT</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="Remove" Value="AppServerFeature">NOT INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="Remove" Value="ServerFeature">NOT INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="Remove" Value="ClientFeature">NOT INSTALL_CLIENT</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="AddLocal" Value="TrayToolFeature">
                <![CDATA[ $(var.NeedTrayTool) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Install" Event="Remove" Value="TrayToolFeature">
                <![CDATA[ NOT $(var.NeedTrayTool) ]]>
            </Publish>

            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="AddLocal" Value="AppServerFeature">INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="AddLocal" Value="ServerFeature">INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="AddLocal" Value="ClientFeature">INSTALL_CLIENT</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="Remove" Value="AppServerFeature">NOT INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="Remove" Value="ServerFeature">NOT INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="Remove" Value="ClientFeature">NOT INSTALL_CLIENT</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="AddLocal" Value="TrayToolFeature">
                <![CDATA[ $(var.NeedTrayTool) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="InstallNoShield" Event="Remove" Value="TrayToolFeature">
                <![CDATA[ NOT $(var.NeedTrayTool) ]]>
            </Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="AddLocal" Value="AppServerFeature">INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="AddLocal" Value="ServerFeature">INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="AddLocal" Value="ClientFeature">INSTALL_CLIENT</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="Remove" Value="AppServerFeature">NOT INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="Remove" Value="ServerFeature">NOT INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="Remove" Value="ClientFeature">NOT INSTALL_CLIENT</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="AddLocal" Value="TrayToolFeature">
                <![CDATA[ $(var.NeedTrayTool) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Change" Event="Remove" Value="TrayToolFeature">
                <![CDATA[ NOT $(var.NeedTrayTool) ]]>
            </Publish>

            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="AddLocal" Value="AppServerFeature">INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="AddLocal" Value="ServerFeature">INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="AddLocal" Value="ClientFeature">INSTALL_CLIENT</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="Remove" Value="AppServerFeature">NOT INSTALL_ECS</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="Remove" Value="ServerFeature">NOT INSTALL_SERVER</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="Remove" Value="ClientFeature">NOT INSTALL_CLIENT</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="AddLocal" Value="TrayToolFeature">
                <![CDATA[ $(var.NeedTrayTool) ]]>
            </Publish>
            <Publish Dialog="VerifyReadyDlg" Control="ChangeNoShield" Event="Remove" Value="TrayToolFeature">
                <![CDATA[ NOT $(var.NeedTrayTool) ]]>
            </Publish>


            <!--            <Publish Dialog="VerifyReadyDlg" Control="Next" Event="ReinstallMode" Value="m" Order="1">WixUI_InstallMode = Change</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Next" Event="Reinstall" Value="Registry" Order="2">WixUI_InstallMode = Change</Publish>
-->            
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="ChangeButton" Event="NewDialog" Value="MyFeaturesDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Property="REMOVE" Value="ALL">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="UninstallOptionsDlg">
                <![CDATA[ !AppServerFeature = 3 ]]>
            </Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">
                <![CDATA[ !AppServerFeature <> 3 ]]></Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

            <Publish Dialog="UninstallOptionsDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="UninstallOptionsDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="UninstallOptionsDlg" Control="Back" Property="REMOVE" Value="{}">1</Publish>
            <Publish Dialog="UninstallOptionsDlg" Control="Back" Property="REMOVE_DATABASE" Value="0">1</Publish>
        </UI>
    </Product>
</Wix>
