<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">
    <Product Id="*" Name="$(env.APPLICATION_NAME)" Language="1033" Version="$(env.APPLICATION_VERSION)" Manufacturer="$(env.ORGANIZATION_NAME)" UpgradeCode="CE572797-45BF-4f1c-A783-369EA79C597E">
        <Package Id="*" InstallerVersion="300" Compressed="yes" Keywords="Installer" Comments="$(env.ORGANIZATION_NAME) $(env.APPLICATION_NAME)(beta) Installer" Manufacturer="$(env.ORGANIZATION_NAME)" InstallPrivileges="elevated"/>
        
        <!-- Wix Variables -->
        
        <?ifdef env.CommonProgramFiles(x86) ?>
        <?define commonProgramFiles = "c:\Program Files (x86)\Common Files\" ?>
        <?else?>
        <?define commonProgramFiles = "c:\Program Files\Common Files\" ?>
        <?endif?>
        
        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="Binary\eve\eve_logo-493x58.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="Binary\eve\eve_logo-493x312.bmp" />
        
        <!-- Logo -->
        <Icon Id="icon_menu.exe" SourceFile="Binary\eve\eve_logo.ico"/>
        <Icon Id="icon_desktop.exe" SourceFile="Binary\eve\eve_logo.ico"/>
        <Icon Id="eve_logo.ico" SourceFile="Binary\eve\eve_logo.ico"/>
        
        <!-- Properties -->
        <Property Id="WelcomeDlg_Title" Value="$(env.APPLICATION_NAME)(beta) Setup" />
        
        <Property Id="ARPPRODUCTICON" Value="eve_logo.ico" />
        
        <Property Id="NEWERFOUND" Secure="yes"/>
        <Property Id="ALLUSERS" Secure="yes"/>
        <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
        <Property Id="LAUNCHAPPONEXIT" Secure="yes" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch $(env.APPLICATION_NAME) when setup exits."  />
        
        <!-- AppServer properties-->
        <Property Id="APPSERVER_PORT" Secure="yes" Value="8000"/>
        <Property Id="APPSERVER_LOGIN" Secure="yes" Value="appserver"/>
        <Property Id="APPSERVER_PASSWORD" Secure="yes" Value="123"/>
        
        <!-- MediaServer properties-->
        <Property Id="SERVER_HOST" Secure="yes" />
        <Property Id="SERVER_PORT" Secure="yes" />
        <Property Id="SERVER_LOGIN" Secure="yes" />
        <Property Id="SERVER_PASSWORD" Secure="yes" />
        <Property Id="SERVER_RTSP_PORT" Secure="yes" Value="8001"/>
        <Property Id="SERVER_API_PORT" Secure="yes" Value="8002"/>
        <Property Id="SERVER_DIRECTORY" Secure="yes"/>
        <Property Id="SERVER_ALLOWCHANGEIP" Secure="yes"/>
        <Property Id="SERVER_AMOUNT" Secure="yes" Value="3"/>
        <Property Id="SERVER_KEEP" Secure="yes" Value="1"/>
        
        <!-- Client properties-->
        <Property Id="CLIENT_APPSERVER_HOST" Secure="yes" Value="localhost"/>
        <Property Id="CLIENT_APPSERVER_PORT" Secure="yes" Value="8000"/>
        <Property Id="CLIENT_APPSERVER_LOGIN" Secure="yes" Value="appserver"/>
        <Property Id="CLIENT_APPSERVER_PASSWORD" Secure="yes" Value="123"/>
        <Property Id="CLIENT_DIRECTORY" Secure="yes"/>
        <Property Id="CLIENT_VMS_MODE" Value="1"/>
        
        <Binary Id="PropsCA.dll" SourceFile="PropsCA\Release\PropsCA.dll" />
        <Binary Id="EveAssocCA.dll" SourceFile="EveAssocCA\Release\EveAssocCA.dll" />
        
        <!-- Custom actions -->
        <CustomAction Id="SetMoviesFolder" BinaryKey="PropsCA.dll" DllEntry="SetMoviesFolder" />
        <CustomAction Id="SetProperties" BinaryKey="PropsCA.dll" DllEntry="SetProperties" Execute="firstSequence" />
        <CustomAction Id="MissingFeature"  Error="At least one component should be selected"/>
        <CustomAction Id="AssignServerFolder" Property="SERVER_DIRECTORY" Value="[MOVIESFOLDER]\VMS Server Media" />
        <CustomAction Id="AssignClientFolder" Property="CLIENT_DIRECTORY" Value="[MOVIESFOLDER]\VMS Client Media" />
        <CustomAction Id="ResetServerFolder" Property="SERVER_DIRECTORY" Value="" />
        <CustomAction Id="ResetClientFolder" Property="CLIENT_DIRECTORY" Value="" />
        
        <!--        <CustomAction Id="StartAppOnExit" FileKey="ClientExe" ExeCommand="" Execute="immediate" Impersonate="yes" Return="asyncNoWait"/>-->
        
        <Upgrade Id="CE572797-45BF-4f1c-A783-369EA79C597E">
            <UpgradeVersion
                Minimum="0.1.0" Maximum="$(env.APPLICATION_VERSION)"
                Property="PREVIOUSVERSIONSINSTALLED"
                IncludeMinimum="yes" IncludeMaximum="yes" />
            <UpgradeVersion OnlyDetect='no' Property='NEWERFOUND' Minimum='$(env.APPLICATION_VERSION)' IncludeMinimum='no' />
        </Upgrade>
        
        <InstallUISequence>
            <Custom Action="SetProperties" Before="SetMoviesFolder" />
            <Custom Action="SetMoviesFolder" Before="AssignClientFolder" />
            <Custom Action="AssignClientFolder" Before="CostInitialize">CLIENT_FOLDER=""</Custom>
            <Custom Action="AssignServerFolder" Before="CostInitialize">SERVER_FOLDER=""</Custom>
            
            <Custom Action="ResetClientFolder" Before="CostFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
            <Custom Action="ResetServerFolder" Before="CostFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
        </InstallUISequence>
        
        <InstallExecuteSequence>
            <RemoveExistingProducts Before="InstallInitialize" />
        </InstallExecuteSequence>
        
        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />
        
        <Directory Id="TARGETDIR" Name="SourceDir">
            
            <Directory Id="SERVER_DIRECTORY" Name="Server Media">
                <Component Id="ServerDirectoryComponent" Guid="{C259A76D-4CAA-489f-A18F-28AED0232853}" Permanent="yes">
                    <CreateFolder Directory="SERVER_DIRECTORY"/>
                    <RegistryValue Root='HKCU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes' />
                </Component>
                
                <Component Id="ServerConfiguration" Guid="{C3BA240A-2D18-4723-B084-D2774F51D1B0}" Permanent="yes">
                    <RegistryKey Root="HKCU"
                                 Key="Software\[Manufacturer]\VMS Server"
                                 Action="createAndRemoveOnUninstall">
                        <RegistryValue Type="integer" Name="SomeIntegerValue" Value="1" KeyPath="yes"/>
                        <RegistryValue Type="string" Name="appserverHost" Value="[SERVER_HOST]"/>
                        <RegistryValue Type="string" Name="appserverPort" Value="[SERVER_PORT]"/>
                        <RegistryValue Type="string" Name="appserverLogin" Value="[SERVER_LOGIN]"/>
                        <RegistryValue Type="string" Name="appserverPassword" Value="[SERVER_PASSWORD]"/>
                        <RegistryValue Type="string" Name="appserverRtspPort" Value="[SERVER_RTSP_PORT]"/>
                        <RegistryValue Type="string" Name="appserverApiPort" Value="[SERVER_API_PORT]"/>
                        <RegistryValue Type="string" Name="appserverMediaDir" Value="[SERVER_DIRECTORY]"/>
                        <RegistryValue Type="string" Name="appserverAllowChangeIp" Value="[SERVER_ALLOWCHANGEIP]"/>
                        <RegistryValue Type="string" Name="appserverAmount" Value="[SERVER_AMOUNT]"/>
                        <RegistryValue Type="string" Name="appserverKeep" Value="[SERVER_KEEP]"/>
                    </RegistryKey>
                </Component>
            </Directory>
            
            <Directory Id="CLIENT_DIRECTORY" Name="Client Media">
                <Component Id="ClientDirectoryComponent" Guid="{953EF7FD-01CF-432f-936C-43F07BC918DE}" Permanent="yes">
                    <CreateFolder Directory="CLIENT_DIRECTORY"/>
                    <RegistryValue Root='HKCU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes' />
                </Component>
            </Directory>
            
            <Component Id="Empty" Guid="" />
            
            <Directory Id="ProgramFilesFolder">
                <Directory Id="NetworkOptix" Name="$(env.ORGANIZATION_NAME)">
                    <Directory Id="INSTALLDIR" Name="$(env.APPLICATION_NAME)">
                        <Directory Id="VmsServerDir" Name="Server">
                            <Component Id="ServerExecutable" Guid="06DFA703-0266-4970-BAC1-3730BF7D1C66">
                                <File Id="ServerExe" Name="server.exe" Source="../server/bin/release/server.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionServer" Name="VMS Server" Scope="any" IgnoreFailure="yes"/>
                                    
                                    <Shortcut Id="StartmenuServer" Directory="ProgramMenuDir" Name="$(env.APPLICATION_NAME)"
                                              WorkingDirectory='INSTALLDIR' Advertise="yes" Icon="icon_menu.exe">
                                    </Shortcut>
                                </File>
                            </Component>
                        
                            <Component Id="ServerFFmpegLibraries" Guid="{692DCCAD-138B-4763-822E-8BC8712F5007}">
                                <File Id="ServerAvcodecDll" Name="avcodec-53.dll" Source="../server/bin/release/avcodec-53.dll"/>
                                <File Id="ServerAvdeviceDll" Name="avdevice-53.dll" Source="../server/bin/release/avdevice-53.dll"/>
                                <File Id="ServerAvfilterDll" Name="avfilter-2.dll" Source="../server/bin/release/avfilter-2.dll"/>
                                <File Id="ServerAvformatDll" Name="avformat-53.dll" Source="../server/bin/release/avformat-53.dll"/>
                                <File Id="ServerAvutilDll" Name="avutil-51.dll" Source="../server/bin/release/avutil-51.dll"/>
                                <File Id="ServerSwscaleDll" Name="swscale-2.dll" Source="../server/bin/release/swscale-2.dll"/>
                            </Component>
                            
                            <Component Id="ServerQTLibraries" Guid="{97B2E8C3-274A-4e3e-8FBD-F60355A75A8A}">
                                <File Id="ServerQtCore4.dll" Name="QtCore4.dll" Source="$(env.QTDIR)\bin\QtCore4.dll"/>
                                <File Id="ServerQtGui4.dll" Name="QtGui4.dll" Source="$(env.QTDIR)\bin\QtGui4.dll"/>
                                <File Id="ServerQtMultimedia4.dll" Name="QtMultimedia4.dll" Source="$(env.QTDIR)\bin\QtMultimedia4.dll"/>
                                <File Id="ServerQtNetwork4.dll" Name="QtNetwork4.dll" Source="$(env.QTDIR)\bin\QtNetwork4.dll"/>
                                <File Id="ServerQtOpenGL4.dll" Name="QtOpenGL4.dll" Source="$(env.QTDIR)\bin\QtOpenGL4.dll"/>
                                <File Id="ServerQtWebKit4.dll" Name="QtWebKit4.dll" Source="$(env.QTDIR)\bin\QtWebKit4.dll"/>
                                <File Id="ServerQtXml4.dll" Name="QtXml4.dll" Source="$(env.QTDIR)\bin\QtXml4.dll"/>
                                <File Id="ServerQtXmlPatterns4.dll" Name="QtXmlPatterns4.dll" Source="$(env.QTDIR)\bin\QtXmlPatterns4.dll"/>
                                <File Id="ServerPhonon4.dll" Name="phonon4.dll" Source="$(env.QTDIR)\bin\phonon4.dll"/>
                            </Component>
                        
                            <Component Id="ServerXerces" Guid="{B81B02A6-9CC1-4b16-9E03-A4AD91624B5E}">
                                <File Id="ServerXercescDll" Name="xerces-c_3_1.dll" Source="../server/bin/release/xerces-c_3_1.dll"/>
                            </Component>
                        </Directory>
                        
                        <Directory Id="VmsClientDir" Name="Client">
                            <Component Id="ClientExecutable" Guid="{7AAC7815-50A6-4dc9-ADD2-BDD9B7EE8FEF}">
                                <File Id="ClientExe" Name="client.exe" Source="../client/bin/release/client.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionClient" Name="VMS Client" Scope="any" IgnoreFailure="yes"/>
                                    
                                    <Shortcut Id="StartmenuClient" Directory="ProgramMenuDir" Name="$(env.APPLICATION_NAME)"
                                              WorkingDirectory='INSTALLDIR' Advertise="yes" Icon="icon_menu.exe">
                                    </Shortcut>
                                </File>
                            </Component>

                            <Directory Id="ImageFormats" Name="imageformats">
                                <Component Id="ImageFormats" Guid="{74793EF7-61C1-4e9c-81D6-A120E85D984F}">
                                    <File Id="qgif4.dll" Name="qgif4.dll" Source="$(env.QTDIR)\plugins\imageformats\qgif4.dll"/>
                                    <File Id="qjpeg4.dll" Name="qjpeg4.dll" Source="$(env.QTDIR)\plugins\imageformats\qjpeg4.dll"/>
                                    <File Id="qtiff4.dll" Name="qtiff4.dll" Source="$(env.QTDIR)\plugins\imageformats\qtiff4.dll"/>
                                </Component>
                            </Directory>

                            <Component Id="ClientFFmpegLibraries" Guid="{5D256521-DE39-4264-A44F-69728AA650EF}">
                                <File Id="ClientAvcodecDll" Name="avcodec-53.dll" Source="../client/bin/release/avcodec-53.dll"/>
                                <File Id="ClientAvdeviceDll" Name="avdevice-53.dll" Source="../client/bin/release/avdevice-53.dll"/>
                                <File Id="ClientAvfilterDll" Name="avfilter-2.dll" Source="../client/bin/release/avfilter-2.dll"/>
                                <File Id="ClientAvformatDll" Name="avformat-53.dll" Source="../client/bin/release/avformat-53.dll"/>
                                <File Id="ClientAvutilDll" Name="avutil-51.dll" Source="../client/bin/release/avutil-51.dll"/>
                                <File Id="ClientSwscaleDll" Name="swscale-2.dll" Source="../client/bin/release/swscale-2.dll"/>
                            </Component>
                            
                            <Component Id="ClientQTLibraries" Guid="{6BDC7AB9-6230-4cf3-9C1C-634C636D90BC}">
                                <File Id="ClientQtCore4.dll" Name="QtCore4.dll" Source="$(env.QTDIR)\bin\QtCore4.dll"/>
                                <File Id="ClientQtGui4.dll" Name="QtGui4.dll" Source="$(env.QTDIR)\bin\QtGui4.dll"/>
                                <File Id="ClientQtMultimedia4.dll" Name="QtMultimedia4.dll" Source="$(env.QTDIR)\bin\QtMultimedia4.dll"/>
                                <File Id="ClientQtNetwork4.dll" Name="QtNetwork4.dll" Source="$(env.QTDIR)\bin\QtNetwork4.dll"/>
                                <File Id="ClientQtOpenGL4.dll" Name="QtOpenGL4.dll" Source="$(env.QTDIR)\bin\QtOpenGL4.dll"/>
                                <File Id="ClientQtWebKit4.dll" Name="QtWebKit4.dll" Source="$(env.QTDIR)\bin\QtWebKit4.dll"/>
                                <File Id="ClientQtXml4.dll" Name="QtXml4.dll" Source="$(env.QTDIR)\bin\QtXml4.dll"/>
                                <File Id="ClientQtXmlPatterns4.dll" Name="QtXmlPatterns4.dll" Source="$(env.QTDIR)\bin\QtXmlPatterns4.dll"/>
                                <File Id="ClientPhonon4.dll" Name="phonon4.dll" Source="$(env.QTDIR)\bin\phonon4.dll"/>
                            </Component>
                            
                            <Component Id="ClientOpenAL" Guid="{FA1A8B92-3BEF-4779-90E9-2F76CC9D79D3}">
                                <File Id="OpenAL32.dll" Name="OpenAL32.dll" Source="..\client\contrib\openal\bin\Win32\OpenAL32.dll"/>
                                <File Id="wrap_oal.dll" Name="wrap_oal.dll" Source="..\client\contrib\openal\bin\Win32\wrap_oal.dll"/>
                            </Component>
                            
                            <Component Id="ClientOpenSSL" Guid="{D7E994B3-B437-4993-A04E-C15AF9DF8312}">
                                <File Id="libeay32.dll" Name="libeay32.dll" Source="..\client\contrib\openssl\libeay32.dll"/>
                                <File Id="ssleay32.dll" Name="ssleay32.dll" Source="..\client\contrib\openssl\ssleay32.dll"/>
                            </Component>
                        
                            <Component Id="ClientXerces" Guid="{50CE2C40-DE8E-4619-979F-2C227009D4BB}">
                                <File Id="ClientXercescDll" Name="xerces-c_3_1.dll" Source="../client/bin/release/xerces-c_3_1.dll"/>
                            </Component>

                            <Directory Id="styles" Name="styles">
                                <Component Id="bespin" Guid="{BF20F7AC-A34C-481a-84E3-731C80050D51}">
                                    <File Id="bespin.dll" Name="bespin.dll" Source="..\client\contrib\bespin\bin\msvc-x86\release\styles\bespin.dll"/>
                                </Component>
                            </Directory>
                            
                            <Directory Id="arecontvision" Name="arecontvision">
                                <Component Id="arecontvision" Guid="{94FE9A39-0F46-4c79-A12F-7FCA2E3B5D16}">
                                    <File Id="devicesxml" Name="devices.xml" Source="../client/resource/arecontvision/devices.xml"/>
                                </Component>
                            </Directory>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>
            
            <Directory Id="ProgramMenuFolder" Name="Programs">
                <Directory Id="ProgramMenuDir" Name="$(env.ORGANIZATION_NAME)">
                    <Component Id="ProgramMenuDir" Guid="{A4C7D09A-756B-45b6-B3A2-1B2D6DCF5D2A}">
                        <RemoveFolder Id='ProgramMenuDir' On='uninstall' />
                        <RegistryValue Root='HKCU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes' />
                    </Component>
                </Directory>
            </Directory>
            
            <Directory Id="DesktopFolder" Name="Desktop"/>
        </Directory>
        
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist1" SourceFile="$(var.commonProgramFiles)Merge Modules\Microsoft_VC90_CRT_x86.msm" DiskId="1" Language="0"/>
            <Merge Id="VCRedist2" SourceFile="$(var.commonProgramFiles)Merge Modules\policy_9_0_Microsoft_VC90_CRT_x86.msm" DiskId="1" Language="0"/>
        </DirectoryRef>
        
        <Feature Id="VCRedist" Title="Visual C++ 9.0 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist1"/>
            <MergeRef Id="VCRedist2"/>
        </Feature>
        
        <Feature Id="AppServerFeature" Title="$(env.APPLICATION_NAME) Application Server" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
            <ComponentRef Id="Empty" />
        </Feature>
        
        <Feature Id="ServerFeature" Title="$(env.APPLICATION_NAME) Media Server" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
            <ComponentRef Id='ServerDirectoryComponent'/>
            <ComponentRef Id='ServerConfiguration'/>
            
            <ComponentRef Id="ServerExecutable" />
            <ComponentRef Id="ServerFFmpegLibraries"/>
            <ComponentRef Id="ServerQTLibraries" />
            <ComponentRef Id="ServerXerces"/>
        </Feature>
        
        <Feature Id="ClientFeature" Title="$(env.APPLICATION_NAME) Client" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
            <!--            <FeatureRef Id='EveMediaPlayerFileAssociations' />-->
            
            <ComponentRef Id="ClientExecutable" />
            <ComponentRef Id="ClientFFmpegLibraries"/>
            <ComponentRef Id="ClientQTLibraries" />
            <ComponentRef Id="ImageFormats" />
            <ComponentRef Id="ClientOpenAL" />
            <ComponentRef Id="ClientOpenSSL" />
            <ComponentRef Id="ClientXerces"/>
            <ComponentRef Id='ProgramMenuDir' />
            <ComponentRef Id="bespin" />
            <ComponentRef Id='arecontvision'/>
            <ComponentRef Id='ClientDirectoryComponent'/>
            
            <ComponentRef Id='EveDirectoryPlayWithMenuItem'/>
            <ComponentRef Id='EveDVDMovieAssociation'/>
            <ComponentRef Id='EveMovieFilesAssociation'/>
            
            <ComponentRef Id='EveApplicationAssociation' />
        </Feature>
        
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <Property Id="WIXUI_SERVER_DIRECTORY" Value="SERVER_DIRECTORY"/>
        <Property Id="WIXUI_CLIENT_DIRECTORY" Value="CLIENT_DIRECTORY"/>
        <Property Id="WIXUI_SERVER_ALLOWCHANGEIP" Value="SERVER_ALLOWCHANGEIP"/>
        
        
        <UIRef Id="WixUI_Common" />
        <UIRef Id="WixUI_ErrorProgressText" />
        
        <UI>
            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />
            
            <Property Id="ARPNOMODIFY" Value="1" />
            
            <DialogRef Id="MyFeaturesDlg" />
            <DialogRef Id="SelectionWarningDlg" />
            <DialogRef Id="DowngradeWarningDlg" />
            <DialogRef Id="BrowseDlg" />
            <DialogRef Id="DiskCostDlg" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />
            <!--Width="260" Height="85"-->
            
            <Binary Id="Warning" SourceFile="Binary\Exclam.ico" />
            
            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <!--            <Publish Dialog="ExitDialog" Control="Finish" Order="1" Event="DoAction" Value="StartAppOnExit">WIXUI_EXITDIALOGOPTIONALCHECKBOX</Publish>-->
            
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">NOT NEWERFOUND</Publish>
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="DowngradeWarningDlg">NEWERFOUND</Publish>
            
            <Publish Dialog="DowngradeWarningDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="DowngradeWarningDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            
            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">NOT NEWERFOUND</Publish>
            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="DowngradeWarningDlg">NEWERFOUND</Publish>
            
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="MyFeaturesDlg">LicenseAccepted = "1"</Publish>
            
            <Publish Dialog="MyFeaturesDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">1</Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="SpawnDialog" Value="SelectionWarningDlg" Order="10">
                <![CDATA[(NOT(&AppServerFeature=3) AND NOT(&ServerFeature=3) AND NOT(&ClientFeature=3))]]>
            </Publish>
            
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="AppServerDlg" Order="2"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="3"><![CDATA[(&AppServerFeature <> 3 AND &ServerFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="4"><![CDATA[(&AppServerFeature <> 3 AND &ServerFeature <>3 AND &ClientFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            
            <Publish Dialog="AppServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="2"><![CDATA[(&ServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="3"><![CDATA[(&ServerFeature <> 3 AND &ClientFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="4"><![CDATA[(&ServerFeature <> 3 AND &ClientFeature<>3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_HOST" Value="localhost" Order="4"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_PORT" Value="[APPSERVER_PORT]" Order="4"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4"><![CDATA[(&AppServerFeature=3)]]></Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="AppServerDlg"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg"><![CDATA[(&AppServerFeature<>3)]]></Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_SERVER_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="ClientDlg" Order="2"><![CDATA[(&ClientFeature=3)]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="3"><![CDATA[(&ClientFeature<>3)]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="ChangeServerMediaDir" Property="_BrowseProperty" Value="[WIXUI_SERVER_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="ChangeServerMediaDir" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="MediaServerDlg"><![CDATA[(&ServerFeature=3)]]></Publish>
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="AppServerDlg"><![CDATA[(&AppServerFeature = 3 AND &ServerFeature<>3)]]></Publish>
            <Publish Dialog="ClientDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg"><![CDATA[(&AppServerFeature <> 3 AND &ServerFeature<>3)]]></Publish>
            <Publish Dialog="ClientDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_CLIENT_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="ClientDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2">1</Publish>
            <Publish Dialog="ClientDlg" Control="ChangeClientMediaDir" Property="_BrowseProperty" Value="[WIXUI_CLIENT_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="ClientDlg" Control="ChangeClientMediaDir" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ClientDlg" Order="1"><![CDATA[(NOT Installed AND &ClientFeature = 3)]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MediaServerDlg" Order="1"><![CDATA[(NOT Installed AND &ClientFeature <> 3 AND &ServerFeature=3)]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="AppServerDlg" Order="1"><![CDATA[(NOT Installed AND &ClientFeature <> 3 AND &ServerFeature<>3 AND &AppServerFeature = 3)]]></Publish>
            
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">Installed</Publish>
            
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>
        </UI>
    </Product>
</Wix>
