<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:SystemTools="http://schemas.appsecinc.com/wix/SystemToolsExtension">
    <Product Id="*" Name="$(env.APPLICATION_NAME)" Language="1033" Version="$(env.APPLICATION_VERSION).$(env.BUILD_NUMBER)" Manufacturer="$(env.ORGANIZATION_NAME)" UpgradeCode="{CE572797-45BF-4f1c-A783-369EA79C597E}">    	
        <Package Id="*" InstallerVersion="300" Compressed="yes" Keywords="Installer" Comments="$(env.ORGANIZATION_NAME) $(env.APPLICATION_NAME)(beta) Installer" Manufacturer="$(env.ORGANIZATION_NAME)" InstallPrivileges="elevated" InstallScope="perMachine"/>
        
    	<?include ControlPanel.wxi ?>
    	
        <!-- Wix Variables -->
        
        <?ifdef env.CommonProgramFiles(x86) ?>
        <?define commonProgramFiles = "c:\Program Files (x86)\Common Files\" ?>
        <?else?>
        <?define commonProgramFiles = "c:\Program Files\Common Files\" ?>
        <?endif?>
        
        <?if $(env.CONFIG) = Debug ?>
        <?define suffix = "d" ?>
        <?else?>
        <?define suffix = "" ?>
        <?endif?>
        
        <?define VmsInstalling=" (NOT Installed AND NOT PREVIOUSVERSIONSINSTALLED) "?>
        <?define VmsUpgrading=" (NOT Installed AND PREVIOUSVERSIONSINSTALLED)" ?>
        <?define VmsChanging=" (Installed AND REMOVE <> "ALL") "?>
        <?define VmsRemoving=" (Installed AND REMOVE = "ALL") "?>
        <?define VmsRepairing=" (REINSTALLMODE) " ?>
        
        <?define LaunchClientChecBoxText="Launch $(env.APPLICATION_NAME) when setup exits." ?>
        
    	<SystemTools:DeleteFile Id="test1" File="[SystemFolder]config\systemprofile\AppData\Local\$(env.ORGANIZATION_NAME)\Enterprise Controller\db\ecs.db" DeleteOnUnInstall="yes" CheckIfExists="yes" > REMOVE_DATABASE = "1" </SystemTools:DeleteFile>

        <SetProperty Id="REBOOT" Value="reallysuppress" After="FindRelatedProducts">Installed AND REMOVE&lt;&gt;"ALL"</SetProperty>
        <SetProperty Id="PREVIOUSVERSIONSINSTALLED" Value="[MIGRATE]" After="FindRelatedProducts"/>
        <SetProperty Id="APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD_REG]" After="FindRelatedProducts">$(var.VmsRepairing)</SetProperty>
        <SetProperty Id="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD_REG]" After="FindRelatedProducts">$(var.VmsRepairing)</SetProperty>

        <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="Binary\eve\eve_logo-493x58.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="Binary\eve\eve_logo-493x312.bmp" />
        
        <!-- Logo -->
        <Icon Id="icon_menu.exe" SourceFile="Binary\eve\eve_logo.ico"/>
        <Icon Id="icon_desktop.exe" SourceFile="Binary\eve\eve_logo.ico"/>
        
        <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" Secure="yes"/>
        
        <Property Id="LAUNCHAPPONEXIT" Secure="yes" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="$(var.LaunchClientChecBoxText)" />
       
        <!-- Properties -->
        <Property Id="WelcomeDlg_Title" Value="$(env.APPLICATION_NAME)(beta) Setup" />
        
        <Property Id="INSTALLTYPE" Value="0"/>
        <Property Id="ADVANCEDTYPE" Value="0"/>
        
        <Property Id="BUSYPORT" Secure="yes"/>
        <Property Id="DUMMY_APPSERVER_LOGIN" Value="admin"/>
        
    	<Property Id="REMOVE_DATABASE" Secure="yes"/>
    	
        <!-- AppServer properties-->
        <Property Id="APPSERVER_GUID" Secure="yes">
            <RegistrySearch Id="EcsGuidReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Enterprise Controller"
                            Name="ecsGuid"
                            Type="raw"
                            Win64="no"/>
        </Property>
        
        <Property Id="APPSERVER_PORT" Secure="yes">
            <RegistrySearch Id="AppServerPortReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Enterprise Controller"
                            Name="port"
                            Type="raw"
                            Win64="no"/>
        </Property>
        
        <Property Id="PROXY_PORT" Secure="yes">
            <RegistrySearch Id="ProxyPortReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Enterprise Controller"
                            Name="proxyPort"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <!-- We use ecs password only when doing repair -->
        <Property Id="APPSERVER_PASSWORD_REG" Secure="yes">
            <RegistrySearch Id="AppServerPasswordReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Enterprise Controller"
                            Name="password"
                            Type="raw"
                            Win64="no"/>
        </Property>
        
        <Property Id="APPSERVER_LOGIN" Secure="yes" Value="admin"/>
        <Property Id="APPSERVER_PASSWORD" Secure="yes"/>
        <Property Id="APPSERVER_PASSWORD_CONFIRM" Secure="yes"/>
        
        <!-- MediaServer properties-->
        <Property Id="SERVER_APPSERVER_HOST" Secure="yes" Value="localhost"/>
        <Property Id="SERVER_APPSERVER_PORT" Secure="yes" Value="8000"/>
        <Property Id="SERVER_APPSERVER_LOGIN" Secure="yes" Value="admin"/>
        <Property Id="SERVER_APPSERVER_PASSWORD" Secure="yes"/>
        <Property Id="SERVER_RTSP_PORT" Secure="yes">
            <RegistrySearch Id="ServerRtspPortReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Network Optix Media Server"
                            Name="rtspPort"
                            Type="raw"
                            Win64="no"/>
        </Property>
        <Property Id="SERVER_API_PORT" Secure="yes">
            <RegistrySearch Id="ServerApiPortReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Network Optix Media Server"
                            Name="apiPort"
                            Type="raw"
                            Win64="no"/>
        </Property>

        <Property Id="SERVER_DIRECTORY_REG" Secure="yes">
            <RegistrySearch Id="ServerDirectoryReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Network Optix Media Server"
                            Name="mediaDir"
                            Type="raw"
                            Win64="no">
            </RegistrySearch>
        </Property>

        <Property Id="SERVER_GUID" Secure="yes">
            <RegistrySearch Id="ServerGuidReg"
                            Root="HKLM"
                            Key="Software\Network Optix\Network Optix Media Server"
                            Name="serverGuid"
                            Type="raw"
                            Win64="no"/>
        </Property>
        
        <Property Id="IS_SERVER_DIRECTORY_REG" Secure="yes">
            <DirectorySearch Id='DirectorySearch1' Path='[SERVER_DIRECTORY_REG]'/>
        </Property>
        
        
        <!-- Client properties-->
        <Property Id="CLIENT_APPSERVER_HOST" Secure="yes" Value="localhost"/>
        <Property Id="CLIENT_APPSERVER_PORT" Secure="yes" Value="7001"/>
        <Property Id="CLIENT_APPSERVER_LOGIN" Secure="yes" Value="admin"/>
        <Property Id="CLIENT_VMS_MODE" Value="1"/>
        <Property Id="CLIENT_DIRECTORY_REG" Secure="yes">
            <RegistrySearch Id="ClientDirectoryReg"
                            Root="HKCU"
                            Key="Software\[Manufacturer]\Network Optix HD Witness Client"
                            Name="mediaRoot"
                            Type="raw"
                            Win64="no"/>
        </Property>
        
        <Binary Id="CustomActions.dll" SourceFile="CustomActions\Release\CustomActions.dll" />
        
        <!-- Custom actions -->
        <CustomAction Id="ResetPreselected" Property="Preselected" Value="" />
        <CustomAction Id="SetMoviesFolder" BinaryKey="CustomActions.dll" DllEntry="SetMoviesFolder" />
        <CustomAction Id="GenerateGuidsForServers" BinaryKey="CustomActions.dll" DllEntry="GenerateGuidsForServers"/>
        <CustomAction Id="MissingFeature"  Error="At least one component should be selected"/>
        
        <CustomAction Id="CheckServerDriveLowSpace" BinaryKey="CustomActions.dll" DllEntry="CheckServerDriveLowSpace"/>
        <CustomAction Id="CheckServerDirectoryWritable" BinaryKey="CustomActions.dll" DllEntry="CheckServerDirectoryWritable"/>
        
        <CustomAction Id="FindFreePorts" BinaryKey="CustomActions.dll" DllEntry="FindFreePorts" />
        <CustomAction Id="CheckPorts" BinaryKey="CustomActions.dll" DllEntry="CheckPorts"/>
        <CustomAction Id="CheckPorts2" BinaryKey="CustomActions.dll" DllEntry="CheckPorts"/>
        
        <CustomAction Id="FixServerFolder" BinaryKey="CustomActions.dll" DllEntry="FixServerFolder"/>
        <CustomAction Id="FixClientFolder" BinaryKey="CustomActions.dll" DllEntry="FixClientFolder"/>
    	
        <CustomAction Id="SetNewGuidForEcs" Property="APPSERVER_GUID" Value="[APPSERVER_GUID_NEW]"/>
        <CustomAction Id="SetNewGuidForServer" Property="SERVER_GUID" Value="[SERVER_GUID_NEW]"/>
        
        <CustomAction Id="AssignOldAppServerPort" Property="OLD_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>
        <CustomAction Id="AssignOldServerRtspPort" Property="OLD_SERVER_RTSP_PORT" Value="[SERVER_RTSP_PORT]"/>
        <CustomAction Id="AssignOldServerApiPort" Property="OLD_SERVER_API_PORT" Value="[SERVER_API_PORT]"/>
        <CustomAction Id="AssignOldProxyPort" Property="OLD_PROXY_PORT" Value="[PROXY_PORT]"/>
        
        <CustomAction Id="AssignAppServerPort" Property="APPSERVER_PORT" Value="[FREEPORT1]"/>
        <CustomAction Id="AssignServerRtspPort" Property="SERVER_RTSP_PORT" Value="[FREEPORT2]"/>
        <CustomAction Id="AssignServerApiPort" Property="SERVER_API_PORT" Value="[FREEPORT3]"/>
        <CustomAction Id="AssignProxyPort" Property="PROXY_PORT" Value="[FREEPORT4]"/>

        <!-- Assign default values for Quick installation -->
        <CustomAction Id="AssignServerAppServerPort" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>
        <CustomAction Id="AssignClientAppServerPort" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]"/>
        
        <CustomAction Id="AssignServerFolder" Property="SERVER_DIRECTORY" Value="[ROOTDRIVE]\HDWitness" />
        <CustomAction Id="AssignClientFolder" Property="CLIENT_DIRECTORY" Value="[MOVIESFOLDER]\HD Witness Client Media" />
        
        <CustomAction Id="ResetServerFolder" Property="SERVER_DIRECTORY" Value="[SERVER_DIRECTORY_REG]" />
        <CustomAction Id="ResetClientFolder" Property="CLIENT_DIRECTORY" Value="[CLIENT_DIRECTORY_REG]" />
        
        <CustomAction Id="InitDatabaseAction_Cmd" Property="InitDatabaseAction"
                      Value="&quot;[#dbconfig.exe]&quot; &quot;[APPSERVER_LOGIN]&quot;  &quot;[APPSERVER_PASSWORD]&quot;" Execute="immediate" Impersonate="yes"/>
        <CustomAction Id="InitDatabaseAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="check" Impersonate="no" />
        
        <CustomAction Id="SyncDatabaseAction_Cmd" Property="SyncDatabaseAction"
                      Value="&quot;[#dbsync.exe]&quot;" Execute="immediate" Impersonate="yes"/>
        <CustomAction Id="SyncDatabaseAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="check" Impersonate="no" />

        <CustomAction Id="CloseTrayToolAction_Cmd" Property="CloseTrayToolAction"
                      Value="&quot;[VmsTrayToolDir]traytool.exe&quot; &quot;quit&quot;" Execute="immediate" />
        <CustomAction Id="CloseTrayToolAction" BinaryKey="WixCA" DllEntry="CAQuietExec"
                      Execute="deferred" Return="ignore" Impersonate="no" />

        <CustomAction Id="LaunchTrayTool" Execute="immediate" Impersonate="yes" Return="asyncNoWait" FileKey="traytool.exe" ExeCommand=""/>
        <CustomAction Id="LaunchClient" Execute="immediate" Impersonate="yes" Return="asyncNoWait" FileKey="HDWitness.exe" ExeCommand=""/>
        
        <CustomAction Id="NoDowngrade" Error="NoDowngrade" /> 
        
<!--        <util:CloseApplication Id="CloseTrayTool" ElevatedCloseMessage="yes" CloseMessage="yes" Target="traytool.exe" RebootPrompt="no"/>-->
    
        <MajorUpgrade AllowSameVersionUpgrades="yes"
            Schedule="afterInstallInitialize"
            DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."
            MigrateFeatures="yes" />
    
<!--        <Upgrade Id="{CE572797-45BF-4f1c-A783-369EA79C597E}">
            <UpgradeVersion
                Minimum="0.0.0.0" Maximum="$(env.APPLICATION_VERSION).$(env.BUILD_NUMBER)"
                Property="PREVIOUSVERSIONSINSTALLED"
                IncludeMinimum="yes" IncludeMaximum="yes" />
            <UpgradeVersion OnlyDetect='no' Property='NEWERVERSIONINSTALLED' Minimum='$(env.APPLICATION_VERSION).$(env.BUILD_NUMBER)' IncludeMinimum='no' />
        </Upgrade>

-->
        <?define EcsNeedsGuid="(&AppServerFeature AND NOT APPSERVER_GUID)"?>
        <?define ServerNeedsGuid="&ServerFeature AND NOT SERVER_GUID"?>
        <InstallUISequence>
            <Custom Action="ResetPreselected" After="CostFinalize">Installed AND Preselected</Custom>
            <FindRelatedProducts Before="AppSearch" />
            <AppSearch Before="LaunchConditions" />
            
            <Custom Action="FindFreePorts" Before="AssignOldAppServerPort"/>
            <Custom Action="AssignOldAppServerPort" Before="AssignOldServerRtspPort">1</Custom>
            <Custom Action="AssignOldServerRtspPort" Before="AssignOldServerApiPort">1</Custom>
            <Custom Action="AssignOldServerApiPort" Before="AssignOldProxyPort">1</Custom>
            <Custom Action="AssignOldProxyPort" Before="AssignAppServerPort">1</Custom>
            <Custom Action="AssignAppServerPort" Before="AssignServerRtspPort">NOT APPSERVER_PORT</Custom>
            <Custom Action="AssignServerRtspPort" Before="AssignServerApiPort">NOT SERVER_RTSP_PORT</Custom>
            <Custom Action="AssignServerApiPort" Before="AssignProxyPort">NOT SERVER_API_PORT</Custom>
            <Custom Action="AssignProxyPort" Before="AssignServerAppServerPort">NOT PROXY_PORT</Custom>
            <Custom Action="AssignServerAppServerPort" Before="AssignClientAppServerPort">1</Custom>
            <Custom Action="AssignClientAppServerPort" Before="SetMoviesFolder">1</Custom>
            <Custom Action="SetMoviesFolder" Before="GenerateGuidsForServers">1</Custom>
            <Custom Action="GenerateGuidsForServers" Before="SetNewGuidForEcs"><![CDATA[ $(var.EcsNeedsGuid) OR $(var.ServerNeedsGuid) ]]></Custom>
            <Custom Action="SetNewGuidForEcs" Before="SetNewGuidForServer"><![CDATA[ $(var.EcsNeedsGuid) ]]></Custom>
            <Custom Action="SetNewGuidForServer" Before="AssignClientFolder"><![CDATA[ $(var.ServerNeedsGuid)  ]]></Custom>
            
            <Custom Action="FixClientFolder" After="ResetClientFolder"/>
            <Custom Action="FixServerFolder" After="ResetServerFolder">IS_SERVER_DIRECTORY_REG</Custom>

            <Custom Action="ResetClientFolder" Before="CostInitialize"/>
            <Custom Action="ResetServerFolder" Before="CostInitialize">IS_SERVER_DIRECTORY_REG</Custom>
            
            <Custom Action="AssignClientFolder" After="CostInitialize">CLIENT_DIRECTORY=""</Custom>
            <Custom Action="AssignServerFolder" After="CostInitialize">SERVER_DIRECTORY=""</Custom>
            
            <!--          <Custom Action="ResetClientFolder" Before="CostFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
            <Custom Action="ResetServerFolder" Before="CostFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
  -->      </InstallUISequence>
        
        <InstallExecuteSequence>
            <FindRelatedProducts Before="AppSearch" />
            <AppSearch Before="LaunchConditions" />

<!--            <RemoveExistingProducts After="InstallFinalize"/>-->
            
<!--            <Custom Action="CloseTrayToolAction" Before="RemoveExistingProducts" />-->
<!--            <RemoveExistingProducts After="InstallInitialize" />-->
            <Custom Action="CloseTrayToolAction_Cmd" Before="CloseTrayToolAction"><![CDATA[ NOT $(var.VmsInstalling) ]]></Custom>
            <Custom Action="CloseTrayToolAction" Before="StopServices"><![CDATA[ NOT $(var.VmsInstalling) ]]></Custom>

            <Custom Action="SyncDatabaseAction_Cmd" After="InstallFiles">      <![CDATA[ (!AppServerFeature=3 OR &AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            <Custom Action="SyncDatabaseAction" After="SyncDatabaseAction_Cmd"><![CDATA[ (!AppServerFeature=3 OR &AppServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
            
            <Custom Action="InitDatabaseAction_Cmd" After="SyncDatabaseAction"><![CDATA[ $(var.VmsInstalling) AND &AppServerFeature=3 ]]></Custom>
            <Custom Action="InitDatabaseAction" After="InitDatabaseAction_Cmd"><![CDATA[ $(var.VmsInstalling) AND &AppServerFeature=3 ]]></Custom>

            <Custom Action="LaunchTrayTool" After="InstallFinalize"><![CDATA[ (!AppServerFeature=3 OR &AppServerFeature=3 OR !ServerFeature=3 OR &ServerFeature=3) AND REMOVE <> "ALL" ]]></Custom>
        </InstallExecuteSequence>
        
        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

        <Directory Id="TARGETDIR" Name="SourceDir">
            
            <Directory Id="SERVER_DIRECTORY" Name="Server Media">
                <Component Id="ServerDirectoryComponent" Guid="{C259A76D-4CAA-489f-A18F-28AED0232853}" Permanent="yes">
                    <CreateFolder Directory="SERVER_DIRECTORY"/>
                    <RegistryValue Root='HKLM' Key='Software\[Manufacturer]\Network Optix Media Server' Type='string' Value='' KeyPath='yes' />
                </Component>
            </Directory>
            
            <Directory Id="CLIENT_DIRECTORY" Name="Client Media">
                <Component Id="ClientDirectoryComponent" Guid="{953EF7FD-01CF-432f-936C-43F07BC918DE}" Permanent="yes">
                    <CreateFolder Directory="CLIENT_DIRECTORY"/>
                    <RegistryValue Root='HKCU' Key='Software\[Manufacturer]\Network Optix HD Witness Client' Type='string' Value='' KeyPath='yes' />
                </Component>
            </Directory>

            <Directory Id="ProgramFilesFolder">
                <Directory Id="NetworkOptix" Name="$(env.ORGANIZATION_NAME)">
                    <Directory Id="INSTALLDIR" Name="$(env.APPLICATION_NAME)">
                        <Directory Id="VmsAppServerDir" Name="Enterprise Controller">
                            <Component Id="AppServerExecutable" Guid="{5FB5A627-BB1F-4d82-A06C-7672903DA4C7}">
                                <File Id="ecexe" Name="ecs.exe" Source="../appserver/setup/build/exe.win32-2.7/ecs.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionAppServer" Name="Network Optix Enterprise Controller" Scope="any" IgnoreFailure="yes" />
                                </File>
                                
                                <ServiceInstall Id="VmsAppServerService"
                                                Name="VmsAppServer"
                                                DisplayName="Network Optix Enterprise Controller"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="Network Optix Enterprise Controller">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>
                                
                                <ServiceControl Id="StartVmsAppServerService" Name="VmsAppServer" Start="install" Wait="no" />
                                <ServiceControl Id="StopVmsAppServerService" Name="VmsAppServer" Stop="both" Wait="yes" Remove="uninstall" />
                            
                            </Component>
                            
                            <!-- Dummy file. To remove on uninstall.  -->
                            <Component Id="ecs.log" Guid="{9F34E3B1-9682-47C7-BE56-3165EA127E40}">
                                <File Id="ecs.log" Name="ecs.log" Source="files/ecs.log" KeyPath="yes"/>
                            </Component>
                            
                            <Component Id="AppServerConfigurationGuid" Guid="{2936DFE8-0645-4573-993F-D009EDFB1732}" Permanent="yes" NeverOverwrite="yes">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Enterprise Controller"
                                             Action="create">
                                    <RegistryValue Type="string" Name="ecsGuid" Value="[APPSERVER_GUID]" KeyPath="yes"/>
                                </RegistryKey>
                            </Component>
                            
                            <Component Id="AppServerConfiguration" Guid="{46C18E7E-D25C-4250-AF5F-0237EEFAA80E}">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Enterprise Controller" Action="create">
                                    <RegistryValue Type="string" Name="port" Value="[APPSERVER_PORT]"/>
                                    <RegistryValue Type="string" Name="proxyPort" Value="[PROXY_PORT]"/>
                                    <RegistryValue Type="string" Name="login" Value="[APPSERVER_LOGIN]"/>
                                </RegistryKey>
                            </Component>
                    	
                    		<Component Id="AppServerConfigurationPassword" Guid="{DF889354-8330-4b69-A2EA-47061E9AF1B0}" Permanent="yes">
                                <Condition>
                                    NOT PREVIOUSVERSIONSINSTALLED
                                </Condition>
                    			
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Enterprise Controller" Action="create">
                                    <RegistryValue Type="string" Name="password" Value="[APPSERVER_PASSWORD]"/>
                                </RegistryKey>
                        	</Component>
                        </Directory>
                        
                        <Directory Id="VmsTrayToolDir" Name="TrayTool">
                            <Component Id="traytool.exe" Guid="{11772981-5229-4D14-B126-66906570AD57}">
                                <File Id="traytool.exe" Name="traytool.exe" Source="../traytool/bin/$(env.CONFIG)/traytool.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionVmsTrayTool" Name="VMS Tray Tool" Scope="any" IgnoreFailure="yes"/>
                                    
                                    <Shortcut Id="StartmenuTrayTool" Directory="ProgramMenuDir" Name="$(env.APPLICATION_NAME) Tray Assistant"
                                              WorkingDirectory='VmsTrayToolDir' Advertise="yes" Icon="icon_menu.exe" >
                                    </Shortcut>
                                    
                                    <Shortcut Id="StartmenuStartupTrayTool" Directory="StartupFolder" Name="$(env.APPLICATION_NAME) Tray Assistant"
                                              WorkingDirectory='VmsTrayToolDir' Advertise="yes" Icon="icon_menu.exe" >
                                    </Shortcut>
                                </File>
                            </Component>
                            <Component Id="TrayToolQTLibraries" Guid="b3bbeb5b-310a-4b10-b0bb-0e1193de80f5">
                                <File Id="TrayToolQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtCore$(var.suffix)4.dll"  />
                                <File Id="TrayToolQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtGui$(var.suffix)4.dll"  />
                                <File Id="TrayToolQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtNetwork$(var.suffix)4.dll"  />
                            </Component>
                            <Component Id="TrayToolOpenSSL" Guid="{9C379C95-1EDE-49b0-8C6C-7B55ADE60599}">
                                <File Id="TrayToollibeay32.dll" Name="libeay32.dll" Source="..\common\contrib\openssl\bin\libeay32.dll"/>
                                <File Id="TrayToolssleay32.dll" Name="ssleay32.dll" Source="..\common\contrib\openssl\bin\ssleay32.dll"/>
                            </Component>
                        </Directory>
                        
                        <Directory Id="VmsProxyServerDir" Name="MediaProxy">
                            <Component Id="ProxyExecutable" Guid="{7BD9B32D-BE6E-417F-B301-E07657F09B35}">
                                <File Id="ProxyExe" Name="mediaproxy.exe" Source="../mediaproxy/bin/$(env.CONFIG)/mediaproxy.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionProxyServer" Name="Network Optix Media Proxy" Scope="any" IgnoreFailure="yes"/>
                                </File>
                                
                                <ServiceInstall Id="VmsMediaProxyService"
                                                Name="VmsMediaProxy"
                                                DisplayName="Network Optix Media Proxy"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="Network Optix Media Proxy">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>
                                
                                <ServiceControl Id="StartVmsProxyService" Name="VmsMediaProxy" Start="install" Wait="no" />
                                <ServiceControl Id="StopVmsProxyService" Name="VmsMediaProxy" Stop="both" Wait="yes" Remove="uninstall" />
                            </Component>
                            
                            <Component Id="ProxyQTLibraries" Guid="{A49B87BB-ADD9-41CA-87C0-304A8A483427}">
                                <File Id="ProxyQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtCore$(var.suffix)4.dll" />
                                <File Id="ProxyQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtGui$(var.suffix)4.dll" />
                                <File Id="ProxyQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtMultimedia$(var.suffix)4.dll" />
                                <File Id="ProxyQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtNetwork$(var.suffix)4.dll" />
                                <File Id="ProxyQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtXml$(var.suffix)4.dll" />
                            </Component>

                            <Component Id="ProxyOpenSSL" Guid="{B2CFCF46-4618-44a9-9BB5-7C832AA10652}">
                                <File Id="Proxylibeay32.dll" Name="libeay32.dll" Source="..\common\contrib\openssl\bin\libeay32.dll"/>
                                <File Id="Proxyssleay32.dll" Name="ssleay32.dll" Source="..\common\contrib\openssl\bin\ssleay32.dll"/>
                            </Component>
                        </Directory>
                        
                        <Directory Id="VmsMediaServerDir" Name="MediaServer">
                            <Component Id="ServerExecutable" Guid="06DFA703-0266-4970-BAC1-3730BF7D1C66">
                                <File Id="ServerExe" Name="mediaserver.exe" Source="../mediaserver/bin/$(env.CONFIG)/mediaserver.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionMediaServer" Name="Network Optix Media Server" Scope="any" IgnoreFailure="yes"/>
                                </File>
                                
                                <ServiceInstall Id="VmsMediaServerService"
                                                Name="VmsMediaServer"
                                                DisplayName="Network Optix Media Server"
                                                Type="ownProcess"
                                                Start="auto"
                                                ErrorControl="normal"
                                                Description="Network Optix Media Server">
                                    <util:ServiceConfig FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart"/>
                                </ServiceInstall>
                                
                                <ServiceControl Id="StartVmsServerService" Name="VmsMediaServer" Start="install" Wait="no" />
                                <ServiceControl Id="StopVmsServerService" Name="VmsMediaServer" Stop="both" Wait="yes" Remove="uninstall" />
                            </Component>
                            
                            <Component Id="ServerConfigurationGuid" Guid="{A2F8AEC6-3050-4262-BEAF-3645943D932F}" Permanent="yes" NeverOverwrite="yes">
                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Network Optix Media Server"
                                             Action="create">
                                    <RegistryValue Type="string" Name="serverGuid" Value="[SERVER_GUID]" KeyPath="yes"/>
                                </RegistryKey>
                            </Component>
                            
                            <Component Id="ServerConfiguration" Guid="{C3BA240A-2D18-4723-B084-D2774F51D1B0}" Permanent="yes">
                                <Condition>
                                    NOT PREVIOUSVERSIONSINSTALLED
                                </Condition>

                                <RegistryKey Root="HKLM"
                                             Key="Software\[Manufacturer]\Network Optix Media Server"
                                             Action="create">
                                    <RegistryValue Type="string" Name="appserverHost" Value="[SERVER_APPSERVER_HOST]"/>
                                    <RegistryValue Type="string" Name="appserverPort" Value="[SERVER_APPSERVER_PORT]"/>
                                    <RegistryValue Type="string" Name="appserverLogin" Value="[SERVER_APPSERVER_LOGIN]"/>
                                    <RegistryValue Type="string" Name="appserverPassword" Value="[SERVER_APPSERVER_PASSWORD]"/>
                                    <RegistryValue Type="string" Name="rtspPort" Value="[SERVER_RTSP_PORT]"/>
                                    <RegistryValue Type="string" Name="apiPort" Value="[SERVER_API_PORT]"/>
                                    <RegistryValue Type="string" Name="mediaDir" Value="[SERVER_DIRECTORY]"/>
                                    <RegistryValue Type="string" Name="serverGuid" Value="[SERVER_GUID]"/>
                                </RegistryKey>
                            </Component>
                            
                            <Component Id="ServerFFmpegLibraries" Guid="{692DCCAD-138B-4763-822E-8BC8712F5007}">
                                <File Id="ServerAvcodecDll" Name="avcodec-54.dll" Source="../mediaserver/bin/$(env.CONFIG)/avcodec-54.dll"/>
                                <File Id="ServerAvdeviceDll" Name="avdevice-53.dll" Source="../mediaserver/bin/$(env.CONFIG)/avdevice-53.dll"/>
                                <File Id="ServerAvfilterDll" Name="avfilter-2.dll" Source="../mediaserver/bin/$(env.CONFIG)/avfilter-2.dll"/>
                                <File Id="ServerAvformatDll" Name="avformat-54.dll" Source="../mediaserver/bin/$(env.CONFIG)/avformat-54.dll"/>
                                <File Id="ServerAvutilDll" Name="avutil-51.dll" Source="../mediaserver/bin/$(env.CONFIG)/avutil-51.dll"/>
                                <File Id="ServerSwscaleDll" Name="swscale-2.dll" Source="../mediaserver/bin/$(env.CONFIG)/swscale-2.dll"/>
<!--                                <File Id="ServerMp3lameDll" Name="libmp3lame-0.dll" Source="../mediaserver/bin/$(env.CONFIG)/libmp3lame-0.dll"/> -->
                            </Component>
                            
                            <Component Id="ServerQTLibraries" Guid="{97B2E8C3-274A-4e3e-8FBD-F60355A75A8A}">
                                <File Id="ServerQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtCore$(var.suffix)4.dll" />
                                <File Id="ServerQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtGui$(var.suffix)4.dll" />
                                <File Id="ServerQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtMultimedia$(var.suffix)4.dll" />
                                <File Id="ServerQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtNetwork$(var.suffix)4.dll" />
                                <File Id="ServerQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtXml$(var.suffix)4.dll" />
                            </Component>
                            
                            <Component Id="ServerOpenSSL" Guid="{DC94094B-CA8C-4be0-9A8A-6DA35FCC77E6}">
                                <File Id="Serverlibeay32.dll" Name="libeay32.dll" Source="..\common\contrib\openssl\bin\libeay32.dll"/>
                                <File Id="Serverssleay32.dll" Name="ssleay32.dll" Source="..\common\contrib\openssl\bin\ssleay32.dll"/>
                            </Component>                            
                        </Directory>
                        
                        <Directory Id="VmsClientDir" Name="Client">
                            <Component Id="ClientExecutable" Guid="{7AAC7815-50A6-4dc9-ADD2-BDD9B7EE8FEF}">
                                <File Id="HDWitness.exe" Name="HDWitness.exe" Source="../client/bin/$(env.CONFIG)/client.exe" KeyPath="yes">
                                    <fire:FirewallException Id="FirewallExceptionClient" Name="HD Witness" Scope="any" IgnoreFailure="yes"/>
                                    
                                    <Shortcut Id="StartmenuClient" Directory="ProgramMenuDir" Name="$(env.APPLICATION_NAME)"
                                              WorkingDirectory='VmsClientDir' Advertise="yes" Icon="icon_menu.exe" >
                                    </Shortcut>
                                    <Shortcut Id="DesktopClient" Directory="DesktopFolder" Name="$(env.APPLICATION_NAME)"
                                              WorkingDirectory='VmsClientDir' Advertise="yes" Icon="icon_desktop.exe">
                                    </Shortcut>
                                
                                </File>
                            </Component>
                            
                            <Component Id="ClientConfiguration" Guid="{8AC01524-8F3A-46ba-8A85-24B3709CEDDE}" Permanent="yes">
                                <Condition>
                                    NOT PREVIOUSVERSIONSINSTALLED
                                </Condition>

                                <RegistryKey Root="HKCU"
                                             Key="Software\[Manufacturer]\Network Optix HD Witness Client"
                                             Action="create">
                                    <RegistryValue Type="string" Name="afterFirstRun" Value="false"/>
                                    <RegistryValue Type="string" Name="appserverHost" Value="[CLIENT_APPSERVER_HOST]"/>
                                    <RegistryValue Type="string" Name="appserverPort" Value="[CLIENT_APPSERVER_PORT]"/>
                                    <RegistryValue Type="string" Name="appserverLogin" Value="[CLIENT_APPSERVER_LOGIN]"/>
                                </RegistryKey>
                            </Component>
                            
                    		<Component Id="ClientConfigurationPassword" Guid="{C6565C10-1BB5-417d-8EEA-F2CC8362374F}">
                    			<RemoveRegistryValue Root="HKCU" Key="Software\[Manufacturer]\Network Optix HD Witness Client" Name="appserverPassword"/>
                        	</Component>
                        	
                            <Directory Id="ImageFormats" Name="imageformats">
                                <Component Id="ImageFormats" Guid="{74793EF7-61C1-4e9c-81D6-A120E85D984F}">
                                    <File Id="qgif4.dll" Name="qgif4.dll" Source="$(env.QTDIR)\plugins\imageformats\qgif4.dll" />
                                    <File Id="qjpeg4.dll" Name="qjpeg4.dll" Source="$(env.QTDIR)\plugins\imageformats\qjpeg4.dll" />
                                    <File Id="qtiff4.dll" Name="qtiff4.dll" Source="$(env.QTDIR)\plugins\imageformats\qtiff4.dll" />
                                </Component>
                            </Directory>
                            
                            <Component Id="ClientFFmpegLibraries" Guid="{5D256521-DE39-4264-A44F-69728AA650EF}">
                                <File Id="ClientAvcodecDll" Name="avcodec-54.dll" Source="../client/bin/$(env.CONFIG)/avcodec-54.dll"/>
                                <File Id="ClientAvdeviceDll" Name="avdevice-53.dll" Source="../client/bin/$(env.CONFIG)/avdevice-53.dll"/>
                                <File Id="ClientAvfilterDll" Name="avfilter-2.dll" Source="../client/bin/$(env.CONFIG)/avfilter-2.dll"/>
                                <File Id="ClientAvformatDll" Name="avformat-54.dll" Source="../client/bin/$(env.CONFIG)/avformat-54.dll"/>
                                <File Id="ClientAvutilDll" Name="avutil-51.dll" Source="../client/bin/$(env.CONFIG)/avutil-51.dll"/>
                                <File Id="ClientSwscaleDll" Name="swscale-2.dll" Source="../client/bin/$(env.CONFIG)/swscale-2.dll"/>
<!--                                <File Id="ClientMp3lameDll" Name="libmp3lame-0.dll" Source="../client/bin/$(env.CONFIG)/libmp3lame-0.dll"/> -->
                                <File Id="ClientX264" Name="x264.exe" Source="../client/bin/$(env.CONFIG)/x264.exe"/>
                            </Component>
                            
                            <Component Id="ClientQTLibraries" Guid="{6BDC7AB9-6230-4cf3-9C1C-634C636D90BC}">
                                <File Id="ClientQtCore$(var.suffix)4.dll" Name="QtCore$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtCore$(var.suffix)4.dll" />
                                <File Id="ClientQtGui$(var.suffix)4.dll" Name="QtGui$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtGui$(var.suffix)4.dll" />
                                <File Id="ClientQtMultimedia$(var.suffix)4.dll" Name="QtMultimedia$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtMultimedia$(var.suffix)4.dll" />
                                <File Id="ClientQtNetwork$(var.suffix)4.dll" Name="QtNetwork$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtNetwork$(var.suffix)4.dll" />
                                <File Id="ClientQtOpenGL$(var.suffix)4.dll" Name="QtOpenGL$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtOpenGL$(var.suffix)4.dll" />
                                <File Id="ClientQtXml$(var.suffix)4.dll" Name="QtXml$(var.suffix)4.dll" Source="$(env.QTDIR)\bin\QtXml$(var.suffix)4.dll" />
                            </Component>
                            
                            <Component Id="ClientOpenAL" Guid="{FA1A8B92-3BEF-4779-90E9-2F76CC9D79D3}">
                                <File Id="OpenAL32.dll" Name="OpenAL32.dll" Source="..\client\contrib\openal\bin\Win32\OpenAL32.dll"/>
                                <File Id="wrap_oal.dll" Name="wrap_oal.dll" Source="..\client\contrib\openal\bin\Win32\wrap_oal.dll"/>
                            </Component>
                            
                            <Component Id="ClientOpenSSL" Guid="{D7E994B3-B437-4993-A04E-C15AF9DF8312}">
                                <File Id="Clientlibeay32.dll" Name="libeay32.dll" Source="..\common\contrib\openssl\bin\libeay32.dll"/>
                                <File Id="Clientssleay32.dll" Name="ssleay32.dll" Source="..\common\contrib\openssl\bin\ssleay32.dll"/>
                            </Component>
                            
                            <Component Id="ClientQtColorPicker" Guid="{A8E0F358-198A-4D79-A6F0-607D60F524EE}">
                                <File Id="ColorPicker26dll" Name="QtSolutions_ColorPicker-2.6.dll " Source="..\client\contrib\qtcolorpicker\lib\QtSolutions_ColorPicker-2.6$(var.suffix).dll"/>
                            </Component>
                            
                            <Directory Id="styles" Name="styles">
                                <Component Id="bespin" Guid="{BF20F7AC-A34C-481a-84E3-731C80050D51}">
                                    <File Id="bespin$(var.suffix).dll" Name="bespin$(var.suffix).dll" Source="..\client\contrib\bespin\bin\msvc-x86\$(env.CONFIG)\styles\bespin$(var.suffix).dll" />
                                </Component>
                            </Directory>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>
            
            <Directory Id="ProgramMenuFolder" Name="Programs">
                <Directory Id="ProgramMenuDir" Name="$(env.ORGANIZATION_NAME)">
                    <Component Id="UninstallProgramMenuFolder" DiskId="1" Guid="{3714E067-D4DC-4A09-9D06-EAC5BCB6ABF3}">
                        <RemoveFolder Id='DashMenuDirRem' On='uninstall' />
                    </Component>
                </Directory>
            </Directory>
            
            <Directory Id="DesktopFolder" Name="Desktop"/>
            <Directory Id="StartupFolder" Name="Startup"/>
        </Directory>
        
        <DirectoryRef Id="TARGETDIR">
            <Merge Id="VCRedist1" SourceFile="$(var.commonProgramFiles)Merge Modules\Microsoft_VC90_CRT_x86.msm" DiskId="1" Language="0"/>
            <Merge Id="VCRedist2" SourceFile="$(var.commonProgramFiles)Merge Modules\policy_9_0_Microsoft_VC90_CRT_x86.msm" DiskId="1" Language="0"/>
            <?if $(env.CONFIG) = Debug ?>
            <Merge Id="VCRedist3" SourceFile="$(var.commonProgramFiles)Merge Modules\Microsoft_VC90_DebugCRT_x86.msm" DiskId="1" Language="0"/>
            <Merge Id="VCRedist4" SourceFile="$(var.commonProgramFiles)Merge Modules\policy_9_0_Microsoft_VC90_DebugCRT_x86.msm" DiskId="1" Language="0"/>
            <?endif?>
        </DirectoryRef>
        
        <Feature Id="VCRedist" Title="Visual C++ 9.0 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist1"/>
            <MergeRef Id="VCRedist2"/>
            <?if $(env.CONFIG) = Debug ?>
            <MergeRef Id="VCRedist3"/>
            <MergeRef Id="VCRedist4"/>
            <?endif?>
        </Feature>
        
        <Feature Id="AppServerFeature" Title="$(env.APPLICATION_NAME) Enterprise Controller" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="hidden" >
<!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !AppServerFeature <> 3 ]]> </Condition>-->
            
            <ComponentGroupRef Id="AppServerFilesComponent" />
            <ComponentRef Id="AppServerExecutable" />
            <ComponentRef Id="ecs.log" />           
            <ComponentRef Id="AppServerConfiguration"/>
        	<ComponentRef Id="AppServerConfigurationPassword"/>
            <ComponentRef Id="AppServerConfigurationGuid"/>
            
            <ComponentRef Id="ProxyExecutable" />
            <ComponentRef Id="ProxyQTLibraries" />
            <ComponentRef Id="ProxyOpenSSL" />
        </Feature>
        
        <Feature Id="TrayToolFeature" Title="Tray Tool" AllowAdvertise="no" Display="hidden" Level="1">
<!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !TrayToolFeature <> 3 ]]> </Condition>-->
            
        	<ComponentRef Id="ARPAltRegistryEntries"/>
            <ComponentRef Id="traytool.exe"/>
            <ComponentRef Id="TrayToolQTLibraries"/>
            <ComponentRef Id="TrayToolOpenSSL"/>
            <ComponentRef Id="UninstallProgramMenuFolder"/>
        </Feature>
        
        <Feature Id="ServerFeature" Title="$(env.APPLICATION_NAME) Media Server" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
<!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !ServerFeature <> 3 ]]> </Condition>-->
            
            <ComponentRef Id='ServerDirectoryComponent'/>
            <ComponentRef Id='ServerConfiguration'/>
            <ComponentRef Id='ServerConfigurationGuid'/>
            
            <ComponentRef Id="ServerExecutable" />
            <ComponentRef Id="ServerFFmpegLibraries"/>
            <ComponentRef Id="ServerQTLibraries" />
            <ComponentRef Id="ServerOpenSSL"/>
        </Feature>
        
        <Feature Id="ClientFeature" Title="$(env.APPLICATION_NAME) Client" Level="1"
                 ConfigurableDirectory="INSTALLDIR" Absent="allow" InstallDefault="local" AllowAdvertise="no" Display="expand">
<!--            <Condition Level="0"><![CDATA[ $(var.VmsUpgrading) AND !ClientFeature <> 3 ]]> </Condition>-->
           
            <ComponentRef Id="NovFileAssociation"/>
 
            <ComponentRef Id="ClientExecutable" />
            <ComponentRef Id="ClientConfiguration" />
            <ComponentRef Id="ClientConfigurationPassword" />
            <ComponentRef Id="ClientFFmpegLibraries"/>
            <ComponentRef Id="ClientQTLibraries" />
            <ComponentRef Id="ImageFormats" />
            <ComponentRef Id="ClientOpenAL" />
            <ComponentRef Id="ClientOpenSSL" />
            <ComponentRef Id="ClientQtColorPicker"/>
            <ComponentRef Id="bespin" />
            
            <ComponentRef Id='ClientDirectoryComponent'/>
        </Feature>
        
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
        <Property Id="WIXUI_SERVER_DIRECTORY" Value="SERVER_DIRECTORY"/>
        <Property Id="WIXUI_CLIENT_DIRECTORY" Value="CLIENT_DIRECTORY"/>
        <Property Id="WIXUI_SERVER_ALLOWCHANGEIP" Value="SERVER_ALLOWCHANGEIP"/>
        
        
        <UIRef Id="WixUI_Common" />
        <UIRef Id="WixUI_ErrorProgressText" />
        
        <UI>
            <!-- These dialog references are needed for CloseApplication above to work correctly -->
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />      
            
            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />
            
<!--            <Property Id="ARPNOMODIFY" Value="1" />-->
            
            <DialogRef Id="MyFeaturesDlg" />
            <DialogRef Id="SelectionWarningDlg" />
            <DialogRef Id="DowngradeWarningDlg" />
            <DialogRef Id="BrowseDlg" />
            <DialogRef Id="DiskCostDlg" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />
            <!--Width="260" Height="85"-->
            
            <Binary Id="Warning" SourceFile="Binary\Exclam.ico" />
            
            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <Publish Dialog="ExitDialog" Control="Finish" Order="1" Event="DoAction" Value="LaunchClient">WIXUI_EXITDIALOGOPTIONALCHECKBOX</Publish>
            
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">NOT PREVIOUSVERSIONSINSTALLED</Publish>          
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="UpgradeDlg">PREVIOUSVERSIONSINSTALLED</Publish>
            
            <Publish Dialog="UpgradeDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="UpgradeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            
            <Publish Dialog="DowngradeWarningDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="DowngradeWarningDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            
            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallTypeDlg">LicenseAccepted = "1"</Publish>
            
            <Publish Dialog="InstallTypeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            
            <Publish Dialog="InstallTypeDlg" Control="Next" Event="NewDialog" Value="PasswordDlg">INSTALLTYPE=0</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Event="NewDialog" Value="AdvancedTypeDlg">INSTALLTYPE=1</Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Event="AddLocal" Value="ALL">INSTALLTYPE=0</Publish>

            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4" ><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="InstallTypeDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4"><![CDATA[ INSTALLTYPE=0 ]]></Publish>

            <?define EcsPasswordsEqual="(APPSERVER_PASSWORD = APPSERVER_PASSWORD_CONFIRM)" ?>
            
            <Publish Dialog="PasswordDlg" Control="Back" Event="NewDialog" Value="InstallTypeDlg">1</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="SpawnDialog" Value="EmptyPasswordDlg">NOT APPSERVER_PASSWORD</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]">APPSERVER_PASSWORD</Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="SpawnDialog" Value="PasswordShouldMatchDlg" Order="2"><![CDATA[ NOT $(var.EcsPasswordsEqual) ]]></Publish>
            <Publish Dialog="PasswordDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">$(var.EcsPasswordsEqual) AND APPSERVER_PASSWORD</Publish>
            
            <Publish Dialog="AdvancedTypeDlg" Control="Back" Event="NewDialog" Value="InstallTypeDlg">1</Publish>
            <Publish Dialog="AdvancedTypeDlg" Control="Next" Event="NewDialog" Value="MyFeaturesDlg">1</Publish>
            
            <Publish Dialog="MyFeaturesDlg" Control="Back" Event="NewDialog" Value="AdvancedTypeDlg"><![CDATA[ NOT $(var.VmsChanging) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg"><![CDATA[ $(var.VmsChanging) ]]></Publish>
            
            <?define SomeFeaturesSelected="(!ServerFeature=3 OR &ServerFeature=3 OR !ClientFeature=3 OR &ClientFeature=3)"?>
            
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="SpawnDialog" Value="SelectionWarningDlg"><![CDATA[NOT $(var.SomeFeaturesSelected)]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg"><![CDATA[$(var.SomeFeaturesSelected) AND $(var.VmsInstalling)]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg"><![CDATA[$(var.SomeFeaturesSelected) AND NOT $(var.VmsInstalling) AND &ServerFeature=3]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg"><![CDATA[$(var.SomeFeaturesSelected) AND NOT $(var.VmsInstalling) AND &ServerFeature<>3]]></Publish>
            
            <!-- Reset values in case when user returns to this dialog after AppServerDlg -->

            <?define AppServerInstallingMediaServer="($(var.VmsChanging) AND !AppServerFeature=3 AND &ServerFeature=3)"?>
            <?define AppServerInstallingClient="($(var.VmsChanging) AND !AppServerFeature=3 AND &ClientFeature=3)"?>
            
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4"><![CDATA[ $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4"><![CDATA[ $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4"><![CDATA[ $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4" ><![CDATA[ $(var.AppServerInstallingMediaServer) ]]></Publish>
            
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="{}" Order="4" ><![CDATA[ NOT $(var.AppServerInstallingMediaServer) ]]></Publish>
            
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4"><![CDATA[ $(var.AppServerInstallingClient) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4"><![CDATA[ $(var.AppServerInstallingClient) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4"><![CDATA[ $(var.AppServerInstallingClient) ]]></Publish>
            
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingClient) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingClient) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="{}" Order="4"><![CDATA[ NOT $(var.AppServerInstallingClient) ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="{}"><![CDATA[ &ClientFeature <> 3 ]]></Publish>
            <Publish Dialog="MyFeaturesDlg" Control="Next" Property="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="$(var.LaunchClientChecBoxText)"><![CDATA[ &ClientFeature = 3 ]]></Publish>
            
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="AppServerDlg" Order="2"><![CDATA[(&AppServerFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="3"><![CDATA[(&AppServerFeature <> 3 AND &ServerFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="4"><![CDATA[(&AppServerFeature <> 3 AND &ServerFeature <>3 AND &ClientFeature=3)]]></Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="CheckServerDriveLowSpace">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="CheckServerDirectoryWritable">1</Publish>
            
            <Publish Dialog="AppServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
     
            <?define EcsPortsDiffer="(APPSERVER_PORT <> PROXY_PORT)" ?>
            <?define EcsNeedCheckPorts="(APPSERVER_PORT <> OLD_APPSERVER_PORT OR PROXY_PORT <> OLD_PROXY_PORT)" ?>
            
            <Publish Dialog="AppServerDlg" Control="Next" Property="BUSYPORT" Value="{}">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORTSTOTEST" Value="[APPSERVER_PORT] [PROXY_PORT]" Order="1">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="PortDuplicateDlg" Order="2"><![CDATA[ NOT $(var.EcsPortsDiffer) ]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="PasswordShouldMatchDlg" Order="2"><![CDATA[ $(var.EcsPortsDiffer) AND NOT $(var.EcsPasswordsEqual) ]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="DoAction" Value="CheckPorts" Order="2"><![CDATA[ $(var.EcsPortsDiffer) AND $(var.EcsPasswordsEqual) AND $(var.EcsNeedCheckPorts) ]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="PortIsBusyDlg" Order="3"><![CDATA[ $(var.EcsPortsDiffer) AND $(var.EcsPasswordsEqual) AND BUSYPORT ]]></Publish>
            
            <?define IsAsSettingsFilled="(APPSERVER_PORT AND PROXY_PORT AND APPSERVER_LOGIN AND APPSERVER_PASSWORD)" ?>
            
            <Publish Dialog="AppServerDlg" Control="Next" Event="SpawnDialog" Value="AllFieldsAreMandatoryDlg"><![CDATA[ NOT $(var.IsAsSettingsFilled) ]]></Publish>
            
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="MediaServerDlg" Order="2"><![CDATA[($(var.IsAsSettingsFilled) AND NOT BUSYPORT AND &ServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="4"><![CDATA[($(var.IsAsSettingsFilled) AND NOT BUSYPORT AND &ServerFeature <> 3)]]></Publish>
            
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_HOST" Value="localhost" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="SERVER_APPSERVER_PASSWORD" Value="[APPSERVER_PASSWORD]" Order="4">1</Publish>
            
            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="localhost" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[APPSERVER_LOGIN]" Order="4">1</Publish>
            
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_BACK" Value="AppServerDlg">1</Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_NEXT" Value="MediaServerDlg"><![CDATA[(NOT BUSYPORT AND &ServerFeature=3)]]></Publish>
            <Publish Dialog="AppServerDlg" Control="Next" Property="PORT_DIALOG_BACK"  Value="VerifyReadyDlg"><![CDATA[(NOT BUSYPORT AND &ServerFeature <> 3)]]></Publish>
            
            <Publish Dialog="PortIsBusyDlg" Control="Back" Event="NewDialog" Value="[PORT_DIALOG_BACK]">1</Publish>
            <Publish Dialog="PortIsBusyDlg" Control="Next" Event="NewDialog" Value="[PORT_DIALOG_NEXT]">1</Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="AppServerDlg"><![CDATA[$(var.VmsInstalling) AND &AppServerFeature=3]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg"><![CDATA[$(var.VmsInstalling) AND &AppServerFeature<>3]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg"><![CDATA[NOT $(var.VmsInstalling)]]></Publish>

            
            <?define IsPortsValid="((&AppServerFeature=3 AND SERVER_RTSP_PORT<>APPSERVER_PORT AND SERVER_API_PORT<>APPSERVER_PORT AND SERVER_RTSP_PORT<>PROXY_PORT AND SERVER_API_PORT<>PROXY_PORT AND SERVER_API_PORT<>SERVER_RTSP_PORT) OR (&AppServerFeature<>3 AND SERVER_API_PORT<>SERVER_RTSP_PORT))" ?>
            <?define IsSettingsFilled="(SERVER_RTSP_PORT AND SERVER_API_PORT AND SERVER_APPSERVER_HOST AND SERVER_APPSERVER_PORT AND SERVER_APPSERVER_LOGIN AND SERVER_APPSERVER_PASSWORD)"?>
            <?define IsSettingsValid="($(var.IsPortsValid) AND $(var.IsSettingsFilled))"?>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_SERVER_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="SpawnDialog" Value="AllFieldsAreMandatoryDlg"><![CDATA[ NOT $(var.IsSettingsFilled) ]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="SpawnDialog" Value="PortDuplicateDlg"><![CDATA[ NOT $(var.IsPortsValid) AND $(var.IsSettingsFilled) ]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2"><![CDATA[$(var.IsSettingsValid) AND $(var.IsPortsValid)]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="ChangeServerMediaDir" Property="_BrowseProperty" Value="[WIXUI_SERVER_DIRECTORY]" Order="1">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="ChangeServerMediaDir" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            
            <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="CheckServerDriveLowSpace" Order="4">1</Publish>
            <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="CheckServerDirectoryWritable" Order="4">1</Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_HOST" Value="[SERVER_APPSERVER_HOST]" Order="4">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_PORT" Value="[SERVER_APPSERVER_PORT]" Order="4">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="CLIENT_APPSERVER_LOGIN" Value="[SERVER_APPSERVER_LOGIN]" Order="4">1</Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Property="BUSYPORT" Value="{}">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORTSTOTEST" Value="[SERVER_API_PORT]" Order="1"><![CDATA[ SERVER_RTSP_PORT = OLD_SERVER_RTSP_PORT OR SERVER_API_PORT <> OLD_SERVER_API_PORT]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORTSTOTEST" Value="[SERVER_RTSP_PORT]" Order="1"><![CDATA[ SERVER_RTSP_PORT <> OLD_SERVER_RTSP_PORT OR SERVER_API_PORT = OLD_SERVER_API_PORT]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORTSTOTEST" Value="[SERVER_API_PORT] [SERVER_RTSP_PORT]" Order="1"><![CDATA[ SERVER_RTSP_PORT <> OLD_SERVER_RTSP_PORT AND SERVER_API_PORT <> OLD_SERVER_API_PORT]]></Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Event="DoAction" Value="CheckPorts2" Order="2"><![CDATA[ SERVER_RTSP_PORT <> OLD_SERVER_RTSP_PORT OR SERVER_API_PORT <> OLD_SERVER_API_PORT]]></Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Event="NewDialog" Value="PortIsBusyDlg" Order="3">BUSYPORT</Publish>
            
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORT_DIALOG_BACK" Value="MediaServerDlg">1</Publish>
            <Publish Dialog="MediaServerDlg" Control="Next" Property="PORT_DIALOG_NEXT" Value="VerifyReadyDlg">1</Publish>
            
            <?define EditingAppServer="(INSTALLTYPE=1 AND &AppServerFeature=3)"?>
            <?define EditingMediaServer="(INSTALLTYPE=1 AND &ServerFeature=3)"?>
            
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="PasswordDlg"><![CDATA[ $(var.VmsInstalling) AND INSTALLTYPE=0 ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MediaServerDlg"><![CDATA[ $(var.VmsInstalling) AND INSTALLTYPE=1 AND $(var.EditingMediaServer) ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="AppServerDlg" ><![CDATA[ $(var.VmsInstalling) AND INSTALLTYPE=1 AND $(var.EditingAppServer) AND NOT $(var.EditingMediaServer) ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg"><![CDATA[ $(var.VmsInstalling) AND INSTALLTYPE=1 AND NOT $(var.EditingAppServer) AND NOT $(var.EditingMediaServer) ]]></Publish>
            
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UpgradeDlg"><![CDATA[ $(var.VmsUpgrading) ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MyFeaturesDlg" Order="2"><![CDATA[ NOT $(var.VmsUpgrading) AND ((Installed AND WixUI_InstallMode <> "Repair") OR (NOT $(var.VmsInstalling) AND &ServerFeature <> 3)) ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2"><![CDATA[ $(var.VmsRemoving) OR WixUI_InstallMode = "Repair" ]]></Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UninstallOptionsDlg" Order="2"><![CDATA[ $(var.VmsRemoving) ]]></Publish>        	
            <Publish Dialog="VerifyReadyDlg" Control="Back" Property="REMOVE" Value="{}" Order="3"><![CDATA[ Installed ]]></Publish>
            
<!--            <Publish Dialog="VerifyReadyDlg" Control="Next" Event="ReinstallMode" Value="m" Order="1">WixUI_InstallMode = Change</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Next" Event="Reinstall" Value="Registry" Order="2">WixUI_InstallMode = Change</Publish>
-->            
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="ChangeButton" Event="NewDialog" Value="MyFeaturesDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Property="REMOVE" Value="ALL">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="UninstallOptionsDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>
    	
    		<Publish Dialog="UninstallOptionsDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
    		<Publish Dialog="UninstallOptionsDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
        </UI>
    </Product>
</Wix>
