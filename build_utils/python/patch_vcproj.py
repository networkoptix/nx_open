#!/usr/bin/env python

'''
Script for Visual Studio Project files patching, that are generated by QMake incorrectly.
'''

import argparse
import xml.etree.ElementTree as ET
from xml.etree.ElementTree import Element

#ElementTree works kinda strange with namespaces
ms_namespace = "http://schemas.microsoft.com/developer/msbuild/2003"

ET.register_namespace('', ms_namespace)
namespaces_dict = {'ms' : ms_namespace}

parent_map = {}
arch = 'x64'
qt_default_path = '%ENVIRONMENT%\\packages\\windows-{0}\\qt-5.6.0'
qt_path = ''

def indent(elem, level=0):
    i = "\n" + level*"  "
    if len(elem):
        if not elem.text or not elem.text.strip():
            elem.text = i + "  "
        if not elem.tail or not elem.tail.strip():
            elem.tail = i
        for subelem in elem:
            indent(subelem, level+1)
        if not elem.tail or not elem.tail.strip():
            elem.tail = i
    else:
        if level and (not elem.tail or not elem.tail.strip()):
            elem.tail = i

def add_prebuild_events(root, project):
    """
    <Target Name="BeforeClean">
        <Message Text="Cleaning moc generated files"/>
        <Exec Command="del \$\(ProjectDir\)..\\\${arch}\\build\\$\(Configuration\)\\generated\\moc_*.* /F /Q" />
    </Target>    
    <ItemDefinitionGroup>
        <Link>
            <SubSystem Condition="'%(Link.SubSystem)'=='' Or '%(Link.SubSystem)'=='NotSet'">Windows</SubSystem>
        </Link>
        <PreBuildEvent>
            <Command>\$\(ProjectDir\)../${arch}/build_moc.bat \$\(ProjectDir\)../${arch} \$\(Configuration\)</Command>
        </PreBuildEvent>
    </ItemDefinitionGroup>    
    """
    print "Adding custom header with pre-build steps"    

    # nx_kit does not use Qt, and "del" here causes an error because there are no moc files.
    if not "/nx_kit-" in project:
        target = Element('Target', {'Name': 'BeforeClean'})
        root.append(target)   
        target.append(Element('Message', {'Text': 'Cleaning moc generated files'}))
        target.append(Element('Exec', {'Command': 'del $(ProjectDir)..\\{0}\\build\\$(Configuration)\\generated\\moc_*.* /F /Q'.format(arch)}))
        indent(target, 1)
    
    group = Element('ItemDefinitionGroup')
    root.insert(1, group)
    
    link = Element('Link')
    group.append(link)
    subsystem = Element('SubSystem', {'Condition': "'%(Link.SubSystem)'=='' Or '%(Link.SubSystem)'=='NotSet'"})
    subsystem.text = 'Windows'
    link.append(subsystem)
    
    pre = Element('PreBuildEvent')
    group.append(pre)
    command = Element('Command')
    pre.append(command)   
    command.text = "$(ProjectDir)../{0}/build_moc.bat $(ProjectDir)../{0} $(Configuration)".format(arch)
    
    indent(group, 1)
    
def fix_mocables(root):
    """Disabling moc preprocessor steps, since we do it with jom."""
    #xpath = "./Project/ItemGroup/CustomBuild[contains(@Include,'.h')]"

    xpath = "./ms:ItemGroup/ms:CustomBuild"
    customBuildNodes = root.findall(xpath, namespaces_dict)

    nodes = [node for node in customBuildNodes if node.get('Include').endswith('.h')]
    if len(nodes) < 1:
        print "Mocable nodes were not found"
        return

    print "Removing moc custom build steps"
    for node in nodes:
        include = node.attrib
        itemGroupNode = parent_map[node]
        itemGroupNode.remove(node)
        itemGroupNode.append(Element('ClInclude', include))
        indent(itemGroupNode, 1)
            
def enable_fastlink(root):
    """Set GenerateDebugInformation to DebugFastLink for debug build"""
    kFastLink = 'DebugFastLink'
    xpath = "./ms:ItemDefinitionGroup/ms:Link/ms:GenerateDebugInformation"
    debugInfoNodes = root.findall(xpath, namespaces_dict)
    nodes = [node for node in debugInfoNodes if node.text.lower() == 'true']
    if len(nodes) < 1:
        return
        
    print "Enabling FastLink"  
    for node in nodes:
        defGroup = parent_map[parent_map[node]]
        if 'debug' in defGroup.get('Condition').lower():
            node.text = kFastLink
            
def fix_qrc(root):
    """Removing additional inputs from qrc, since we rebuild it manually."""
    #xpath = "./Project/ItemGroup/CustomBuild[contains(@Include,'.qrc')]/AdditionalInputs"

    xpath = "./ms:ItemGroup/ms:CustomBuild"
    customBuildNodes = root.findall(xpath, namespaces_dict)

    nodes = [node for node in customBuildNodes if node.get('Include').endswith('.qrc')]
    if len(nodes) < 1:
        print "Qrc node was not found"
        return

    print "Removing AdditionalInputs from qrc custom build step"
    for node in nodes:
        inputsNodes = node.findall("./ms:AdditionalInputs", namespaces_dict)
        for inputNode in inputsNodes:
            files = inputNode.text.split(';')
            allowed = [f for f in files if not f.endswith('.png') and not f.endswith('.ico') and not f.endswith('.qm')]
            inputNode.text = ';'.join(allowed)

def add_qt_path(root):
    """Adding runtime path to QT libs."""
    #xpath = "./Project/PropertyGroup"
   
    print "Adding path to QT libs: {}".format(qt_path)
    target = Element('PropertyGroup')
    root.insert(3, target)
    
    env = Element('LocalDebuggerEnvironment')
    env.text= 'PATH={0}\\bin$(LocalDebuggerEnvironment)'.format(qt_path)
    target.append(env)
    indent(target, 1)
    
def ignore_link_4221(root):
    """Adding librarian additional parameter to ignore this warning."""
    #xpath = "./Project/ItemDefinitionGroup/Lib/AdditionalOptions"
    
    print "Suppress linker 4221 message"
    xpath = "./ms:ItemDefinitionGroup/ms:Lib"
    nodes = root.findall(xpath, namespaces_dict)
    for node in nodes:
        existing = node.findall("./ms:AdditionalOptions", namespaces_dict)
        if existing:
            for e in existing:
                e.text = '/ignore:4221 ' + e.text
        else:  
            target = Element('AdditionalOptions')
            target.text = '/ignore:4221 %(AdditionalOptions)'
            node.append(target)
        indent(node, 2)
       
            
def patch_project(project):
    print "Patching {0}...".format(project)
    tree = ET.parse(project)
    root = tree.getroot()
    
    global parent_map
    parent_map = {c:p for p in tree.iter() for c in p}
    
    fix_qrc(root)
    fix_mocables(root)
    add_prebuild_events(root, project)
    add_qt_path(root)
    enable_fastlink(root)
    ignore_link_4221(root)
    tree.write(project, encoding="utf-8", xml_declaration=True)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('project', type=str, help='Project to be patched.')
    parser.add_argument('-a', '--arch', help='Target architecture.')
    parser.add_argument('-q', '--qt-dir', help='Path to Qt.')
    args = parser.parse_args()
    
    if args.arch:
        global arch
        arch = args.arch
    
    global qt_path
    if args.qt_dir:
        qt_path = args.qt_dir.replace('/', '\\')
    else:
        qt_path = qt_default_path.format(arch)
    
    patch_project(args.project)


if __name__ == '__main__':
    main()